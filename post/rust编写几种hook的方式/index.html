<!DOCTYPE html>
<html lang="en"><head>
<title>Rustç¼–å†™å‡ ç§hookçš„æ–¹å¼</title>




<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="G-XXXXXXXXXX">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=5, user-scalable=5" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="description" content="">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">



<meta property="og:url" content="https://military-axe.github.io/post/rust%E7%BC%96%E5%86%99%E5%87%A0%E7%A7%8Dhook%E7%9A%84%E6%96%B9%E5%BC%8F/">
  <meta property="og:site_name" content="Mi1itray.axe">
  <meta property="og:title" content="Rustç¼–å†™å‡ ç§hookçš„æ–¹å¼">
  <meta property="og:description" content="ä½¿ç”¨Rustç¼–å†™å‡ ç§åœ¨windowsä¸Šå¸¸ç”¨çš„hookæ–¹å¼:
IAT hook Inline hook VMT hook ä¸ºä»€ä¹ˆè¦ç”¨rustçš„ä¸ç”¨c&#43;&#43;ï¼Ÿå°±æ˜¯æƒ³ç”¨ï¼Œæƒ³ç»™è‡ªå·±æ‰¾éº»çƒ¦ğŸ˜">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2024-03-22T15:59:44+08:00">
    <meta property="article:modified_time" content="2024-03-22T15:59:44+08:00">
    <meta property="article:tag" content="Retour">
    <meta property="article:tag" content="Inline Hook">
    <meta property="article:tag" content="Vmt Hook">
    <meta property="article:tag" content="Iat Hook">
    <meta property="article:tag" content="Rust">
    <meta property="article:tag" content="Hook">






  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Rustç¼–å†™å‡ ç§hookçš„æ–¹å¼">
  <meta name="twitter:description" content="ä½¿ç”¨Rustç¼–å†™å‡ ç§åœ¨windowsä¸Šå¸¸ç”¨çš„hookæ–¹å¼:
IAT hook Inline hook VMT hook ä¸ºä»€ä¹ˆè¦ç”¨rustçš„ä¸ç”¨c&#43;&#43;ï¼Ÿå°±æ˜¯æƒ³ç”¨ï¼Œæƒ³ç»™è‡ªå·±æ‰¾éº»çƒ¦ğŸ˜">







      <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-XXXXXXXXXX');
        }
      </script>




<script type="text/javascript">
  (function(c,l,a,r,i,t,y){
      c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
      t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
      y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
  })(window, document, "clarity", "script", "abcdefghzd");
</script>



  






      <script src="/js/toc.js"></script>
    
    <link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">

<link rel="stylesheet" href="/scss/dark-mode.min.cb53f1bee2b8900cb4f082afbf00175d6618f281cf9a2fe8619e3b52d20b5721.css" integrity="sha256-y1PxvuK4kAy08IKvvwAXXWYY8oHPmi/oYZ47UtILVyE=" media="screen">


<link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Material+Icons">



















</head>
<body>
    	<div id="app"><div class="single-column-drawer-container" id="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/posts">
                    Archive
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/categories">
                    Categories
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/tags">
                    Tags
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/index.xml">
                    RSS Feed
                </a>
                
            
            
            <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#rust-windows-rs-%e5%ba%93%e4%bd%bf%e7%94%a8" class="nav-rust-windows-rs-åº“ä½¿ç”¨">
									Rust windows-rs åº“ä½¿ç”¨
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#features" class="nav-features">
									features
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#32%e4%bd%8d--64%e4%bd%8d--dll" class="nav-32ä½--64ä½--dll">
									32ä½ &amp; 64ä½ &amp; DLL
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#iat-hook" class="nav-iat-hook">
									IAT hook
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#inline-hook" class="nav-inline-hook">
									Inline hook
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#vmt-hook" class="nav-vmt-hook">
									VMT hook
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%8f%82%e8%80%83" class="nav-å‚è€ƒ">
									å‚è€ƒ
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div id="drawer-mask" v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav id="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div id="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a id="navTitle" class="navbar-brand" href="https://military-axe.github.io/">
            Mi1itray.axe
        </a>
        
        <button type="button" class="nav-darkmode-toggle" id="darkModeToggleButton2">
            <i class="material-icons" id="darkModeToggleIcon2">
                dark_mode
            </i>
        </button>
        
    </div>
</nav>
<div class="single-column-header-container" id="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="https://military-axe.github.io/">
        <div class="single-column-header-title">Mi1itray.axe</div>
        
        <div class="single-column-header-subtitle">mi1itray.axe@gmail.com</div>
        

    </a>
</div>

            <div id="content">
                <div id="streamContainer" class="stream-container">

    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            

            <div class="post-head-wrapper-text-only"
                
            >
                <div class="post-title">
                    Rustç¼–å†™å‡ ç§hookçš„æ–¹å¼
                    
                    <div class="post-meta">
                        
                        <time itemprop="datePublished">
                            2024-03-22 15:59
                        </time>
                        

                        
                            <i class="material-icons" style="">folder</i>
                                <a href="/categories/reverse">Reverse</a>
                                &nbsp;
                        

                        
                            <i class="material-icons" style="">label</i>
                            
                                <a href="/tags/retour">retour</a>
                                &nbsp;
                            
                                <a href="/tags/inline-hook">inline hook</a>
                                &nbsp;
                            
                                <a href="/tags/vmt-hook">vmt hook</a>
                                &nbsp;
                            
                                <a href="/tags/iat-hook">iat hook</a>
                                &nbsp;
                            
                                <a href="/tags/rust">rust</a>
                                &nbsp;
                            
                                <a href="/tags/hook">hook</a>
                                &nbsp;
                            
                        
                        
                    </div>
                </div>
            </div>
            
            <div class="post-body-wrapper">
                
                <div class="post-body" v-pre>
                
                    <p>ä½¿ç”¨Rustç¼–å†™å‡ ç§åœ¨windowsä¸Šå¸¸ç”¨çš„hookæ–¹å¼:</p>
<ul>
<li>IAT hook</li>
<li>Inline hook</li>
<li>VMT hook</li>
</ul>
<p>ä¸ºä»€ä¹ˆè¦ç”¨rustçš„ä¸ç”¨c++ï¼Ÿå°±æ˜¯æƒ³ç”¨ï¼Œæƒ³ç»™è‡ªå·±æ‰¾éº»çƒ¦ğŸ˜</p>
<h1 id="rust-windows-rs-åº“ä½¿ç”¨">Rust windows-rs åº“ä½¿ç”¨</h1>
<p>æ—©å¹´çš„æ•™ç¨‹å¤§å¤šæ˜¯ä½¿ç”¨<code>winapi</code>è¿™ä¸ªåº“ï¼Œåæ¥å¾®è½¯å®˜æ–¹å‘å¸ƒäº†<code>windows-rs</code>ï¼Œæˆ‘å°±é€‰å®šç”¨å®˜æ–¹çš„åº“æ¥åšã€‚ä¸‹é¢æ˜¯ruståº“çš„ä¸€å†™åŸºç¡€çŸ¥è¯†</p>
<h2 id="features">features</h2>
<p><strong>ä»€ä¹ˆæ˜¯featuresï¼Ÿ</strong></p>
<p>åœ¨å®‰è£…åº“çš„æ—¶å€™å¤§å¤šæ˜¯æ—¶å€™æˆ‘ä»¬éƒ½æ˜¯<code>cargo add &lt;åº“åç§°&gt;</code>å®‰è£…ä¸€æ•´ä¸ªåº“ï¼Œç¼–è¯‘çš„æ—¶å€™ä¹Ÿå°±æ•´ä¸ªåº“å‚ä¸ç¼–è¯‘ï¼Œè€Œ<code>features</code>åˆ™å¯ä»¥è¿›ä¸€æ­¥é€‰æ‹©åº“ä¸­ç‰¹å®šçš„æ¨¡å—ï¼Œæ‰‹åŠ¨åœ¨<code>Cargo.toml</code>æ·»åŠ å³å¯</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span>[dependencies]
</span></span><span style="display:flex;"><span>windows-sys = { version = <span style="color:#cd5555">&#34;0.52.0&#34;</span>, features = [
</span></span><span style="display:flex;"><span>    <span style="color:#cd5555">&#34;Win32_UI_WindowsAndMessaging&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#cd5555">&#34;Win32_System_LibraryLoader&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#cd5555">&#34;Win32_System_Memory&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#cd5555">&#34;Win32_Foundation&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#cd5555">&#34;Win32_System_SystemServices&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#cd5555">&#34;Win32_System_SystemInformation&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#cd5555">&#34;Win32_System_Diagnostics_Debug&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#cd5555">&#34;Win32_Security&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#cd5555">&#34;Win32_System_Threading&#34;</span>,
</span></span><span style="display:flex;"><span>] }
</span></span></code></pre></div><p>æ¯”å¦‚<code>windows-sys</code>å°±æœ‰å¾ˆå¤šä¸ªfeaturesï¼Œä¸åŒçš„apiå¤„äºä¸åŒçš„featureä¸‹ï¼Œéœ€è¦æ·»åŠ åæ‰å¯ä»¥ç¼–è¯‘</p>
<p><strong>æŸ¥çœ‹API/ç»“æ„ä½“å¯¹åº”çš„fearture</strong></p>
<p>è¿™ä¸ªä¸€èˆ¬è¦çœ‹æ–‡æ¡£ï¼Œæˆ‘è¿™é‡Œæœç´¢å¯¹åº”featureæ˜¯ï¼Œwindows-rsåº“æ–‡æ¡£ä¸­ä¸“é—¨æä¾›äº†ä¸€ä¸ªæœç´¢apiå¯¹åº”featureçš„åœ°æ–¹</p>
<p><a href="https://microsoft.github.io/windows-rs/features/#/0.53.0">https://microsoft.github.io/windows-rs/features/#/0.53.0</a></p>
<p><img src="https://raw.githubusercontent.com/Military-axe/imgtable/main/202403211356104.png" alt="image-20240321135612069"></p>
<p><strong>windows &amp; window-sys</strong></p>
<p>windows -rsåº“ä¸‹æœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼Œä¸€ä¸ªæ˜¯windowsï¼Œä¸€ä¸ªæ˜¯windows-sysã€‚åŒºåˆ«æ˜¯sysæ›´åº•å±‚ä¸€äº›ï¼Œwindowså°è£…çš„æ›´å¤šä¸€äº›.</p>
<h2 id="32ä½--64ä½--dll">32ä½ &amp; 64ä½ &amp; DLL</h2>
<p>åœ¨windowsä¸Šç¼–è¯‘32ä½çš„éœ€è¦rustupæ·»åŠ ä¸€ä¸ªäº¤å‰ç¼–è¯‘å¹³å°ã€‚</p>
<p>æŸ¥çœ‹æ‰€æœ‰äº¤å‰ç¼–è¯‘å¹³å°</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>rustup target list
</span></span></code></pre></div><p>æˆ‘æ˜¯64ä½ win11ï¼Œå®‰è£…ä¸€ä¸ª32çš„äº¤å‰ç¼–è¯‘</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>rustup target add i686-pc-windows-msvc
</span></span></code></pre></div><p>ç¼–è¯‘32ä½ç¨‹åº</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cargo build --target=i686-pc-windows-msvc
</span></span></code></pre></div><p>å¦‚æœæŠ¥é”™æ‰¾ä¸åˆ°linkerï¼Œéœ€è¦åœ¨cargo.tomlä¸­é…ç½®ä¸€ä¸‹linkerï¼Œæ ¹æ®è‡ªå·±çš„è·¯å¾„æ¥é…ç½®</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span>[target.i686-pc-windows-msvc]
</span></span><span style="display:flex;"><span>linker = <span style="color:#cd5555">&#34;C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\BuildTools\\VC\\Tools\\MSVC\\14.24.28314\\bin\\Hostx64\\x86\\link.exe&#34;</span>
</span></span></code></pre></div><p>ç„¶åç¼–è¯‘æˆ<strong>dll</strong>åˆ™éœ€è¦åœ¨cargo.tomlä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span>[lib]
</span></span><span style="display:flex;"><span>crate-type = [<span style="color:#cd5555">&#34;cdylib&#34;</span>]
</span></span></code></pre></div><h1 id="iat-hook">IAT hook</h1>
<p>å¯¼å…¥è¡¨hookï¼Œä»€ä¹ˆæ˜¯å¯¼å…¥è¡¨ï¼Ÿå½“PEç¨‹åºè°ƒç”¨dllä¸­çš„å‡½æ•°æ—¶ï¼Œå°±è¦å»è‡ªå·±çš„å¯¼å…¥è¡¨ä¸­æŸ¥æ‰¾dllä¸­å‡½æ•°åœ°å€ï¼Œè¿™ä¸ªIATè¡¨åœ¨ç¨‹åºåˆå§‹åŒ–ä¸­å°±åˆå§‹åŒ–å¥½äº†ã€‚</p>
<p>å¯ä»¥é€šè¿‡CFF exploeræ¥æŸ¥æ‰¾ä½ æƒ³hookçš„å‡½æ•°åœ¨é‚£ä¸ªdllä¸­</p>
<p><img src="https://raw.githubusercontent.com/Military-axe/imgtable/main/202403211549619.png" alt="CFF exploer"></p>
<p>hookçš„æ€è·¯ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯æ›¿æ¢æ‰è¡¨ä¸­çš„å‡½æ•°æŒ‡é’ˆå€¼ï¼Œä¿®æ”¹æˆæˆ‘ä»¬çš„å‡½æ•°åœ°å€</p>
<p><img src="https://raw.githubusercontent.com/Military-axe/imgtable/main/202403211551812.png" alt=""></p>
<p>ç°åœ¨å‡è®¾æˆ‘ä»¬çš„ç›®æ ‡å°±æ˜¯hookä¸€ä¸ªç¨‹åºä¸­çš„<code>MessageBoxA</code>å‡½æ•°</p>
<p><strong>IAT hook å…ˆå†³æ¡ä»¶</strong></p>
<ol>
<li>é¦–å…ˆç›®æ ‡ç¨‹åºéœ€è¦è°ƒç”¨äº†<code>MessageBoxA</code>å‡½æ•°</li>
<li>è¿™ä¸ªç¨‹åºéœ€è¦è°ƒç”¨IATè¡¨ä¸­çš„<code>MessageBoxA</code></li>
</ol>
<p>C++ç‰ˆæœ¬çš„ä»£ç æœ‰å¾ˆå¤šï¼Œå¯ä»¥å‚è€ƒ<a href="https://www.ired.team/offensive-security/code-injection-process-injection/import-adress-table-iat-hooking">Red Team Note</a>çš„ç‰ˆæœ¬</p>
<p>å…³é”®éƒ¨åˆ†æ˜¯å®šä½åˆ°IATè¡¨ç„¶åéå†è¡¨é¡¹ï¼Œå®šä½IATè¡¨éœ€è¦åšä¸€ä¸ªPEå¤´çš„è§£æï¼Œæˆ–è€…è¯´åç§»ï¼Œå…·ä½“å¦‚ä¸‹</p>
<p>é¦–å…ˆé€šè¿‡DOSå¤´çš„<code>e_lfanew</code>ï¼ˆæœ€å4ä¸ªå­—èŠ‚ï¼‰å®šä½åˆ°NTå¤´</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span>image_base<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>GetModuleHandleA(null())<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span><span style="color:#00688b;font-weight:bold">u64</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span>p_dos_header<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>image_base<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span>PimageDosHeader;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span>p_nt_headers<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>(image_base<span style="color:#bbb"> </span>+<span style="color:#bbb"> </span>(*p_dos_header).e_lfanew<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span><span style="color:#00688b;font-weight:bold">u64</span>)<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span>PimageNtHeaders64;<span style="color:#bbb">
</span></span></span></code></pre></div><p>ç„¶åNTå¤´çš„<code>OptionalHeader--&gt;DataDirArray</code>ä¸­ç¬¬2é¡¹å°±æ˜¯å¯¼å…¥è¡¨çš„åç§»ï¼ŒåŒç†å¯ä»¥å¾—åˆ°å…¶ä»–è¡¨ï¼Œå…·ä½“æœ‰å“ªäº›è¡¨å¯ä»¥æŸ¥æ–‡æ¡£ï¼Œä¸‹é¢æ˜¯010editoræˆªå›¾</p>
<p><img src="https://raw.githubusercontent.com/Military-axe/imgtable/main/202403211731982.png" alt=""></p>
<p>ç„¶åéå†å¯¹æ¯”å¯¼å…¥è¡¨ä¸­çš„æ¨¡å—åæ˜¯å¦å’Œç›®æ ‡æ¨¡å—ç›¸åŒï¼Œç›¸åŒåˆ™ç»§ç»­éå†æ¨¡å—ä¸­çš„å‡½æ•°åï¼Œç›´åˆ°åŒ¹é…åˆ°ç›®æ ‡å‡½æ•°ã€‚</p>
<p>åŒ¹é…åˆ°ç›®æ ‡å‡½æ•°ä¹Ÿå°±æ˜¯<code>MessageBoxA</code>åï¼Œä¿®æ”¹æƒé™ï¼Œå†ä¿®æ”¹å‡½æ•°æŒ‡é’ˆï¼Œå†ä¿®æ”¹å›åŸæ¥çš„æƒé™(å…»æˆå¥½ä¹ æƒ¯ï¼Œä¸ç•™ä¸‹çƒ‚æ‘Šå­)</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#228b22">/* ä¿®æ”¹IATè¡¨å±æ€§ä¸ºå¯è¯»å¯å†™å¯æ‰§è¡Œ, ç„¶åä¿®æ”¹å¯¹åº”IATè¡¨é¡¹å€¼ä¸ºhookå‡½æ•° */</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#228b22">/* ç”±äºåªæ˜¯ä¿®æ”¹IATè¡¨ä¸­çš„ä¸€ä¸ªæŒ‡é’ˆï¼Œæ‰€ä»¥å¤§å°ç›´æ¥0x1000ï¼Œä¸ä¼šæœ‰å¤§å°çš„é™åˆ¶ */</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span>old_protection<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span><span style="color:#b452cd">0</span><span style="color:#8b008b;font-weight:bold">u32</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>VirtualProtect(p_func<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span>_,<span style="color:#bbb"> </span><span style="color:#b452cd">0x1000</span>,<span style="color:#bbb"> </span><span style="color:#00688b">PAGE_EXECUTE_READWRITE</span>,<span style="color:#bbb"> </span>&amp;<span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span>old_protection<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span>_);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>*p_func<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>new_func_address;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>VirtualProtect(p_func<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span>_,<span style="color:#bbb"> </span><span style="color:#b452cd">0x1000</span>,<span style="color:#bbb"> </span>old_protection,<span style="color:#bbb"> </span>&amp;<span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span>old_protection<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span>_);<span style="color:#bbb">
</span></span></span></code></pre></div><p>è¿™æ ·å°±å¯ä»¥äº†ï¼Œéœ€è¦è®°å¾—å†å®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„<code>new_func_address</code>ä¹Ÿå°±æ˜¯æˆ‘ä»¬è‡ªå·±hookçš„å‡½æ•°</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">extern</span><span style="color:#bbb"> </span><span style="color:#cd5555">&#34;system&#34;</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">fn</span> <span style="color:#008b45">hook_message_box_a</span>(h_wnd: <span style="color:#008b45;font-weight:bold">HWND</span>,<span style="color:#bbb"> </span>_: <span style="color:#008b45;font-weight:bold">PCSTR</span>,<span style="color:#bbb"> </span>_: <span style="color:#008b45;font-weight:bold">PCSTR</span>,<span style="color:#bbb"> </span>u_type: <span style="color:#00688b;font-weight:bold">u32</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#00688b;font-weight:bold">i32</span> {<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>(*(&amp;<span style="color:#00688b">MESSAGE_BOX_A_HOOK_ADDRESS</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span>*<span style="color:#8b008b;font-weight:bold">const</span><span style="color:#bbb"> </span>_<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span>MessageBoxWHook))(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>h_wnd,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>s!(<span style="color:#cd5555">&#34;Ops hooked by mi1itray.axe!&#34;</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>s!(<span style="color:#cd5555">&#34;Ops hooked by mi1itray.axe!&#34;</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>u_type,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div><p>Rustç‰ˆæœ¬64ä½ä»£ç å¦‚ä¸‹:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">use</span><span style="color:#bbb"> </span>core::ptr::null;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">use</span><span style="color:#bbb"> </span>std::os::raw::c_void;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">use</span><span style="color:#bbb"> </span>windows_sys::{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>core::*,<span style="color:#bbb"> </span>Win32::Foundation::*,<span style="color:#bbb"> </span>Win32::System::Diagnostics::Debug::<span style="color:#00688b">IMAGE_NT_HEADERS64</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>Win32::System::LibraryLoader::*,<span style="color:#bbb"> </span>Win32::System::Memory::*,<span style="color:#bbb"> </span>Win32::System::SystemServices::*,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>Win32::<span style="color:#00688b">UI</span>::WindowsAndMessaging::*,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>};<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#228b22">// å®šä¹‰ä¸€ä¸ªåˆ«å
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span><span style="color:#8b008b;font-weight:bold">type</span> <span style="color:#008b45;font-weight:bold">MessageBoxWHook</span><span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>*<span style="color:#8b008b;font-weight:bold">const</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">extern</span><span style="color:#bbb"> </span><span style="color:#cd5555">&#34;system&#34;</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">fn</span>(<span style="color:#00688b">HWND</span>,<span style="color:#bbb"> </span><span style="color:#00688b">PCSTR</span>,<span style="color:#bbb"> </span><span style="color:#00688b">PCSTR</span>,<span style="color:#bbb"> </span><span style="color:#00688b;font-weight:bold">u32</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#00688b;font-weight:bold">i32</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">type</span> <span style="color:#008b45;font-weight:bold">LPVOID</span><span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>*<span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span>c_void;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">type</span> <span style="color:#008b45;font-weight:bold">PimageNtHeaders64</span><span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>*<span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span><span style="color:#00688b">IMAGE_NT_HEADERS64</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">type</span> <span style="color:#008b45;font-weight:bold">PimageImportDescriptor</span><span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>*<span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span><span style="color:#00688b">IMAGE_IMPORT_DESCRIPTOR</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">type</span> <span style="color:#008b45;font-weight:bold">PimageDosHeader</span><span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>*<span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span><span style="color:#00688b">IMAGE_DOS_HEADER</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#228b22">// ä¿å­˜åŸå‡½æ•°åœ°å€ï¼Œå½“ç„¶è¿™é‡Œå¯ä»¥ç”¨æŒ‡é’ˆå…·ä½“å†™æ³•åé¢å•ç‹¬ä»‹ç»
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span><span style="color:#8b008b;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span><span style="color:#00688b">MESSAGE_BOX_A_HOOK_ADDRESS</span>: <span style="color:#00688b;font-weight:bold">u64</span> =<span style="color:#bbb"> </span><span style="color:#b452cd">0</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#228b22">// ä¸¤ä¸ªè°ƒè¯•çš„æ—¶å€™ä½¿ç”¨çš„å‡½æ•°ï¼Œç”¨äºè¾“å…¥Errorä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span><span style="color:#1e889b">#[allow(dead_code)]</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">fn</span> <span style="color:#008b45">clear_last_error</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>SetLastError(<span style="color:#b452cd">0</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#1e889b">#[allow(dead_code)]</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">fn</span> <span style="color:#008b45">show_last_error</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span>e<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>format!(<span style="color:#cd5555">&#34;</span><span style="color:#cd5555">{:?}</span><span style="color:#cd5555">\0</span><span style="color:#cd5555">&#34;</span>,<span style="color:#bbb"> </span>GetLastError()).as_ptr();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>MessageBoxA(<span style="color:#b452cd">0</span>,<span style="color:#bbb"> </span>e,<span style="color:#bbb"> </span>s!(<span style="color:#cd5555">&#34;Warn&#34;</span>),<span style="color:#bbb"> </span><span style="color:#00688b">MB_OK</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#cd5555">/// `hook_message_box_a`æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„messageboxå‡½æ•°ï¼Œç”¨äºæ›¿æ¢æ‰åŸæ¥çš„`MessageBoxA`å‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">/// æ•ˆæœæ˜¯å¼¹å‡ºä¸€ä¸ªæ¶ˆæ¯æ¡†ï¼Œä¸»ä½“å†…å®¹å’Œæ ‡é¢˜æ å†…å®¹éƒ½æ˜¯**Ops hooked by mi1itray.axe!**
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">///
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">/// # å‚æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">///
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">/// å‚æ•°ä¸åŸæœ¬çš„`MessageBoxA`å‡½æ•°å£°æ˜ç›¸åŒ
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">extern</span><span style="color:#bbb"> </span><span style="color:#cd5555">&#34;system&#34;</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">fn</span> <span style="color:#008b45">hook_message_box_a</span>(h_wnd: <span style="color:#008b45;font-weight:bold">HWND</span>,<span style="color:#bbb"> </span>_: <span style="color:#008b45;font-weight:bold">PCSTR</span>,<span style="color:#bbb"> </span>_: <span style="color:#008b45;font-weight:bold">PCSTR</span>,<span style="color:#bbb"> </span>u_type: <span style="color:#00688b;font-weight:bold">u32</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#00688b;font-weight:bold">i32</span> {<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>(*(&amp;<span style="color:#00688b">MESSAGE_BOX_A_HOOK_ADDRESS</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span>*<span style="color:#8b008b;font-weight:bold">const</span><span style="color:#bbb"> </span>_<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span>MessageBoxWHook))(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>h_wnd,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>s!(<span style="color:#cd5555">&#34;Ops hooked by mi1itray.axe!&#34;</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>s!(<span style="color:#cd5555">&#34;Ops hooked by mi1itray.axe!&#34;</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>u_type,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#cd5555">/// `detour`æ‰§è¡Œhooké€»è¾‘çš„å‡½æ•°ï¼Œå°†æŒ‡å®šæ¨¡å—ä¸­æŒ‡å®šåç§»å€¼çš„å‡½æ•°æŒ‡é’ˆæ›¿æ¢æˆæŒ‡å®šçš„æ–°å‡½æ•°åœ°å€å€¼ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">/// é¦–å…ˆéå†æ¨¡å—åˆ—è¡¨ï¼Œç›´åˆ°å¯¹æ¯”å‡ºç›¸åŒçš„æ¨¡å—åç§°ã€‚ç„¶å
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">///
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">/// # å‚æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">///
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">/// - `module_name`: æŒ‡å‘æ¨¡å—åç§°å†…å­˜çš„æŒ‡é’ˆï¼Œç±»å‹æ˜¯`*const u8`
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">/// - `old_func_offset`: åŸæœ¬å‡½æ•°æŒ‡é’ˆåœ¨æ¨¡å—ä¸ŠIATè¡¨ä¸­çš„åç§»
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">/// - `new_func_address`: æ›¿æ¢çš„å‡½æ•°æŒ‡é’ˆåœ°å€å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">///
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">/// # è¿”å›å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">///
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">/// å¦‚æœhookæˆåŠŸåˆ™è¿”å›åŸå§‹å‡½æ•°çš„åœ°å€ï¼Œå¦‚æœå¤±è´¥åˆ™è¿”å›0
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">///
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">/// # ä¾‹å­
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">///
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">/// ```rust
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">/// detour(&#34;USER32.dll\0&#34;.as_ptr() as _, 0x72AD0, hook_message_box_w as _);
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">/// ```
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">fn</span> <span style="color:#008b45">detour</span>(module_name: *<span style="color:#8b008b;font-weight:bold">const</span><span style="color:#bbb"> </span><span style="color:#00688b;font-weight:bold">u8</span>,<span style="color:#bbb"> </span>old_func_offset: <span style="color:#00688b;font-weight:bold">u64</span>,<span style="color:#bbb"> </span>new_func_address: <span style="color:#00688b;font-weight:bold">u64</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#00688b;font-weight:bold">u64</span> {<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span>module_address<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>GetModuleHandleA(module_name)<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span><span style="color:#00688b;font-weight:bold">u64</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span>old_func_address<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>module_address<span style="color:#bbb"> </span>+<span style="color:#bbb"> </span>old_func_offset;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span>image_base<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>GetModuleHandleA(null())<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span><span style="color:#00688b;font-weight:bold">u64</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span>p_dos_header<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>image_base<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span>PimageDosHeader;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span>p_nt_headers<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>(image_base<span style="color:#bbb"> </span>+<span style="color:#bbb"> </span>(*p_dos_header).e_lfanew<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span><span style="color:#00688b;font-weight:bold">u64</span>)<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span>PimageNtHeaders64;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span>p_import_descriptor<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>(image_base<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>+<span style="color:#bbb"> </span>(*p_nt_headers).OptionalHeader.DataDirectory[<span style="color:#b452cd">1</span>].VirtualAddress<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span><span style="color:#00688b;font-weight:bold">u64</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span>PimageImportDescriptor;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">while</span><span style="color:#bbb"> </span>(*p_import_descriptor).FirstThunk<span style="color:#bbb"> </span>!=<span style="color:#bbb"> </span><span style="color:#b452cd">0</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#228b22">/* å¯¹æ¯”å¯¼å…¥è¡¨é¡¹åç§°ä¸ç›®æ ‡æ˜¯å¦ç¬¦åˆï¼Œä¸ç¬¦åˆåˆ™ç›´æ¥åç§»å¯¼å…¥è¡¨ä¸‹ä¸€é¡¹ */</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#8b008b;font-weight:bold">if</span><span style="color:#bbb"> </span>module_name.eq(&amp;((image_base<span style="color:#bbb"> </span>+<span style="color:#bbb"> </span>(*p_import_descriptor).Name<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span><span style="color:#00688b;font-weight:bold">u64</span>)<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span>*<span style="color:#8b008b;font-weight:bold">const</span><span style="color:#bbb"> </span><span style="color:#00688b;font-weight:bold">u8</span>))<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>p_import_descriptor<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>p_import_descriptor.offset(<span style="color:#b452cd">1</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#8b008b;font-weight:bold">continue</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#228b22">/* åŒ¹é…åˆ°ç›®æ ‡æ¨¡å—, å¼¹å‡ºä¸€ä¸ªæ¶ˆæ¯æ¡† */</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span>module_name<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>(image_base<span style="color:#bbb"> </span>+<span style="color:#bbb"> </span>(*p_import_descriptor).Name<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span><span style="color:#00688b;font-weight:bold">u64</span>)<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span>*<span style="color:#8b008b;font-weight:bold">const</span><span style="color:#bbb"> </span><span style="color:#00688b;font-weight:bold">u8</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>MessageBoxA(<span style="color:#b452cd">0</span>,<span style="color:#bbb"> </span>module_name,<span style="color:#bbb"> </span>s!(<span style="color:#cd5555">&#34;Module name&#34;</span>),<span style="color:#bbb"> </span><span style="color:#00688b">MB_OK</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#228b22">/* éå†å¯¼å…¥è¡¨ */</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span>p_func<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>(image_base<span style="color:#bbb"> </span>+<span style="color:#bbb"> </span>(*p_import_descriptor).FirstThunk<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span><span style="color:#00688b;font-weight:bold">u64</span>)<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span>*<span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span><span style="color:#00688b;font-weight:bold">u64</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#8b008b;font-weight:bold">for</span><span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">in</span><span style="color:#bbb"> </span><span style="color:#b452cd">0</span>..<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#8b008b;font-weight:bold">if</span><span style="color:#bbb"> </span>p_func.is_null()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#8b008b;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#b452cd">0</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#228b22">/* åŒ¹é…åˆ°å¯¼å…¥è¡¨å‡½æ•°ï¼Œå¼¹å‡ºä¸€ä¸ªæ¶ˆæ¯æ¡† */</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span>func_name<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span><span style="color:#00688b">PCSTR</span>::from(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>(image_base<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>+<span style="color:#bbb"> </span>(*((image_base<span style="color:#bbb"> </span>+<span style="color:#bbb"> </span>(*p_import_descriptor).Anonymous.OriginalFirstThunk<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span><span style="color:#00688b;font-weight:bold">u64</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                        </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span>*<span style="color:#8b008b;font-weight:bold">const</span><span style="color:#bbb"> </span><span style="color:#00688b;font-weight:bold">u64</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                        </span>.offset(i))<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>+<span style="color:#bbb"> </span><span style="color:#b452cd">2</span>)<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span>*<span style="color:#8b008b;font-weight:bold">const</span><span style="color:#bbb"> </span><span style="color:#00688b;font-weight:bold">u8</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#8b008b;font-weight:bold">if</span><span style="color:#bbb"> </span>old_func_address<span style="color:#bbb"> </span>==<span style="color:#bbb"> </span>*p_func<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>MessageBoxA(<span style="color:#b452cd">0</span>,<span style="color:#bbb"> </span>func_name,<span style="color:#bbb"> </span>s!(<span style="color:#cd5555">&#34;Find Func&#34;</span>),<span style="color:#bbb"> </span><span style="color:#00688b">MB_OK</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#228b22">/* ä¿®æ”¹IATè¡¨å±æ€§ä¸ºå¯è¯»å¯å†™å¯æ‰§è¡Œ, ç„¶åä¿®æ”¹å¯¹åº”IATè¡¨é¡¹å€¼ä¸ºhookå‡½æ•° */</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#228b22">/* ç”±äºåªæ˜¯ä¿®æ”¹IATè¡¨ä¸­çš„ä¸€ä¸ªæŒ‡é’ˆï¼Œæ‰€ä»¥å¤§å°ç›´æ¥0x1000ï¼Œä¸ä¼šæœ‰å¤§å°çš„é™åˆ¶ */</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span>old_protection<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span><span style="color:#b452cd">0</span><span style="color:#8b008b;font-weight:bold">u32</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>VirtualProtect(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>p_func<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span>_,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span><span style="color:#b452cd">0x1000</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span><span style="color:#00688b">PAGE_EXECUTE_READWRITE</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>&amp;<span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span>old_protection<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span>_,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>*p_func<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>new_func_address;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#228b22">/* ä¿®æ”¹å›åŸæ¥çš„å±æ€§ */</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>VirtualProtect(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>p_func<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span>_,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span><span style="color:#b452cd">0x1000</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>old_protection,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>&amp;<span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span>old_protection<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span>_,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#8b008b;font-weight:bold">return</span><span style="color:#bbb"> </span>old_func_address;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>p_func<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>p_func.offset(<span style="color:#b452cd">1</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#8b008b;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#b452cd">0</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b452cd">0</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#cd5555">/// `init_hook` ä¾‹ç¨‹æ‰§è¡Œå‡½æ•°ï¼Œè°ƒç”¨`detour`å‡½æ•°ï¼ŒIAThookå‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">/// å…¶ä¸­çš„`0x79730`æ˜¯æˆ‘æœ¬æœºä¸Šuser32.dllä¸­åŸºåœ°å€åˆ°MessageBoxAçš„åç§»å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">extern</span><span style="color:#bbb"> </span><span style="color:#cd5555">&#34;system&#34;</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">fn</span> <span style="color:#008b45">init_hook</span>()<span style="color:#bbb"> </span>-&gt; <span style="color:#00688b;font-weight:bold">u32</span> {<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#00688b">MESSAGE_BOX_A_HOOK_ADDRESS</span><span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>detour(s!(<span style="color:#cd5555">&#34;USER32.dll&#34;</span>),<span style="color:#bbb"> </span><span style="color:#b452cd">0x79730</span>,<span style="color:#bbb"> </span>hook_message_box_a<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span>_);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b452cd">0</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#1e889b">#[no_mangle]</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#1e889b">#[allow(non_snake_case)]</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">pub</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">extern</span><span style="color:#bbb"> </span><span style="color:#cd5555">&#34;system&#34;</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">fn</span> <span style="color:#008b45">DllMain</span>(_: <span style="color:#00688b;font-weight:bold">isize</span>,<span style="color:#bbb"> </span>reason: <span style="color:#00688b;font-weight:bold">u32</span>,<span style="color:#bbb"> </span>_: <span style="color:#008b45;font-weight:bold">LPVOID</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#00688b;font-weight:bold">i32</span> {<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">match</span><span style="color:#bbb"> </span>reason<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#00688b">DLL_PROCESS_ATTACH</span><span style="color:#bbb"> </span>=&gt;<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>MessageBoxA(<span style="color:#b452cd">0</span>,<span style="color:#bbb"> </span>s!(<span style="color:#cd5555">&#34;Inject dll success&#34;</span>),<span style="color:#bbb"> </span>s!(<span style="color:#cd5555">&#34;Step 1&#34;</span>),<span style="color:#bbb"> </span><span style="color:#00688b">MB_OK</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>init_hook();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>},<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#00688b">DLL_PROCESS_DETACH</span><span style="color:#bbb"> </span>=&gt;<span style="color:#bbb"> </span>(),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#00688b">DLL_THREAD_ATTACH</span><span style="color:#bbb"> </span>=&gt;<span style="color:#bbb"> </span>(),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#00688b">DLL_THREAD_DETACH</span><span style="color:#bbb"> </span>=&gt;<span style="color:#bbb"> </span>(),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>_<span style="color:#bbb"> </span>=&gt;<span style="color:#bbb"> </span>(),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b452cd">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div><h1 id="inline-hook">Inline hook</h1>
<p>inline hookæ˜¯hookå®Œè¿™ä¸ªå‡½æ•°å</p>
<ul>
<li>
<p>é¦–å…ˆè¦å°†åŸå§‹å‡½æ•°çš„å‚æ•°å€¼éƒ½å­˜å…¥æ ˆä¸­</p>
</li>
<li>
<p>ç„¶åå†è·³è½¬è‡ªå®šä¹‰hookå‡½æ•°</p>
</li>
<li>
<p>æ‰§è¡Œå®Œæˆ‘ä»¬çš„å‡½æ•°åå›åˆ°åŸå§‹å‡½æ•°</p>
</li>
<li>
<p>å†æ¢å¤åŸå§‹å‡½æ•°çš„å‚æ•°ï¼Œè®©åŸå§‹å‡½æ•°ç»§ç»­æ­£å¸¸è¿è¡Œã€‚</p>
</li>
</ul>
<p>ç›®çš„å°±æ˜¯å‡å°å½±å“ã€‚è¿™ç§æ–¹æ³•æ•ˆæœæœ€å¥½ï¼Œåº”ç”¨åœºæ™¯å¹¿ï¼Œæ²¡æœ‰é™åˆ¶ï¼›ä½†æ˜¯éœ€è¦å†™æ±‡ç¼–è¯­å¥æ¥å°†å‚æ•°å­˜å…¥æ ˆä¸­ï¼ŒåŒæ—¶éœ€è¦æ ¹æ®hookå‡½æ•°ç¦»hookä½ç½®æ¥å†³å®šæ˜¯è¦<strong>é•¿è·³è½¬è¿˜æ˜¯çŸ­è·³è½¬</strong>ã€‚</p>
<p>å¥½åœ¨å¯ä»¥ä½¿ç”¨ä¸€äº›hookæ¡†æ¶æ¥é™ä½éš¾åº¦ï¼Œwindowsä¸‹cè¯­è¨€å¾ˆå¤šæ¡†æ¶ï¼Œdetourï¼Œminihookç­‰ï¼Œrusté€‰æ‹©å°±æ¯”è¾ƒå°‘ï¼Œä¹‹å‰æ¯”è¾ƒæœ‰åçš„æ˜¯detourï¼Œä½†æ˜¯ä»¥åŠåœæ­¢ç»´æŠ¤äº†ã€‚æ‰€ä»¥æˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯<a href="https://github.com/Hpmason/retour-rs">retour</a>ï¼Œä¸€ä¸ªdetourçš„forkç»´æŠ¤ç‰ˆæœ¬</p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªå®˜æ–¹çš„ä»£ç ï¼Œæ˜¯hook <code>MessageBoxW</code>çš„</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#cd5555">//! A `MessageBoxW` detour example.
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">//!
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">//! Ensure the crate is compiled as a &#39;cdylib&#39; library to allow C interop.
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span><span style="color:#8b008b;font-weight:bold">use</span><span style="color:#bbb"> </span>retour::static_detour;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">use</span><span style="color:#bbb"> </span>std::error::Error;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">use</span><span style="color:#bbb"> </span>std::ffi::c_int;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">use</span><span style="color:#bbb"> </span>std::os::raw::c_void;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">use</span><span style="color:#bbb"> </span>std::{ffi::CString,<span style="color:#bbb"> </span>iter,<span style="color:#bbb"> </span>mem};<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">use</span><span style="color:#bbb"> </span>windows::core::{<span style="color:#00688b">PCSTR</span>,<span style="color:#bbb"> </span><span style="color:#00688b">PCWSTR</span>};<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">use</span><span style="color:#bbb"> </span>windows::w;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">use</span><span style="color:#bbb"> </span>windows::Win32::Foundation::{<span style="color:#00688b">BOOL</span>,<span style="color:#bbb"> </span><span style="color:#00688b">HANDLE</span>,<span style="color:#bbb"> </span><span style="color:#00688b">HWND</span>};<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">use</span><span style="color:#bbb"> </span>windows::Win32::System::LibraryLoader::{GetModuleHandleW,<span style="color:#bbb"> </span>GetProcAddress};<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">use</span><span style="color:#bbb"> </span>windows::Win32::System::SystemServices::{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#00688b">DLL_PROCESS_ATTACH</span>,<span style="color:#bbb"> </span><span style="color:#00688b">DLL_PROCESS_DETACH</span>,<span style="color:#bbb"> </span><span style="color:#00688b">DLL_THREAD_ATTACH</span>,<span style="color:#bbb"> </span><span style="color:#00688b">DLL_THREAD_DETACH</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>};<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>static_detour!<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#8b008b;font-weight:bold">static</span><span style="color:#bbb"> </span>MessageBoxWHook: <span style="color:#008b45;font-weight:bold">unsafe</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">extern</span><span style="color:#bbb"> </span><span style="color:#cd5555">&#34;system&#34;</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">fn</span>(<span style="color:#00688b">HWND</span>,<span style="color:#bbb"> </span><span style="color:#00688b">PCWSTR</span>,<span style="color:#bbb"> </span><span style="color:#00688b">PCWSTR</span>,<span style="color:#bbb"> </span><span style="color:#00688b;font-weight:bold">u32</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#008b45;font-weight:bold">c_int</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#228b22">// A type alias for `MessageBoxW` (makes the transmute easy on the eyes)
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span><span style="color:#8b008b;font-weight:bold">type</span> <span style="color:#008b45;font-weight:bold">FnMessageBoxW</span><span style="color:#bbb"> </span>=<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">extern</span><span style="color:#bbb"> </span><span style="color:#cd5555">&#34;system&#34;</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">fn</span>(<span style="color:#00688b">HWND</span>,<span style="color:#bbb"> </span><span style="color:#00688b">PCWSTR</span>,<span style="color:#bbb"> </span><span style="color:#00688b">PCWSTR</span>,<span style="color:#bbb"> </span><span style="color:#00688b;font-weight:bold">u32</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#008b45;font-weight:bold">c_int</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#cd5555">/// Called when the DLL is attached to the process.
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">fn</span> <span style="color:#008b45">main</span>()<span style="color:#bbb"> </span>-&gt; <span style="color:#658b00">Result</span>&lt;(),<span style="color:#bbb"> </span><span style="color:#658b00">Box</span>&lt;<span style="color:#8b008b;font-weight:bold">dyn</span><span style="color:#bbb"> </span>Error&gt;&gt;<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#228b22">// Retrieve an absolute address of `MessageBoxW`. This is required for
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span><span style="color:#bbb">    </span><span style="color:#228b22">// libraries due to the import address table. If `MessageBoxW` would be
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span><span style="color:#bbb">    </span><span style="color:#228b22">// provided directly as the target, it would only hook this DLL&#39;s
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span><span style="color:#bbb">    </span><span style="color:#228b22">// `MessageBoxW`. Using the method below an absolute address is retrieved
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span><span style="color:#bbb">    </span><span style="color:#228b22">// instead, detouring all invocations of `MessageBoxW` in the active process.
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span>address<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>get_module_symbol_address(<span style="color:#cd5555">&#34;user32.dll&#34;</span>,<span style="color:#bbb"> </span><span style="color:#cd5555">&#34;MessageBoxW&#34;</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>.expect(<span style="color:#cd5555">&#34;could not find &#39;MessageBoxW&#39; address&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span>target: <span style="color:#008b45;font-weight:bold">FnMessageBoxW</span><span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>mem::transmute(address);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#228b22">// Initialize AND enable the detour (the 2nd parameter can also be a closure)
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span><span style="color:#bbb">    </span>MessageBoxWHook<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>.initialize(target,<span style="color:#bbb"> </span>messageboxw_detour)?<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>.enable()?;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#658b00">Ok</span>(())<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#cd5555">/// Called whenever `MessageBoxW` is invoked in the process.
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span><span style="color:#8b008b;font-weight:bold">fn</span> <span style="color:#008b45">messageboxw_detour</span>(hwnd: <span style="color:#008b45;font-weight:bold">HWND</span>,<span style="color:#bbb"> </span>text: <span style="color:#008b45;font-weight:bold">PCWSTR</span>,<span style="color:#bbb"> </span>_caption: <span style="color:#008b45;font-weight:bold">PCWSTR</span>,<span style="color:#bbb"> </span>msgbox_style: <span style="color:#00688b;font-weight:bold">u32</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#008b45;font-weight:bold">c_int</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#228b22">// Call the original `MessageBoxW`, but replace the caption
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span>replaced_caption<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>w!(<span style="color:#cd5555">&#34;Detoured!&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span>{<span style="color:#bbb"> </span>MessageBoxWHook.call(hwnd,<span style="color:#bbb"> </span>text,<span style="color:#bbb"> </span>replaced_caption,<span style="color:#bbb"> </span>msgbox_style)<span style="color:#bbb"> </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#cd5555">/// Returns a module symbol&#39;s absolute address.
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span><span style="color:#8b008b;font-weight:bold">fn</span> <span style="color:#008b45">get_module_symbol_address</span>(module: <span style="color:#8b008b;font-weight:bold">&amp;</span><span style="color:#00688b;font-weight:bold">str</span>,<span style="color:#bbb"> </span>symbol: <span style="color:#8b008b;font-weight:bold">&amp;</span><span style="color:#00688b;font-weight:bold">str</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#658b00">Option</span>&lt;<span style="color:#00688b;font-weight:bold">usize</span>&gt;<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span>module<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>module<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>.encode_utf16()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>.chain(iter::once(<span style="color:#b452cd">0</span>))<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>.collect::&lt;<span style="color:#658b00">Vec</span>&lt;<span style="color:#00688b;font-weight:bold">u16</span>&gt;&gt;();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span>symbol<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>CString::new(symbol).unwrap();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span>handle<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>GetModuleHandleW(<span style="color:#00688b">PCWSTR</span>(module.as_ptr()<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span>_)).unwrap();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#8b008b;font-weight:bold">match</span><span style="color:#bbb"> </span>GetProcAddress(handle,<span style="color:#bbb"> </span><span style="color:#00688b">PCSTR</span>(symbol.as_ptr()<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span>_))<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#658b00">Some</span>(func)<span style="color:#bbb"> </span>=&gt;<span style="color:#bbb"> </span><span style="color:#658b00">Some</span>(func<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span><span style="color:#00688b;font-weight:bold">usize</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#658b00">None</span><span style="color:#bbb"> </span>=&gt;<span style="color:#bbb"> </span><span style="color:#658b00">None</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#1e889b">#[no_mangle]</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">extern</span><span style="color:#bbb"> </span><span style="color:#cd5555">&#34;system&#34;</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">fn</span> <span style="color:#008b45">DllMain</span>(_hinst: <span style="color:#008b45;font-weight:bold">HANDLE</span>,<span style="color:#bbb"> </span>reason: <span style="color:#00688b;font-weight:bold">u32</span>,<span style="color:#bbb"> </span>_reserved: *<span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span>c_void)<span style="color:#bbb"> </span>-&gt; <span style="color:#008b45;font-weight:bold">BOOL</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">match</span><span style="color:#bbb"> </span>reason<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#00688b">DLL_PROCESS_ATTACH</span><span style="color:#bbb"> </span>=&gt;<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>println!(<span style="color:#cd5555">&#34;attaching&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span>{<span style="color:#bbb"> </span>main().unwrap()<span style="color:#bbb"> </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#00688b">DLL_PROCESS_DETACH</span><span style="color:#bbb"> </span>=&gt;<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>println!(<span style="color:#cd5555">&#34;detaching&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#00688b">DLL_THREAD_ATTACH</span><span style="color:#bbb"> </span>=&gt;<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#00688b">DLL_THREAD_DETACH</span><span style="color:#bbb"> </span>=&gt;<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>_<span style="color:#bbb"> </span>=&gt;<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>};<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#00688b">BOOL</span>::from(<span style="color:#8b008b;font-weight:bold">true</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div><p>çœ‹å®Œæˆ‘åªèƒ½è¯´ï¼Œä¼˜é›…ï¼Œå¤ªä¼˜é›…äº†ï¼å®›å¦‚æ±‰å°¼æ‹”åšäººä¸€æ ·çš„ä¼˜é›…ã€‚</p>
<h1 id="vmt-hook">VMT hook</h1>
<p>è™šè¡¨hookï¼Œåœ¨c++ä¸­ï¼Œä¸€ä¸ªç±»å¦‚æœä½¿ç”¨åˆ°äº†è™šå‡½æ•°ï¼Œå°±ä¼šæœ‰è™šè¡¨ã€‚è¿™ä¸ªè™šè¡¨åªå±äºè¿™ä¸ªç±»ï¼Œè¿™ä¸ªç±»çš„å¯¹è±¡éƒ½æœ‰æŒ‡å‘è¿™ä¸ªè™šè¡¨çš„æŒ‡é’ˆ</p>
<pre tabindex="0"><code class="language-mermaid" data-lang="mermaid">graph LR

	A(ç±»Açš„å¯¹è±¡1) --&gt; B(ç±»Aè™šè¡¨)
	C(ç±»Açš„å¯¹è±¡2) --&gt; B
	B --&gt; D(ç±»Açš„è™šå‡½æ•°)
</code></pre><p>å…ˆå†™ä¸€ä¸ªç®€å•çš„ä¾‹å­</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#1e889b">#include</span> <span style="color:#1e889b">&lt;iostream&gt;</span><span style="color:#1e889b">
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b"></span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">using</span> <span style="color:#8b008b;font-weight:bold">namespace</span> std;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">class</span> <span style="color:#008b45;font-weight:bold">Base</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">public</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">virtual</span> <span style="color:#00688b;font-weight:bold">void</span> func1() { cout &lt;&lt; <span style="color:#cd5555">&#34;func1()&#34;</span> &lt;&lt; endl; }
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">virtual</span> <span style="color:#00688b;font-weight:bold">void</span> <span style="color:#008b45">func2</span>() { cout &lt;&lt; <span style="color:#cd5555">&#34;func2()&#34;</span> &lt;&lt; endl; }
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">virtual</span> <span style="color:#00688b;font-weight:bold">void</span> <span style="color:#008b45">func3</span>() { cout &lt;&lt; <span style="color:#cd5555">&#34;func3()&#34;</span> &lt;&lt; endl; }
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00688b;font-weight:bold">int</span> <span style="color:#008b45">main</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    Base t;
</span></span><span style="display:flex;"><span>    (((<span style="color:#00688b;font-weight:bold">void</span> (*)()) * ((<span style="color:#00688b;font-weight:bold">int</span>*)(*((<span style="color:#00688b;font-weight:bold">int</span>*)&amp;t)) + <span style="color:#b452cd">0</span>)))();
</span></span><span style="display:flex;"><span>    (((<span style="color:#00688b;font-weight:bold">void</span> (*)()) * ((<span style="color:#00688b;font-weight:bold">int</span>*)(*((<span style="color:#00688b;font-weight:bold">int</span>*)&amp;t)) + <span style="color:#b452cd">1</span>)))();
</span></span><span style="display:flex;"><span>    (((<span style="color:#00688b;font-weight:bold">void</span> (*)()) * ((<span style="color:#00688b;font-weight:bold">int</span>*)(*((<span style="color:#00688b;font-weight:bold">int</span>*)&amp;t)) + <span style="color:#b452cd">2</span>)))();
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#b452cd">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>è¿è¡Œåå¯ä»¥çœ‹åˆ°</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span> â¯â¯ mi1it â¯â¯ .<span style="color:#cd5555">\v</span>mt.exe
</span></span><span style="display:flex;"><span>func1()
</span></span><span style="display:flex;"><span>func2()
</span></span><span style="display:flex;"><span>func3()
</span></span></code></pre></div><p>g++ç¼–è¯‘æˆx86æ¶æ„çš„ï¼Œä½¿ç”¨idaæ‰“å¼€åˆ†æä¸€ä¸‹</p>
<pre tabindex="0"><code class="language-assembly" data-lang="assembly">.rdata:004052A8 ; public Base
.rdata:004052A8                 public __ZTI4Base
.rdata:004052A8 ; `typeinfo for&#39;Base
.rdata:004052A8 __ZTI4Base      dd offset __imp___ZTVN10__cxxabiv117__class_type_infoE+8
.rdata:004052A8                                         ; DATA XREF: .rdata:004052BCâ†“o
.rdata:004052A8                                         ; reference to RTTI&#39;s type class
.rdata:004052AC                 dd offset __ZTS4Base    ; reference to type&#39;s name
.rdata:004052B0                 public __ZTS4Base
.rdata:004052B0 ; `typeinfo name for&#39;Base
.rdata:004052B0 __ZTS4Base      db &#39;4Base&#39;,0            ; DATA XREF: .rdata:004052ACâ†‘o
.rdata:004052B0                                         ; type descriptor name
.rdata:004052B6                 align 4
.rdata:004052B8                 public __ZTV4Base
.rdata:004052B8 ; `vtable for&#39;Base
.rdata:004052B8 __ZTV4Base      dd 0                    ; offset to this
.rdata:004052BC                 dd offset __ZTI4Base    ; `typeinfo for&#39;Base
.rdata:004052C0 virtual         dd offset __ZN4Base5func1Ev
.rdata:004052C0                                         ; DATA XREF: _main+Eâ†‘o
.rdata:004052C0                                         ; Base::func1(void)
.rdata:004052C4                 dd offset __ZN4Base5func2Ev ; Base::func2(void)
.rdata:004052C8                 dd offset __ZN4Base5func3Ev ; Base::func3(void)
</code></pre><p>å¯ä»¥çœ‹åˆ°ä¸€ä¸ªBaseç±»çš„ç»“æ„ï¼Œåœ¨thisæŒ‡é’ˆåç§»2çš„ä½ç½®å°±æ˜¯è™šè¡¨ï¼Œåˆ†åˆ«æŒ‡å‘3ä¸ªè™šå‡½æ•°ã€‚ä½†æ˜¯è¿™æ˜¯ç±»çš„ç»“æ„ï¼Œä¸æ˜¯å¯¹è±¡çš„ç»“æ„ã€‚ä¸€ä¸ªå®ä¾‹å¯¹è±¡çš„åœ°å€æŒ‡å‘çš„å°±æ˜¯è™šè¡¨ï¼Œæ‰€ä»¥ä»£ç ä¸­å®ä¾‹tç›´æ¥é€šè¿‡åç§»å¯ä»¥å¾—åˆ°å‡½æ•°åœ°å€ã€‚</p>
<p>å¦‚æœæˆ‘ä¿®æ”¹VMTä¸­çš„ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œå½“è¿™ä¸ªè¿™ä¸ªå‡½æ•°è¢«è°ƒç”¨çš„æ—¶å€™å°±è¾¾åˆ°äº†hookçš„æ•ˆæœã€‚åŸºäºè¿™ç§è™šè¡¨ï¼Œå¯ä»¥ä¿®æ”¹è¡¨çš„å†…å®¹ï¼Œå°±åƒIAT hookï¼Œæˆ–è€…ç›´æ¥hookè™šå‡½æ•°æœ¬èº«ï¼Œå°±ç±»ä¼¼inline hookçš„ã€‚</p>
<p>åŸºäºretourå†™ä¸€ä¸ªç±»ä¼¼inlinr hookçš„å°±å¯ä»¥</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">use</span><span style="color:#bbb"> </span>std::ptr::null;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">use</span><span style="color:#bbb"> </span>std::error::Error;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">use</span><span style="color:#bbb"> </span>std::mem;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">use</span><span style="color:#bbb"> </span>windows_sys::Win32::System::LibraryLoader::*;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">use</span><span style="color:#bbb"> </span>windows_sys::Win32::Foundation::{<span style="color:#00688b">BOOL</span>,<span style="color:#bbb"> </span><span style="color:#00688b">HANDLE</span>};<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">use</span><span style="color:#bbb"> </span>std::os::raw::c_void;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">use</span><span style="color:#bbb"> </span>retour::static_detour;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">use</span><span style="color:#bbb"> </span>windows_sys::Win32::System::SystemServices::{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#00688b">DLL_PROCESS_ATTACH</span>,<span style="color:#bbb"> </span><span style="color:#00688b">DLL_PROCESS_DETACH</span>,<span style="color:#bbb"> </span><span style="color:#00688b">DLL_THREAD_ATTACH</span>,<span style="color:#bbb"> </span><span style="color:#00688b">DLL_THREAD_DETACH</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>};<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>static_detour!<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">static</span><span style="color:#bbb"> </span>HookIt: <span style="color:#008b45;font-weight:bold">fn</span>();<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">type</span> <span style="color:#008b45;font-weight:bold">BaseF1</span><span style="color:#bbb"> </span>=<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">fn</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">fn</span> <span style="color:#008b45">get_func_address</span>(offset: <span style="color:#00688b;font-weight:bold">usize</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#008b45;font-weight:bold">BaseF1</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span>handle<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span>{<span style="color:#bbb"> </span>GetModuleHandleA(null())<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span><span style="color:#00688b;font-weight:bold">usize</span><span style="color:#bbb"> </span>};<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span>{<span style="color:#bbb"> </span>mem::transmute::&lt;<span style="color:#00688b;font-weight:bold">usize</span>,<span style="color:#bbb"> </span>BaseF1&gt;(<span style="color:#bbb"> </span>offset<span style="color:#bbb"> </span>+<span style="color:#bbb"> </span>handle)<span style="color:#bbb"> </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">fn</span> <span style="color:#008b45">detour</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>println!(<span style="color:#cd5555">&#34;Ops hook it by mi1itray.axe&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">fn</span> <span style="color:#008b45">main</span>()<span style="color:#bbb"> </span>-&gt; <span style="color:#658b00">Result</span>&lt;(),<span style="color:#bbb"> </span><span style="color:#658b00">Box</span>&lt;<span style="color:#8b008b;font-weight:bold">dyn</span><span style="color:#bbb"> </span>Error&gt;&gt;{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span>func_1<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>get_func_address(<span style="color:#b452cd">0x52c4</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span>{<span style="color:#bbb"> </span>HookIt.initialize(func_1,<span style="color:#bbb"> </span>detour)?.enable()<span style="color:#bbb"> </span>}?;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#658b00">Ok</span>(())<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#1e889b">#[no_mangle]</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">extern</span><span style="color:#bbb"> </span><span style="color:#cd5555">&#34;system&#34;</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">fn</span> <span style="color:#008b45">DllMain</span>(_hinst: <span style="color:#008b45;font-weight:bold">HANDLE</span>,<span style="color:#bbb"> </span>reason: <span style="color:#00688b;font-weight:bold">u32</span>,<span style="color:#bbb"> </span>_reserved: *<span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span>c_void)<span style="color:#bbb"> </span>-&gt; <span style="color:#008b45;font-weight:bold">BOOL</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">match</span><span style="color:#bbb"> </span>reason<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#00688b">DLL_PROCESS_ATTACH</span><span style="color:#bbb"> </span>=&gt;<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>println!(<span style="color:#cd5555">&#34;attaching&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span>{<span style="color:#bbb"> </span>main().unwrap()<span style="color:#bbb"> </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#00688b">DLL_PROCESS_DETACH</span><span style="color:#bbb"> </span>=&gt;<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>println!(<span style="color:#cd5555">&#34;detaching&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#00688b">DLL_THREAD_ATTACH</span><span style="color:#bbb"> </span>=&gt;<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#00688b">DLL_THREAD_DETACH</span><span style="color:#bbb"> </span>=&gt;<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>_<span style="color:#bbb"> </span>=&gt;<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>};<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#00688b">BOOL</span>::from(<span style="color:#8b008b;font-weight:bold">true</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div><h1 id="å‚è€ƒ">å‚è€ƒ</h1>
<p><a href="https://blog.csdn.net/kunyus/article/details/108884016">ä½¿ç”¨Rustç¼–å†™ Windows dll å¹¶æ³¨å…¥è¿›ç¬¬ä¸‰æ–¹è¿›ç¨‹åå¯¹ Windows API MessageBoxW è¿›è¡Œ Hook | CSDN</a></p>
<p><a href="https://microsoft.github.io/windows-docs-rs/doc/windows/index.html">windows-rs crate doc | microsoft.github.io</a></p>
<p><a href="https://blog.csdn.net/weixin_43695321/article/details/132241468">rust x84 windowsç¼–è¯‘æŠ¥é”™ | CSDN</a></p>
<p><a href="https://www.ired.team/offensive-security/code-injection-process-injection/import-adress-table-iat-hooking">Red Team note | ired.team</a></p>
<p><a href="https://github.com/Hpmason/retour-rs">retour-rs | github.com</a></p>
<p><a href="https://www.cnblogs.com/Mered1th/p/10924545.html">æ·±å…¥ç†è§£C++è™šå‡½æ•°è¡¨ | cnblogs.com</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/75172640">C++ è™šå‡½æ•°è¡¨å‰–æ | çŸ¥ä¹</a></p>
                    
                    <HR width="100%" id="EOF">
		    <p style="color:#777;">Last modified on 2024-03-22</p>
                    
                </div>
            </div>
            
            
            <nav class="post-pagination">

                
                <a class="newer-posts" href="/post/%E5%8F%A5%E6%9F%84%E9%99%8D%E6%9D%83%E7%BB%95%E8%BF%87callbacks%E6%A3%80%E6%9F%A5/">
			Next<br>å¥æŸ„é™æƒç»•è¿‡CallBacksæ£€æŸ¥
                </a>
                
                
                
                <a class="older-posts" href="/post/%E5%88%A9%E7%94%A8peb%E9%81%8D%E5%8E%86%E6%A8%A1%E5%9D%97%E9%93%BE%E8%A1%A8/">
			Previous<br>åˆ©ç”¨PEBéå†æ¨¡å—é“¾è¡¨
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                












<script src="https://giscus.app/client.js"
        data-repo="username/repo"
        data-repo-id="**************************"
        data-category="General"
        data-category-id="*********************"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="preferred_color_scheme"
        data-lang="en"
        crossorigin="anonymous"
        async>
</script>

            </div>
        </div>
    </div>


                    </div>
            </div><div id="sideContainer" class="side-container">
    
    <a class="a-block nav-head false" href="https://military-axe.github.io/">
    
        <div class="nav-title">
            Mi1itray.axe
        </div>
        
        <div class="nav-subtitle">
            mi1itray.axe@gmail.com
        </div>
        
    </a>

    <div class="nav-link-list">
        
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/posts">
                Archive
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/categories">
                Categories
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/tags">
                Tags
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/index.xml">
                RSS Feed
            </a>
            
        
    </div>

    

    <div class="nav-footer">
        
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://risehere.net/">Rise</a>
<br>
Ported from <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	mi1itray.axe copyright.
	

    </div>
    
</div><div id="extraContainer" class="extra-container">
    <div class="toc-wrapper">
        

        
        <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#rust-windows-rs-%e5%ba%93%e4%bd%bf%e7%94%a8" class="nav-rust-windows-rs-åº“ä½¿ç”¨">
									Rust windows-rs åº“ä½¿ç”¨
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#features" class="nav-features">
									features
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#32%e4%bd%8d--64%e4%bd%8d--dll" class="nav-32ä½--64ä½--dll">
									32ä½ &amp; 64ä½ &amp; DLL
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#iat-hook" class="nav-iat-hook">
									IAT hook
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#inline-hook" class="nav-inline-hook">
									Inline hook
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#vmt-hook" class="nav-vmt-hook">
									VMT hook
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%8f%82%e8%80%83" class="nav-å‚è€ƒ">
									å‚è€ƒ
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
        
    </div>
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top"
            :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
        <a type="button" class="pagination-action" id="darkModeToggleButton">
            <span class="material-icons pagination-action-icon" id="darkModeToggleIcon">
                dark_mode
            </span>
        </a>
        
        
    </div>
</div>

<div id="single-column-footer">
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://risehere.net/">Rise</a>
<br>
Ported from <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	mi1itray.axe copyright.
	
</div>
            </div>
    
    <script src="/js/journal.js"></script></body>
</html>
