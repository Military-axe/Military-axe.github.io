<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1">

  
      <link href="/css/fonts.css" rel="stylesheet" type="text/css">
    
  <title>Rustç¼–å†™å‡ ç§hookçš„æ–¹å¼</title><link rel="stylesheet" href="/css/hugo-octopress.css">

  
    <link rel="stylesheet" href="/css/fork-awesome.min.css">
  
    <link href="https://military-axe.github.io/favicon.png" rel="icon">
  

  <meta name="description" content="" />
  <meta name="keywords" content="">
  <meta name="author" content="Mi1itray.axe"><meta name="generator" content="Hugo 0.153.2">

</head>
<body><header role="banner"><hgroup><h1><a href="https://military-axe.github.io/">Mi1itray.axe</a></h1>
    <h2>mi1itray.axe@gmail.com</h2>
</hgroup></header><nav role="navigation"><fieldset class="mobile-nav"><select onchange="location = this.value;">
    <option value="">Navigateâ€¦</option>
      
        <option value="https://military-axe.github.io/">Â» Blog</option>
      
        <option value="https://military-axe.github.io/categories">Â» Categories</option>
      
        <option value="https://military-axe.github.io/tags">Â» Tags</option>
      
  </select>
</fieldset><ul class="main-navigation">
    
      <li><a href="https://military-axe.github.io/" title="Blog">Blog</a></li>
    
  
    
      <li><a href="https://military-axe.github.io/categories" title="Categories"  target="_blank"  rel="noopener noreferrer">Categories</a></li>
    
  
    
      <li><a href="https://military-axe.github.io/tags" title="Tags"  target="_blank"  rel="noopener noreferrer">Tags</a></li>
    
  
</ul>

<ul class="subscription">
  
    
        <a href="https://military-axe.github.io/index.xml" target="_blank" type="application/rss+xml" title="RSS" rel="noopener noreferrer"><i class="fa fa-rss-square fa-lg"></i></a>
    
  
</ul>


  <form action="https://www.google.com/search" method="get" target="_blank" rel="noopener noreferrer">
    <fieldset role="search">
      <input class="search" type="text" name="q" results="0" placeholder="Search"/>
      <input type="hidden" name="q" value="site:https://military-axe.github.io/" />
    </fieldset>
  </form>

</nav>


<div id="main">
  <div id="content">
    <div>
      <article class="hentry" role="article">

        
        <header>
  <p class="meta">Mar 22, 2024
     - 7 minute read - <a class="label" href="https://military-axe.github.io/categories/reverse/">Reverse </a>
    
  </p>
  <h1 class="entry-title">
     Rustç¼–å†™å‡ ç§hookçš„æ–¹å¼ 
  </h1>
</header>


        <div class="entry-content">
          
            <nav id="TableOfContents">
  <ul>
    <li><a href="#rust-windows-rs-åº“ä½¿ç”¨">Rust windows-rs åº“ä½¿ç”¨</a>
      <ul>
        <li><a href="#features">features</a></li>
        <li><a href="#32ä½--64ä½--dll">32ä½ &amp; 64ä½ &amp; DLL</a></li>
      </ul>
    </li>
    <li><a href="#iat-hook">IAT hook</a></li>
    <li><a href="#inline-hook">Inline hook</a></li>
    <li><a href="#vmt-hook">VMT hook</a></li>
    <li><a href="#å‚è€ƒ">å‚è€ƒ</a></li>
  </ul>
</nav>
          
          <p>ä½¿ç”¨Rustç¼–å†™å‡ ç§åœ¨windowsä¸Šå¸¸ç”¨çš„hookæ–¹å¼:</p>
<ul>
<li>IAT hook</li>
<li>Inline hook</li>
<li>VMT hook</li>
</ul>
<p>ä¸ºä»€ä¹ˆè¦ç”¨rustçš„ä¸ç”¨c++ï¼Ÿå°±æ˜¯æƒ³ç”¨ï¼Œæƒ³ç»™è‡ªå·±æ‰¾éº»çƒ¦ğŸ˜</p>
<h1 id="rust-windows-rs-åº“ä½¿ç”¨">Rust windows-rs åº“ä½¿ç”¨</h1>
<p>æ—©å¹´çš„æ•™ç¨‹å¤§å¤šæ˜¯ä½¿ç”¨<code>winapi</code>è¿™ä¸ªåº“ï¼Œåæ¥å¾®è½¯å®˜æ–¹å‘å¸ƒäº†<code>windows-rs</code>ï¼Œæˆ‘å°±é€‰å®šç”¨å®˜æ–¹çš„åº“æ¥åšã€‚ä¸‹é¢æ˜¯ruståº“çš„ä¸€å†™åŸºç¡€çŸ¥è¯†</p>
<h2 id="features">features</h2>
<p><strong>ä»€ä¹ˆæ˜¯featuresï¼Ÿ</strong></p>
<p>åœ¨å®‰è£…åº“çš„æ—¶å€™å¤§å¤šæ˜¯æ—¶å€™æˆ‘ä»¬éƒ½æ˜¯<code>cargo add &lt;åº“åç§°&gt;</code>å®‰è£…ä¸€æ•´ä¸ªåº“ï¼Œç¼–è¯‘çš„æ—¶å€™ä¹Ÿå°±æ•´ä¸ªåº“å‚ä¸ç¼–è¯‘ï¼Œè€Œ<code>features</code>åˆ™å¯ä»¥è¿›ä¸€æ­¥é€‰æ‹©åº“ä¸­ç‰¹å®šçš„æ¨¡å—ï¼Œæ‰‹åŠ¨åœ¨<code>Cargo.toml</code>æ·»åŠ å³å¯</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span>[dependencies]
</span></span><span style="display:flex;"><span>windows-sys = { version = <span style="color:#2aa198">&#34;0.52.0&#34;</span>, features = [
</span></span><span style="display:flex;"><span>    <span style="color:#2aa198">&#34;Win32_UI_WindowsAndMessaging&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#2aa198">&#34;Win32_System_LibraryLoader&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#2aa198">&#34;Win32_System_Memory&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#2aa198">&#34;Win32_Foundation&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#2aa198">&#34;Win32_System_SystemServices&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#2aa198">&#34;Win32_System_SystemInformation&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#2aa198">&#34;Win32_System_Diagnostics_Debug&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#2aa198">&#34;Win32_Security&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#2aa198">&#34;Win32_System_Threading&#34;</span>,
</span></span><span style="display:flex;"><span>] }
</span></span></code></pre></div><p>æ¯”å¦‚<code>windows-sys</code>å°±æœ‰å¾ˆå¤šä¸ªfeaturesï¼Œä¸åŒçš„apiå¤„äºä¸åŒçš„featureä¸‹ï¼Œéœ€è¦æ·»åŠ åæ‰å¯ä»¥ç¼–è¯‘</p>
<p><strong>æŸ¥çœ‹API/ç»“æ„ä½“å¯¹åº”çš„fearture</strong></p>
<p>è¿™ä¸ªä¸€èˆ¬è¦çœ‹æ–‡æ¡£ï¼Œæˆ‘è¿™é‡Œæœç´¢å¯¹åº”featureæ˜¯ï¼Œwindows-rsåº“æ–‡æ¡£ä¸­ä¸“é—¨æä¾›äº†ä¸€ä¸ªæœç´¢apiå¯¹åº”featureçš„åœ°æ–¹</p>
<p>
<a href="https://microsoft.github.io/windows-rs/features/#/0.53.0" target="_blank" rel="noopener">https://microsoft.github.io/windows-rs/features/#/0.53.0</a></p>
<p><img src="https://raw.githubusercontent.com/Military-axe/imgtable/main/202403211356104.png" alt="image-20240321135612069"></p>
<p><strong>windows &amp; window-sys</strong></p>
<p>windows -rsåº“ä¸‹æœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼Œä¸€ä¸ªæ˜¯windowsï¼Œä¸€ä¸ªæ˜¯windows-sysã€‚åŒºåˆ«æ˜¯sysæ›´åº•å±‚ä¸€äº›ï¼Œwindowså°è£…çš„æ›´å¤šä¸€äº›.</p>
<h2 id="32ä½--64ä½--dll">32ä½ &amp; 64ä½ &amp; DLL</h2>
<p>åœ¨windowsä¸Šç¼–è¯‘32ä½çš„éœ€è¦rustupæ·»åŠ ä¸€ä¸ªäº¤å‰ç¼–è¯‘å¹³å°ã€‚</p>
<p>æŸ¥çœ‹æ‰€æœ‰äº¤å‰ç¼–è¯‘å¹³å°</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>rustup target list
</span></span></code></pre></div><p>æˆ‘æ˜¯64ä½ win11ï¼Œå®‰è£…ä¸€ä¸ª32çš„äº¤å‰ç¼–è¯‘</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>rustup target add i686-pc-windows-msvc
</span></span></code></pre></div><p>ç¼–è¯‘32ä½ç¨‹åº</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cargo build --target<span style="color:#719e07">=</span>i686-pc-windows-msvc
</span></span></code></pre></div><p>å¦‚æœæŠ¥é”™æ‰¾ä¸åˆ°linkerï¼Œéœ€è¦åœ¨cargo.tomlä¸­é…ç½®ä¸€ä¸‹linkerï¼Œæ ¹æ®è‡ªå·±çš„è·¯å¾„æ¥é…ç½®</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span>[target.i686-pc-windows-msvc]
</span></span><span style="display:flex;"><span>linker = <span style="color:#2aa198">&#34;C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\BuildTools\\VC\\Tools\\MSVC\\14.24.28314\\bin\\Hostx64\\x86\\link.exe&#34;</span>
</span></span></code></pre></div><p>ç„¶åç¼–è¯‘æˆ<strong>dll</strong>åˆ™éœ€è¦åœ¨cargo.tomlä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span>[lib]
</span></span><span style="display:flex;"><span>crate-type = [<span style="color:#2aa198">&#34;cdylib&#34;</span>]
</span></span></code></pre></div><h1 id="iat-hook">IAT hook</h1>
<p>å¯¼å…¥è¡¨hookï¼Œä»€ä¹ˆæ˜¯å¯¼å…¥è¡¨ï¼Ÿå½“PEç¨‹åºè°ƒç”¨dllä¸­çš„å‡½æ•°æ—¶ï¼Œå°±è¦å»è‡ªå·±çš„å¯¼å…¥è¡¨ä¸­æŸ¥æ‰¾dllä¸­å‡½æ•°åœ°å€ï¼Œè¿™ä¸ªIATè¡¨åœ¨ç¨‹åºåˆå§‹åŒ–ä¸­å°±åˆå§‹åŒ–å¥½äº†ã€‚</p>
<p>å¯ä»¥é€šè¿‡CFF exploeræ¥æŸ¥æ‰¾ä½ æƒ³hookçš„å‡½æ•°åœ¨é‚£ä¸ªdllä¸­</p>
<p><img src="https://raw.githubusercontent.com/Military-axe/imgtable/main/202403211549619.png" alt="CFF exploer"></p>
<p>hookçš„æ€è·¯ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯æ›¿æ¢æ‰è¡¨ä¸­çš„å‡½æ•°æŒ‡é’ˆå€¼ï¼Œä¿®æ”¹æˆæˆ‘ä»¬çš„å‡½æ•°åœ°å€</p>
<p><img src="https://raw.githubusercontent.com/Military-axe/imgtable/main/202403211551812.png" alt=""></p>
<p>ç°åœ¨å‡è®¾æˆ‘ä»¬çš„ç›®æ ‡å°±æ˜¯hookä¸€ä¸ªç¨‹åºä¸­çš„<code>MessageBoxA</code>å‡½æ•°</p>
<p><strong>IAT hook å…ˆå†³æ¡ä»¶</strong></p>
<ol>
<li>é¦–å…ˆç›®æ ‡ç¨‹åºéœ€è¦è°ƒç”¨äº†<code>MessageBoxA</code>å‡½æ•°</li>
<li>è¿™ä¸ªç¨‹åºéœ€è¦è°ƒç”¨IATè¡¨ä¸­çš„<code>MessageBoxA</code></li>
</ol>
<p>C++ç‰ˆæœ¬çš„ä»£ç æœ‰å¾ˆå¤šï¼Œå¯ä»¥å‚è€ƒ
<a href="https://www.ired.team/offensive-security/code-injection-process-injection/import-adress-table-iat-hooking" target="_blank" rel="noopener">Red Team Note</a>çš„ç‰ˆæœ¬</p>
<p>å…³é”®éƒ¨åˆ†æ˜¯å®šä½åˆ°IATè¡¨ç„¶åéå†è¡¨é¡¹ï¼Œå®šä½IATè¡¨éœ€è¦åšä¸€ä¸ªPEå¤´çš„è§£æï¼Œæˆ–è€…è¯´åç§»ï¼Œå…·ä½“å¦‚ä¸‹</p>
<p>é¦–å…ˆé€šè¿‡DOSå¤´çš„<code>e_lfanew</code>ï¼ˆæœ€å4ä¸ªå­—èŠ‚ï¼‰å®šä½åˆ°NTå¤´</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#268bd2">let</span> image_base <span style="color:#719e07">=</span> GetModuleHandleA(null()) <span style="color:#719e07">as</span> <span style="color:#dc322f">u64</span>;
</span></span><span style="display:flex;"><span><span style="color:#268bd2">let</span> p_dos_header <span style="color:#719e07">=</span> image_base <span style="color:#719e07">as</span> PimageDosHeader;
</span></span><span style="display:flex;"><span><span style="color:#268bd2">let</span> p_nt_headers <span style="color:#719e07">=</span> (image_base <span style="color:#719e07">+</span> (<span style="color:#719e07">*</span>p_dos_header).e_lfanew <span style="color:#719e07">as</span> <span style="color:#dc322f">u64</span>) <span style="color:#719e07">as</span> PimageNtHeaders64;
</span></span></code></pre></div><p>ç„¶åNTå¤´çš„<code>OptionalHeader--&gt;DataDirArray</code>ä¸­ç¬¬2é¡¹å°±æ˜¯å¯¼å…¥è¡¨çš„åç§»ï¼ŒåŒç†å¯ä»¥å¾—åˆ°å…¶ä»–è¡¨ï¼Œå…·ä½“æœ‰å“ªäº›è¡¨å¯ä»¥æŸ¥æ–‡æ¡£ï¼Œä¸‹é¢æ˜¯010editoræˆªå›¾</p>
<p><img src="https://raw.githubusercontent.com/Military-axe/imgtable/main/202403211731982.png" alt=""></p>
<p>ç„¶åéå†å¯¹æ¯”å¯¼å…¥è¡¨ä¸­çš„æ¨¡å—åæ˜¯å¦å’Œç›®æ ‡æ¨¡å—ç›¸åŒï¼Œç›¸åŒåˆ™ç»§ç»­éå†æ¨¡å—ä¸­çš„å‡½æ•°åï¼Œç›´åˆ°åŒ¹é…åˆ°ç›®æ ‡å‡½æ•°ã€‚</p>
<p>åŒ¹é…åˆ°ç›®æ ‡å‡½æ•°ä¹Ÿå°±æ˜¯<code>MessageBoxA</code>åï¼Œä¿®æ”¹æƒé™ï¼Œå†ä¿®æ”¹å‡½æ•°æŒ‡é’ˆï¼Œå†ä¿®æ”¹å›åŸæ¥çš„æƒé™(å…»æˆå¥½ä¹ æƒ¯ï¼Œä¸ç•™ä¸‹çƒ‚æ‘Šå­)</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#586e75">/* ä¿®æ”¹IATè¡¨å±æ€§ä¸ºå¯è¯»å¯å†™å¯æ‰§è¡Œ, ç„¶åä¿®æ”¹å¯¹åº”IATè¡¨é¡¹å€¼ä¸ºhookå‡½æ•° */</span>
</span></span><span style="display:flex;"><span><span style="color:#586e75">/* ç”±äºåªæ˜¯ä¿®æ”¹IATè¡¨ä¸­çš„ä¸€ä¸ªæŒ‡é’ˆï¼Œæ‰€ä»¥å¤§å°ç›´æ¥0x1000ï¼Œä¸ä¼šæœ‰å¤§å°çš„é™åˆ¶ */</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">let</span> <span style="color:#719e07">mut</span> old_protection <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span><span style="color:#719e07">u32</span>;
</span></span><span style="display:flex;"><span>VirtualProtect(p_func <span style="color:#719e07">as</span> _, <span style="color:#2aa198">0x1000</span>, <span style="color:#cb4b16">PAGE_EXECUTE_READWRITE</span>, <span style="color:#719e07">&amp;</span><span style="color:#719e07">mut</span> old_protection <span style="color:#719e07">as</span> _);
</span></span><span style="display:flex;"><span><span style="color:#719e07">*</span>p_func <span style="color:#719e07">=</span> new_func_address;
</span></span><span style="display:flex;"><span>VirtualProtect(p_func <span style="color:#719e07">as</span> _, <span style="color:#2aa198">0x1000</span>, old_protection, <span style="color:#719e07">&amp;</span><span style="color:#719e07">mut</span> old_protection <span style="color:#719e07">as</span> _);
</span></span></code></pre></div><p>è¿™æ ·å°±å¯ä»¥äº†ï¼Œéœ€è¦è®°å¾—å†å®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„<code>new_func_address</code>ä¹Ÿå°±æ˜¯æˆ‘ä»¬è‡ªå·±hookçš„å‡½æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#719e07">unsafe</span> <span style="color:#719e07">extern</span> <span style="color:#2aa198">&#34;system&#34;</span> <span style="color:#719e07">fn</span> <span style="color:#268bd2">hook_message_box_a</span>(h_wnd: <span style="color:#268bd2">HWND</span>, _: <span style="color:#268bd2">PCSTR</span>, _: <span style="color:#268bd2">PCSTR</span>, u_type: <span style="color:#dc322f">u32</span>) -&gt; <span style="color:#dc322f">i32</span> {
</span></span><span style="display:flex;"><span>    (<span style="color:#719e07">*</span>(<span style="color:#719e07">&amp;</span><span style="color:#cb4b16">MESSAGE_BOX_A_HOOK_ADDRESS</span> <span style="color:#719e07">as</span> <span style="color:#719e07">*</span><span style="color:#719e07">const</span> _ <span style="color:#719e07">as</span> MessageBoxWHook))(
</span></span><span style="display:flex;"><span>        h_wnd,
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2">s!</span>(<span style="color:#2aa198">&#34;Ops hooked by mi1itray.axe!&#34;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2">s!</span>(<span style="color:#2aa198">&#34;Ops hooked by mi1itray.axe!&#34;</span>),
</span></span><span style="display:flex;"><span>        u_type,
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Rustç‰ˆæœ¬64ä½ä»£ç å¦‚ä¸‹:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#719e07">use</span> core::ptr::null;
</span></span><span style="display:flex;"><span><span style="color:#719e07">use</span> std::os::raw::c_void;
</span></span><span style="display:flex;"><span><span style="color:#719e07">use</span> windows_sys::{
</span></span><span style="display:flex;"><span>    core::<span style="color:#719e07">*</span>, Win32::Foundation::<span style="color:#719e07">*</span>, Win32::System::Diagnostics::Debug::<span style="color:#cb4b16">IMAGE_NT_HEADERS64</span>,
</span></span><span style="display:flex;"><span>    Win32::System::LibraryLoader::<span style="color:#719e07">*</span>, Win32::System::Memory::<span style="color:#719e07">*</span>, Win32::System::SystemServices::<span style="color:#719e07">*</span>,
</span></span><span style="display:flex;"><span>    Win32::<span style="color:#cb4b16">UI</span>::WindowsAndMessaging::<span style="color:#719e07">*</span>,
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#586e75">// å®šä¹‰ä¸€ä¸ªåˆ«å
</span></span></span><span style="display:flex;"><span><span style="color:#719e07">type</span> <span style="color:#268bd2">MessageBoxWHook</span> <span style="color:#719e07">=</span> <span style="color:#719e07">*</span><span style="color:#719e07">const</span> <span style="color:#719e07">unsafe</span> <span style="color:#719e07">extern</span> <span style="color:#2aa198">&#34;system&#34;</span> <span style="color:#719e07">fn</span>(<span style="color:#cb4b16">HWND</span>, <span style="color:#cb4b16">PCSTR</span>, <span style="color:#cb4b16">PCSTR</span>, <span style="color:#dc322f">u32</span>) -&gt; <span style="color:#dc322f">i32</span>;
</span></span><span style="display:flex;"><span><span style="color:#719e07">type</span> <span style="color:#268bd2">LPVOID</span> <span style="color:#719e07">=</span> <span style="color:#719e07">*</span><span style="color:#719e07">mut</span> c_void;
</span></span><span style="display:flex;"><span><span style="color:#719e07">type</span> <span style="color:#268bd2">PimageNtHeaders64</span> <span style="color:#719e07">=</span> <span style="color:#719e07">*</span><span style="color:#719e07">mut</span> <span style="color:#cb4b16">IMAGE_NT_HEADERS64</span>;
</span></span><span style="display:flex;"><span><span style="color:#719e07">type</span> <span style="color:#268bd2">PimageImportDescriptor</span> <span style="color:#719e07">=</span> <span style="color:#719e07">*</span><span style="color:#719e07">mut</span> <span style="color:#cb4b16">IMAGE_IMPORT_DESCRIPTOR</span>;
</span></span><span style="display:flex;"><span><span style="color:#719e07">type</span> <span style="color:#268bd2">PimageDosHeader</span> <span style="color:#719e07">=</span> <span style="color:#719e07">*</span><span style="color:#719e07">mut</span> <span style="color:#cb4b16">IMAGE_DOS_HEADER</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#586e75">// ä¿å­˜åŸå‡½æ•°åœ°å€ï¼Œå½“ç„¶è¿™é‡Œå¯ä»¥ç”¨æŒ‡é’ˆå…·ä½“å†™æ³•åé¢å•ç‹¬ä»‹ç»
</span></span></span><span style="display:flex;"><span><span style="color:#719e07">static</span> <span style="color:#719e07">mut</span> <span style="color:#cb4b16">MESSAGE_BOX_A_HOOK_ADDRESS</span>: <span style="color:#dc322f">u64</span> <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#586e75">// ä¸¤ä¸ªè°ƒè¯•çš„æ—¶å€™ä½¿ç”¨çš„å‡½æ•°ï¼Œç”¨äºè¾“å…¥Errorä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#719e07">#[allow(dead_code)]</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">unsafe</span> <span style="color:#719e07">fn</span> <span style="color:#268bd2">clear_last_error</span>() {
</span></span><span style="display:flex;"><span>    SetLastError(<span style="color:#2aa198">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">#[allow(dead_code)]</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">unsafe</span> <span style="color:#719e07">fn</span> <span style="color:#268bd2">show_last_error</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">let</span> e <span style="color:#719e07">=</span> <span style="color:#268bd2">format!</span>(<span style="color:#2aa198">&#34;</span><span style="color:#2aa198">{:?}</span><span style="color:#cb4b16">\0</span><span style="color:#2aa198">&#34;</span>, GetLastError()).as_ptr();
</span></span><span style="display:flex;"><span>    MessageBoxA(<span style="color:#2aa198">0</span>, e, <span style="color:#268bd2">s!</span>(<span style="color:#2aa198">&#34;Warn&#34;</span>), <span style="color:#cb4b16">MB_OK</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#2aa198">/// `hook_message_box_a`æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„messageboxå‡½æ•°ï¼Œç”¨äºæ›¿æ¢æ‰åŸæ¥çš„`MessageBoxA`å‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">/// æ•ˆæœæ˜¯å¼¹å‡ºä¸€ä¸ªæ¶ˆæ¯æ¡†ï¼Œä¸»ä½“å†…å®¹å’Œæ ‡é¢˜æ å†…å®¹éƒ½æ˜¯**Ops hooked by mi1itray.axe!**
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">///
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">/// # å‚æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">///
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">/// å‚æ•°ä¸åŸæœ¬çš„`MessageBoxA`å‡½æ•°å£°æ˜ç›¸åŒ
</span></span></span><span style="display:flex;"><span><span style="color:#719e07">unsafe</span> <span style="color:#719e07">extern</span> <span style="color:#2aa198">&#34;system&#34;</span> <span style="color:#719e07">fn</span> <span style="color:#268bd2">hook_message_box_a</span>(h_wnd: <span style="color:#268bd2">HWND</span>, _: <span style="color:#268bd2">PCSTR</span>, _: <span style="color:#268bd2">PCSTR</span>, u_type: <span style="color:#dc322f">u32</span>) -&gt; <span style="color:#dc322f">i32</span> {
</span></span><span style="display:flex;"><span>    (<span style="color:#719e07">*</span>(<span style="color:#719e07">&amp;</span><span style="color:#cb4b16">MESSAGE_BOX_A_HOOK_ADDRESS</span> <span style="color:#719e07">as</span> <span style="color:#719e07">*</span><span style="color:#719e07">const</span> _ <span style="color:#719e07">as</span> MessageBoxWHook))(
</span></span><span style="display:flex;"><span>        h_wnd,
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2">s!</span>(<span style="color:#2aa198">&#34;Ops hooked by mi1itray.axe!&#34;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2">s!</span>(<span style="color:#2aa198">&#34;Ops hooked by mi1itray.axe!&#34;</span>),
</span></span><span style="display:flex;"><span>        u_type,
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#2aa198">/// `detour`æ‰§è¡Œhooké€»è¾‘çš„å‡½æ•°ï¼Œå°†æŒ‡å®šæ¨¡å—ä¸­æŒ‡å®šåç§»å€¼çš„å‡½æ•°æŒ‡é’ˆæ›¿æ¢æˆæŒ‡å®šçš„æ–°å‡½æ•°åœ°å€å€¼ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">/// é¦–å…ˆéå†æ¨¡å—åˆ—è¡¨ï¼Œç›´åˆ°å¯¹æ¯”å‡ºç›¸åŒçš„æ¨¡å—åç§°ã€‚ç„¶å
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">///
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">/// # å‚æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">///
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">/// - `module_name`: æŒ‡å‘æ¨¡å—åç§°å†…å­˜çš„æŒ‡é’ˆï¼Œç±»å‹æ˜¯`*const u8`
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">/// - `old_func_offset`: åŸæœ¬å‡½æ•°æŒ‡é’ˆåœ¨æ¨¡å—ä¸ŠIATè¡¨ä¸­çš„åç§»
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">/// - `new_func_address`: æ›¿æ¢çš„å‡½æ•°æŒ‡é’ˆåœ°å€å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">///
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">/// # è¿”å›å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">///
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">/// å¦‚æœhookæˆåŠŸåˆ™è¿”å›åŸå§‹å‡½æ•°çš„åœ°å€ï¼Œå¦‚æœå¤±è´¥åˆ™è¿”å›0
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">///
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">/// # ä¾‹å­
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">///
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">/// ```rust
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">/// detour(&#34;USER32.dll\0&#34;.as_ptr() as _, 0x72AD0, hook_message_box_w as _);
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">/// ```
</span></span></span><span style="display:flex;"><span><span style="color:#719e07">unsafe</span> <span style="color:#719e07">fn</span> <span style="color:#268bd2">detour</span>(module_name: <span style="color:#719e07">*</span><span style="color:#719e07">const</span> <span style="color:#dc322f">u8</span>, old_func_offset: <span style="color:#dc322f">u64</span>, new_func_address: <span style="color:#dc322f">u64</span>) -&gt; <span style="color:#dc322f">u64</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">let</span> module_address <span style="color:#719e07">=</span> GetModuleHandleA(module_name) <span style="color:#719e07">as</span> <span style="color:#dc322f">u64</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">let</span> old_func_address <span style="color:#719e07">=</span> module_address <span style="color:#719e07">+</span> old_func_offset;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">let</span> image_base <span style="color:#719e07">=</span> GetModuleHandleA(null()) <span style="color:#719e07">as</span> <span style="color:#dc322f">u64</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">let</span> p_dos_header <span style="color:#719e07">=</span> image_base <span style="color:#719e07">as</span> PimageDosHeader;
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">let</span> p_nt_headers <span style="color:#719e07">=</span> (image_base <span style="color:#719e07">+</span> (<span style="color:#719e07">*</span>p_dos_header).e_lfanew <span style="color:#719e07">as</span> <span style="color:#dc322f">u64</span>) <span style="color:#719e07">as</span> PimageNtHeaders64;
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">let</span> <span style="color:#719e07">mut</span> p_import_descriptor <span style="color:#719e07">=</span> (image_base
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">+</span> (<span style="color:#719e07">*</span>p_nt_headers).OptionalHeader.DataDirectory[<span style="color:#2aa198">1</span>].VirtualAddress <span style="color:#719e07">as</span> <span style="color:#dc322f">u64</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">as</span> PimageImportDescriptor;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">while</span> (<span style="color:#719e07">*</span>p_import_descriptor).FirstThunk <span style="color:#719e07">!=</span> <span style="color:#2aa198">0</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#586e75">/* å¯¹æ¯”å¯¼å…¥è¡¨é¡¹åç§°ä¸ç›®æ ‡æ˜¯å¦ç¬¦åˆï¼Œä¸ç¬¦åˆåˆ™ç›´æ¥åç§»å¯¼å…¥è¡¨ä¸‹ä¸€é¡¹ */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">if</span> module_name.eq(<span style="color:#719e07">&amp;</span>((image_base <span style="color:#719e07">+</span> (<span style="color:#719e07">*</span>p_import_descriptor).Name <span style="color:#719e07">as</span> <span style="color:#dc322f">u64</span>) <span style="color:#719e07">as</span> <span style="color:#719e07">*</span><span style="color:#719e07">const</span> <span style="color:#dc322f">u8</span>)) {
</span></span><span style="display:flex;"><span>            p_import_descriptor <span style="color:#719e07">=</span> p_import_descriptor.offset(<span style="color:#2aa198">1</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">continue</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#586e75">/* åŒ¹é…åˆ°ç›®æ ‡æ¨¡å—, å¼¹å‡ºä¸€ä¸ªæ¶ˆæ¯æ¡† */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2">let</span> module_name <span style="color:#719e07">=</span> (image_base <span style="color:#719e07">+</span> (<span style="color:#719e07">*</span>p_import_descriptor).Name <span style="color:#719e07">as</span> <span style="color:#dc322f">u64</span>) <span style="color:#719e07">as</span> <span style="color:#719e07">*</span><span style="color:#719e07">const</span> <span style="color:#dc322f">u8</span>;
</span></span><span style="display:flex;"><span>        MessageBoxA(<span style="color:#2aa198">0</span>, module_name, <span style="color:#268bd2">s!</span>(<span style="color:#2aa198">&#34;Module name&#34;</span>), <span style="color:#cb4b16">MB_OK</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#586e75">/* éå†å¯¼å…¥è¡¨ */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2">let</span> <span style="color:#719e07">mut</span> p_func <span style="color:#719e07">=</span> (image_base <span style="color:#719e07">+</span> (<span style="color:#719e07">*</span>p_import_descriptor).FirstThunk <span style="color:#719e07">as</span> <span style="color:#dc322f">u64</span>) <span style="color:#719e07">as</span> <span style="color:#719e07">*</span><span style="color:#719e07">mut</span> <span style="color:#dc322f">u64</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">for</span> i <span style="color:#719e07">in</span> <span style="color:#2aa198">0</span><span style="color:#719e07">..</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">if</span> p_func.is_null() {
</span></span><span style="display:flex;"><span>                <span style="color:#719e07">return</span> <span style="color:#2aa198">0</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#586e75">/* åŒ¹é…åˆ°å¯¼å…¥è¡¨å‡½æ•°ï¼Œå¼¹å‡ºä¸€ä¸ªæ¶ˆæ¯æ¡† */</span>
</span></span><span style="display:flex;"><span>            <span style="color:#268bd2">let</span> func_name <span style="color:#719e07">=</span> <span style="color:#cb4b16">PCSTR</span>::from(
</span></span><span style="display:flex;"><span>                (image_base
</span></span><span style="display:flex;"><span>                    <span style="color:#719e07">+</span> (<span style="color:#719e07">*</span>((image_base <span style="color:#719e07">+</span> (<span style="color:#719e07">*</span>p_import_descriptor).Anonymous.OriginalFirstThunk <span style="color:#719e07">as</span> <span style="color:#dc322f">u64</span>)
</span></span><span style="display:flex;"><span>                        <span style="color:#719e07">as</span> <span style="color:#719e07">*</span><span style="color:#719e07">const</span> <span style="color:#dc322f">u64</span>)
</span></span><span style="display:flex;"><span>                        .offset(i))
</span></span><span style="display:flex;"><span>                    <span style="color:#719e07">+</span> <span style="color:#2aa198">2</span>) <span style="color:#719e07">as</span> <span style="color:#719e07">*</span><span style="color:#719e07">const</span> <span style="color:#dc322f">u8</span>,
</span></span><span style="display:flex;"><span>            );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">if</span> old_func_address <span style="color:#719e07">==</span> <span style="color:#719e07">*</span>p_func {
</span></span><span style="display:flex;"><span>                MessageBoxA(<span style="color:#2aa198">0</span>, func_name, <span style="color:#268bd2">s!</span>(<span style="color:#2aa198">&#34;Find Func&#34;</span>), <span style="color:#cb4b16">MB_OK</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#586e75">/* ä¿®æ”¹IATè¡¨å±æ€§ä¸ºå¯è¯»å¯å†™å¯æ‰§è¡Œ, ç„¶åä¿®æ”¹å¯¹åº”IATè¡¨é¡¹å€¼ä¸ºhookå‡½æ•° */</span>
</span></span><span style="display:flex;"><span>                <span style="color:#586e75">/* ç”±äºåªæ˜¯ä¿®æ”¹IATè¡¨ä¸­çš„ä¸€ä¸ªæŒ‡é’ˆï¼Œæ‰€ä»¥å¤§å°ç›´æ¥0x1000ï¼Œä¸ä¼šæœ‰å¤§å°çš„é™åˆ¶ */</span>
</span></span><span style="display:flex;"><span>                <span style="color:#268bd2">let</span> <span style="color:#719e07">mut</span> old_protection <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span><span style="color:#719e07">u32</span>;
</span></span><span style="display:flex;"><span>                VirtualProtect(
</span></span><span style="display:flex;"><span>                    p_func <span style="color:#719e07">as</span> _,
</span></span><span style="display:flex;"><span>                    <span style="color:#2aa198">0x1000</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#cb4b16">PAGE_EXECUTE_READWRITE</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#719e07">&amp;</span><span style="color:#719e07">mut</span> old_protection <span style="color:#719e07">as</span> _,
</span></span><span style="display:flex;"><span>                );
</span></span><span style="display:flex;"><span>                <span style="color:#719e07">*</span>p_func <span style="color:#719e07">=</span> new_func_address;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#586e75">/* ä¿®æ”¹å›åŸæ¥çš„å±æ€§ */</span>
</span></span><span style="display:flex;"><span>                VirtualProtect(
</span></span><span style="display:flex;"><span>                    p_func <span style="color:#719e07">as</span> _,
</span></span><span style="display:flex;"><span>                    <span style="color:#2aa198">0x1000</span>,
</span></span><span style="display:flex;"><span>                    old_protection,
</span></span><span style="display:flex;"><span>                    <span style="color:#719e07">&amp;</span><span style="color:#719e07">mut</span> old_protection <span style="color:#719e07">as</span> _,
</span></span><span style="display:flex;"><span>                );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#719e07">return</span> old_func_address;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            p_func <span style="color:#719e07">=</span> p_func.offset(<span style="color:#2aa198">1</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">return</span> <span style="color:#2aa198">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#2aa198">0</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#2aa198">/// `init_hook` ä¾‹ç¨‹æ‰§è¡Œå‡½æ•°ï¼Œè°ƒç”¨`detour`å‡½æ•°ï¼ŒIAThookå‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">/// å…¶ä¸­çš„`0x79730`æ˜¯æˆ‘æœ¬æœºä¸Šuser32.dllä¸­åŸºåœ°å€åˆ°MessageBoxAçš„åç§»å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#719e07">unsafe</span> <span style="color:#719e07">extern</span> <span style="color:#2aa198">&#34;system&#34;</span> <span style="color:#719e07">fn</span> <span style="color:#268bd2">init_hook</span>() -&gt; <span style="color:#dc322f">u32</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#cb4b16">MESSAGE_BOX_A_HOOK_ADDRESS</span> <span style="color:#719e07">=</span> detour(<span style="color:#268bd2">s!</span>(<span style="color:#2aa198">&#34;USER32.dll&#34;</span>), <span style="color:#2aa198">0x79730</span>, hook_message_box_a <span style="color:#719e07">as</span> _);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#2aa198">0</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">#[no_mangle]</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">#[allow(non_snake_case)]</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">pub</span> <span style="color:#719e07">extern</span> <span style="color:#2aa198">&#34;system&#34;</span> <span style="color:#719e07">fn</span> <span style="color:#268bd2">DllMain</span>(_: <span style="color:#dc322f">isize</span>, reason: <span style="color:#dc322f">u32</span>, _: <span style="color:#268bd2">LPVOID</span>) -&gt; <span style="color:#dc322f">i32</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">match</span> reason {
</span></span><span style="display:flex;"><span>        <span style="color:#cb4b16">DLL_PROCESS_ATTACH</span> <span style="color:#719e07">=&gt;</span> <span style="color:#719e07">unsafe</span> {
</span></span><span style="display:flex;"><span>            MessageBoxA(<span style="color:#2aa198">0</span>, <span style="color:#268bd2">s!</span>(<span style="color:#2aa198">&#34;Inject dll success&#34;</span>), <span style="color:#268bd2">s!</span>(<span style="color:#2aa198">&#34;Step 1&#34;</span>), <span style="color:#cb4b16">MB_OK</span>);
</span></span><span style="display:flex;"><span>            init_hook();
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#cb4b16">DLL_PROCESS_DETACH</span> <span style="color:#719e07">=&gt;</span> (),
</span></span><span style="display:flex;"><span>        <span style="color:#cb4b16">DLL_THREAD_ATTACH</span> <span style="color:#719e07">=&gt;</span> (),
</span></span><span style="display:flex;"><span>        <span style="color:#cb4b16">DLL_THREAD_DETACH</span> <span style="color:#719e07">=&gt;</span> (),
</span></span><span style="display:flex;"><span>        _ <span style="color:#719e07">=&gt;</span> (),
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#2aa198">1</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="inline-hook">Inline hook</h1>
<p>inline hookæ˜¯hookå®Œè¿™ä¸ªå‡½æ•°å</p>
<ul>
<li>
<p>é¦–å…ˆè¦å°†åŸå§‹å‡½æ•°çš„å‚æ•°å€¼éƒ½å­˜å…¥æ ˆä¸­</p>
</li>
<li>
<p>ç„¶åå†è·³è½¬è‡ªå®šä¹‰hookå‡½æ•°</p>
</li>
<li>
<p>æ‰§è¡Œå®Œæˆ‘ä»¬çš„å‡½æ•°åå›åˆ°åŸå§‹å‡½æ•°</p>
</li>
<li>
<p>å†æ¢å¤åŸå§‹å‡½æ•°çš„å‚æ•°ï¼Œè®©åŸå§‹å‡½æ•°ç»§ç»­æ­£å¸¸è¿è¡Œã€‚</p>
</li>
</ul>
<p>ç›®çš„å°±æ˜¯å‡å°å½±å“ã€‚è¿™ç§æ–¹æ³•æ•ˆæœæœ€å¥½ï¼Œåº”ç”¨åœºæ™¯å¹¿ï¼Œæ²¡æœ‰é™åˆ¶ï¼›ä½†æ˜¯éœ€è¦å†™æ±‡ç¼–è¯­å¥æ¥å°†å‚æ•°å­˜å…¥æ ˆä¸­ï¼ŒåŒæ—¶éœ€è¦æ ¹æ®hookå‡½æ•°ç¦»hookä½ç½®æ¥å†³å®šæ˜¯è¦<strong>é•¿è·³è½¬è¿˜æ˜¯çŸ­è·³è½¬</strong>ã€‚</p>
<p>å¥½åœ¨å¯ä»¥ä½¿ç”¨ä¸€äº›hookæ¡†æ¶æ¥é™ä½éš¾åº¦ï¼Œwindowsä¸‹cè¯­è¨€å¾ˆå¤šæ¡†æ¶ï¼Œdetourï¼Œminihookç­‰ï¼Œrusté€‰æ‹©å°±æ¯”è¾ƒå°‘ï¼Œä¹‹å‰æ¯”è¾ƒæœ‰åçš„æ˜¯detourï¼Œä½†æ˜¯ä»¥åŠåœæ­¢ç»´æŠ¤äº†ã€‚æ‰€ä»¥æˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯
<a href="https://github.com/Hpmason/retour-rs" target="_blank" rel="noopener">retour</a>ï¼Œä¸€ä¸ªdetourçš„forkç»´æŠ¤ç‰ˆæœ¬</p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªå®˜æ–¹çš„ä»£ç ï¼Œæ˜¯hook <code>MessageBoxW</code>çš„</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#2aa198">//! A `MessageBoxW` detour example.
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">//!
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">//! Ensure the crate is compiled as a &#39;cdylib&#39; library to allow C interop.
</span></span></span><span style="display:flex;"><span><span style="color:#719e07">use</span> retour::static_detour;
</span></span><span style="display:flex;"><span><span style="color:#719e07">use</span> std::error::Error;
</span></span><span style="display:flex;"><span><span style="color:#719e07">use</span> std::ffi::c_int;
</span></span><span style="display:flex;"><span><span style="color:#719e07">use</span> std::os::raw::c_void;
</span></span><span style="display:flex;"><span><span style="color:#719e07">use</span> std::{ffi::CString, iter, mem};
</span></span><span style="display:flex;"><span><span style="color:#719e07">use</span> windows::core::{<span style="color:#cb4b16">PCSTR</span>, <span style="color:#cb4b16">PCWSTR</span>};
</span></span><span style="display:flex;"><span><span style="color:#719e07">use</span> windows::w;
</span></span><span style="display:flex;"><span><span style="color:#719e07">use</span> windows::Win32::Foundation::{<span style="color:#cb4b16">BOOL</span>, <span style="color:#cb4b16">HANDLE</span>, <span style="color:#cb4b16">HWND</span>};
</span></span><span style="display:flex;"><span><span style="color:#719e07">use</span> windows::Win32::System::LibraryLoader::{GetModuleHandleW, GetProcAddress};
</span></span><span style="display:flex;"><span><span style="color:#719e07">use</span> windows::Win32::System::SystemServices::{
</span></span><span style="display:flex;"><span>    <span style="color:#cb4b16">DLL_PROCESS_ATTACH</span>, <span style="color:#cb4b16">DLL_PROCESS_DETACH</span>, <span style="color:#cb4b16">DLL_THREAD_ATTACH</span>, <span style="color:#cb4b16">DLL_THREAD_DETACH</span>,
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">static_detour!</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">static</span> MessageBoxWHook: <span style="color:#268bd2">unsafe</span> <span style="color:#719e07">extern</span> <span style="color:#2aa198">&#34;system&#34;</span> <span style="color:#719e07">fn</span>(<span style="color:#cb4b16">HWND</span>, <span style="color:#cb4b16">PCWSTR</span>, <span style="color:#cb4b16">PCWSTR</span>, <span style="color:#dc322f">u32</span>) -&gt; <span style="color:#268bd2">c_int</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#586e75">// A type alias for `MessageBoxW` (makes the transmute easy on the eyes)
</span></span></span><span style="display:flex;"><span><span style="color:#719e07">type</span> <span style="color:#268bd2">FnMessageBoxW</span> <span style="color:#719e07">=</span> <span style="color:#719e07">unsafe</span> <span style="color:#719e07">extern</span> <span style="color:#2aa198">&#34;system&#34;</span> <span style="color:#719e07">fn</span>(<span style="color:#cb4b16">HWND</span>, <span style="color:#cb4b16">PCWSTR</span>, <span style="color:#cb4b16">PCWSTR</span>, <span style="color:#dc322f">u32</span>) -&gt; <span style="color:#268bd2">c_int</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#2aa198">/// Called when the DLL is attached to the process.
</span></span></span><span style="display:flex;"><span><span style="color:#719e07">unsafe</span> <span style="color:#719e07">fn</span> <span style="color:#268bd2">main</span>() -&gt; <span style="color:#b58900">Result</span><span style="color:#719e07">&lt;</span>(), <span style="color:#b58900">Box</span><span style="color:#719e07">&lt;</span><span style="color:#719e07">dyn</span> Error<span style="color:#719e07">&gt;&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#586e75">// Retrieve an absolute address of `MessageBoxW`. This is required for
</span></span></span><span style="display:flex;"><span>    <span style="color:#586e75">// libraries due to the import address table. If `MessageBoxW` would be
</span></span></span><span style="display:flex;"><span>    <span style="color:#586e75">// provided directly as the target, it would only hook this DLL&#39;s
</span></span></span><span style="display:flex;"><span>    <span style="color:#586e75">// `MessageBoxW`. Using the method below an absolute address is retrieved
</span></span></span><span style="display:flex;"><span>    <span style="color:#586e75">// instead, detouring all invocations of `MessageBoxW` in the active process.
</span></span></span><span style="display:flex;"><span>    <span style="color:#268bd2">let</span> address <span style="color:#719e07">=</span> get_module_symbol_address(<span style="color:#2aa198">&#34;user32.dll&#34;</span>, <span style="color:#2aa198">&#34;MessageBoxW&#34;</span>)
</span></span><span style="display:flex;"><span>        .expect(<span style="color:#2aa198">&#34;could not find &#39;MessageBoxW&#39; address&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">let</span> target: <span style="color:#268bd2">FnMessageBoxW</span> <span style="color:#719e07">=</span> mem::transmute(address);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#586e75">// Initialize AND enable the detour (the 2nd parameter can also be a closure)
</span></span></span><span style="display:flex;"><span>    MessageBoxWHook
</span></span><span style="display:flex;"><span>        .initialize(target, messageboxw_detour)<span style="color:#719e07">?</span>
</span></span><span style="display:flex;"><span>        .enable()<span style="color:#719e07">?</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#b58900">Ok</span>(())
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#2aa198">/// Called whenever `MessageBoxW` is invoked in the process.
</span></span></span><span style="display:flex;"><span><span style="color:#719e07">fn</span> <span style="color:#268bd2">messageboxw_detour</span>(hwnd: <span style="color:#268bd2">HWND</span>, text: <span style="color:#268bd2">PCWSTR</span>, _caption: <span style="color:#268bd2">PCWSTR</span>, msgbox_style: <span style="color:#dc322f">u32</span>) -&gt; <span style="color:#268bd2">c_int</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#586e75">// Call the original `MessageBoxW`, but replace the caption
</span></span></span><span style="display:flex;"><span>    <span style="color:#268bd2">let</span> replaced_caption <span style="color:#719e07">=</span> <span style="color:#268bd2">w!</span>(<span style="color:#2aa198">&#34;Detoured!&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">unsafe</span> { MessageBoxWHook.call(hwnd, text, replaced_caption, msgbox_style) }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#2aa198">/// Returns a module symbol&#39;s absolute address.
</span></span></span><span style="display:flex;"><span><span style="color:#719e07">fn</span> <span style="color:#268bd2">get_module_symbol_address</span>(module: <span style="color:#719e07">&amp;</span><span style="color:#dc322f">str</span>, symbol: <span style="color:#719e07">&amp;</span><span style="color:#dc322f">str</span>) -&gt; <span style="color:#b58900">Option</span><span style="color:#719e07">&lt;</span><span style="color:#dc322f">usize</span><span style="color:#719e07">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">let</span> module <span style="color:#719e07">=</span> module
</span></span><span style="display:flex;"><span>        .encode_utf16()
</span></span><span style="display:flex;"><span>        .chain(iter::once(<span style="color:#2aa198">0</span>))
</span></span><span style="display:flex;"><span>        .collect::<span style="color:#719e07">&lt;</span><span style="color:#b58900">Vec</span><span style="color:#719e07">&lt;</span><span style="color:#dc322f">u16</span><span style="color:#719e07">&gt;&gt;</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">let</span> symbol <span style="color:#719e07">=</span> CString::new(symbol).unwrap();
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">unsafe</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2">let</span> handle <span style="color:#719e07">=</span> GetModuleHandleW(<span style="color:#cb4b16">PCWSTR</span>(module.as_ptr() <span style="color:#719e07">as</span> _)).unwrap();
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">match</span> GetProcAddress(handle, <span style="color:#cb4b16">PCSTR</span>(symbol.as_ptr() <span style="color:#719e07">as</span> _)) {
</span></span><span style="display:flex;"><span>            <span style="color:#b58900">Some</span>(func) <span style="color:#719e07">=&gt;</span> <span style="color:#b58900">Some</span>(func <span style="color:#719e07">as</span> <span style="color:#dc322f">usize</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#b58900">None</span> <span style="color:#719e07">=&gt;</span> <span style="color:#b58900">None</span>,
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">#[no_mangle]</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">unsafe</span> <span style="color:#719e07">extern</span> <span style="color:#2aa198">&#34;system&#34;</span> <span style="color:#719e07">fn</span> <span style="color:#268bd2">DllMain</span>(_hinst: <span style="color:#268bd2">HANDLE</span>, reason: <span style="color:#dc322f">u32</span>, _reserved: <span style="color:#719e07">*</span><span style="color:#719e07">mut</span> c_void) -&gt; <span style="color:#268bd2">BOOL</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">match</span> reason {
</span></span><span style="display:flex;"><span>        <span style="color:#cb4b16">DLL_PROCESS_ATTACH</span> <span style="color:#719e07">=&gt;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#268bd2">println!</span>(<span style="color:#2aa198">&#34;attaching&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">unsafe</span> { main().unwrap() }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#cb4b16">DLL_PROCESS_DETACH</span> <span style="color:#719e07">=&gt;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#268bd2">println!</span>(<span style="color:#2aa198">&#34;detaching&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#cb4b16">DLL_THREAD_ATTACH</span> <span style="color:#719e07">=&gt;</span> {}
</span></span><span style="display:flex;"><span>        <span style="color:#cb4b16">DLL_THREAD_DETACH</span> <span style="color:#719e07">=&gt;</span> {}
</span></span><span style="display:flex;"><span>        _ <span style="color:#719e07">=&gt;</span> {}
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">return</span> <span style="color:#cb4b16">BOOL</span>::from(<span style="color:#cb4b16">true</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>çœ‹å®Œæˆ‘åªèƒ½è¯´ï¼Œä¼˜é›…ï¼Œå¤ªä¼˜é›…äº†ï¼å®›å¦‚æ±‰å°¼æ‹”åšäººä¸€æ ·çš„ä¼˜é›…ã€‚</p>
<h1 id="vmt-hook">VMT hook</h1>
<p>è™šè¡¨hookï¼Œåœ¨c++ä¸­ï¼Œä¸€ä¸ªç±»å¦‚æœä½¿ç”¨åˆ°äº†è™šå‡½æ•°ï¼Œå°±ä¼šæœ‰è™šè¡¨ã€‚è¿™ä¸ªè™šè¡¨åªå±äºè¿™ä¸ªç±»ï¼Œè¿™ä¸ªç±»çš„å¯¹è±¡éƒ½æœ‰æŒ‡å‘è¿™ä¸ªè™šè¡¨çš„æŒ‡é’ˆ</p>
<pre tabindex="0"><code class="language-mermaid" data-lang="mermaid">graph LR

	A(ç±»Açš„å¯¹è±¡1) --&gt; B(ç±»Aè™šè¡¨)
	C(ç±»Açš„å¯¹è±¡2) --&gt; B
	B --&gt; D(ç±»Açš„è™šå‡½æ•°)
</code></pre><p>å…ˆå†™ä¸€ä¸ªç®€å•çš„ä¾‹å­</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#719e07">#include</span> <span style="color:#719e07">&lt;iostream&gt;</span><span style="color:#719e07">
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">using</span> <span style="color:#719e07">namespace</span> std;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">class</span> <span style="color:#268bd2">Base</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#719e07">public</span><span style="color:#719e07">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">virtual</span> <span style="color:#dc322f">void</span> func1() { cout <span style="color:#719e07">&lt;&lt;</span> <span style="color:#2aa198">&#34;func1()&#34;</span> <span style="color:#719e07">&lt;&lt;</span> endl; }
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">virtual</span> <span style="color:#dc322f">void</span> <span style="color:#268bd2">func2</span>() { cout <span style="color:#719e07">&lt;&lt;</span> <span style="color:#2aa198">&#34;func2()&#34;</span> <span style="color:#719e07">&lt;&lt;</span> endl; }
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">virtual</span> <span style="color:#dc322f">void</span> <span style="color:#268bd2">func3</span>() { cout <span style="color:#719e07">&lt;&lt;</span> <span style="color:#2aa198">&#34;func3()&#34;</span> <span style="color:#719e07">&lt;&lt;</span> endl; }
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#dc322f">int</span> <span style="color:#268bd2">main</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    Base t;
</span></span><span style="display:flex;"><span>    (((<span style="color:#dc322f">void</span> (<span style="color:#719e07">*</span>)()) <span style="color:#719e07">*</span> ((<span style="color:#dc322f">int</span><span style="color:#719e07">*</span>)(<span style="color:#719e07">*</span>((<span style="color:#dc322f">int</span><span style="color:#719e07">*</span>)<span style="color:#719e07">&amp;</span>t)) <span style="color:#719e07">+</span> <span style="color:#2aa198">0</span>)))();
</span></span><span style="display:flex;"><span>    (((<span style="color:#dc322f">void</span> (<span style="color:#719e07">*</span>)()) <span style="color:#719e07">*</span> ((<span style="color:#dc322f">int</span><span style="color:#719e07">*</span>)(<span style="color:#719e07">*</span>((<span style="color:#dc322f">int</span><span style="color:#719e07">*</span>)<span style="color:#719e07">&amp;</span>t)) <span style="color:#719e07">+</span> <span style="color:#2aa198">1</span>)))();
</span></span><span style="display:flex;"><span>    (((<span style="color:#dc322f">void</span> (<span style="color:#719e07">*</span>)()) <span style="color:#719e07">*</span> ((<span style="color:#dc322f">int</span><span style="color:#719e07">*</span>)(<span style="color:#719e07">*</span>((<span style="color:#dc322f">int</span><span style="color:#719e07">*</span>)<span style="color:#719e07">&amp;</span>t)) <span style="color:#719e07">+</span> <span style="color:#2aa198">2</span>)))();
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">return</span> <span style="color:#2aa198">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>è¿è¡Œåå¯ä»¥çœ‹åˆ°</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span> â¯â¯ mi1it â¯â¯ .<span style="color:#cb4b16">\v</span>mt.exe
</span></span><span style="display:flex;"><span>func1<span style="color:#719e07">()</span>
</span></span><span style="display:flex;"><span>func2<span style="color:#719e07">()</span>
</span></span><span style="display:flex;"><span>func3<span style="color:#719e07">()</span>
</span></span></code></pre></div><p>g++ç¼–è¯‘æˆx86æ¶æ„çš„ï¼Œä½¿ç”¨idaæ‰“å¼€åˆ†æä¸€ä¸‹</p>
<pre tabindex="0"><code class="language-assembly" data-lang="assembly">.rdata:004052A8 ; public Base
.rdata:004052A8                 public __ZTI4Base
.rdata:004052A8 ; `typeinfo for&#39;Base
.rdata:004052A8 __ZTI4Base      dd offset __imp___ZTVN10__cxxabiv117__class_type_infoE+8
.rdata:004052A8                                         ; DATA XREF: .rdata:004052BCâ†“o
.rdata:004052A8                                         ; reference to RTTI&#39;s type class
.rdata:004052AC                 dd offset __ZTS4Base    ; reference to type&#39;s name
.rdata:004052B0                 public __ZTS4Base
.rdata:004052B0 ; `typeinfo name for&#39;Base
.rdata:004052B0 __ZTS4Base      db &#39;4Base&#39;,0            ; DATA XREF: .rdata:004052ACâ†‘o
.rdata:004052B0                                         ; type descriptor name
.rdata:004052B6                 align 4
.rdata:004052B8                 public __ZTV4Base
.rdata:004052B8 ; `vtable for&#39;Base
.rdata:004052B8 __ZTV4Base      dd 0                    ; offset to this
.rdata:004052BC                 dd offset __ZTI4Base    ; `typeinfo for&#39;Base
.rdata:004052C0 virtual         dd offset __ZN4Base5func1Ev
.rdata:004052C0                                         ; DATA XREF: _main+Eâ†‘o
.rdata:004052C0                                         ; Base::func1(void)
.rdata:004052C4                 dd offset __ZN4Base5func2Ev ; Base::func2(void)
.rdata:004052C8                 dd offset __ZN4Base5func3Ev ; Base::func3(void)
</code></pre><p>å¯ä»¥çœ‹åˆ°ä¸€ä¸ªBaseç±»çš„ç»“æ„ï¼Œåœ¨thisæŒ‡é’ˆåç§»2çš„ä½ç½®å°±æ˜¯è™šè¡¨ï¼Œåˆ†åˆ«æŒ‡å‘3ä¸ªè™šå‡½æ•°ã€‚ä½†æ˜¯è¿™æ˜¯ç±»çš„ç»“æ„ï¼Œä¸æ˜¯å¯¹è±¡çš„ç»“æ„ã€‚ä¸€ä¸ªå®ä¾‹å¯¹è±¡çš„åœ°å€æŒ‡å‘çš„å°±æ˜¯è™šè¡¨ï¼Œæ‰€ä»¥ä»£ç ä¸­å®ä¾‹tç›´æ¥é€šè¿‡åç§»å¯ä»¥å¾—åˆ°å‡½æ•°åœ°å€ã€‚</p>
<p>å¦‚æœæˆ‘ä¿®æ”¹VMTä¸­çš„ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œå½“è¿™ä¸ªè¿™ä¸ªå‡½æ•°è¢«è°ƒç”¨çš„æ—¶å€™å°±è¾¾åˆ°äº†hookçš„æ•ˆæœã€‚åŸºäºè¿™ç§è™šè¡¨ï¼Œå¯ä»¥ä¿®æ”¹è¡¨çš„å†…å®¹ï¼Œå°±åƒIAT hookï¼Œæˆ–è€…ç›´æ¥hookè™šå‡½æ•°æœ¬èº«ï¼Œå°±ç±»ä¼¼inline hookçš„ã€‚</p>
<p>åŸºäºretourå†™ä¸€ä¸ªç±»ä¼¼inlinr hookçš„å°±å¯ä»¥</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#719e07">use</span> std::ptr::null;
</span></span><span style="display:flex;"><span><span style="color:#719e07">use</span> std::error::Error;
</span></span><span style="display:flex;"><span><span style="color:#719e07">use</span> std::mem;
</span></span><span style="display:flex;"><span><span style="color:#719e07">use</span> windows_sys::Win32::System::LibraryLoader::<span style="color:#719e07">*</span>;
</span></span><span style="display:flex;"><span><span style="color:#719e07">use</span> windows_sys::Win32::Foundation::{<span style="color:#cb4b16">BOOL</span>, <span style="color:#cb4b16">HANDLE</span>};
</span></span><span style="display:flex;"><span><span style="color:#719e07">use</span> std::os::raw::c_void;
</span></span><span style="display:flex;"><span><span style="color:#719e07">use</span> retour::static_detour;
</span></span><span style="display:flex;"><span><span style="color:#719e07">use</span> windows_sys::Win32::System::SystemServices::{
</span></span><span style="display:flex;"><span>    <span style="color:#cb4b16">DLL_PROCESS_ATTACH</span>, <span style="color:#cb4b16">DLL_PROCESS_DETACH</span>, <span style="color:#cb4b16">DLL_THREAD_ATTACH</span>, <span style="color:#cb4b16">DLL_THREAD_DETACH</span>,
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">static_detour!</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">static</span> HookIt: <span style="color:#268bd2">fn</span>(); 
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">type</span> <span style="color:#268bd2">BaseF1</span> <span style="color:#719e07">=</span> <span style="color:#719e07">fn</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">fn</span> <span style="color:#268bd2">get_func_address</span>(offset: <span style="color:#dc322f">usize</span>) -&gt; <span style="color:#268bd2">BaseF1</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">let</span> handle <span style="color:#719e07">=</span> <span style="color:#719e07">unsafe</span> { GetModuleHandleA(null()) <span style="color:#719e07">as</span> <span style="color:#dc322f">usize</span> };
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">unsafe</span> { mem::transmute::<span style="color:#719e07">&lt;</span><span style="color:#dc322f">usize</span>, BaseF1<span style="color:#719e07">&gt;</span>( offset <span style="color:#719e07">+</span> handle) }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">fn</span> <span style="color:#268bd2">detour</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">println!</span>(<span style="color:#2aa198">&#34;Ops hook it by mi1itray.axe&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">unsafe</span> <span style="color:#719e07">fn</span> <span style="color:#268bd2">main</span>() -&gt; <span style="color:#b58900">Result</span><span style="color:#719e07">&lt;</span>(), <span style="color:#b58900">Box</span><span style="color:#719e07">&lt;</span><span style="color:#719e07">dyn</span> Error<span style="color:#719e07">&gt;&gt;</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">let</span> func_1 <span style="color:#719e07">=</span> get_func_address(<span style="color:#2aa198">0x52c4</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">unsafe</span> { HookIt.initialize(func_1, detour)<span style="color:#719e07">?</span>.enable() }<span style="color:#719e07">?</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#b58900">Ok</span>(())
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">#[no_mangle]</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">unsafe</span> <span style="color:#719e07">extern</span> <span style="color:#2aa198">&#34;system&#34;</span> <span style="color:#719e07">fn</span> <span style="color:#268bd2">DllMain</span>(_hinst: <span style="color:#268bd2">HANDLE</span>, reason: <span style="color:#dc322f">u32</span>, _reserved: <span style="color:#719e07">*</span><span style="color:#719e07">mut</span> c_void) -&gt; <span style="color:#268bd2">BOOL</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">match</span> reason {
</span></span><span style="display:flex;"><span>        <span style="color:#cb4b16">DLL_PROCESS_ATTACH</span> <span style="color:#719e07">=&gt;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#268bd2">println!</span>(<span style="color:#2aa198">&#34;attaching&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">unsafe</span> { main().unwrap() }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#cb4b16">DLL_PROCESS_DETACH</span> <span style="color:#719e07">=&gt;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#268bd2">println!</span>(<span style="color:#2aa198">&#34;detaching&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#cb4b16">DLL_THREAD_ATTACH</span> <span style="color:#719e07">=&gt;</span> {}
</span></span><span style="display:flex;"><span>        <span style="color:#cb4b16">DLL_THREAD_DETACH</span> <span style="color:#719e07">=&gt;</span> {}
</span></span><span style="display:flex;"><span>        _ <span style="color:#719e07">=&gt;</span> {}
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">return</span> <span style="color:#cb4b16">BOOL</span>::from(<span style="color:#cb4b16">true</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="å‚è€ƒ">å‚è€ƒ</h1>
<p>
<a href="https://blog.csdn.net/kunyus/article/details/108884016" target="_blank" rel="noopener">ä½¿ç”¨Rustç¼–å†™ Windows dll å¹¶æ³¨å…¥è¿›ç¬¬ä¸‰æ–¹è¿›ç¨‹åå¯¹ Windows API MessageBoxW è¿›è¡Œ Hook | CSDN</a></p>
<p>
<a href="https://microsoft.github.io/windows-docs-rs/doc/windows/index.html" target="_blank" rel="noopener">windows-rs crate doc | microsoft.github.io</a></p>
<p>
<a href="https://blog.csdn.net/weixin_43695321/article/details/132241468" target="_blank" rel="noopener">rust x84 windowsç¼–è¯‘æŠ¥é”™ | CSDN</a></p>
<p>
<a href="https://www.ired.team/offensive-security/code-injection-process-injection/import-adress-table-iat-hooking" target="_blank" rel="noopener">Red Team note | ired.team</a></p>
<p>
<a href="https://github.com/Hpmason/retour-rs" target="_blank" rel="noopener">retour-rs | github.com</a></p>
<p>
<a href="https://www.cnblogs.com/Mered1th/p/10924545.html" target="_blank" rel="noopener">æ·±å…¥ç†è§£C++è™šå‡½æ•°è¡¨ | cnblogs.com</a></p>
<p>
<a href="https://zhuanlan.zhihu.com/p/75172640" target="_blank" rel="noopener">C++ è™šå‡½æ•°è¡¨å‰–æ | çŸ¥ä¹</a></p>
        </div>
        <footer>
  <p class="meta">
    <span class="byline author vcard">Posted by <span class="fn">Mi1itray.axe</span></span><time>Mar 22, 2024</time>
    
      <span class="categories">
        Tags:<a class="category" href="https://military-axe.github.io/tags/retour">retour</a>  <a class="category" href="https://military-axe.github.io/tags/inline-hook">inline hook</a>  <a class="category" href="https://military-axe.github.io/tags/vmt-hook">vmt hook</a>  <a class="category" href="https://military-axe.github.io/tags/iat-hook">iat hook</a>  <a class="category" href="https://military-axe.github.io/tags/rust">rust</a>  <a class="category" href="https://military-axe.github.io/tags/hook">hook</a>  
    
    </span>
  </p><p class="meta">
    
        <a class="basic-alignment left" href="https://military-axe.github.io/blog/2024-03-19-%E5%88%A9%E7%94%A8peb%E9%81%8D%E5%8E%86%E6%A8%A1%E5%9D%97%E9%93%BE%E8%A1%A8/" title="åˆ©ç”¨PEBéå†æ¨¡å—é“¾è¡¨">åˆ©ç”¨PEBéå†æ¨¡å—é“¾è¡¨</a>
    

    
      <a class="basic-alignment right" href="https://military-axe.github.io/blog/2024-04-29-%E5%8F%A5%E6%9F%84%E9%99%8D%E6%9D%83%E7%BB%95%E8%BF%87callbacks%E6%A3%80%E6%9F%A5/" title="å¥æŸ„é™æƒç»•è¿‡CallBacksæ£€æŸ¥">å¥æŸ„é™æƒç»•è¿‡CallBacksæ£€æŸ¥</a>
    
  </p>
  
  
</footer>


      </article>
    </div>
    <aside class="sidebar thirds">
  <section class="first odd">

    
      <h1>About</h1>
    

    <p>
      
        <p>mi1itray.axe&rsquo;s blog</p>
<p>This blog is mainly used to record my learning in the field of CTF. The main direction is Reverse.</p>
<p>You can use gpg to contact me, My public key in 
<a href="./gpg_publickey.asc">here</a></p>

      
    </p>
  </section><ul class="sidebar-nav">
  <li class="sidebar-nav-item">
    <a target="_blank" rel="noopener noreferrer" href="https://github.com/Military-axe" title="https://github.com/Military-axe"><i class="fa fa-github fa-3x"></i></a>
    
    
    
    
    
    
    
    
    
    
    </li>
</ul>
    
      <section class="odd">
        
          <h1>Friend Link</h1>
        
        
          <li>
            <a href="https://h0pe-ay.github.io/" title="h0pe" >h0pe</a>
          </li>
        
          <li>
            <a href="https://lindll.github.io/" title="l0ck" >l0ck</a>
          </li>
        
          <li>
            <a href="https://www.cnblogs.com/Ar3sh1" title="Ar3sh1" >Ar3sh1</a>
          </li>
        
          <li>
            <a href="https://github.com/WyHlj" title="Char0n" >Char0n</a>
          </li>
        
          <li>
            <a href="https://southsea.st/" title="southsea" >southsea</a>
          </li>
        
      </section>
    
  
    
      <section class="even">
        <h1>Recent Posts</h1>
        <ul id="recent_posts">
          
          
            
              <li class="post">
                <a href="/blog/2025-01-25-llvm-base-development-environment-configuration/">llvm base development environment configuration</a>
              </li>
            
          
            
          
            
              <li class="post">
                <a href="/blog/2025-01-10-c-static-polymorphism-curiously-recurring-template-pattern/">C&#43;&#43; static polymorphism &amp;&amp; Curiously recurring template pattern</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2024-05-30-windows%E8%BF%9B%E7%A8%8B%E9%9A%90%E8%97%8F%E5%88%9D%E6%8E%A2/">Windowsè¿›ç¨‹éšè—åˆæ¢</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2024-05-06-%E9%80%9A%E8%BF%87%E4%BF%AE%E6%94%B9%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98%E5%AE%9E%E7%8E%B0%E8%B7%A8%E8%BF%9B%E7%A8%8B%E5%86%85%E5%AD%98%E8%AF%BB%E5%86%99/">é€šè¿‡ä¿®æ”¹ç‰©ç†å†…å­˜å®ç°è·¨è¿›ç¨‹å†…å­˜è¯»å†™</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2024-04-29-%E5%8F%A5%E6%9F%84%E9%99%8D%E6%9D%83%E7%BB%95%E8%BF%87callbacks%E6%A3%80%E6%9F%A5/">å¥æŸ„é™æƒç»•è¿‡CallBacksæ£€æŸ¥</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2024-03-22-rust%E7%BC%96%E5%86%99%E5%87%A0%E7%A7%8Dhook%E7%9A%84%E6%96%B9%E5%BC%8F/">Rustç¼–å†™å‡ ç§hookçš„æ–¹å¼</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2024-03-19-%E5%88%A9%E7%94%A8peb%E9%81%8D%E5%8E%86%E6%A8%A1%E5%9D%97%E9%93%BE%E8%A1%A8/">åˆ©ç”¨PEBéå†æ¨¡å—é“¾è¡¨</a>
              </li>
            
          
        </ul>
      </section>
    
  
</aside>

  </div>
</div>

    <footer role="contentinfo">
      <p>Copyright &copy; 2025 Mi1itray.axe - <a href="https://military-axe.github.io/license/">License</a> -
        <span class="credit">Powered by <a target="_blank" href="https://gohugo.io" rel="noopener noreferrer">Hugo</a> and <a target="_blank" href="https://github.com/parsiya/hugo-octopress/" rel="noopener noreferrer">Hugo-Octopress</a> theme.
      </p>
    </footer>
  </body>
</html>

