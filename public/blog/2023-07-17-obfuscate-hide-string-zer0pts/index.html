<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1">

  
      <link href="/css/fonts.css" rel="stylesheet" type="text/css">
    
  <title>Obfuscate hide string &amp;&amp; zer0pts</title><link rel="stylesheet" href="/css/hugo-octopress.css">

  
    <link rel="stylesheet" href="/css/fork-awesome.min.css">
  
    <link href="https://military-axe.github.io/favicon.png" rel="icon">
  

  <meta name="description" content="" />
  <meta name="keywords" content="">
  <meta name="author" content="Mi1itray.axe"><meta name="generator" content="Hugo 0.153.2">

</head>
<body><header role="banner"><hgroup><h1><a href="https://military-axe.github.io/">Mi1itray.axe</a></h1>
    <h2>mi1itray.axe@gmail.com</h2>
</hgroup></header><nav role="navigation"><fieldset class="mobile-nav"><select onchange="location = this.value;">
    <option value="">Navigate…</option>
      
        <option value="https://military-axe.github.io/">» Blog</option>
      
        <option value="https://military-axe.github.io/categories">» Categories</option>
      
        <option value="https://military-axe.github.io/tags">» Tags</option>
      
  </select>
</fieldset><ul class="main-navigation">
    
      <li><a href="https://military-axe.github.io/" title="Blog">Blog</a></li>
    
  
    
      <li><a href="https://military-axe.github.io/categories" title="Categories"  target="_blank"  rel="noopener noreferrer">Categories</a></li>
    
  
    
      <li><a href="https://military-axe.github.io/tags" title="Tags"  target="_blank"  rel="noopener noreferrer">Tags</a></li>
    
  
</ul>

<ul class="subscription">
  
    
        <a href="https://military-axe.github.io/index.xml" target="_blank" type="application/rss+xml" title="RSS" rel="noopener noreferrer"><i class="fa fa-rss-square fa-lg"></i></a>
    
  
</ul>


  <form action="https://www.google.com/search" method="get" target="_blank" rel="noopener noreferrer">
    <fieldset role="search">
      <input class="search" type="text" name="q" results="0" placeholder="Search"/>
      <input type="hidden" name="q" value="site:https://military-axe.github.io/" />
    </fieldset>
  </form>

</nav>


<div id="main">
  <div id="content">
    <div>
      <article class="hentry" role="article">

        
        <header>
  <p class="meta">Jul 17, 2023
     - 8 minute read - <a class="label" href="https://military-axe.github.io/categories/reverse/">Reverse </a>
    
  </p>
  <h1 class="entry-title">
     Obfuscate hide string &amp;&amp; zer0pts 
  </h1>
</header>


        <div class="entry-content">
          
            <nav id="TableOfContents">
  <ul>
    <li><a href="#obfuscate-项目使用">Obfuscate 项目使用</a></li>
    <li><a href="#zer0pts-mimikyu">zer0pts mimikyu</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>
          
          <p>Obfuscate项目是用于隐藏字符串，增加分析的难度，但是Obfuscate只能对抗静态的分析。zer0pts比赛中的一题就是利用这个项目，但是它很巧妙，隐藏的是模块的函数名，主要逻辑是调用so文件的模块，它隐藏so中的函数名后，从静态分析是很难看出来调用的逻辑是什么，忽然感觉这个项目就有点用了。</p>
<h1 id="obfuscate-项目使用">Obfuscate 项目使用</h1>
<p>github地址：
<a href="https://github.com/adamyaxley/Obfuscate" target="_blank" rel="noopener">adamyaxley/Obfuscate: Guaranteed compile-time string literal obfuscation header-only library for C++14 (github.com)</a></p>
<p>这个项目是对字符串进行加密与解密的一个项目，使用非常简单。</p>
<ol>
<li>复制<code>obfuscate.h</code> 到项目中并include进去</li>
<li>封装字符串<code>AY_OBFUSCATE(&quot;My String&quot;)</code></li>
</ol>
<p>源码</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#719e07">#include</span> <span style="color:#719e07">&lt;iostream&gt;</span><span style="color:#719e07">
</span></span></span><span style="display:flex;"><span><span style="color:#719e07">#include</span> <span style="color:#719e07">&lt;string&gt;</span><span style="color:#719e07">
</span></span></span><span style="display:flex;"><span><span style="color:#719e07">#include</span> <span style="color:#719e07">&#34;obfuscate.h&#34;</span><span style="color:#719e07">
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#dc322f">int</span> <span style="color:#268bd2">main</span>() 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">const</span> std<span style="color:#719e07">::</span>string username(AY_OBFUSCATE(<span style="color:#2aa198">&#34;root&#34;</span>));
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">const</span> std<span style="color:#719e07">::</span>string password(AY_OBFUSCATE(<span style="color:#2aa198">&#34;password&#34;</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	std<span style="color:#719e07">::</span>cout <span style="color:#719e07">&lt;&lt;</span> <span style="color:#2aa198">&#34;Obfuscate naive login example (bloat test)&#34;</span> <span style="color:#719e07">&lt;&lt;</span> std<span style="color:#719e07">::</span>endl;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	std<span style="color:#719e07">::</span>string input_username;
</span></span><span style="display:flex;"><span>	std<span style="color:#719e07">::</span>string input_password;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">while</span> (<span style="color:#b58900">true</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		std<span style="color:#719e07">::</span>cout <span style="color:#719e07">&lt;&lt;</span> <span style="color:#2aa198">&#34;Username: &#34;</span>;
</span></span><span style="display:flex;"><span>		std<span style="color:#719e07">::</span>cin <span style="color:#719e07">&gt;&gt;</span> input_username;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		std<span style="color:#719e07">::</span>cout <span style="color:#719e07">&lt;&lt;</span> <span style="color:#2aa198">&#34;Password: &#34;</span>;
</span></span><span style="display:flex;"><span>		std<span style="color:#719e07">::</span>cin <span style="color:#719e07">&gt;&gt;</span> input_password;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#719e07">if</span> (input_username <span style="color:#719e07">==</span> username <span style="color:#719e07">&amp;&amp;</span> input_password <span style="color:#719e07">==</span> password)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			std<span style="color:#719e07">::</span>cout <span style="color:#719e07">&lt;&lt;</span> <span style="color:#2aa198">&#34;Login success!&#34;</span> <span style="color:#719e07">&lt;&lt;</span> std<span style="color:#719e07">::</span>endl;
</span></span><span style="display:flex;"><span>			<span style="color:#719e07">break</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#719e07">else</span>
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			std<span style="color:#719e07">::</span>cout <span style="color:#719e07">&lt;&lt;</span> <span style="color:#2aa198">&#34;Login failure: unrecognised username and password&#34;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#2aa198">&#34;combination.&#34;</span> <span style="color:#719e07">&lt;&lt;</span> std<span style="color:#719e07">::</span>endl;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">return</span> <span style="color:#2aa198">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ida打开分析后，发现</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>	<span style="color:#719e07">const</span> std<span style="color:#719e07">::</span>string username(AY_OBFUSCATE(<span style="color:#2aa198">&#34;root&#34;</span>));
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">const</span> std<span style="color:#719e07">::</span>string password(AY_OBFUSCATE(<span style="color:#2aa198">&#34;password&#34;</span>));
</span></span></code></pre></div><p>中的两个字符串找不到了，他们无法被静态的找到了，但是动态运行起来后，还是可以在内存中找到这个字符串。所以这个项目只能防护静态分析字符串。</p>
<p>如果只是防护字符串，那还是挺鸡肋的。下面这题用这个隐藏需要调用的函数名，一次来做一个隐藏函数逻辑的方法有一点意思。</p>
<h1 id="zer0pts-mimikyu">zer0pts mimikyu</h1>
<p>题目地址：
<a href="https://github.com/Military-axe/ctf/tree/master/2023/mimikyu" target="_blank" rel="noopener">ctf/2023/mimikyu at master · Military-axe/ctf (github.com)</a></p>
<p>程序很直白，打开main函数看到几乎所有代码</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#dc322f">int</span> <span style="color:#268bd2">__cdecl</span> <span style="color:#268bd2">main</span>(<span style="color:#dc322f">int</span> argc, <span style="color:#719e07">const</span> <span style="color:#dc322f">char</span> <span style="color:#719e07">**</span>argv, <span style="color:#719e07">const</span> <span style="color:#dc322f">char</span> <span style="color:#719e07">**</span>envp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">__int64</span> v4; <span style="color:#586e75">// rdx
</span></span></span><span style="display:flex;"><span>  <span style="color:#268bd2">__int64</span> v5; <span style="color:#586e75">// rdx
</span></span></span><span style="display:flex;"><span>  <span style="color:#dc322f">unsigned</span> <span style="color:#268bd2">__int64</span> i; <span style="color:#586e75">// [rsp+18h] [rbp-78h]
</span></span></span><span style="display:flex;"><span>  <span style="color:#dc322f">unsigned</span> <span style="color:#268bd2">__int64</span> j; <span style="color:#586e75">// [rsp+20h] [rbp-70h]
</span></span></span><span style="display:flex;"><span>  <span style="color:#dc322f">unsigned</span> <span style="color:#268bd2">__int64</span> k; <span style="color:#586e75">// [rsp+28h] [rbp-68h]
</span></span></span><span style="display:flex;"><span>  <span style="color:#dc322f">char</span> <span style="color:#719e07">*</span>s; <span style="color:#586e75">// [rsp+30h] [rbp-60h]
</span></span></span><span style="display:flex;"><span>  <span style="color:#dc322f">void</span> <span style="color:#719e07">*</span>LibraryA; <span style="color:#586e75">// [rsp+40h] [rbp-50h]
</span></span></span><span style="display:flex;"><span>  <span style="color:#dc322f">void</span> <span style="color:#719e07">*</span>libgmp; <span style="color:#586e75">// [rsp+48h] [rbp-48h]
</span></span></span><span style="display:flex;"><span>  <span style="color:#dc322f">char</span> v12[<span style="color:#2aa198">16</span>]; <span style="color:#586e75">// [rsp+50h] [rbp-40h] BYREF
</span></span></span><span style="display:flex;"><span>  <span style="color:#dc322f">char</span> v13[<span style="color:#2aa198">16</span>]; <span style="color:#586e75">// [rsp+60h] [rbp-30h] BYREF
</span></span></span><span style="display:flex;"><span>  <span style="color:#dc322f">char</span> v14[<span style="color:#2aa198">24</span>]; <span style="color:#586e75">// [rsp+70h] [rbp-20h] BYREF
</span></span></span><span style="display:flex;"><span>  <span style="color:#dc322f">unsigned</span> <span style="color:#268bd2">__int64</span> v15; <span style="color:#586e75">// [rsp+88h] [rbp-8h]
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  v15 <span style="color:#719e07">=</span> <span style="color:#268bd2">__readfsqword</span>(<span style="color:#2aa198">0x28u</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">if</span> ( argc <span style="color:#719e07">&gt;</span> <span style="color:#2aa198">1</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    s <span style="color:#719e07">=</span> (<span style="color:#dc322f">char</span> <span style="color:#719e07">*</span>)argv[<span style="color:#2aa198">1</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">if</span> ( <span style="color:#268bd2">strlen</span>(s) <span style="color:#719e07">==</span> <span style="color:#2aa198">40</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      LibraryA <span style="color:#719e07">=</span> (<span style="color:#dc322f">void</span> <span style="color:#719e07">*</span>)<span style="color:#268bd2">LoadLibraryA</span>(<span style="color:#2aa198">&#34;libc.so.6&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">if</span> ( <span style="color:#719e07">!</span>LibraryA )
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2">__assert_fail</span>(<span style="color:#2aa198">&#34;hLibc != NULL&#34;</span>, <span style="color:#2aa198">&#34;main.c&#34;</span>, <span style="color:#2aa198">0x4Au</span>, <span style="color:#2aa198">&#34;main&#34;</span>);
</span></span><span style="display:flex;"><span>      libgmp <span style="color:#719e07">=</span> (<span style="color:#dc322f">void</span> <span style="color:#719e07">*</span>)<span style="color:#268bd2">LoadLibraryA</span>(<span style="color:#2aa198">&#34;libgmp.so&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">if</span> ( <span style="color:#719e07">!</span>libgmp )
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2">__assert_fail</span>(<span style="color:#2aa198">&#34;hGMP != NULL&#34;</span>, <span style="color:#2aa198">&#34;main.c&#34;</span>, <span style="color:#2aa198">0x4Cu</span>, <span style="color:#2aa198">&#34;main&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">ResolveModuleFunction</span>(libgmp, <span style="color:#2aa198">1907704461</span>, v12);
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">ResolveModuleFunction</span>(libgmp, <span style="color:#2aa198">1907704461</span>, v13);
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">ResolveModuleFunction</span>(libgmp, <span style="color:#2aa198">1907704461</span>, v14);
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">ResolveModuleFunction</span>(LibraryA, <span style="color:#719e07">-</span><span style="color:#2aa198">58821864</span>, <span style="color:#719e07">*</span>(<span style="color:#dc322f">unsigned</span> <span style="color:#dc322f">int</span> <span style="color:#719e07">*</span>)main);
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">ResolveModuleFunction</span>(LibraryA, <span style="color:#719e07">-</span><span style="color:#2aa198">1810257824</span>, _bss_start, <span style="color:#2aa198">0LL</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">printf</span>(<span style="color:#2aa198">&#34;Checking...&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">for</span> ( i <span style="color:#719e07">=</span> <span style="color:#2aa198">0LL</span>; i <span style="color:#719e07">&lt;</span> <span style="color:#2aa198">0x28</span>; <span style="color:#719e07">++</span>i )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">if</span> ( <span style="color:#719e07">!</span>(<span style="color:#dc322f">unsigned</span> <span style="color:#dc322f">int</span>)<span style="color:#268bd2">ResolveModuleFunction</span>(LibraryA, <span style="color:#2aa198">1317667610</span>, (<span style="color:#dc322f">unsigned</span> <span style="color:#dc322f">int</span>)s[i]) )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>LABEL_21:
</span></span><span style="display:flex;"><span>          <span style="color:#268bd2">puts</span>(<span style="color:#2aa198">&#34;</span><span style="color:#cb4b16">\n</span><span style="color:#2aa198">Wrong.&#34;</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#719e07">goto</span> LABEL_22;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">for</span> ( j <span style="color:#719e07">=</span> <span style="color:#2aa198">0LL</span>; j <span style="color:#719e07">&lt;</span> <span style="color:#2aa198">0x28</span>; j <span style="color:#719e07">+=</span> <span style="color:#2aa198">4LL</span> )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2">ResolveModuleFunction</span>(libgmp, <span style="color:#719e07">-</span><span style="color:#2aa198">249367710</span>, v13, <span style="color:#2aa198">1LL</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">for</span> ( k <span style="color:#719e07">=</span> <span style="color:#2aa198">0LL</span>; k <span style="color:#719e07">&lt;=</span> <span style="color:#2aa198">2</span>; <span style="color:#719e07">++</span>k )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#268bd2">ResolveModuleFunction</span>(LibraryA, <span style="color:#2aa198">13994153</span>, <span style="color:#2aa198">46LL</span>);
</span></span><span style="display:flex;"><span>          v4 <span style="color:#719e07">=</span> (<span style="color:#dc322f">int</span>)<span style="color:#268bd2">ResolveModuleFunction</span>(LibraryA, <span style="color:#2aa198">2070735453</span>) <span style="color:#719e07">%</span> <span style="color:#2aa198">0x10000</span>;
</span></span><span style="display:flex;"><span>          <span style="color:#268bd2">cap</span>(LibraryA, libgmp, v4, v12);
</span></span><span style="display:flex;"><span>          <span style="color:#268bd2">ResolveModuleFunction</span>(libgmp, <span style="color:#2aa198">880641627</span>, v13, v13, v12);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2">ResolveModuleFunction</span>(LibraryA, <span style="color:#2aa198">13994153</span>, <span style="color:#2aa198">46LL</span>);
</span></span><span style="display:flex;"><span>        v5 <span style="color:#719e07">=</span> (<span style="color:#dc322f">int</span>)<span style="color:#268bd2">ResolveModuleFunction</span>(LibraryA, <span style="color:#2aa198">2070735453</span>) <span style="color:#719e07">%</span> <span style="color:#2aa198">0x10000</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2">cap</span>(LibraryA, libgmp, v5, v14);
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2">ResolveModuleFunction</span>(libgmp, <span style="color:#719e07">-</span><span style="color:#2aa198">249367710</span>, v12, <span style="color:#719e07">*</span>(<span style="color:#dc322f">unsigned</span> <span style="color:#dc322f">int</span> <span style="color:#719e07">*</span>)<span style="color:#719e07">&amp;</span>s[j]);
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2">ResolveModuleFunction</span>(libgmp, <span style="color:#719e07">-</span><span style="color:#2aa198">1876728194</span>, v12, v12, v14, v13);
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">if</span> ( (<span style="color:#dc322f">unsigned</span> <span style="color:#dc322f">int</span>)<span style="color:#268bd2">ResolveModuleFunction</span>(libgmp, <span style="color:#719e07">-</span><span style="color:#2aa198">1309138724</span>, v12, encoded[j <span style="color:#719e07">&gt;&gt;</span> <span style="color:#2aa198">2</span>]) )
</span></span><span style="display:flex;"><span>          <span style="color:#719e07">goto</span> LABEL_21;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">puts</span>(<span style="color:#2aa198">&#34;</span><span style="color:#cb4b16">\n</span><span style="color:#2aa198">Correct!&#34;</span>);
</span></span><span style="display:flex;"><span>LABEL_22:
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">ResolveModuleFunction</span>(libgmp, <span style="color:#2aa198">835473311</span>, v12);<span style="color:#586e75">// gmpz_clean
</span></span></span><span style="display:flex;"><span>      <span style="color:#268bd2">ResolveModuleFunction</span>(libgmp, <span style="color:#2aa198">835473311</span>, v13);<span style="color:#586e75">// gmpz_clean
</span></span></span><span style="display:flex;"><span>      <span style="color:#268bd2">ResolveModuleFunction</span>(libgmp, <span style="color:#2aa198">835473311</span>, v14);<span style="color:#586e75">// gmpz_clean
</span></span></span><span style="display:flex;"><span>      <span style="color:#268bd2">CloseHandle</span>(LibraryA);
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">CloseHandle</span>(libgmp);
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">return</span> <span style="color:#2aa198">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">puts</span>(<span style="color:#2aa198">&#34;Nowhere near close.&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">return</span> <span style="color:#2aa198">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">else</span>
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">printf</span>(<span style="color:#2aa198">&#34;Usage: %s FLAG</span><span style="color:#cb4b16">\n</span><span style="color:#2aa198">&#34;</span>, <span style="color:#719e07">*</span>argv);
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">return</span> <span style="color:#2aa198">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>会发现<code>ResolveModuleFunction</code>函数调用两个so文件模块。其实也可以才出来，应该是调用模块中的函数做一个运算吗，但是用<code>ResolveModuleFunction</code>来隐藏具体调用的是哪个函数。</p>
<p>接下来打开<code>ResolveModuleFunction</code>函数，看看这个函数做了什么</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#268bd2">__int64</span> <span style="color:#268bd2">ResolveModuleFunction</span>(<span style="color:#dc322f">void</span> <span style="color:#719e07">*</span>a1, <span style="color:#dc322f">int</span> a2, ...)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">__int64</span> v2; <span style="color:#586e75">// rax
</span></span></span><span style="display:flex;"><span>  <span style="color:#268bd2">__int64</span> <span style="color:#719e07">*</span>overflow_arg_area; <span style="color:#586e75">// rax
</span></span></span><span style="display:flex;"><span>  <span style="color:#dc322f">int</span> v5; <span style="color:#586e75">// [rsp+18h] [rbp-158h]
</span></span></span><span style="display:flex;"><span>  <span style="color:#dc322f">int</span> j; <span style="color:#586e75">// [rsp+1Ch] [rbp-154h]
</span></span></span><span style="display:flex;"><span>  <span style="color:#dc322f">int</span> k; <span style="color:#586e75">// [rsp+20h] [rbp-150h]
</span></span></span><span style="display:flex;"><span>  <span style="color:#dc322f">int</span> v8; <span style="color:#586e75">// [rsp+24h] [rbp-14Ch]
</span></span></span><span style="display:flex;"><span>  <span style="color:#268bd2">__int64</span> v9; <span style="color:#586e75">// [rsp+28h] [rbp-148h] BYREF
</span></span></span><span style="display:flex;"><span>  <span style="color:#268bd2">__int64</span> v10; <span style="color:#586e75">// [rsp+30h] [rbp-140h]
</span></span></span><span style="display:flex;"><span>  <span style="color:#268bd2">__int64</span> v11; <span style="color:#586e75">// [rsp+38h] [rbp-138h]
</span></span></span><span style="display:flex;"><span>  <span style="color:#268bd2">__int64</span> v12; <span style="color:#586e75">// [rsp+40h] [rbp-130h]
</span></span></span><span style="display:flex;"><span>  <span style="color:#268bd2">__int64</span> <span style="color:#719e07">*</span>i; <span style="color:#586e75">// [rsp+48h] [rbp-128h]
</span></span></span><span style="display:flex;"><span>  <span style="color:#dc322f">unsigned</span> <span style="color:#dc322f">int</span> <span style="color:#719e07">*</span>v14; <span style="color:#586e75">// [rsp+50h] [rbp-120h]
</span></span></span><span style="display:flex;"><span>  <span style="color:#dc322f">char</span> <span style="color:#719e07">*</span>name; <span style="color:#586e75">// [rsp+58h] [rbp-118h]
</span></span></span><span style="display:flex;"><span>  <span style="color:#268bd2">__int64</span> (<span style="color:#268bd2">__fastcall</span> <span style="color:#719e07">*</span>v16)(<span style="color:#268bd2">__int64</span>, <span style="color:#268bd2">__int64</span>, <span style="color:#268bd2">__int64</span>, <span style="color:#268bd2">__int64</span>, <span style="color:#268bd2">__int64</span>, <span style="color:#268bd2">__int64</span>); <span style="color:#586e75">// [rsp+60h] [rbp-110h]
</span></span></span><span style="display:flex;"><span>  gcc_va_list va; <span style="color:#586e75">// [rsp+68h] [rbp-108h] BYREF
</span></span></span><span style="display:flex;"><span>  <span style="color:#268bd2">__int64</span> v18[<span style="color:#2aa198">8</span>]; <span style="color:#586e75">// [rsp+80h] [rbp-F0h]
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">va_start</span>(va, a2);
</span></span><span style="display:flex;"><span>  v18[<span style="color:#2aa198">7</span>] <span style="color:#719e07">=</span> <span style="color:#268bd2">__readfsqword</span>(<span style="color:#2aa198">0x28u</span>);
</span></span><span style="display:flex;"><span>  v9 <span style="color:#719e07">=</span> <span style="color:#2aa198">0LL</span>;
</span></span><span style="display:flex;"><span>  v12 <span style="color:#719e07">=</span> <span style="color:#2aa198">0LL</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">if</span> ( <span style="color:#719e07">!</span>(<span style="color:#dc322f">unsigned</span> <span style="color:#dc322f">int</span>)<span style="color:#268bd2">GetModuleInformation</span>(a1, <span style="color:#719e07">&amp;</span>v9) )
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">__assert_fail</span>(<span style="color:#2aa198">&#34;GetModuleInformation(hModule, &amp;lpmodinfo)&#34;</span>, <span style="color:#2aa198">&#34;obfuscate.h&#34;</span>, <span style="color:#2aa198">0x71u</span>, <span style="color:#2aa198">&#34;ResolveModuleFunction&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">for</span> ( i <span style="color:#719e07">=</span> <span style="color:#719e07">*</span>(<span style="color:#268bd2">__int64</span> <span style="color:#719e07">**</span>)(v9 <span style="color:#719e07">+</span> <span style="color:#2aa198">16</span>); <span style="color:#719e07">*</span>i; i <span style="color:#719e07">+=</span> <span style="color:#2aa198">2</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    v2 <span style="color:#719e07">=</span> <span style="color:#719e07">*</span>i;
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">if</span> ( <span style="color:#719e07">*</span>i <span style="color:#719e07">==</span> <span style="color:#2aa198">11</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      v5 <span style="color:#719e07">=</span> i[<span style="color:#2aa198">1</span>];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">else</span> <span style="color:#719e07">if</span> ( v2 <span style="color:#719e07">&lt;=</span> <span style="color:#2aa198">11</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">if</span> ( v2 <span style="color:#719e07">==</span> <span style="color:#2aa198">5</span> )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        v11 <span style="color:#719e07">=</span> i[<span style="color:#2aa198">1</span>];
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">else</span> <span style="color:#719e07">if</span> ( v2 <span style="color:#719e07">==</span> <span style="color:#2aa198">6</span> )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        v10 <span style="color:#719e07">=</span> i[<span style="color:#2aa198">1</span>];
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">dlerror</span>();
</span></span><span style="display:flex;"><span>  v8 <span style="color:#719e07">=</span> v11 <span style="color:#719e07">-</span> v10;
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">for</span> ( j <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>; j <span style="color:#719e07">&lt;</span> v8 <span style="color:#719e07">/</span> v5; <span style="color:#719e07">++</span>j )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    v14 <span style="color:#719e07">=</span> (<span style="color:#dc322f">unsigned</span> <span style="color:#dc322f">int</span> <span style="color:#719e07">*</span>)(<span style="color:#2aa198">24LL</span> <span style="color:#719e07">*</span> j <span style="color:#719e07">+</span> v10);
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">if</span> ( (v14[<span style="color:#2aa198">1</span>] <span style="color:#719e07">&amp;</span> <span style="color:#2aa198">0xF</span>) <span style="color:#719e07">==</span> <span style="color:#2aa198">2</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      name <span style="color:#719e07">=</span> (<span style="color:#dc322f">char</span> <span style="color:#719e07">*</span>)(<span style="color:#719e07">*</span>v14 <span style="color:#719e07">+</span> v11);
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">if</span> ( a2 <span style="color:#719e07">==</span> (<span style="color:#dc322f">unsigned</span> <span style="color:#dc322f">int</span>)<span style="color:#268bd2">CryptGetHashParam</span>(name) )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        v16 <span style="color:#719e07">=</span> (<span style="color:#268bd2">__int64</span> (<span style="color:#268bd2">__fastcall</span> <span style="color:#719e07">*</span>)(<span style="color:#268bd2">__int64</span>, <span style="color:#268bd2">__int64</span>, <span style="color:#268bd2">__int64</span>, <span style="color:#268bd2">__int64</span>, <span style="color:#268bd2">__int64</span>, <span style="color:#268bd2">__int64</span>))<span style="color:#268bd2">dlsym</span>(a1, name);
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">if</span> ( <span style="color:#268bd2">dlerror</span>() )
</span></span><span style="display:flex;"><span>          <span style="color:#268bd2">BUG</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">for</span> ( k <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>; k <span style="color:#719e07">&lt;=</span> <span style="color:#2aa198">5</span>; <span style="color:#719e07">++</span>k )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#719e07">if</span> ( va[<span style="color:#2aa198">0</span>].gp_offset <span style="color:#719e07">&gt;</span> <span style="color:#2aa198">0x2F</span> )
</span></span><span style="display:flex;"><span>          {
</span></span><span style="display:flex;"><span>            overflow_arg_area <span style="color:#719e07">=</span> (<span style="color:#268bd2">__int64</span> <span style="color:#719e07">*</span>)va[<span style="color:#2aa198">0</span>].overflow_arg_area;
</span></span><span style="display:flex;"><span>            va[<span style="color:#2aa198">0</span>].overflow_arg_area <span style="color:#719e07">=</span> (<span style="color:#dc322f">char</span> <span style="color:#719e07">*</span>)va[<span style="color:#2aa198">0</span>].overflow_arg_area <span style="color:#719e07">+</span> <span style="color:#2aa198">8</span>;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          <span style="color:#719e07">else</span>
</span></span><span style="display:flex;"><span>          {
</span></span><span style="display:flex;"><span>            overflow_arg_area <span style="color:#719e07">=</span> (<span style="color:#268bd2">__int64</span> <span style="color:#719e07">*</span>)((<span style="color:#dc322f">char</span> <span style="color:#719e07">*</span>)va[<span style="color:#2aa198">0</span>].reg_save_area <span style="color:#719e07">+</span> va[<span style="color:#2aa198">0</span>].gp_offset);
</span></span><span style="display:flex;"><span>            va[<span style="color:#2aa198">0</span>].gp_offset <span style="color:#719e07">+=</span> <span style="color:#2aa198">8</span>;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          v18[k] <span style="color:#719e07">=</span> <span style="color:#719e07">*</span>overflow_arg_area;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">return</span> <span style="color:#268bd2">v16</span>(v18[<span style="color:#2aa198">0</span>], v18[<span style="color:#2aa198">1</span>], v18[<span style="color:#2aa198">2</span>], v18[<span style="color:#2aa198">3</span>], v18[<span style="color:#2aa198">4</span>], v18[<span style="color:#2aa198">5</span>]);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">return</span> v12;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>可以看到很关键的两句，一句是</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>v16 <span style="color:#719e07">=</span> (<span style="color:#268bd2">__int64</span> (<span style="color:#268bd2">__fastcall</span> <span style="color:#719e07">*</span>)(<span style="color:#268bd2">__int64</span>, <span style="color:#268bd2">__int64</span>, <span style="color:#268bd2">__int64</span>, <span style="color:#268bd2">__int64</span>, <span style="color:#268bd2">__int64</span>, <span style="color:#268bd2">__int64</span>))<span style="color:#268bd2">dlsym</span>(a1, name);
</span></span></code></pre></div><p>一句是</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span> <span style="color:#719e07">return</span> <span style="color:#268bd2">v16</span>(v18[<span style="color:#2aa198">0</span>], v18[<span style="color:#2aa198">1</span>], v18[<span style="color:#2aa198">2</span>], v18[<span style="color:#2aa198">3</span>], v18[<span style="color:#2aa198">4</span>], v18[<span style="color:#2aa198">5</span>]);
</span></span></code></pre></div><p>可以知道，前面都是解密运算真正的函数名，然后调用<code>dlsym</code>就可以获取对应函数的指针，再调用函数指针来运行此函数，做到一个隐藏真正调用函数的过程。</p>
<p>既然知道了这个流程，也非常简单，查看每次调用<code>ResolveModuleFunction</code>时，在<code>dlsym(a1, name)</code>中的name参数，也就知道此时的<code>ResolveModuleFunction</code>等同于那个函数了。</p>
<p><img src="https://raw.githubusercontent.com/Military-axe/imgtable/main/202307171225131.png" alt="image-20230717122504520"></p>
<p>还原全部的调用后如下</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#dc322f">int</span> <span style="color:#268bd2">__cdecl</span> <span style="color:#268bd2">main</span>(<span style="color:#dc322f">int</span> argc, <span style="color:#719e07">const</span> <span style="color:#dc322f">char</span> <span style="color:#719e07">**</span>argv, <span style="color:#719e07">const</span> <span style="color:#dc322f">char</span> <span style="color:#719e07">**</span>envp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#268bd2">__int64</span> v4; <span style="color:#586e75">// rdx
</span></span></span><span style="display:flex;"><span>  <span style="color:#268bd2">__int64</span> v5; <span style="color:#586e75">// rdx
</span></span></span><span style="display:flex;"><span>  <span style="color:#dc322f">unsigned</span> <span style="color:#268bd2">__int64</span> i; <span style="color:#586e75">// [rsp+18h] [rbp-78h]
</span></span></span><span style="display:flex;"><span>  <span style="color:#dc322f">unsigned</span> <span style="color:#268bd2">__int64</span> j; <span style="color:#586e75">// [rsp+20h] [rbp-70h]
</span></span></span><span style="display:flex;"><span>  <span style="color:#dc322f">unsigned</span> <span style="color:#268bd2">__int64</span> k; <span style="color:#586e75">// [rsp+28h] [rbp-68h]
</span></span></span><span style="display:flex;"><span>  <span style="color:#dc322f">char</span> <span style="color:#719e07">*</span>s; <span style="color:#586e75">// [rsp+30h] [rbp-60h]
</span></span></span><span style="display:flex;"><span>  <span style="color:#dc322f">void</span> <span style="color:#719e07">*</span>LibraryA; <span style="color:#586e75">// [rsp+40h] [rbp-50h]
</span></span></span><span style="display:flex;"><span>  <span style="color:#dc322f">void</span> <span style="color:#719e07">*</span>libgmp; <span style="color:#586e75">// [rsp+48h] [rbp-48h]
</span></span></span><span style="display:flex;"><span>  <span style="color:#dc322f">char</span> v12[<span style="color:#2aa198">16</span>]; <span style="color:#586e75">// [rsp+50h] [rbp-40h] BYREF
</span></span></span><span style="display:flex;"><span>  <span style="color:#dc322f">char</span> v13[<span style="color:#2aa198">16</span>]; <span style="color:#586e75">// [rsp+60h] [rbp-30h] BYREF
</span></span></span><span style="display:flex;"><span>  <span style="color:#dc322f">char</span> v14[<span style="color:#2aa198">24</span>]; <span style="color:#586e75">// [rsp+70h] [rbp-20h] BYREF
</span></span></span><span style="display:flex;"><span>  <span style="color:#dc322f">unsigned</span> <span style="color:#268bd2">__int64</span> v15; <span style="color:#586e75">// [rsp+88h] [rbp-8h]
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  v15 <span style="color:#719e07">=</span> <span style="color:#268bd2">__readfsqword</span>(<span style="color:#2aa198">0x28u</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">if</span> ( argc <span style="color:#719e07">&gt;</span> <span style="color:#2aa198">1</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    s <span style="color:#719e07">=</span> (<span style="color:#dc322f">char</span> <span style="color:#719e07">*</span>)argv[<span style="color:#2aa198">1</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">if</span> ( <span style="color:#268bd2">strlen</span>(s) <span style="color:#719e07">==</span> <span style="color:#2aa198">40</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      LibraryA <span style="color:#719e07">=</span> (<span style="color:#dc322f">void</span> <span style="color:#719e07">*</span>)<span style="color:#268bd2">LoadLibraryA</span>(<span style="color:#2aa198">&#34;libc.so.6&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">if</span> ( <span style="color:#719e07">!</span>LibraryA )
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2">__assert_fail</span>(<span style="color:#2aa198">&#34;hLibc != NULL&#34;</span>, <span style="color:#2aa198">&#34;main.c&#34;</span>, <span style="color:#2aa198">0x4Au</span>, <span style="color:#2aa198">&#34;main&#34;</span>);
</span></span><span style="display:flex;"><span>      libgmp <span style="color:#719e07">=</span> (<span style="color:#dc322f">void</span> <span style="color:#719e07">*</span>)<span style="color:#268bd2">LoadLibraryA</span>(<span style="color:#2aa198">&#34;libgmp.so&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">if</span> ( <span style="color:#719e07">!</span>libgmp )
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2">__assert_fail</span>(<span style="color:#2aa198">&#34;hGMP != NULL&#34;</span>, <span style="color:#2aa198">&#34;main.c&#34;</span>, <span style="color:#2aa198">0x4Cu</span>, <span style="color:#2aa198">&#34;main&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">ResolveModuleFunction</span>(libgmp, <span style="color:#2aa198">1907704461</span>, v12);<span style="color:#586e75">// gmpz_init
</span></span></span><span style="display:flex;"><span>      <span style="color:#268bd2">ResolveModuleFunction</span>(libgmp, <span style="color:#2aa198">1907704461</span>, v13);<span style="color:#586e75">// gmpz_init
</span></span></span><span style="display:flex;"><span>      <span style="color:#268bd2">ResolveModuleFunction</span>(libgmp, <span style="color:#2aa198">1907704461</span>, v14);<span style="color:#586e75">// gmpz_init
</span></span></span><span style="display:flex;"><span>      <span style="color:#268bd2">ResolveModuleFunction</span>(LibraryA, <span style="color:#719e07">-</span><span style="color:#2aa198">58821864</span>, <span style="color:#719e07">*</span>(<span style="color:#dc322f">unsigned</span> <span style="color:#dc322f">int</span> <span style="color:#719e07">*</span>)main);<span style="color:#586e75">// srand
</span></span></span><span style="display:flex;"><span>      <span style="color:#268bd2">ResolveModuleFunction</span>(LibraryA, <span style="color:#719e07">-</span><span style="color:#2aa198">1810257824</span>, _bss_start, <span style="color:#2aa198">0LL</span>);<span style="color:#586e75">// setbuf
</span></span></span><span style="display:flex;"><span>      <span style="color:#268bd2">printf</span>(<span style="color:#2aa198">&#34;Checking...&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">for</span> ( i <span style="color:#719e07">=</span> <span style="color:#2aa198">0LL</span>; i <span style="color:#719e07">&lt;</span> <span style="color:#2aa198">0x28</span>; <span style="color:#719e07">++</span>i )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">if</span> ( <span style="color:#719e07">!</span>(<span style="color:#dc322f">unsigned</span> <span style="color:#dc322f">int</span>)<span style="color:#268bd2">ResolveModuleFunction</span>(LibraryA, <span style="color:#2aa198">1317667610</span>, (<span style="color:#dc322f">unsigned</span> <span style="color:#dc322f">int</span>)s[i]) )<span style="color:#586e75">// isprint
</span></span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>LABEL_21:
</span></span><span style="display:flex;"><span>          <span style="color:#268bd2">puts</span>(<span style="color:#2aa198">&#34;</span><span style="color:#cb4b16">\n</span><span style="color:#2aa198">Wrong.&#34;</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#719e07">goto</span> LABEL_22;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">for</span> ( j <span style="color:#719e07">=</span> <span style="color:#2aa198">0LL</span>; j <span style="color:#719e07">&lt;</span> <span style="color:#2aa198">0x28</span>; j <span style="color:#719e07">+=</span> <span style="color:#2aa198">4LL</span> )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2">ResolveModuleFunction</span>(libgmp, <span style="color:#719e07">-</span><span style="color:#2aa198">249367710</span>, v13, <span style="color:#2aa198">1LL</span>);<span style="color:#586e75">// gmpz_set_ui
</span></span></span><span style="display:flex;"><span>        <span style="color:#719e07">for</span> ( k <span style="color:#719e07">=</span> <span style="color:#2aa198">0LL</span>; k <span style="color:#719e07">&lt;=</span> <span style="color:#2aa198">2</span>; <span style="color:#719e07">++</span>k )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#268bd2">ResolveModuleFunction</span>(LibraryA, <span style="color:#2aa198">13994153</span>, <span style="color:#2aa198">&#39;.&#39;</span>);<span style="color:#586e75">// putchar
</span></span></span><span style="display:flex;"><span>          v4 <span style="color:#719e07">=</span> (<span style="color:#dc322f">int</span>)<span style="color:#268bd2">ResolveModuleFunction</span>(LibraryA, <span style="color:#2aa198">2070735453</span>) <span style="color:#719e07">%</span> <span style="color:#2aa198">0x10000</span>;<span style="color:#586e75">// rand
</span></span></span><span style="display:flex;"><span>          <span style="color:#268bd2">cap</span>(LibraryA, libgmp, v4, (<span style="color:#268bd2">__int64</span>)v12);
</span></span><span style="display:flex;"><span>          <span style="color:#268bd2">ResolveModuleFunction</span>(libgmp, <span style="color:#2aa198">880641627</span>, v13, v13, v12);<span style="color:#586e75">// gmpz_mul
</span></span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2">ResolveModuleFunction</span>(LibraryA, <span style="color:#2aa198">13994153</span>, <span style="color:#2aa198">&#39;.&#39;</span>);
</span></span><span style="display:flex;"><span>        v5 <span style="color:#719e07">=</span> (<span style="color:#dc322f">int</span>)<span style="color:#268bd2">ResolveModuleFunction</span>(LibraryA, <span style="color:#2aa198">2070735453</span>) <span style="color:#719e07">%</span> <span style="color:#2aa198">0x10000</span>;<span style="color:#586e75">// rand
</span></span></span><span style="display:flex;"><span>        <span style="color:#268bd2">cap</span>(LibraryA, libgmp, v5, (<span style="color:#268bd2">__int64</span>)v14);
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2">ResolveModuleFunction</span>(libgmp, <span style="color:#719e07">-</span><span style="color:#2aa198">249367710</span>, v12, <span style="color:#719e07">*</span>(<span style="color:#dc322f">unsigned</span> <span style="color:#dc322f">int</span> <span style="color:#719e07">*</span>)<span style="color:#719e07">&amp;</span>s[j]);<span style="color:#586e75">// gmpz_set_ui
</span></span></span><span style="display:flex;"><span>        <span style="color:#268bd2">ResolveModuleFunction</span>(libgmp, <span style="color:#719e07">-</span><span style="color:#2aa198">1876728194</span>, v12, v12, v14, v13);<span style="color:#586e75">// gmpz_pown
</span></span></span><span style="display:flex;"><span>        <span style="color:#719e07">if</span> ( (<span style="color:#dc322f">unsigned</span> <span style="color:#dc322f">int</span>)<span style="color:#268bd2">ResolveModuleFunction</span>(libgmp, <span style="color:#719e07">-</span><span style="color:#2aa198">1309138724</span>, v12, encoded[j <span style="color:#719e07">&gt;&gt;</span> <span style="color:#2aa198">2</span>]) )<span style="color:#586e75">// gmpz_cmp_ui
</span></span></span><span style="display:flex;"><span>          <span style="color:#719e07">goto</span> LABEL_21;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">puts</span>(<span style="color:#2aa198">&#34;</span><span style="color:#cb4b16">\n</span><span style="color:#2aa198">Correct!&#34;</span>);
</span></span><span style="display:flex;"><span>LABEL_22:
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">ResolveModuleFunction</span>(libgmp, <span style="color:#2aa198">835473311</span>, v12);<span style="color:#586e75">// gmpz_clean
</span></span></span><span style="display:flex;"><span>      <span style="color:#268bd2">ResolveModuleFunction</span>(libgmp, <span style="color:#2aa198">835473311</span>, v13);<span style="color:#586e75">// gmpz_clean
</span></span></span><span style="display:flex;"><span>      <span style="color:#268bd2">ResolveModuleFunction</span>(libgmp, <span style="color:#2aa198">835473311</span>, v14);<span style="color:#586e75">// gmpz_clean
</span></span></span><span style="display:flex;"><span>      <span style="color:#268bd2">CloseHandle</span>(LibraryA);
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">CloseHandle</span>(libgmp);
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">return</span> <span style="color:#2aa198">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#268bd2">puts</span>(<span style="color:#2aa198">&#34;Nowhere near close.&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">return</span> <span style="color:#2aa198">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">else</span>
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">printf</span>(<span style="color:#2aa198">&#34;Usage: %s FLAG</span><span style="color:#cb4b16">\n</span><span style="color:#2aa198">&#34;</span>, <span style="color:#719e07">*</span>argv);
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">return</span> <span style="color:#2aa198">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>最重要的是下面这两句</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#268bd2">ResolveModuleFunction</span>(libgmp, <span style="color:#719e07">-</span><span style="color:#2aa198">249367710</span>, v12, <span style="color:#719e07">*</span>(<span style="color:#dc322f">unsigned</span> <span style="color:#dc322f">int</span> <span style="color:#719e07">*</span>)<span style="color:#719e07">&amp;</span>s[j]);<span style="color:#586e75">// gmpz_set_ui
</span></span></span><span style="display:flex;"><span><span style="color:#268bd2">ResolveModuleFunction</span>(libgmp, <span style="color:#719e07">-</span><span style="color:#2aa198">1876728194</span>, v12, v12, v14, v13);<span style="color:#586e75">// gmpz_pown
</span></span></span><span style="display:flex;"><span><span style="color:#719e07">if</span> ( (<span style="color:#dc322f">unsigned</span> <span style="color:#dc322f">int</span>)<span style="color:#268bd2">ResolveModuleFunction</span>(libgmp, <span style="color:#719e07">-</span><span style="color:#2aa198">1309138724</span>, v12, encoded[j <span style="color:#719e07">&gt;&gt;</span> <span style="color:#2aa198">2</span>]) )<span style="color:#586e75">// gmpz_cmp_ui
</span></span></span><span style="display:flex;"><span>     <span style="color:#719e07">goto</span> LABEL_21;
</span></span></code></pre></div><p>首先是读输入4个字符当做一个32bit数据，然后放入gmpz_pown中加密。其实libgmp是一个大数运算库，可以查到函数调声明的。</p>
<p><code>gmpz_pown</code>就和python中的pow函数类似，需要三个参数<code>pow(a, b, c)</code>计算的就是 \(a^b\bmod c\) 。</p>
<p>此时a是我们输入的值也就是flag，b，c可以通过动态调试获得。需要注意的值，调用的参数是一个结构体，所以通过查询文档，确定gmp库中调用参数类型结构体如下</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#dc322f">void</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">mpz_powm</span> (mpz_ptr r, mpz_srcptr b, mpz_srcptr e, mpz_srcptr m)<span style="color:#586e75">// 函数声明，结构体是mpz_t
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">typedef</span> __mpz_struct <span style="color:#719e07">*</span>mpz_ptr;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">typedef</span> <span style="color:#719e07">struct</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#dc322f">int</span> _mp_alloc;		<span style="color:#586e75">/* Number of *limbs* allocated and pointed
</span></span></span><span style="display:flex;"><span><span style="color:#586e75">				   to by the _mp_d field.  */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#dc322f">int</span> _mp_size;			<span style="color:#586e75">/* abs(_mp_size) is the number of limbs the
</span></span></span><span style="display:flex;"><span><span style="color:#586e75">				   last field points to.  If _mp_size is
</span></span></span><span style="display:flex;"><span><span style="color:#586e75">				   negative this is a negative number.  */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#dc322f">mp_limb_t</span> <span style="color:#719e07">*</span>_mp_d;		<span style="color:#586e75">/* Pointer to the limbs.  */</span>
</span></span><span style="display:flex;"><span>} __mpz_struct;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">typedef</span> <span style="color:#dc322f">unsigned</span> <span style="color:#dc322f">long</span> <span style="color:#dc322f">mp_limb_t</span>;
</span></span></code></pre></div><p>所以可以知道参数结构体中只有三个值，两个int类型，以及一个指针指向存储的内存。</p>
<p>在ida中定义结构体，然后修改三个参数的类型</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#2aa198">00000000</span> <span style="color:#dc322f">mpz_t</span> struc ; (<span style="color:#719e07">sizeof</span><span style="color:#719e07">=</span><span style="color:#2aa198">0x10</span>, mappedto_8) ; XREF: main<span style="color:#719e07">/</span>r
</span></span><span style="display:flex;"><span><span style="color:#2aa198">00000000</span>                                         ; main<span style="color:#719e07">/</span>r ...
</span></span><span style="display:flex;"><span><span style="color:#2aa198">00000000</span> _mp_alloc dd <span style="color:#719e07">?</span>
</span></span><span style="display:flex;"><span><span style="color:#2aa198">00000004</span> _mp_size dd <span style="color:#719e07">?</span>
</span></span><span style="display:flex;"><span><span style="color:#2aa198">0000000</span><span style="color:#2aa198">8</span> _mp_d dq <span style="color:#719e07">?</span>
</span></span><span style="display:flex;"><span><span style="color:#2aa198">00000010</span> <span style="color:#dc322f">mpz_t</span> ends
</span></span><span style="display:flex;"><span><span style="color:#2aa198">00000010</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#586e75">/// 修改类型
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#dc322f">mpz_t</span> v12; <span style="color:#586e75">// [rsp+50h] [rbp-40h] BYREF
</span></span></span><span style="display:flex;"><span>  <span style="color:#dc322f">mpz_t</span> v13; <span style="color:#586e75">// [rsp+60h] [rbp-30h] BYREF
</span></span></span><span style="display:flex;"><span>  <span style="color:#dc322f">mpz_t</span> v14; <span style="color:#586e75">// [rsp+70h] [rbp-20h] BYREF
</span></span></span></code></pre></div><p>再动调获取每次调用<code>gmpz_powm</code>的参数值，每次修改一下对比后的跳转，就可以继续调试获取值。获取的值如下</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>powm_argu <span style="color:#719e07">=</span> [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;exp&#34;</span><span style="color:#719e07">:</span> [<span style="color:#2aa198">0xD3</span>, <span style="color:#2aa198">0xF0</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;mod&#34;</span><span style="color:#719e07">:</span> [<span style="color:#2aa198">0xFF</span>, <span style="color:#2aa198">0x0D</span>, <span style="color:#2aa198">0x3A</span>, <span style="color:#2aa198">0xF2</span>, <span style="color:#2aa198">0x50</span>, <span style="color:#2aa198">0x23</span>]
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;exp&#34;</span><span style="color:#719e07">:</span> [<span style="color:#2aa198">0x5F</span>, <span style="color:#2aa198">0x08</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;mod&#34;</span><span style="color:#719e07">:</span> [<span style="color:#2aa198">0x33</span>, <span style="color:#2aa198">0x4D</span>, <span style="color:#2aa198">0x9D</span>, <span style="color:#2aa198">0x8E</span>, <span style="color:#2aa198">0xD1</span>, <span style="color:#2aa198">0x32</span>]
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;exp&#34;</span><span style="color:#719e07">:</span> [<span style="color:#2aa198">0x63</span>, <span style="color:#2aa198">0x8E</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;mod&#34;</span><span style="color:#719e07">:</span> [<span style="color:#2aa198">0x1B</span>, <span style="color:#2aa198">0x1F</span>, <span style="color:#2aa198">0xD7</span>, <span style="color:#2aa198">0x6C</span>, <span style="color:#2aa198">0x86</span>, <span style="color:#2aa198">0x03</span>]
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;exp&#34;</span><span style="color:#719e07">:</span> [<span style="color:#2aa198">0x49</span>, <span style="color:#2aa198">0x82</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;mod&#34;</span><span style="color:#719e07">:</span> [<span style="color:#2aa198">0x8F</span>, <span style="color:#2aa198">0xFC</span>, <span style="color:#2aa198">0xE3</span>, <span style="color:#2aa198">0x9B</span>, <span style="color:#2aa198">0xAE</span>, <span style="color:#2aa198">0x10</span>]
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;exp&#34;</span><span style="color:#719e07">:</span> [<span style="color:#2aa198">0xA1</span>, <span style="color:#2aa198">0xC6</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;mod&#34;</span><span style="color:#719e07">:</span> [<span style="color:#2aa198">0x7D</span>, <span style="color:#2aa198">0xF6</span>, <span style="color:#2aa198">0xEF</span>, <span style="color:#2aa198">0x42</span>, <span style="color:#2aa198">0xD9</span>, <span style="color:#2aa198">0x09</span>]
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;exp&#34;</span><span style="color:#719e07">:</span> [<span style="color:#2aa198">0x6D</span>, <span style="color:#2aa198">0x0C</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;mod&#34;</span><span style="color:#719e07">:</span> [<span style="color:#2aa198">0xB1</span>, <span style="color:#2aa198">0x8B</span>, <span style="color:#2aa198">0xAA</span>, <span style="color:#2aa198">0xE3</span>, <span style="color:#2aa198">0xE2</span>, <span style="color:#2aa198">0x1D</span>]
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;exp&#34;</span><span style="color:#719e07">:</span> [<span style="color:#2aa198">0xF5</span>, <span style="color:#2aa198">0xAE</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;mod&#34;</span><span style="color:#719e07">:</span> [<span style="color:#2aa198">0xF3</span>, <span style="color:#2aa198">0x41</span>, <span style="color:#2aa198">0x58</span>, <span style="color:#2aa198">0xC6</span>, <span style="color:#2aa198">0x3F</span>, <span style="color:#2aa198">0x10</span>]
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;exp&#34;</span><span style="color:#719e07">:</span> [<span style="color:#2aa198">0xDF</span>, <span style="color:#2aa198">0xD5</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;mod&#34;</span><span style="color:#719e07">:</span> [<span style="color:#2aa198">0xC9</span>, <span style="color:#2aa198">0xED</span>, <span style="color:#2aa198">0x70</span>, <span style="color:#2aa198">0x09</span>, <span style="color:#2aa198">0x1A</span>, <span style="color:#2aa198">0x01</span>]
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;exp&#34;</span><span style="color:#719e07">:</span> [<span style="color:#2aa198">0x8D</span>, <span style="color:#2aa198">0xE6</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;mod&#34;</span><span style="color:#719e07">:</span> [<span style="color:#2aa198">0x39</span>, <span style="color:#2aa198">0xDF</span>, <span style="color:#2aa198">0xBD</span>, <span style="color:#2aa198">0x20</span>, <span style="color:#2aa198">0x8D</span>, <span style="color:#2aa198">0x5F</span>]
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;exp&#34;</span><span style="color:#719e07">:</span> [<span style="color:#2aa198">0xFB</span>, <span style="color:#2aa198">0xF3</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;mod&#34;</span><span style="color:#719e07">:</span> [<span style="color:#2aa198">0xED</span>, <span style="color:#2aa198">0xE0</span>, <span style="color:#2aa198">0x11</span>, <span style="color:#2aa198">0x4E</span>, <span style="color:#2aa198">0xB1</span>, <span style="color:#2aa198">0x45</span>]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p>这是总过10次加密，每次不同的powm中的指数与模数。</p>
<p>调用gmpz_powm的加密很像rsa，那可以尝试按照rsa的解密方法来解密。先分解<code>mod</code>，通过代码中可以知道每个mod是3个因子相乘，每个小于0x10000，直接一路爆破过去，可以得到三个因子，然后就是欧拉函数与求逆了。变成了baby rsa的密码题了</p>
<p>exp:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#719e07">from</span> Crypto.Util.number <span style="color:#719e07">import</span> <span style="color:#719e07">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>powm_argu <span style="color:#719e07">=</span> [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;exp&#34;</span>: [<span style="color:#2aa198">0xD3</span>, <span style="color:#2aa198">0xF0</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;mod&#34;</span>: [<span style="color:#2aa198">0xFF</span>, <span style="color:#2aa198">0x0D</span>, <span style="color:#2aa198">0x3A</span>, <span style="color:#2aa198">0xF2</span>, <span style="color:#2aa198">0x50</span>, <span style="color:#2aa198">0x23</span>]
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;exp&#34;</span>: [<span style="color:#2aa198">0x5F</span>, <span style="color:#2aa198">0x08</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;mod&#34;</span>: [<span style="color:#2aa198">0x33</span>, <span style="color:#2aa198">0x4D</span>, <span style="color:#2aa198">0x9D</span>, <span style="color:#2aa198">0x8E</span>, <span style="color:#2aa198">0xD1</span>, <span style="color:#2aa198">0x32</span>]
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;exp&#34;</span>: [<span style="color:#2aa198">0x63</span>, <span style="color:#2aa198">0x8E</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;mod&#34;</span>: [<span style="color:#2aa198">0x1B</span>, <span style="color:#2aa198">0x1F</span>, <span style="color:#2aa198">0xD7</span>, <span style="color:#2aa198">0x6C</span>, <span style="color:#2aa198">0x86</span>, <span style="color:#2aa198">0x03</span>]
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;exp&#34;</span>: [<span style="color:#2aa198">0x49</span>, <span style="color:#2aa198">0x82</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;mod&#34;</span>: [<span style="color:#2aa198">0x8F</span>, <span style="color:#2aa198">0xFC</span>, <span style="color:#2aa198">0xE3</span>, <span style="color:#2aa198">0x9B</span>, <span style="color:#2aa198">0xAE</span>, <span style="color:#2aa198">0x10</span>]
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;exp&#34;</span>: [<span style="color:#2aa198">0xA1</span>, <span style="color:#2aa198">0xC6</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;mod&#34;</span>: [<span style="color:#2aa198">0x7D</span>, <span style="color:#2aa198">0xF6</span>, <span style="color:#2aa198">0xEF</span>, <span style="color:#2aa198">0x42</span>, <span style="color:#2aa198">0xD9</span>, <span style="color:#2aa198">0x09</span>]
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;exp&#34;</span>: [<span style="color:#2aa198">0x6D</span>, <span style="color:#2aa198">0x0C</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;mod&#34;</span>: [<span style="color:#2aa198">0xB1</span>, <span style="color:#2aa198">0x8B</span>, <span style="color:#2aa198">0xAA</span>, <span style="color:#2aa198">0xE3</span>, <span style="color:#2aa198">0xE2</span>, <span style="color:#2aa198">0x1D</span>]
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;exp&#34;</span>: [<span style="color:#2aa198">0xF5</span>, <span style="color:#2aa198">0xAE</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;mod&#34;</span>: [<span style="color:#2aa198">0xF3</span>, <span style="color:#2aa198">0x41</span>, <span style="color:#2aa198">0x58</span>, <span style="color:#2aa198">0xC6</span>, <span style="color:#2aa198">0x3F</span>, <span style="color:#2aa198">0x10</span>]
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;exp&#34;</span>: [<span style="color:#2aa198">0xDF</span>, <span style="color:#2aa198">0xD5</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;mod&#34;</span>: [<span style="color:#2aa198">0xC9</span>, <span style="color:#2aa198">0xED</span>, <span style="color:#2aa198">0x70</span>, <span style="color:#2aa198">0x09</span>, <span style="color:#2aa198">0x1A</span>, <span style="color:#2aa198">0x01</span>]
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;exp&#34;</span>: [<span style="color:#2aa198">0x8D</span>, <span style="color:#2aa198">0xE6</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;mod&#34;</span>: [<span style="color:#2aa198">0x39</span>, <span style="color:#2aa198">0xDF</span>, <span style="color:#2aa198">0xBD</span>, <span style="color:#2aa198">0x20</span>, <span style="color:#2aa198">0x8D</span>, <span style="color:#2aa198">0x5F</span>]
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;exp&#34;</span>: [<span style="color:#2aa198">0xFB</span>, <span style="color:#2aa198">0xF3</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;mod&#34;</span>: [<span style="color:#2aa198">0xED</span>, <span style="color:#2aa198">0xE0</span>, <span style="color:#2aa198">0x11</span>, <span style="color:#2aa198">0x4E</span>, <span style="color:#2aa198">0xB1</span>, <span style="color:#2aa198">0x45</span>]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>encodes <span style="color:#719e07">=</span> [<span style="color:#2aa198">0x00000FE4C025C5F4</span>, <span style="color:#2aa198">0x00001B792FF17E8A</span>, <span style="color:#2aa198">0x00000183B156AB40</span>, <span style="color:#2aa198">0x00000BEFFCF5E5DA</span>, <span style="color:#2aa198">0x00000297CF86E251</span>, <span style="color:#2aa198">0x00000EB3EDC1D4B4</span>, <span style="color:#2aa198">0x000000FA10CE3A08</span>, <span style="color:#2aa198">0x0000002BDD418672</span>, <span style="color:#2aa198">0x00005EBB5050EA46</span>, <span style="color:#2aa198">0x000005BF9B73CF86</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">def</span> <span style="color:#268bd2">factor</span>(x: <span style="color:#b58900">int</span>) <span style="color:#719e07">-&gt;</span> <span style="color:#b58900">list</span>[<span style="color:#b58900">int</span>]:
</span></span><span style="display:flex;"><span>    r <span style="color:#719e07">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">for</span> j <span style="color:#719e07">in</span> <span style="color:#b58900">range</span>(<span style="color:#2aa198">2</span>, <span style="color:#2aa198">0x10000</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">if</span> x<span style="color:#719e07">%</span>j<span style="color:#719e07">==</span><span style="color:#2aa198">0</span>:
</span></span><span style="display:flex;"><span>            r<span style="color:#719e07">.</span>append(j)
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">return</span> r
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">def</span> <span style="color:#268bd2">inv_x</span>(exp: <span style="color:#b58900">int</span>, r: <span style="color:#b58900">list</span>[<span style="color:#b58900">int</span>]) <span style="color:#719e07">-&gt;</span> <span style="color:#b58900">int</span>:
</span></span><span style="display:flex;"><span>    l <span style="color:#719e07">=</span> (r[<span style="color:#2aa198">0</span>]<span style="color:#719e07">-</span><span style="color:#2aa198">1</span>) <span style="color:#719e07">*</span> (r[<span style="color:#2aa198">1</span>]<span style="color:#719e07">-</span><span style="color:#2aa198">1</span>) <span style="color:#719e07">*</span> (r[<span style="color:#2aa198">2</span>]<span style="color:#719e07">-</span><span style="color:#2aa198">1</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">return</span> inverse(exp, l)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">def</span> <span style="color:#268bd2">dec</span>(c: <span style="color:#b58900">int</span>, x_inv: <span style="color:#b58900">int</span>, N: <span style="color:#b58900">int</span>):
</span></span><span style="display:flex;"><span>    m <span style="color:#719e07">=</span> <span style="color:#b58900">pow</span>(c, x_inv, N)
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">return</span> m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>flag <span style="color:#719e07">=</span> <span style="color:#2aa198">b</span><span style="color:#2aa198">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">for</span> i,k <span style="color:#719e07">in</span> <span style="color:#b58900">enumerate</span>(powm_argu):
</span></span><span style="display:flex;"><span>    x <span style="color:#719e07">=</span> <span style="color:#b58900">int</span><span style="color:#719e07">.</span>from_bytes(<span style="color:#b58900">bytes</span>(k[<span style="color:#2aa198">&#39;exp&#39;</span>]),<span style="color:#2aa198">&#39;little&#39;</span>)
</span></span><span style="display:flex;"><span>    N <span style="color:#719e07">=</span> <span style="color:#b58900">int</span><span style="color:#719e07">.</span>from_bytes(<span style="color:#b58900">bytes</span>(k[<span style="color:#2aa198">&#39;mod&#39;</span>]),<span style="color:#2aa198">&#39;little&#39;</span>)
</span></span><span style="display:flex;"><span>    r <span style="color:#719e07">=</span> factor(N)
</span></span><span style="display:flex;"><span>    x_inv <span style="color:#719e07">=</span> inv_x(x, r)
</span></span><span style="display:flex;"><span>    m <span style="color:#719e07">=</span> dec(encodes[i], x_inv, N)
</span></span><span style="display:flex;"><span>    flag <span style="color:#719e07">+=</span> long_to_bytes(m)[::<span style="color:#719e07">-</span><span style="color:#2aa198">1</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#b58900">print</span>(flag)    
</span></span></code></pre></div><p>flag: <code>zer0pts{L00k_th3_1nt3rn4l_0f_l1br4r13s!}</code></p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ./mimikyu zer0pts<span style="color:#719e07">{</span>L00k_th3_1nt3rn4l_0f_l1br4r13s!<span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span>Checking...........................................
</span></span><span style="display:flex;"><span>Correct!
</span></span></code></pre></div><h1 id="参考">参考</h1>
<p>
<a href="https://www.cnblogs.com/xinwang-coding/p/12803237.html" target="_blank" rel="noopener">GMP-C/C++（大数库）使用方法 - 新望 - 博客园 (cnblogs.com)</a></p>
<p>
<a href="https://github.com/adamyaxley/Obfuscate" target="_blank" rel="noopener">adamyaxley/Obfuscate: Guaranteed compile-time string literal obfuscation header-only library for C++14 (github.com)</a></p>
        </div>
        <footer>
  <p class="meta">
    <span class="byline author vcard">Posted by <span class="fn">Mi1itray.axe</span></span><time>Jul 17, 2023</time>
    
      <span class="categories">
        Tags:<a class="category" href="https://military-axe.github.io/tags/rsa">rsa</a>  <a class="category" href="https://military-axe.github.io/tags/obfuscate">obfuscate</a>  
    
    </span>
  </p><p class="meta">
    
        <a class="basic-alignment left" href="https://military-axe.github.io/blog/2023-07-07-frida-call-java-class/method-to-explode/" title="Frida call java class/method to explode">Frida call java class/method to explode</a>
    

    
      <a class="basic-alignment right" href="https://military-axe.github.io/blog/2023-07-23-khaos-the-impact-of-inter-procedural-code-obfuscation-on-binary-diffing-techniques/" title="Khaos: The Impact of Inter-procedural Code Obfuscation on Binary Diffing Techniques">Khaos: The Impact of Inter-procedural Code Obfuscation on Binary Diffing Techniques</a>
    
  </p>
  
  
</footer>


      </article>
    </div>
    <aside class="sidebar thirds">
  <section class="first odd">

    
      <h1>About</h1>
    

    <p>
      
        <p>mi1itray.axe&rsquo;s blog</p>
<p>This blog is mainly used to record my learning in the field of CTF. The main direction is Reverse.</p>
<p>You can use gpg to contact me, My public key in 
<a href="./gpg_publickey.asc">here</a></p>

      
    </p>
  </section><ul class="sidebar-nav">
  <li class="sidebar-nav-item">
    <a target="_blank" rel="noopener noreferrer" href="https://github.com/Military-axe" title="https://github.com/Military-axe"><i class="fa fa-github fa-3x"></i></a>
    
    
    
    
    
    
    
    
    
    
    </li>
</ul>
    
      <section class="odd">
        
          <h1>Friend Link</h1>
        
        
          <li>
            <a href="https://h0pe-ay.github.io/" title="h0pe" >h0pe</a>
          </li>
        
          <li>
            <a href="https://lindll.github.io/" title="l0ck" >l0ck</a>
          </li>
        
          <li>
            <a href="https://www.cnblogs.com/Ar3sh1" title="Ar3sh1" >Ar3sh1</a>
          </li>
        
          <li>
            <a href="https://github.com/WyHlj" title="Char0n" >Char0n</a>
          </li>
        
          <li>
            <a href="https://southsea.st/" title="southsea" >southsea</a>
          </li>
        
      </section>
    
  
    
      <section class="even">
        <h1>Recent Posts</h1>
        <ul id="recent_posts">
          
          
            
              <li class="post">
                <a href="/blog/2025-01-25-llvm-base-development-environment-configuration/">llvm base development environment configuration</a>
              </li>
            
          
            
          
            
              <li class="post">
                <a href="/blog/2025-01-10-c-static-polymorphism-curiously-recurring-template-pattern/">C&#43;&#43; static polymorphism &amp;&amp; Curiously recurring template pattern</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2024-05-30-windows%E8%BF%9B%E7%A8%8B%E9%9A%90%E8%97%8F%E5%88%9D%E6%8E%A2/">Windows进程隐藏初探</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2024-05-06-%E9%80%9A%E8%BF%87%E4%BF%AE%E6%94%B9%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98%E5%AE%9E%E7%8E%B0%E8%B7%A8%E8%BF%9B%E7%A8%8B%E5%86%85%E5%AD%98%E8%AF%BB%E5%86%99/">通过修改物理内存实现跨进程内存读写</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2024-04-29-%E5%8F%A5%E6%9F%84%E9%99%8D%E6%9D%83%E7%BB%95%E8%BF%87callbacks%E6%A3%80%E6%9F%A5/">句柄降权绕过CallBacks检查</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2024-03-22-rust%E7%BC%96%E5%86%99%E5%87%A0%E7%A7%8Dhook%E7%9A%84%E6%96%B9%E5%BC%8F/">Rust编写几种hook的方式</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2024-03-19-%E5%88%A9%E7%94%A8peb%E9%81%8D%E5%8E%86%E6%A8%A1%E5%9D%97%E9%93%BE%E8%A1%A8/">利用PEB遍历模块链表</a>
              </li>
            
          
        </ul>
      </section>
    
  
</aside>

  </div>
</div>

    <footer role="contentinfo">
      <p>Copyright &copy; 2025 Mi1itray.axe - <a href="https://military-axe.github.io/license/">License</a> -
        <span class="credit">Powered by <a target="_blank" href="https://gohugo.io" rel="noopener noreferrer">Hugo</a> and <a target="_blank" href="https://github.com/parsiya/hugo-octopress/" rel="noopener noreferrer">Hugo-Octopress</a> theme.
      </p>
    </footer>
  </body>
</html>

