<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1">

  
      <link href="/css/fonts.css" rel="stylesheet" type="text/css">
    
  <title>Windowsè¿›ç¨‹éšè—åˆæ¢</title><link rel="stylesheet" href="/css/hugo-octopress.css">

  
    <link rel="stylesheet" href="/css/fork-awesome.min.css">
  
    <link href="http://localhost:1313/favicon.png" rel="icon">
  

  <meta name="description" content="" />
  <meta name="keywords" content="">
  <meta name="author" content="Mi1itray.axe"><meta name="generator" content="Hugo 0.153.2">

</head>
<body><header role="banner"><hgroup><h1><a href="http://localhost:1313/">Mi1itray.axe</a></h1>
    <h2>mi1itray.axe@gmail.com</h2>
</hgroup></header><nav role="navigation"><fieldset class="mobile-nav"><select onchange="location = this.value;">
    <option value="">Navigateâ€¦</option>
      
        <option value="http://localhost:1313/">Â» Blog</option>
      
        <option value="http://localhost:1313/categories">Â» Categories</option>
      
        <option value="http://localhost:1313/tags">Â» Tags</option>
      
  </select>
</fieldset><ul class="main-navigation">
    
      <li><a href="http://localhost:1313/" title="Blog">Blog</a></li>
    
  
    
      <li><a href="http://localhost:1313/categories" title="Categories"  target="_blank"  rel="noopener noreferrer">Categories</a></li>
    
  
    
      <li><a href="http://localhost:1313/tags" title="Tags"  target="_blank"  rel="noopener noreferrer">Tags</a></li>
    
  
</ul>

<ul class="subscription">
  
    
        <a href="http://localhost:1313/index.xml" target="_blank" type="application/rss+xml" title="RSS" rel="noopener noreferrer"><i class="fa fa-rss-square fa-lg"></i></a>
    
  
</ul>


  <form action="https://www.google.com/search" method="get" target="_blank" rel="noopener noreferrer">
    <fieldset role="search">
      <input class="search" type="text" name="q" results="0" placeholder="Search"/>
      <input type="hidden" name="q" value="site:http://localhost:1313/" />
    </fieldset>
  </form>

</nav>


<div id="main">
  <div id="content">
    <div>
      <article class="hentry" role="article">

        
        <header>
  <p class="meta">May 30, 2024
     - 9 minute read - <a class="label" href="http://localhost:1313/categories/driver/">Driver </a>
    
  </p>
  <h1 class="entry-title">
     Windowsè¿›ç¨‹éšè—åˆæ¢ 
  </h1>
</header>


        <div class="entry-content">
          
            <nav id="TableOfContents">
  <ul>
    <li><a href="#windowsè¿›ç¨‹éšè—åˆæ¢">Windowsè¿›ç¨‹éšè—åˆæ¢</a>
      <ul>
        <li><a href="#r3éšè—ä¿¡æ¯">R3éšè—ä¿¡æ¯</a>
          <ul>
            <li><a href="#r3ä¼ªé€ ä¿¡æ¯">R3ä¼ªé€ ä¿¡æ¯</a></li>
            <li><a href="#r3æ¶ˆé™¤è¿›ç¨‹">R3æ¶ˆé™¤è¿›ç¨‹</a>
              <ul>
                <li><a href="#api-hook-hookä»»åŠ¡ç®¡ç†å™¨">[API hook] Hookä»»åŠ¡ç®¡ç†å™¨</a></li>
                <li><a href="#å…¨å±€hook-setwindowshookex">[å…¨å±€hook] SetWindowsHookEx</a></li>
                <li><a href="#å…¨å±€hook-hook-explorer">[å…¨å±€hook] Hook Explorer</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#r0éšè—ä¿¡æ¯">R0éšè—ä¿¡æ¯</a>
          <ul>
            <li><a href="#r0ä¼ªé€ ä¿¡æ¯">R0ä¼ªé€ ä¿¡æ¯</a></li>
            <li><a href="#r0æ¶ˆé™¤è¿›ç¨‹">R0æ¶ˆé™¤è¿›ç¨‹</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#æ€»ç»“æ€è€ƒ">æ€»ç»“æ€è€ƒ</a></li>
    <li><a href="#å‚è€ƒ">å‚è€ƒ</a></li>
  </ul>
</nav>
          
          <h1 id="windowsè¿›ç¨‹éšè—åˆæ¢">Windowsè¿›ç¨‹éšè—åˆæ¢</h1>
<p>ç›®çš„æ˜¯å°†æˆ‘ä»¬çš„è¿›ç¨‹ä¿¡æ¯ä¿®æ”¹ï¼Œè®©ä»»åŠ¡ç®¡ç†å™¨è¿™äº›æ— æ³•è¯»å–åˆ°åŸæœ¬çœŸå®çš„ä¿¡æ¯ï¼Œä»è€Œåšåˆ°éšè—æ•ˆæœã€‚æ¯”å¦‚å°†ç›®çš„è¿›ç¨‹ä¿®æ”¹æˆç³»ç»Ÿè¿›ç¨‹ä¿¡æ¯ã€‚</p>
<p>ä¸»è¦ä½¿ç”¨ä¸¤ä¸ªå±‚é¢éšè—</p>
<ul>
<li>
<p>R3çš„PEBä¸­éšè—ä¿¡æ¯</p>
</li>
<li>
<p>R0çš„_EPROCESSä¸­éšè—ä¿¡æ¯ã€‚</p>
</li>
</ul>
<p>éšè—æˆ‘ä»¬ä¹Ÿå¯ä»¥ä»ä¸¤ä¸ªæ–¹é¢æ¥çœ‹ï¼Œä¸€ç§æ˜¯ä¼ªé€ ä¿¡æ¯ï¼Œä¸€ç§æ˜¯æ¶ˆé™¤ä¿¡æ¯ã€‚ä¼ªé€ ä¿¡æ¯æ˜¯æŒ‡å°†ä¸€ä¸ªæŒ‡å®šè¿›ç¨‹ä¼ªé€ æˆå…¶ä»–è¿›ç¨‹ï¼Œæ¶ˆé™¤ä¿¡æ¯æ˜¯æŒ‡è®©ä»»åŠ¡ç®¡ç†å™¨è¿™ç§æ— æ³•è¯»å–åˆ°è¿™ä¸ªè¿›ç¨‹çš„ä¿¡æ¯ã€‚</p>
<h2 id="r3éšè—ä¿¡æ¯">R3éšè—ä¿¡æ¯</h2>
<h3 id="r3ä¼ªé€ ä¿¡æ¯">R3ä¼ªé€ ä¿¡æ¯</h3>
<p>æˆ‘çœ‹ä¸€äº›æ–‡ç« ä¸»è¦éšè—ä¿¡æ¯å¦‚ä¸‹(å®é™…ä¸Šä¸æ­¢ï¼Œä½†æ˜¯æ€è·¯æ˜¯ç±»ä¼¼çš„ï¼Œä½†æ˜¯æˆ‘æµ‹è¯•å‘ç°æ²¡æœ‰ä»€ä¹ˆå®é™…ä¸Šçš„ç”¨å¤„</p>
<ul>
<li>ç¨‹åºåç§°ImageBaseName</li>
<li>å‘½ä»¤è¡Œå‚æ•°CommandLine</li>
<li>ä¿®æ”¹ç”¨æˆ·ç»„</li>
</ul>
<p>æ€è·¯ä¹Ÿå¾ˆç®€å•ï¼Œè·å–PEBç»“æ„ä½“ï¼Œç„¶åä¿®æ”¹å¯¹åº”å­—æ®µçš„å†…å®¹ï¼Œè¿™é‡Œæˆ‘ç”¨Rustæ¥å†™ï¼Œrustè°ƒç”¨windowsåº“å‡½æ•°å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰å†™çš„
<a href="https://military-axe.github.io/posts/rustbian-xie-ji-chong-hookde-fang-shi/" target="_blank" rel="noopener">æ–‡ç« </a>ï¼Œè¿™é‡Œåªå†™æ€è·¯å’Œéƒ¨åˆ†ä»£ç ç‰‡æ®µï¼Œå®Œæ•´åœ¨é™„å½•ã€‚</p>
<p>è·å–æœ¬èº«è¿›ç¨‹çš„pebåœ°å€ï¼Œè¿™ä¸ªå¾ˆç®€å•ï¼Œå¤§ğŸ”¥éƒ½çŸ¥é“ï¼Œè¯»å–<code>gs:[60h]</code></p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#719e07">unsafe</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">asm!</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;mov {0}, gs:[0x60]&#34;</span>,
</span></span><span style="display:flex;"><span>        inout(reg) ppeb
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¦‚æœæ˜¯å°†è¿™ä¸ªä»£ç æ”¾åœ¨dllä¸­ï¼Œæ³¨å…¥è¿›å»éœ€è¦ä¼ªè£…çš„è¿›ç¨‹ä¹Ÿå¯ä»¥å®ç°è¯»å–pebçš„æ•ˆæœã€‚ä½†æ˜¯æˆ‘è¿™é‡Œè¿˜æ˜¯åå‘äºä¸ä½¿ç”¨æ³¨å…¥æ‰‹æ®µï¼Œå€¾å‘äºç›´æ¥ä¼ å…¥è¿›ç¨‹pidï¼Œç„¶åè·å–pebï¼Œè¿™é‡Œå¯ä»¥ä½¿ç”¨<code>ntdll.dll</code>ä¸­æœªå¯¼å‡ºçš„å‡½æ•°<code>NtQueryInformationProcess</code>ã€‚åœ¨rustä¸­å¯ä»¥ç›´æ¥ç”¨ï¼Œc++ä¸­éœ€è¦<code>GetProcAddress(Ntdll, &quot;NtQueryInformationProcess&quot;)</code>æ¥è·å–</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#719e07">fn</span> <span style="color:#268bd2">main</span>() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">let</span> handle <span style="color:#719e07">=</span> <span style="color:#719e07">unsafe</span> {
</span></span><span style="display:flex;"><span>        OpenProcess(<span style="color:#cb4b16">PROCESS_QUERY_INFORMATION</span> <span style="color:#719e07">|</span> <span style="color:#cb4b16">PROCESS_VM_READ</span>, <span style="color:#cb4b16">false</span>, <span style="color:#2aa198">9676</span>)
</span></span><span style="display:flex;"><span>            .expect(<span style="color:#2aa198">&#34;[!] OpenProcess error&#34;</span>)
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">let</span> <span style="color:#719e07">mut</span> pbi <span style="color:#719e07">=</span> <span style="color:#cb4b16">PROCESS_BASIC_INFORMATION</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">..</span><span style="color:#b58900">Default</span>::default()
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">let</span> ppbi <span style="color:#719e07">=</span> <span style="color:#719e07">&amp;</span><span style="color:#719e07">mut</span> pbi <span style="color:#719e07">as</span> <span style="color:#719e07">*</span><span style="color:#719e07">mut</span> _;
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">let</span> <span style="color:#719e07">mut</span> return_length <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span><span style="color:#719e07">u32</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">unsafe</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2">let</span> _ <span style="color:#719e07">=</span> NtQueryInformationProcess(
</span></span><span style="display:flex;"><span>            handle,
</span></span><span style="display:flex;"><span>            ProcessBasicInformation,
</span></span><span style="display:flex;"><span>            ppbi <span style="color:#719e07">as</span> <span style="color:#719e07">*</span><span style="color:#719e07">mut</span> c_void,
</span></span><span style="display:flex;"><span>            size_of::<span style="color:#719e07">&lt;</span><span style="color:#cb4b16">PROCESS_BASIC_INFORMATION</span><span style="color:#719e07">&gt;</span>() <span style="color:#719e07">as</span> <span style="color:#dc322f">u32</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">&amp;</span><span style="color:#719e07">mut</span> return_length,
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2">println!</span>(<span style="color:#2aa198">&#34;</span><span style="color:#2aa198">{:#?}</span><span style="color:#2aa198">&#34;</span>, pbi);
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ä½¿ç”¨<code>NtQueryInformationProcess</code>å¯ä»¥å¾—åˆ°<code>PROCESS_BASIC_INFORMATION</code>ç»“æ„ä½“</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#719e07">#[repr(C)]</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">pub</span> <span style="color:#719e07">struct</span> <span style="color:#268bd2">PROCESS_BASIC_INFORMATION</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">pub</span> ExitStatus: <span style="color:#268bd2">NTSTATUS</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">pub</span> PebBaseAddress: <span style="color:#719e07">*</span><span style="color:#719e07">mut</span> <span style="color:#cb4b16">PEB</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">pub</span> AffinityMask: <span style="color:#dc322f">usize</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">pub</span> BasePriority: <span style="color:#dc322f">i32</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">pub</span> UniqueProcessId: <span style="color:#dc322f">usize</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">pub</span> InheritedFromUniqueProcessId: <span style="color:#dc322f">usize</span>,
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¯ä»¥ä»ç»“æ„ä½“ä¸­<code>PROCESS_BASIC_INFORMATION-&gt;PebBaseAddress</code>è·å–pebåœ°å€ã€‚å¸¸è§çš„æ–‡ç« ä¸€èˆ¬æ˜¯ä¿®æ”¹<code>ImageBaseNamed</code>å’Œ<code>CommandLine</code>æ¥éšè—è¿™ä¸¤ä¸ªä¿¡æ¯</p>
<p>ImageBaseNamedå’ŒCommandLineçš„ä½ç½®æŸ¥çœ‹pebç»“æ„ä½“å¯çŸ¥</p>
<ul>
<li><code>Peb-&gt;ProcessParameters-&gt;ImageBaseNamed</code></li>
<li><code>Peb-&gt;ProcessParameters-&gt;CommandLine </code></li>
</ul>
<p>å®é™…ä¸Šéœ€è¦ä¿®æ”¹çš„åœ°æ–¹è¿˜æœ‰å¾ˆå¤šï¼ŒæŸ¥çœ‹<code>Peb-&gt;ProcessParameters</code>å¯ä»¥çœ‹åˆ°</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#2aa198">0</span><span style="color:#719e07">:</span> kd<span style="color:#719e07">&gt;</span> dt <span style="color:#2aa198">0x0000020c</span>`<span style="color:#2aa198">6f</span><span style="color:#2aa198">211</span>de0 _RTL_USER_PROCESS_PARAMETERS
</span></span><span style="display:flex;"><span>nt<span style="color:#719e07">!</span>_RTL_USER_PROCESS_PARAMETERS
</span></span><span style="display:flex;"><span>   <span style="color:#719e07">+</span><span style="color:#2aa198">0x000</span> MaximumLength    : <span style="color:#2aa198">0x764</span>
</span></span><span style="display:flex;"><span>   <span style="color:#719e07">+</span><span style="color:#2aa198">0x004</span> Length           : <span style="color:#2aa198">0x764</span>
</span></span><span style="display:flex;"><span>   <span style="color:#719e07">+</span><span style="color:#2aa198">0x008</span> Flags            : <span style="color:#2aa198">0x4001</span>
</span></span><span style="display:flex;"><span>   <span style="color:#719e07">+</span><span style="color:#2aa198">0x00c</span> DebugFlags       : <span style="color:#2aa198">0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#719e07">+</span><span style="color:#2aa198">0x010</span> ConsoleHandle    : <span style="color:#2aa198">0x00000000</span>`<span style="color:#2aa198">0000004</span><span style="color:#2aa198">8</span> Void
</span></span><span style="display:flex;"><span>   <span style="color:#719e07">+</span><span style="color:#2aa198">0x018</span> ConsoleFlags     : <span style="color:#2aa198">0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#719e07">+</span><span style="color:#2aa198">0x020</span> StandardInput    : <span style="color:#2aa198">0x00000000</span>`<span style="color:#2aa198">0000005</span>c Void
</span></span><span style="display:flex;"><span>   <span style="color:#719e07">+</span><span style="color:#2aa198">0x028</span> StandardOutput   : <span style="color:#2aa198">0x00000000</span>`<span style="color:#2aa198">00000060</span> Void
</span></span><span style="display:flex;"><span>   <span style="color:#719e07">+</span><span style="color:#2aa198">0x030</span> StandardError    : <span style="color:#2aa198">0x00000000</span>`<span style="color:#2aa198">00000064</span> Void
</span></span><span style="display:flex;"><span>   <span style="color:#719e07">+</span><span style="color:#2aa198">0x038</span> CurrentDirectory : _CURDIR
</span></span><span style="display:flex;"><span>   <span style="color:#719e07">+</span><span style="color:#2aa198">0x050</span> DllPath          : _UNICODE_STRING <span style="color:#2aa198">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#719e07">+</span><span style="color:#2aa198">0x060</span> ImagePathName    : _UNICODE_STRING <span style="color:#2aa198">&#34;C:\Users</span><span style="color:#cb4b16">\a</span><span style="color:#2aa198">xe\Desktop\hide_process_r3.exe&#34;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#719e07">+</span><span style="color:#2aa198">0x070</span> CommandLine      : _UNICODE_STRING <span style="color:#2aa198">&#34;&#34;</span>C:\Users\axe\Desktop\hide_process_r3.exe<span style="color:#2aa198">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#719e07">+</span><span style="color:#2aa198">0x080</span> Environment      : <span style="color:#2aa198">0x0000020c</span>`<span style="color:#2aa198">6f210f</span>e0 Void
</span></span><span style="display:flex;"><span>   <span style="color:#719e07">+</span><span style="color:#2aa198">0x088</span> StartingX        : <span style="color:#2aa198">0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#719e07">+</span><span style="color:#2aa198">0x08c</span> StartingY        : <span style="color:#2aa198">0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#719e07">+</span><span style="color:#2aa198">0x090</span> CountX           : <span style="color:#2aa198">0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#719e07">+</span><span style="color:#2aa198">0x094</span> CountY           : <span style="color:#2aa198">0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#719e07">+</span><span style="color:#2aa198">0x098</span> CountCharsX      : <span style="color:#2aa198">0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#719e07">+</span><span style="color:#2aa198">0x09c</span> CountCharsY      : <span style="color:#2aa198">0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#719e07">+</span><span style="color:#2aa198">0x0a0</span> FillAttribute    : <span style="color:#2aa198">0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#719e07">+</span><span style="color:#2aa198">0x0a4</span> WindowFlags      : <span style="color:#2aa198">0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#719e07">+</span><span style="color:#2aa198">0x0a8</span> ShowWindowFlags  : <span style="color:#2aa198">0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#719e07">+</span><span style="color:#2aa198">0x0b0</span> WindowTitle      : _UNICODE_STRING <span style="color:#2aa198">&#34;C:\Users</span><span style="color:#cb4b16">\a</span><span style="color:#2aa198">xe\Desktop\hide_process_r3.exe&#34;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#719e07">+</span><span style="color:#2aa198">0x0c0</span> DesktopInfo      : _UNICODE_STRING <span style="color:#2aa198">&#34;WinSta0\Default&#34;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#719e07">+</span><span style="color:#2aa198">0x0d0</span> ShellInfo        : _UNICODE_STRING <span style="color:#2aa198">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#719e07">+</span><span style="color:#2aa198">0x0e0</span> RuntimeData      : _UNICODE_STRING <span style="color:#2aa198">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#719e07">+</span><span style="color:#2aa198">0x0f0</span> CurrentDirectores : [<span style="color:#2aa198">32</span>] _RTL_DRIVE_LETTER_CURDIR
</span></span><span style="display:flex;"><span>   <span style="color:#719e07">+</span><span style="color:#2aa198">0x3f0</span> EnvironmentSize  : <span style="color:#2aa198">0xdf8</span>
</span></span><span style="display:flex;"><span>   <span style="color:#719e07">+</span><span style="color:#2aa198">0x3f8</span> EnvironmentVersion : <span style="color:#2aa198">3</span>
</span></span><span style="display:flex;"><span>   <span style="color:#719e07">+</span><span style="color:#2aa198">0x400</span> PackageDependencyData : (null) 
</span></span><span style="display:flex;"><span>   <span style="color:#719e07">+</span><span style="color:#2aa198">0x408</span> ProcessGroupId   : <span style="color:#2aa198">0x21c</span>
</span></span><span style="display:flex;"><span>   <span style="color:#719e07">+</span><span style="color:#2aa198">0x40c</span> LoaderThreads    : <span style="color:#2aa198">0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#719e07">+</span><span style="color:#2aa198">0x410</span> RedirectionDllName : _UNICODE_STRING <span style="color:#2aa198">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#719e07">+</span><span style="color:#2aa198">0x420</span> HeapPartitionName : _UNICODE_STRING <span style="color:#2aa198">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#719e07">+</span><span style="color:#2aa198">0x430</span> DefaultThreadpoolCpuSetMasks : (null) 
</span></span><span style="display:flex;"><span>   <span style="color:#719e07">+</span><span style="color:#2aa198">0x438</span> DefaultThreadpoolCpuSetMaskCount : <span style="color:#2aa198">0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#719e07">+</span><span style="color:#2aa198">0x43c</span> DefaultThreadpoolThreadMaximum : <span style="color:#2aa198">0</span>
</span></span></code></pre></div><p>ä½†æ˜¯æˆ‘å‘ç°ä¿®æ”¹äº†è¿™äº›å­—ç¬¦ä¸²åï¼Œä»»åŠ¡ç®¡ç†å™¨ä¸­ä¾ç„¶æ²¡æœ‰è¢«ä¿®æ”¹ï¼Œè¯´æ˜ä»»åŠ¡ç®¡ç†å™¨è¯»å–çš„å­—ç¬¦ä¸²åº”è¯¥ä¸æ˜¯PEBä¸­çš„ï¼Œå¯èƒ½æ˜¯EPORCESSä¸­çš„(åœ¨R0ä¸­éªŒè¯)ã€‚æ‰€ä»¥æ²¡å•¥ç”¨ã€‚</p>
<p>ä»£ç åœ¨
<a href="https://github.com/Military-axe/HideProcessR3" target="_blank" rel="noopener">HideProcessR3</a>é¡¹ç›®</p>
<h3 id="r3æ¶ˆé™¤è¿›ç¨‹">R3æ¶ˆé™¤è¿›ç¨‹</h3>
<blockquote>
<p>è¿™ä¸ªéƒ¨åˆ†æˆ‘è§‰å¾—æ˜¯æœ‰ç”¨çš„ï¼Œè‡³å°‘èƒ½è®©ä¸€äº›è½¯ä»¶æ˜¾ç¤ºä¸å‡ºæ¥æˆ‘ä»¬çš„è¿›ç¨‹ã€‚</p>
</blockquote>
<p>R3æ¶ˆé™¤è¿›ç¨‹æˆ‘ä¸»è¦å­¦åˆ°ä¸¤ä¸ªæ–¹é¢ï¼Œä¸€ä¸ªæ˜¯hookï¼Œä¸€ä¸ªæ˜¯R3æ–­é“¾</p>
<h4 id="api-hook-hookä»»åŠ¡ç®¡ç†å™¨">[API hook] Hookä»»åŠ¡ç®¡ç†å™¨</h4>
<p>è¿™é‡Œä¸»è¦é’ˆå¯¹ä»»åŠ¡ç®¡ç†å™¨è¿›ç¨‹ï¼Œè®©ä»»åŠ¡ç®¡ç†å™¨è·å–ä¸åˆ°æˆ‘ä»¬çš„è¿›ç¨‹ã€‚è¿™é‡Œå…¶å®æ˜¯hookæ‰ä»»åŠ¡ç®¡ç†å™¨çš„<code>ZwQuerySystemInformation</code>å‡½æ•°ï¼Œè¿™ç¯‡
<a href="https://bbs.kanxue.com/thread-269919.htm" target="_blank" rel="noopener">çœ‹é›ªçš„æ–‡ç« </a>å·²ç»å®ç°è¿‡äº†c/c++ç‰ˆæœ¬çš„ï¼Œæˆ‘è¿™é‡Œå°±ç”¨rustçš„å†™ä¸€éR3çš„éƒ¨åˆ†ã€‚</p>
<blockquote>
<p>çœ‹é›ªæ–‡ç« æ˜¯æ‰‹åŠ¨å®ç°hookçš„è¿‡ç¨‹ï¼Œæˆ‘æ˜¯ä½¿ç”¨ç¬¬ä¸‰æ–¹çš„hookåº“ï¼Œå› ä¸ºä»»åŠ¡ç®¡ç†è¿˜æ¶‰åŠåˆ°ä¸€äº›å¤šçº¿ç¨‹çš„é—®é¢˜ï¼Œç®€å•æ‰‹åŠ¨hookå¯èƒ½ä¼šæœ‰é—®é¢˜ã€‚ç”¨ç¬¬ä¸‰æ–¹åº“åˆ™å·²ç»å¸®æˆ‘è§£å†³è¿™ä¸ªé—®é¢˜äº†ã€‚</p>
</blockquote>
<p>ä»»åŠ¡ç®¡ç†å™¨è·å–è¿›ç¨‹ä¿¡æ¯ï¼Œåº•å±‚è°ƒç”¨çš„æ˜¯<code>ZwQuerySystemInformation</code>å‡½æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>NTSTATUS WINAPI <span style="color:#268bd2">ZwQuerySystemInformation</span>(
</span></span><span style="display:flex;"><span>  __in       SYSTEM_INFORMATION_CLASS SystemInformationClass,
</span></span><span style="display:flex;"><span>  __inout    PVOID SystemInformation,
</span></span><span style="display:flex;"><span>  __in       ULONG SystemInformationLength,
</span></span><span style="display:flex;"><span>  __out_opt  PULONG ReturnLength);
</span></span></code></pre></div><table>
  <thead>
      <tr>
          <th>å‚æ•°</th>
          <th>è¯´æ˜</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>SystemInformationClass</td>
          <td>è¦æ£€ç´¢çš„ç±»å‹ã€‚æ˜¯ä¸€ä¸ªSYSTEM_INFORMATION_CLASSçš„è”åˆä½“</td>
      </tr>
      <tr>
          <td>SystemInformation</td>
          <td>æŒ‡å‘ç¼“å†²åŒºçš„æŒ‡é’ˆï¼Œç”¨äºæ¥æ”¶è¯·æ±‚ä¿¡æ¯ã€‚è¯¥ä¿¡æ¯çš„å¤§å°å’Œç»“æ„å–å†³äºSystemInformationClass</td>
      </tr>
      <tr>
          <td>SystemInformationLength</td>
          <td>SystemInformationå‚æ•°æŒ‡å‘çš„ç¼“å†²åŒºçš„å¤§å°</td>
      </tr>
      <tr>
          <td>ReturnLength</td>
          <td>ä¸€ä¸ªå¯é€‰æŒ‡é’ˆï¼ŒæŒ‡å‘å‡½æ•°å†™å…¥è¯·æ±‚ä¿¡æ¯çš„å®é™…å¤§å°çš„ä½ç½®</td>
      </tr>
  </tbody>
</table>
<p>SystemInformationClassä¸­æœ‰å¾ˆå¤šç±»å‹</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#719e07">typedef</span> <span style="color:#719e07">enum</span> _SYSTEM_INFORMATION_CLASS {
</span></span><span style="display:flex;"><span>    SystemBasicInformation <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>,
</span></span><span style="display:flex;"><span>    SystemPerformanceInformation <span style="color:#719e07">=</span> <span style="color:#2aa198">2</span>,
</span></span><span style="display:flex;"><span>    SystemTimeOfDayInformation <span style="color:#719e07">=</span> <span style="color:#2aa198">3</span>,
</span></span><span style="display:flex;"><span>    SystemProcessInformation <span style="color:#719e07">=</span> <span style="color:#2aa198">5</span>,
</span></span><span style="display:flex;"><span>    SystemProcessorPerformanceInformation <span style="color:#719e07">=</span> <span style="color:#2aa198">8</span>,
</span></span><span style="display:flex;"><span>    SystemInterruptInformation <span style="color:#719e07">=</span> <span style="color:#2aa198">23</span>,
</span></span><span style="display:flex;"><span>    SystemExceptionInformation <span style="color:#719e07">=</span> <span style="color:#2aa198">33</span>,
</span></span><span style="display:flex;"><span>    SystemRegistryQuotaInformation <span style="color:#719e07">=</span> <span style="color:#2aa198">37</span>,
</span></span><span style="display:flex;"><span>    SystemLookasideInformation <span style="color:#719e07">=</span> <span style="color:#2aa198">45</span>
</span></span><span style="display:flex;"><span>} SYSTEM_INFORMATION_CLASS;
</span></span></code></pre></div><p><code>SystemProcessInformation(5)</code>å°±æ˜¯è¿›ç¨‹ä¿¡æ¯ç±»å‹ï¼Œæˆ‘ä»¬hookå‡½æ•°åï¼Œç›®æ ‡å°±æ˜¯<code>SystemInformationClass</code>çš„å€¼ç­‰äº5çš„æƒ…å†µã€‚</p>
<p>ç„¶åè¿˜éœ€è¦æ³¨æ„åˆ°SystemInformationå€¼ï¼Œè¿™ä¸ªå€¼çš„ç»“æ„ä½“å¦‚ä¸‹</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#719e07">pub</span> <span style="color:#719e07">struct</span> <span style="color:#268bd2">SYSTEM_PROCESS_INFORMATION</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">pub</span> NextEntryOffset: <span style="color:#dc322f">u32</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">pub</span> NumberOfThreads: <span style="color:#dc322f">u32</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">pub</span> Reserved1: [<span style="color:#dc322f">u8</span>; <span style="color:#2aa198">48</span>],
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">pub</span> ImageName: <span style="color:#268bd2">super</span>::<span style="color:#719e07">super</span>::Foundation::<span style="color:#cb4b16">UNICODE_STRING</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">pub</span> BasePriority: <span style="color:#dc322f">i32</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">pub</span> UniqueProcessId: <span style="color:#268bd2">super</span>::<span style="color:#719e07">super</span>::Foundation::<span style="color:#cb4b16">HANDLE</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">pub</span> Reserved2: <span style="color:#719e07">*</span><span style="color:#719e07">mut</span> core::ffi::c_void,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">pub</span> HandleCount: <span style="color:#dc322f">u32</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">pub</span> SessionId: <span style="color:#dc322f">u32</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">pub</span> Reserved3: <span style="color:#719e07">*</span><span style="color:#719e07">mut</span> core::ffi::c_void,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">pub</span> PeakVirtualSize: <span style="color:#dc322f">usize</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">pub</span> VirtualSize: <span style="color:#dc322f">usize</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">pub</span> Reserved4: <span style="color:#dc322f">u32</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">pub</span> PeakWorkingSetSize: <span style="color:#dc322f">usize</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">pub</span> WorkingSetSize: <span style="color:#dc322f">usize</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">pub</span> Reserved5: <span style="color:#719e07">*</span><span style="color:#719e07">mut</span> core::ffi::c_void,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">pub</span> QuotaPagedPoolUsage: <span style="color:#dc322f">usize</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">pub</span> Reserved6: <span style="color:#719e07">*</span><span style="color:#719e07">mut</span> core::ffi::c_void,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">pub</span> QuotaNonPagedPoolUsage: <span style="color:#dc322f">usize</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">pub</span> PagefileUsage: <span style="color:#dc322f">usize</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">pub</span> PeakPagefileUsage: <span style="color:#dc322f">usize</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">pub</span> PrivatePageCount: <span style="color:#dc322f">usize</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">pub</span> Reserved7: [<span style="color:#dc322f">i64</span>; <span style="color:#2aa198">6</span>],
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å…¶ä¸­<code>UniqueProcessId</code>è¡¨ç¤ºè¿›ç¨‹pidï¼Œä¹Ÿæ˜¯æˆ‘ä»¬å¯¹æ¯”æ˜¯å¦æ˜¯ç›®æ ‡è¿›ç¨‹çš„å€¼ã€‚ç„¶å<code>NextEntryOffset</code>è¡¨ç¤ºä¸‹ä¸€ä¸ªSYSTEM_PROCESS_INFORMATIONè·ç¦»å½“å‰è¿™ä¸ªç»“æ„ä½“çš„åç§»å€¼</p>
<p><img src="https://s2.loli.net/2024/05/31/QdgwEjzDxVNGXBZ.png" alt=""></p>
<p>æˆ‘è¿™é‡Œä½¿ç”¨<code>retour</code>åº“æ¥hookï¼Œæºç ä¸­æŒ‡å®šéœ€è¦hookçš„è¿›ç¨‹å·(ä»»åŠ¡ç®¡ç†å™¨çš„è¿›ç¨‹å·)åšå…¨å±€å˜é‡</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#586e75">// éœ€è¦éšè—çš„è¿›ç¨‹id
</span></span></span><span style="display:flex;"><span><span style="color:#719e07">const</span> <span style="color:#cb4b16">HIDE_PID</span>: <span style="color:#dc322f">i32</span> <span style="color:#719e07">=</span> <span style="color:#2aa198">21664</span>;
</span></span></code></pre></div><p>ç„¶åå†™æˆä¸€ä¸ªdllçš„ä»£ç ï¼ŒåŸç†å°±æ˜¯inline hookï¼Œå†™æ³•å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„
<a href="https://military-axe.github.io/posts/rustbian-xie-ji-chong-hookde-fang-shi/" target="_blank" rel="noopener">æ–‡ç« </a></p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#268bd2">static_detour!</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">static</span> ZwQuerySystemInformationHook: <span style="color:#268bd2">unsafe</span> <span style="color:#719e07">extern</span> <span style="color:#2aa198">&#34;system&#34;</span> <span style="color:#719e07">fn</span>(<span style="color:#cb4b16">SYSTEM_INFORMATION_CLASS</span>, <span style="color:#719e07">*</span><span style="color:#719e07">mut</span> c_void, c_ulong, <span style="color:#719e07">*</span><span style="color:#719e07">mut</span> c_ulong) -&gt; <span style="color:#268bd2">NTSTATUS</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#586e75">// A type alias for `ZwQuerySystemInformation` (makes the transmute easy on the eyes)
</span></span></span><span style="display:flex;"><span><span style="color:#719e07">type</span> <span style="color:#268bd2">FnZwQuerySystemInformation</span> <span style="color:#719e07">=</span> <span style="color:#719e07">unsafe</span> <span style="color:#719e07">extern</span> <span style="color:#2aa198">&#34;system&#34;</span> <span style="color:#719e07">fn</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#cb4b16">SYSTEM_INFORMATION_CLASS</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">*</span><span style="color:#719e07">mut</span> c_void,
</span></span><span style="display:flex;"><span>    c_ulong,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">*</span><span style="color:#719e07">mut</span> c_ulong,
</span></span><span style="display:flex;"><span>) -&gt; <span style="color:#268bd2">NTSTATUS</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#2aa198">/// Called when the DLL is attached to the process.
</span></span></span><span style="display:flex;"><span><span style="color:#719e07">unsafe</span> <span style="color:#719e07">fn</span> <span style="color:#268bd2">main</span>() -&gt; <span style="color:#b58900">Result</span><span style="color:#719e07">&lt;</span>(), <span style="color:#b58900">Box</span><span style="color:#719e07">&lt;</span><span style="color:#719e07">dyn</span> Error<span style="color:#719e07">&gt;&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">let</span> address <span style="color:#719e07">=</span> get_module_symbol_address(<span style="color:#2aa198">&#34;ntdll.dll&#34;</span>, <span style="color:#2aa198">&#34;ZwQuerySystemInformation&#34;</span>)
</span></span><span style="display:flex;"><span>        .expect(<span style="color:#2aa198">&#34;could not find &#39;ZwQuerySystemInformation&#39; address&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">let</span> target: <span style="color:#268bd2">FnZwQuerySystemInformation</span> <span style="color:#719e07">=</span> mem::transmute(address);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ZwQuerySystemInformationHook
</span></span><span style="display:flex;"><span>        .initialize(target, zwquery_system_infomation_detour)<span style="color:#719e07">?</span>
</span></span><span style="display:flex;"><span>        .enable()<span style="color:#719e07">?</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#b58900">Ok</span>(())
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">#[allow(unused_assignments)]</span>
</span></span><span style="display:flex;"><span><span style="color:#2aa198">/// Called whenever `ZwQuerySystemInformation` is invoked in the process.
</span></span></span><span style="display:flex;"><span><span style="color:#719e07">fn</span> <span style="color:#268bd2">zwquery_system_infomation_detour</span>(
</span></span><span style="display:flex;"><span>    system_infomation_class: <span style="color:#268bd2">SYSTEM_INFORMATION_CLASS</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">mut</span> system_infomation: <span style="color:#719e07">*</span><span style="color:#719e07">mut</span> c_void,
</span></span><span style="display:flex;"><span>    system_infomation_length: <span style="color:#268bd2">c_ulong</span>,
</span></span><span style="display:flex;"><span>    return_length: <span style="color:#719e07">*</span><span style="color:#719e07">mut</span> c_ulong,
</span></span><span style="display:flex;"><span>) -&gt; <span style="color:#268bd2">NTSTATUS</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">let</span> <span style="color:#719e07">mut</span> prev <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">let</span> status <span style="color:#719e07">=</span> <span style="color:#719e07">unsafe</span> {
</span></span><span style="display:flex;"><span>        ZwQuerySystemInformationHook.call(
</span></span><span style="display:flex;"><span>            system_infomation_class,
</span></span><span style="display:flex;"><span>            system_infomation,
</span></span><span style="display:flex;"><span>            system_infomation_length,
</span></span><span style="display:flex;"><span>            return_length,
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">if</span> status <span style="color:#719e07">!=</span> <span style="color:#cb4b16">STATUS_SUCCESS</span> <span style="color:#719e07">||</span> system_infomation_class <span style="color:#719e07">!=</span> SystemProcessInformation {
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">return</span> status;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">let</span> <span style="color:#719e07">mut</span> psystem_information: <span style="color:#719e07">*</span><span style="color:#719e07">mut</span> <span style="color:#cb4b16">SYSTEM_PROCESS_INFORMATION</span> <span style="color:#719e07">=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">unsafe</span> { mem::transmute(system_infomation) };
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">loop</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">if</span> <span style="color:#cb4b16">HIDE_PID</span> <span style="color:#719e07">==</span> <span style="color:#719e07">unsafe</span> { (<span style="color:#719e07">*</span>psystem_information).UniqueProcessId.<span style="color:#2aa198">0</span> } <span style="color:#719e07">as</span> <span style="color:#dc322f">i32</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#268bd2">let</span> st <span style="color:#719e07">=</span> <span style="color:#719e07">unsafe</span> { <span style="color:#268bd2">format!</span>(<span style="color:#2aa198">&#34;system information ==&gt; </span><span style="color:#2aa198">{:#?}</span><span style="color:#2aa198">&#34;</span>, <span style="color:#719e07">*</span>psystem_information) };
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">unsafe</span> { MessageBoxA(<span style="color:#b58900">None</span>, <span style="color:#cb4b16">PCSTR</span>::from_raw(st.as_ptr()), <span style="color:#268bd2">s!</span>(<span style="color:#2aa198">&#34;info&#34;</span>), <span style="color:#cb4b16">MB_OK</span>) };
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">if</span> prev <span style="color:#719e07">==</span> <span style="color:#2aa198">0</span> {
</span></span><span style="display:flex;"><span>                system_infomation <span style="color:#719e07">=</span> (psystem_information <span style="color:#719e07">as</span> <span style="color:#dc322f">u64</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#719e07">+</span> (<span style="color:#719e07">unsafe</span> { <span style="color:#719e07">*</span>psystem_information }).NextEntryOffset <span style="color:#719e07">as</span> <span style="color:#dc322f">u64</span>)
</span></span><span style="display:flex;"><span>                    <span style="color:#719e07">as</span> <span style="color:#719e07">*</span><span style="color:#719e07">mut</span> c_void;
</span></span><span style="display:flex;"><span>            } <span style="color:#719e07">else</span> <span style="color:#719e07">if</span> (<span style="color:#719e07">unsafe</span> { <span style="color:#719e07">*</span>psystem_information }).NextEntryOffset <span style="color:#719e07">==</span> <span style="color:#2aa198">0</span> {
</span></span><span style="display:flex;"><span>                (<span style="color:#719e07">unsafe</span> { <span style="color:#719e07">*</span>(prev <span style="color:#719e07">as</span> <span style="color:#719e07">*</span><span style="color:#719e07">mut</span> <span style="color:#cb4b16">SYSTEM_PROCESS_INFORMATION</span>) }).NextEntryOffset <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>;
</span></span><span style="display:flex;"><span>            } <span style="color:#719e07">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#719e07">unsafe</span> {
</span></span><span style="display:flex;"><span>                    (<span style="color:#719e07">*</span>(prev <span style="color:#719e07">as</span> <span style="color:#719e07">*</span><span style="color:#719e07">mut</span> <span style="color:#cb4b16">SYSTEM_PROCESS_INFORMATION</span>)).NextEntryOffset <span style="color:#719e07">+=</span>
</span></span><span style="display:flex;"><span>                        (<span style="color:#719e07">*</span>psystem_information).NextEntryOffset;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">break</span>;
</span></span><span style="display:flex;"><span>        } <span style="color:#719e07">else</span> {
</span></span><span style="display:flex;"><span>            prev <span style="color:#719e07">=</span> psystem_information <span style="color:#719e07">as</span> <span style="color:#dc322f">u64</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">if</span> <span style="color:#719e07">unsafe</span> { (<span style="color:#719e07">*</span>psystem_information).NextEntryOffset <span style="color:#719e07">==</span> <span style="color:#2aa198">0</span> } {
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        psystem_information <span style="color:#719e07">=</span>
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">unsafe</span> { psystem_information <span style="color:#719e07">as</span> <span style="color:#dc322f">u64</span> <span style="color:#719e07">+</span> (<span style="color:#719e07">*</span>psystem_information).NextEntryOffset <span style="color:#719e07">as</span> <span style="color:#dc322f">u64</span> }
</span></span><span style="display:flex;"><span>                <span style="color:#719e07">as</span> <span style="color:#719e07">*</span><span style="color:#719e07">mut</span> <span style="color:#cb4b16">SYSTEM_PROCESS_INFORMATION</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    status
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#2aa198">/// Returns a module symbol&#39;s absolute address.
</span></span></span><span style="display:flex;"><span><span style="color:#719e07">fn</span> <span style="color:#268bd2">get_module_symbol_address</span>(module: <span style="color:#719e07">&amp;</span><span style="color:#dc322f">str</span>, symbol: <span style="color:#719e07">&amp;</span><span style="color:#dc322f">str</span>) -&gt; <span style="color:#b58900">Option</span><span style="color:#719e07">&lt;</span><span style="color:#dc322f">usize</span><span style="color:#719e07">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">let</span> module <span style="color:#719e07">=</span> module
</span></span><span style="display:flex;"><span>        .encode_utf16()
</span></span><span style="display:flex;"><span>        .chain(iter::once(<span style="color:#2aa198">0</span>))
</span></span><span style="display:flex;"><span>        .collect::<span style="color:#719e07">&lt;</span><span style="color:#b58900">Vec</span><span style="color:#719e07">&lt;</span><span style="color:#dc322f">u16</span><span style="color:#719e07">&gt;&gt;</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">let</span> symbol <span style="color:#719e07">=</span> CString::new(symbol).unwrap();
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">unsafe</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2">let</span> handle <span style="color:#719e07">=</span> GetModuleHandleW(<span style="color:#cb4b16">PCWSTR</span>(module.as_ptr() <span style="color:#719e07">as</span> _)).unwrap();
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">match</span> GetProcAddress(handle, <span style="color:#cb4b16">PCSTR</span>(symbol.as_ptr() <span style="color:#719e07">as</span> _)) {
</span></span><span style="display:flex;"><span>            <span style="color:#b58900">Some</span>(func) <span style="color:#719e07">=&gt;</span> <span style="color:#b58900">Some</span>(func <span style="color:#719e07">as</span> <span style="color:#dc322f">usize</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#b58900">None</span> <span style="color:#719e07">=&gt;</span> <span style="color:#b58900">None</span>,
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">#[no_mangle]</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">unsafe</span> <span style="color:#719e07">extern</span> <span style="color:#2aa198">&#34;system&#34;</span> <span style="color:#719e07">fn</span> <span style="color:#268bd2">DllMain</span>(_hinst: <span style="color:#268bd2">HANDLE</span>, reason: <span style="color:#dc322f">u32</span>, _reserved: <span style="color:#719e07">*</span><span style="color:#719e07">mut</span> c_void) -&gt; <span style="color:#268bd2">BOOL</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">match</span> reason {
</span></span><span style="display:flex;"><span>        <span style="color:#cb4b16">DLL_PROCESS_ATTACH</span> <span style="color:#719e07">=&gt;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#268bd2">println!</span>(<span style="color:#2aa198">&#34;attaching&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">unsafe</span> { main().unwrap() }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#cb4b16">DLL_PROCESS_DETACH</span> <span style="color:#719e07">=&gt;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#268bd2">println!</span>(<span style="color:#2aa198">&#34;detaching&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#cb4b16">DLL_THREAD_ATTACH</span> <span style="color:#719e07">=&gt;</span> {}
</span></span><span style="display:flex;"><span>        <span style="color:#cb4b16">DLL_THREAD_DETACH</span> <span style="color:#719e07">=&gt;</span> {}
</span></span><span style="display:flex;"><span>        _ <span style="color:#719e07">=&gt;</span> {}
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">return</span> <span style="color:#cb4b16">BOOL</span>::from(<span style="color:#cb4b16">true</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>æ³¨å…¥å‰</p>
<p><img src="https://s2.loli.net/2024/05/31/D2yiMpuP4QCkt8G.png" alt="image-20240521213951309"></p>
<p>æ³¨å…¥ä»»åŠ¡ç®¡ç†å™¨ååˆ™æ— æ³•æœç´¢åˆ°å¯¹åº”çš„è¿›ç¨‹ã€‚</p>
<p><img src="https://s2.loli.net/2024/05/31/O9p6yai3zfNKwuv.png" alt="image-20240521214135198"></p>
<h4 id="å…¨å±€hook-setwindowshookex">[å…¨å±€hook] SetWindowsHookEx</h4>
<p>ä¸Šä¸€ç§API hookçš„å±€é™æ€§æ˜¯æˆ‘éœ€è¦æŒ‡å®šéœ€è¦hookçš„è¿›ç¨‹ï¼Œæ¯”å¦‚æˆ‘éœ€è¦æŒ‡å®šhookä»»åŠ¡ç®¡ç†å™¨ï¼Œä¸ºäº†éšè—è¿›ç¨‹ï¼Œæˆ‘å¯èƒ½è¿˜è¦å¤šhookå‡ ä¸ªç±»ä¼¼çš„è¿›ç¨‹ï¼Œæ¯”å¦‚ProcessHackï¼ŒSysteminfoç­‰ã€‚ä½†æ˜¯æˆ‘å¾ˆéš¾å°½å–„å°½ç¾ï¼ŒæŠŠæ‰€æœ‰éœ€è¦hookçš„ç¨‹åºåç§°éƒ½åŠ åœ¨å…¶ä¸­ï¼Œæ‰€ä»¥è€ƒè™‘åˆ°å…¨å±€hookã€‚å…¨å±€hookåˆ™æ˜¯ä¸éœ€è¦æˆ‘æŒ‡å®šè¿›ç¨‹ï¼Œåªè¦æœ‰è¿›ç¨‹åˆ›å»ºï¼ˆæˆ–è€…å¤åˆæ ‡å‡†çš„è¿›ç¨‹ï¼‰ï¼Œå°±å¾€è¿›ç¨‹ä¸­æ³¨å…¥dllã€‚SetWindowsHookExå°±æ˜¯è¿™æ ·ä¸€ä¸ªWindows API</p>
<blockquote>
<p>ä¸ºäº†èƒ½å¤Ÿè®©DLLæ³¨å…¥æ‰€æœ‰çš„è¿›ç¨‹ä¸­ï¼Œç¨‹åºè®¾ç½®WH_GETMESSAGEæ¶ˆæ¯çš„å…¨å±€é’©å­ã€‚å› ä¸ºWH_GETMESSAGEç±»å‹çš„é’©å­ä¼šç›‘è§†æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç”±äºWindowsç³»ç»Ÿæ˜¯åŸºäºæ¶ˆæ¯é©±åŠ¨çš„ï¼Œæ‰€ä»¥æ‰€æœ‰è¿›ç¨‹éƒ½ä¼šæœ‰è‡ªå·±çš„ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œéƒ½ä¼šåŠ è½½WH_GETMESSAGEç±»å‹çš„å…¨å±€é’©å­DLLã€‚ &mdash;-ã€ŠWindowsé»‘å®¢ç¼–ç¨‹æŠ€æœ¯è¯¦è§£ã€‹</p>
</blockquote>
<p>windowsæ­£å¸¸æ¶ˆæ¯å¤„ç†æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="https://s2.loli.net/2024/05/31/TIQZJ8ozOMFAbnD.png" alt=""></p>
<p>ä½¿ç”¨SetWindowsHookExä¹‹åçš„æ¶ˆæ¯å¤„ç†æµç¨‹åˆ™æ˜¯</p>
<p><img src="https://s2.loli.net/2024/05/31/hqS8JuYQlEZsmwb.png" alt=""></p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>HHOOK <span style="color:#268bd2">SetWindowsHookExA</span>(
</span></span><span style="display:flex;"><span>  [in] <span style="color:#dc322f">int</span>       idHook,
</span></span><span style="display:flex;"><span>  [in] HOOKPROC  lpfn,
</span></span><span style="display:flex;"><span>  [in] HINSTANCE hmod,
</span></span><span style="display:flex;"><span>  [in] DWORD     dwThreadId
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><ul>
<li>
<p>idHook: éœ€è¦å®‰è£…hookçš„ç±»å‹ï¼Œå¯ä»¥å®‰è£…é”®ç›˜hookï¼ˆWH_KEYBOARDï¼‰ï¼Œé¼ æ ‡hookï¼ˆWH_MOUSEï¼‰ï¼Œæˆ‘ä»¬å…¨å±€hookæ³¨å…¥dllçš„è¯ï¼Œéœ€è¦ä½¿ç”¨<strong>WH_GETMESSAGE</strong>ç±»å‹</p>
</li>
<li>
<p>lpfn: æŒ‡å‘ç›¸åº”çš„æŒ‚é’©å¤„ç†è¿‡ç¨‹.è‹¥å‚æ•°dwThreadIdä¸º0æˆ–è€…æŒ‡ç¤ºäº†ä¸€ä¸ªå…¶ä»–è¿›ç¨‹åˆ›å»ºçš„çº¿ç¨‹ä¹‹æ ‡è¯†ç¬¦,åˆ™å‚æ•°lpfnå¿…é¡»æŒ‡å‘ä¸€ä¸ªåŠ¨æ€é“¾æ¥ä¸­çš„æŒ‚é’©å¤„ç†è¿‡ç¨‹.å¦åˆ™,å‚æ•°lpfnå¯ä»¥æŒ‡å‘ä¸€ä¸ªä¸å½“å‰è¿›ç¨‹ç›¸å…³çš„ä»£ç ä¸­å®šä¹‰çš„æŒ‚é’©å¤„ç†è¿‡ç¨‹ã€‚</p>
</li>
<li>
<p>hmod: DLL çš„å¥æŸ„ï¼Œå…¶ä¸­åŒ…å« <em>lpfn</em> å‚æ•°æŒ‡å‘çš„æŒ‚é’©è¿‡ç¨‹ã€‚ å¦‚æœ <em>dwThreadId</em> å‚æ•°æŒ‡å®šå½“å‰è¿›ç¨‹åˆ›å»ºçš„çº¿ç¨‹ï¼Œå¹¶ä¸”æŒ‚é’©è¿‡ç¨‹ä½äºä¸å½“å‰è¿›ç¨‹å…³è”çš„ä»£ç ä¸­ï¼Œåˆ™å¿…é¡»å°† <em>hMod</em> å‚æ•°è®¾ç½®ä¸º <strong>NULL</strong>ã€‚</p>
</li>
<li>
<p>dwThreadIdï¼šæŒ‡ç¤ºäº†ä¸€ä¸ªçº¿ç¨‹æ ‡è¯†ç¬¦,æŒ‚é’©å¤„ç†è¿‡ç¨‹ä¸çº¿ç¨‹ç›¸å…³.è‹¥æ­¤å‚æ•°å€¼ä¸º0,åˆ™è¯¥æŒ‚é’©å¤„ç†è¿‡ç¨‹ä¸æ‰€æœ‰ç°å­˜çš„çº¿ç¨‹ç›¸å…³</p>
</li>
</ul>
<p>ä»£ç å‚è€ƒäº†è¿™ç¯‡
<a href="https://blog.csdn.net/kingkee/article/details/97390029" target="_blank" rel="noopener">æ–‡ç« </a></p>
<p>DLLä»£ç :</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#586e75">// GlobalHook_Test.cpp : å®šä¹‰ DLL åº”ç”¨ç¨‹åºçš„å¯¼å‡ºå‡½æ•°ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#586e75">//
</span></span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#719e07">#include</span> <span style="color:#719e07">&#34;stdafx.h&#34;</span><span style="color:#719e07">
</span></span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#719e07">extern</span> HMODULE g_hDllModule;
</span></span><span style="display:flex;"><span><span style="color:#586e75">// å…±äº«å†…å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#719e07">#pragma data_seg(&#34;mydata&#34;)
</span></span></span><span style="display:flex;"><span>    HHOOK g_hHook <span style="color:#719e07">=</span> <span style="color:#b58900">NULL</span>;
</span></span><span style="display:flex;"><span><span style="color:#719e07">#pragma data_seg()
</span></span></span><span style="display:flex;"><span><span style="color:#719e07">#pragma comment(linker, &#34;/SECTION:mydata,RWS&#34;)
</span></span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#586e75">// é’©å­å›è°ƒå‡½æ•°
</span></span></span><span style="display:flex;"><span>LRESULT <span style="color:#268bd2">GetMsgProc</span>(
</span></span><span style="display:flex;"><span>	<span style="color:#dc322f">int</span> code,
</span></span><span style="display:flex;"><span>	WPARAM wParam,
</span></span><span style="display:flex;"><span>	LPARAM lParam)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">return</span> <span style="color:#719e07">::</span><span style="color:#268bd2">CallNextHookEx</span>(g_hHook, code, wParam, lParam);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#586e75">// è®¾ç½®å…¨å±€é’©å­
</span></span></span><span style="display:flex;"><span>BOOL <span style="color:#268bd2">SetGlobalHook</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	g_hHook <span style="color:#719e07">=</span> <span style="color:#719e07">::</span><span style="color:#268bd2">SetWindowsHookEx</span>(WH_GETMESSAGE, (HOOKPROC)GetMsgProc, g_hDllModule, <span style="color:#2aa198">0</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">if</span> (<span style="color:#b58900">NULL</span> <span style="color:#719e07">==</span> g_hHook)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#719e07">return</span> FALSE;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">return</span> TRUE;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#586e75">// å¸è½½é’©å­
</span></span></span><span style="display:flex;"><span>BOOL <span style="color:#268bd2">UnsetGlobalHook</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">if</span> (g_hHook)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#719e07">::</span><span style="color:#268bd2">UnhookWindowsHookEx</span>(g_hHook);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">return</span> TRUE;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ä¸Šé¢æ˜¯dllçš„ä»£ç ï¼Œç„¶åç¼–è¯‘è°ƒç”¨è¿™ä¸ªdllçš„ä»£ç </p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#719e07">#include</span> <span style="color:#719e07">&#34;stdafx.h&#34;</span><span style="color:#719e07">
</span></span></span><span style="display:flex;"><span><span style="color:#719e07">#include</span> <span style="color:#719e07">&lt;Windows.h&gt;</span><span style="color:#719e07">
</span></span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#dc322f">int</span> <span style="color:#268bd2">_tmain</span>(<span style="color:#dc322f">int</span> argc, _TCHAR<span style="color:#719e07">*</span> argv[])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">typedef</span> <span style="color:#268bd2">BOOL</span>(<span style="color:#719e07">*</span>typedef_SetGlobalHook)();
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">typedef</span> <span style="color:#268bd2">BOOL</span>(<span style="color:#719e07">*</span>typedef_UnsetGlobalHook)();
</span></span><span style="display:flex;"><span>	HMODULE hDll <span style="color:#719e07">=</span> <span style="color:#b58900">NULL</span>;
</span></span><span style="display:flex;"><span>	typedef_SetGlobalHook SetGlobalHook <span style="color:#719e07">=</span> <span style="color:#b58900">NULL</span>;
</span></span><span style="display:flex;"><span>	typedef_UnsetGlobalHook UnsetGlobalHook <span style="color:#719e07">=</span> <span style="color:#b58900">NULL</span>;
</span></span><span style="display:flex;"><span>	BOOL bRet <span style="color:#719e07">=</span> FALSE;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">do</span>
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		hDll <span style="color:#719e07">=</span> <span style="color:#719e07">::</span><span style="color:#268bd2">LoadLibrary</span>(<span style="color:#2aa198">&#34;GlobalHook_Test.dll&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#719e07">if</span> (<span style="color:#b58900">NULL</span> <span style="color:#719e07">==</span> hDll)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#268bd2">printf</span>(<span style="color:#2aa198">&#34;LoadLibrary Error[%d]</span><span style="color:#cb4b16">\n</span><span style="color:#2aa198">&#34;</span>, <span style="color:#719e07">::</span><span style="color:#268bd2">GetLastError</span>());
</span></span><span style="display:flex;"><span>			<span style="color:#719e07">break</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>		SetGlobalHook <span style="color:#719e07">=</span> (typedef_SetGlobalHook)<span style="color:#719e07">::</span><span style="color:#268bd2">GetProcAddress</span>(hDll, <span style="color:#2aa198">&#34;SetGlobalHook&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#719e07">if</span> (<span style="color:#b58900">NULL</span> <span style="color:#719e07">==</span> SetGlobalHook)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#268bd2">printf</span>(<span style="color:#2aa198">&#34;GetProcAddress Error[%d]</span><span style="color:#cb4b16">\n</span><span style="color:#2aa198">&#34;</span>, <span style="color:#719e07">::</span><span style="color:#268bd2">GetLastError</span>());
</span></span><span style="display:flex;"><span>			<span style="color:#719e07">break</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>		bRet <span style="color:#719e07">=</span> <span style="color:#268bd2">SetGlobalHook</span>();
</span></span><span style="display:flex;"><span>		<span style="color:#719e07">if</span> (bRet)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#268bd2">printf</span>(<span style="color:#2aa198">&#34;SetGlobalHook OK.</span><span style="color:#cb4b16">\n</span><span style="color:#2aa198">&#34;</span>);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#719e07">else</span>
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#268bd2">printf</span>(<span style="color:#2aa198">&#34;SetGlobalHook ERROR.</span><span style="color:#cb4b16">\n</span><span style="color:#2aa198">&#34;</span>);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>		<span style="color:#268bd2">system</span>(<span style="color:#2aa198">&#34;pause&#34;</span>);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>		UnsetGlobalHook <span style="color:#719e07">=</span> (typedef_UnsetGlobalHook)<span style="color:#719e07">::</span><span style="color:#268bd2">GetProcAddress</span>(hDll, <span style="color:#2aa198">&#34;UnsetGlobalHook&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#719e07">if</span> (<span style="color:#b58900">NULL</span> <span style="color:#719e07">==</span> UnsetGlobalHook)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#268bd2">printf</span>(<span style="color:#2aa198">&#34;GetProcAddress Error[%d]</span><span style="color:#cb4b16">\n</span><span style="color:#2aa198">&#34;</span>, <span style="color:#719e07">::</span><span style="color:#268bd2">GetLastError</span>());
</span></span><span style="display:flex;"><span>			<span style="color:#719e07">break</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#268bd2">UnsetGlobalHook</span>();
</span></span><span style="display:flex;"><span>		<span style="color:#268bd2">printf</span>(<span style="color:#2aa198">&#34;UnsetGlobalHook OK.</span><span style="color:#cb4b16">\n</span><span style="color:#2aa198">&#34;</span>);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>	}<span style="color:#719e07">while</span>(FALSE);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>	<span style="color:#268bd2">system</span>(<span style="color:#2aa198">&#34;pause&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">return</span> <span style="color:#2aa198">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>è¿™ç§æ–¹æ³•é’ˆå¯¹äºæœ‰çª—å£çš„ç¨‹åºï¼Œå¦‚æœæ˜¯å‘½ä»¤è¡Œçš„å°±æ²¡æœ‰æ¶ˆæ¯ä¼ é€’æœºåˆ¶ï¼Œæ— æ³•ä½¿ç”¨SetWindowsHookExæ¥å…¨å±€æ³¨å…¥ã€‚æ¯”å¦‚<code>Tasklist.exe</code>æŸ¥çœ‹è¿›ç¨‹ï¼Œå°±æ²¡æ³•åšåˆ°éšè—è¿›ç¨‹</p>
<h4 id="å…¨å±€hook-hook-explorer">[å…¨å±€hook] Hook Explorer</h4>
<p>è¿™æ˜¯å…¨å±€hookçš„ä¸€ç§æ€è·¯ï¼Œé€šè¿‡hook explorer.exeè¿›ç¨‹ï¼Œå½“æ–°è¿›ç¨‹åˆ›å»ºéƒ½æ˜¯ä½œä¸ºexplorer.exeçš„å­è¿›ç¨‹ï¼Œæ‰€ä»¥é¦–å…ˆhook explorer.exeä¸­çš„<code>CreateProcess</code>ã€‚ç›‘æ§æ¯ä¸€ä¸ªè¿›ç¨‹çš„åˆ›å»ºã€‚å½“ç›®æ ‡è¿›ç¨‹(ä»»åŠ¡ç®¡ç†å™¨ç­‰)åˆ›å»ºæ—¶ï¼Œå†å‘ç›®æ ‡è¿›ç¨‹æ³¨å…¥</p>
<p>// TODO</p>
<h2 id="r0éšè—ä¿¡æ¯">R0éšè—ä¿¡æ¯</h2>
<h3 id="r0ä¼ªé€ ä¿¡æ¯">R0ä¼ªé€ ä¿¡æ¯</h3>
<p>è¿™é‡Œæ˜¯é’ˆå¯¹<code>_EPROCESS</code>ï¼Œä¿®æ”¹ç›¸åº”çš„ä¿¡æ¯</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#586e75">//0xa40 bytes (sizeof)
</span></span></span><span style="display:flex;"><span><span style="color:#719e07">struct</span> _EPROCESS
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">struct</span> _KPROCESS Pcb;                                                   <span style="color:#586e75">//0x0
</span></span></span><span style="display:flex;"><span>    <span style="color:#719e07">struct</span> _EX_PUSH_LOCK ProcessLock;                                       <span style="color:#586e75">//0x438
</span></span></span><span style="display:flex;"><span>    VOID<span style="color:#719e07">*</span> UniqueProcessId;                                                  <span style="color:#586e75">//0x440
</span></span></span><span style="display:flex;"><span>    <span style="color:#719e07">struct</span> _LIST_ENTRY ActiveProcessLinks;                                  <span style="color:#586e75">//0x448
</span></span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    UCHAR ImageFileName[<span style="color:#2aa198">15</span>];                                                <span style="color:#586e75">//0x5a8
</span></span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>EPROCESSä¸­æœ‰ä¸€ä¸ªå±æ€§å€¼æ˜¯<code>ImageFileName</code>ï¼Œæ ‡å¿—çš„æ˜¯ç¨‹åºåç§°ï¼Œè¿™ä¸ªå€¼æ˜¯å¯ä»¥è¢«ä¿®æ”¹çš„ï¼Œæ‰€ä»¥å¯ä»¥åœ¨é©±åŠ¨å±‚ä¿®æ”¹</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#719e07">typedef</span> <span style="color:#719e07">struct</span> SET_IMAGE_NAME {
</span></span><span style="display:flex;"><span>    UCHAR bImageName[<span style="color:#2aa198">250</span>];
</span></span><span style="display:flex;"><span>    UINT64 pid;
</span></span><span style="display:flex;"><span>}SET_IMAGE_NAME, <span style="color:#719e07">*</span>PSET_IMAGE_NAME ;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#268bd2">SetImageName</span>(PSET_IMAGE_NAME pSetImageName)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    PEPROCESS     pEprocess, pCurProcess;
</span></span><span style="display:flex;"><span>    PUCHAR        pOldImageName;
</span></span><span style="display:flex;"><span>    SIZE_T        len;
</span></span><span style="display:flex;"><span>    PLIST_ENTRY64 pActiveProcessLinks;
</span></span><span style="display:flex;"><span>    PLIST_ENTRY64 pCurNode;
</span></span><span style="display:flex;"><span>    UINT64        uProcessId;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pEprocess <span style="color:#719e07">=</span> <span style="color:#268bd2">PsGetCurrentProcess</span>();
</span></span><span style="display:flex;"><span>    len <span style="color:#719e07">=</span> <span style="color:#268bd2">strlen</span>(pSetImageName<span style="color:#719e07">-&gt;</span>bImageName);
</span></span><span style="display:flex;"><span>    pActiveProcessLinks <span style="color:#719e07">=</span>
</span></span><span style="display:flex;"><span>        ((PCHAR)pEprocess <span style="color:#719e07">+</span> WIN10_21H1_EPROCESS_TO_ACTIVEPROCESSLINKS_OFFSET);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">for</span> (PLIST_ENTRY64 pBeginNode <span style="color:#719e07">=</span> pActiveProcessLinks, pCurNode <span style="color:#719e07">=</span> pBeginNode;
</span></span><span style="display:flex;"><span>         pCurNode<span style="color:#719e07">-&gt;</span>Flink <span style="color:#719e07">!=</span> pBeginNode;
</span></span><span style="display:flex;"><span>         pCurNode <span style="color:#719e07">=</span> pCurNode<span style="color:#719e07">-&gt;</span>Flink) {
</span></span><span style="display:flex;"><span>        pCurProcess <span style="color:#719e07">=</span>
</span></span><span style="display:flex;"><span>            (PEPROCESS)((PCHAR)pCurNode <span style="color:#719e07">-</span>
</span></span><span style="display:flex;"><span>                        WIN10_21H1_EPROCESS_TO_ACTIVEPROCESSLINKS_OFFSET);
</span></span><span style="display:flex;"><span>        uProcessId <span style="color:#719e07">=</span> <span style="color:#268bd2">PsGetProcessId</span>(pCurProcess);
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">if</span> (uProcessId <span style="color:#719e07">==</span> pSetImageName<span style="color:#719e07">-&gt;</span>pid) {
</span></span><span style="display:flex;"><span>            <span style="color:#586e75">// copy new string to cover the old string
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#268bd2">kprintf</span>(<span style="color:#2aa198">&#34;[+ Hide Process R0] found the process pid</span><span style="color:#cb4b16">\r\n</span><span style="color:#2aa198">&#34;</span>, uProcessId);
</span></span><span style="display:flex;"><span>            pOldImageName <span style="color:#719e07">=</span> <span style="color:#268bd2">PsGetProcessImageFileName</span>(pCurProcess);
</span></span><span style="display:flex;"><span>            <span style="color:#268bd2">RtlCopyMemory</span>(pOldImageName, pSetImageName<span style="color:#719e07">-&gt;</span>bImageName, len);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">return</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">return</span> STATUS_UNSUCCESSFUL;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="r0æ¶ˆé™¤è¿›ç¨‹">R0æ¶ˆé™¤è¿›ç¨‹</h3>
<p>è¿™é‡Œä¸»è¦æ˜¯<strong>R0çš„æ–­é“¾</strong></p>
<p>EPROCESSæ˜¯è¿›ç¨‹åœ¨å†…æ ¸ä¸­çš„ç»“æ„ä½“ï¼Œä¸€ä¸ªè¿›ç¨‹ä¸€ä¸ªEPROCESSï¼Œ<code>EPROCESSä¸­-&gt;ActiveProcessLinks</code>å€¼æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼ŒæŒ‡å‘çš„æ˜¯å…¶ä»–è¿›ç¨‹ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>copy
</span></span><span style="display:flex;"><span><span style="color:#586e75">//0xa40 bytes (sizeof)
</span></span></span><span style="display:flex;"><span><span style="color:#719e07">struct</span> _EPROCESS
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">struct</span> _KPROCESS Pcb;                                                   <span style="color:#586e75">//0x0
</span></span></span><span style="display:flex;"><span>    <span style="color:#719e07">struct</span> _EX_PUSH_LOCK ProcessLock;                                       <span style="color:#586e75">//0x438
</span></span></span><span style="display:flex;"><span>    VOID<span style="color:#719e07">*</span> UniqueProcessId;                                                  <span style="color:#586e75">//0x440
</span></span></span><span style="display:flex;"><span>    <span style="color:#719e07">struct</span> _LIST_ENTRY ActiveProcessLinks;                                  <span style="color:#586e75">//0x448
</span></span></span><span style="display:flex;"><span>    <span style="color:#719e07">struct</span> _EX_RUNDOWN_REF RundownProtect;                                  <span style="color:#586e75">//0x458
</span></span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><pre tabindex="0"><code class="language-mer" data-lang="mer">					_eprocess1                   _eprocess2
					.........                    .........
					.........                    .........
					ActiveProcessLinks -&gt; {      ActiveProcessLinks -&gt; {
------------------&gt;	    Flink ------------------&gt;    Flink ------------------&gt;
&lt;------------------   	Blink &lt;------------------    Blink &lt;------------------
					}                            }
</code></pre><p>ç„¶å<code>EPROCESS-&gt;UniqueProcessId</code>è¡¨ç¤ºçš„æ˜¯è¿™ä¸ªè¿›ç¨‹çš„pidã€‚</p>
<p>æ‰€æœ‰æˆ‘ä»¬å¯ä»¥ä¾¿åˆ©æ‰€æœ‰è¿›ç¨‹ï¼Œç„¶åå¯¹æ¯”pidæ˜¯å¦æ˜¯æˆ‘ä»¬çš„ç›®æ ‡pidï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ä»é“¾è¡¨ä¸­æ–­å¼€è¿™ä¸ª<code>ActiveProcessLinks</code>èŠ‚ç‚¹ï¼Œè¿™æ ·å°±å¯ä»¥åšåˆ°éšè—è¿›ç¨‹çš„æ•ˆæœã€‚</p>
<p><strong>é©±åŠ¨éƒ¨åˆ†</strong></p>
<p>è·å–æœ¬è¿›ç¨‹EPROCESSï¼Œä»æœ¬è¿›ç¨‹å¼€å§‹éå†ã€‚æˆ‘è¿™é‡Œæ˜¯ç”¨<code>PsGetCurrentProcess</code>ï¼Œè¿™ç¯‡[æ–‡ç« ](
<a href="https://bbs.kanxue.com/thread-278717.htm" target="_blank" rel="noopener">https://bbs.kanxue.com/thread-278717.htm</a>è¿˜æå‡ºä¸€ç§ä»<code>fs:[0x124]</code>è·å–KPCRå†ï¼Œä¸€å±‚ä¸€å±‚å–å¾—åˆ°EPROCESSçš„æ€è·¯:<code>_KPCR -&gt; _KPRCB -&gt; KTHREAD -&gt; _KAPC_STATE -&gt; _KPROCESS -&gt; _EPROCESS</code>.å¤§ä½¬åˆ†æè¯´è¿™å…¶å®å°±æ˜¯PsGetCurrentProcessçš„ä»£ç å®ç°åŸç†ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>pEprocess <span style="color:#719e07">=</span> <span style="color:#268bd2">PsGetCurrentProcess</span>();
</span></span><span style="display:flex;"><span>pActiveProcessLinks <span style="color:#719e07">=</span>
</span></span><span style="display:flex;"><span>        ((PCHAR)pEprocess <span style="color:#719e07">+</span> WIN10_21H1_EPROCESS_TO_ACTIVEPROCESSLINKS_OFFSET);
</span></span></code></pre></div><p>ç„¶åéå†é“¾è¡¨ï¼Œåˆ¤æ–­æ¯ä¸ªèŠ‚ç‚¹çš„pidæ˜¯å¦æ˜¯ç›®æ ‡pidã€‚å¦‚æœæ˜¯ç›®æ ‡pidåˆ™æ–­å¼€é“¾è¡¨èŠ‚ç‚¹ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#719e07">for</span> (PLIST_ENTRY64 pBeginNode <span style="color:#719e07">=</span> pActiveProcessLinks, pCurNode <span style="color:#719e07">=</span> pBeginNode;
</span></span><span style="display:flex;"><span>     pCurNode<span style="color:#719e07">-&gt;</span>Flink <span style="color:#719e07">!=</span> pBeginNode;
</span></span><span style="display:flex;"><span>     pCurNode <span style="color:#719e07">=</span> pCurNode<span style="color:#719e07">-&gt;</span>Flink) {
</span></span><span style="display:flex;"><span>    pCurProcess <span style="color:#719e07">=</span>
</span></span><span style="display:flex;"><span>        (PEPROCESS)((PCHAR)pCurNode <span style="color:#719e07">-</span>
</span></span><span style="display:flex;"><span>                    WIN10_21H1_EPROCESS_TO_ACTIVEPROCESSLINKS_OFFSET);
</span></span><span style="display:flex;"><span>    uProcessId <span style="color:#719e07">=</span> <span style="color:#268bd2">PsGetProcessId</span>(pCurProcess);
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">kprintf</span>(<span style="color:#2aa198">&#34;[+] pid =&gt; {%#llx}</span><span style="color:#cb4b16">\r\n</span><span style="color:#2aa198">.&#34;</span>, uProcessId);
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">if</span> (uProcessId <span style="color:#719e07">==</span> pid) {
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2">kprintf</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#2aa198">&#34;[+ Hide Process R0] Found the Object Process id: %#llx.</span><span style="color:#cb4b16">\r\n</span><span style="color:#2aa198">&#34;</span>,
</span></span><span style="display:flex;"><span>            uProcessId);
</span></span><span style="display:flex;"><span>        ((PLIST_ENTRY64)pCurNode<span style="color:#719e07">-&gt;</span>Blink)<span style="color:#719e07">-&gt;</span>Flink <span style="color:#719e07">=</span> pCurNode<span style="color:#719e07">-&gt;</span>Flink;
</span></span><span style="display:flex;"><span>        ((PLIST_ENTRY64)pCurNode<span style="color:#719e07">-&gt;</span>Flink)<span style="color:#719e07">-&gt;</span>Blink <span style="color:#719e07">=</span> pCurNode<span style="color:#719e07">-&gt;</span>Blink;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">goto</span> success;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>å‡½æ•°æ€»ä½“ä»£ç </strong></p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#586e75">/// @brief éšè—æŒ‡å®šè¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#586e75">/// @param pid éœ€è¦éšè—çš„è¿›ç¨‹Pid
</span></span></span><span style="display:flex;"><span><span style="color:#586e75">/// @return å¦‚æœéšè—æˆåŠŸåˆ™è¿”å›STATUS_SUCCESSï¼Œå¤±è´¥åˆ™è¿”å›STATUS_UNSUCCESSFUL
</span></span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#268bd2">HideProcessByPid</span>(UINT64 pid)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    UINT64        uProcessId;
</span></span><span style="display:flex;"><span>    PEPROCESS     pEprocess, pCurProcess;
</span></span><span style="display:flex;"><span>    PLIST_ENTRY64 pActiveProcessLinks;
</span></span><span style="display:flex;"><span>    PLIST_ENTRY64 pCurNode;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pEprocess <span style="color:#719e07">=</span> <span style="color:#268bd2">PsGetCurrentProcess</span>();
</span></span><span style="display:flex;"><span>    pActiveProcessLinks <span style="color:#719e07">=</span>
</span></span><span style="display:flex;"><span>        ((PCHAR)pEprocess <span style="color:#719e07">+</span> WIN10_21H1_EPROCESS_TO_ACTIVEPROCESSLINKS_OFFSET);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">for</span> (PLIST_ENTRY64 pBeginNode <span style="color:#719e07">=</span> pActiveProcessLinks, pCurNode <span style="color:#719e07">=</span> pBeginNode;
</span></span><span style="display:flex;"><span>         pCurNode<span style="color:#719e07">-&gt;</span>Flink <span style="color:#719e07">!=</span> pBeginNode;
</span></span><span style="display:flex;"><span>         pCurNode <span style="color:#719e07">=</span> pCurNode<span style="color:#719e07">-&gt;</span>Flink) {
</span></span><span style="display:flex;"><span>        pCurProcess <span style="color:#719e07">=</span>
</span></span><span style="display:flex;"><span>            (PEPROCESS)((PCHAR)pCurNode <span style="color:#719e07">-</span>
</span></span><span style="display:flex;"><span>                        WIN10_21H1_EPROCESS_TO_ACTIVEPROCESSLINKS_OFFSET);
</span></span><span style="display:flex;"><span>        uProcessId <span style="color:#719e07">=</span> <span style="color:#268bd2">PsGetProcessId</span>(pCurProcess);
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2">kprintf</span>(<span style="color:#2aa198">&#34;[+] pid =&gt; {%#llx}</span><span style="color:#cb4b16">\r\n</span><span style="color:#2aa198">.&#34;</span>, uProcessId);
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">if</span> (uProcessId <span style="color:#719e07">==</span> pid) {
</span></span><span style="display:flex;"><span>            <span style="color:#268bd2">kprintf</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#2aa198">&#34;[+ Hide Process R0] Found the Object Process id: %#llx.</span><span style="color:#cb4b16">\r\n</span><span style="color:#2aa198">&#34;</span>,
</span></span><span style="display:flex;"><span>                uProcessId);
</span></span><span style="display:flex;"><span>            ((PLIST_ENTRY64)pCurNode<span style="color:#719e07">-&gt;</span>Blink)<span style="color:#719e07">-&gt;</span>Flink <span style="color:#719e07">=</span> pCurNode<span style="color:#719e07">-&gt;</span>Flink;
</span></span><span style="display:flex;"><span>            ((PLIST_ENTRY64)pCurNode<span style="color:#719e07">-&gt;</span>Flink)<span style="color:#719e07">-&gt;</span>Blink <span style="color:#719e07">=</span> pCurNode<span style="color:#719e07">-&gt;</span>Blink;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">goto</span> success;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">return</span> STATUS_UNSUCCESSFUL;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>success:
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">return</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>æˆ‘æ˜¯å†™æˆwdmç±»å‹çš„é©±åŠ¨ï¼Œè¿™ä¸ªå‡½æ•°éœ€è¦ä¸€ä¸ªè¿›ç¨‹pidï¼Œæ‰€ä»¥è¦ç”¨æˆ·å±‚ä¼ å…¥Pidã€‚æˆ‘å°†è¿™ä¸ªå‡½æ•°å®šä¹‰åœ¨<code>IRP_MJ_DEVICE_CONTROL</code>ä¸‹</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#719e07">#define IOCTL_HIDE_BY_PID \
</span></span></span><span style="display:flex;"><span><span style="color:#719e07">    CTL_CODE(FILE_DEVICE_UNKNOWN, 0x6666, METHOD_BUFFERED, FILE_ANY_ACCESS)
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#268bd2">CustomControl</span>(PDEVICE_OBJECT pDevice, PIRP pIrp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    PIO_STACK_LOCATION pstack;
</span></span><span style="display:flex;"><span>    UINT64             iocode, in_len, out_len, ioinfo, pid;
</span></span><span style="display:flex;"><span>    NTSTATUS           status;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    status  <span style="color:#719e07">=</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>    pstack  <span style="color:#719e07">=</span> <span style="color:#268bd2">IoGetCurrentIrpStackLocation</span>(pIrp);
</span></span><span style="display:flex;"><span>    iocode  <span style="color:#719e07">=</span> pstack<span style="color:#719e07">-&gt;</span>Parameters.DeviceIoControl.IoControlCode;
</span></span><span style="display:flex;"><span>    in_len  <span style="color:#719e07">=</span> pstack<span style="color:#719e07">-&gt;</span>Parameters.DeviceIoControl.InputBufferLength;
</span></span><span style="display:flex;"><span>    out_len <span style="color:#719e07">=</span> pstack<span style="color:#719e07">-&gt;</span>Parameters.DeviceIoControl.OutputBufferLength;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">switch</span> (iocode) {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">case</span> IOCTL_HIDE_BY_PID:
</span></span><span style="display:flex;"><span>        pid <span style="color:#719e07">=</span> <span style="color:#719e07">*</span>(PUINT32)pIrp<span style="color:#719e07">-&gt;</span>AssociatedIrp.SystemBuffer;
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2">kprintf</span>(<span style="color:#2aa198">&#34;[+ Hide Process R0] Recv %#llx from R3.</span><span style="color:#cb4b16">\r\n</span><span style="color:#2aa198">&#34;</span>, pid);
</span></span><span style="display:flex;"><span>        status <span style="color:#719e07">=</span> <span style="color:#268bd2">HideProcessByPid</span>(pid);
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">if</span> (<span style="color:#719e07">!</span><span style="color:#268bd2">NT_SUCCESS</span>(status)) {
</span></span><span style="display:flex;"><span>            <span style="color:#268bd2">kprintf</span>(<span style="color:#2aa198">&#34;[! Hide Process R0] Hide Process failed.</span><span style="color:#cb4b16">\r\n</span><span style="color:#2aa198">&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        ioinfo <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">default</span><span style="color:#719e07">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2">kprintf</span>(<span style="color:#2aa198">&#34;[! Hide Process]Recv iocode: %#llx&#34;</span>, iocode);
</span></span><span style="display:flex;"><span>        status <span style="color:#719e07">=</span> STATUS_UNSUCCESSFUL;
</span></span><span style="display:flex;"><span>        ioinfo <span style="color:#719e07">=</span> <span style="color:#2aa198">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pIrp<span style="color:#719e07">-&gt;</span>IoStatus.Status      <span style="color:#719e07">=</span> status;
</span></span><span style="display:flex;"><span>    pIrp<span style="color:#719e07">-&gt;</span>IoStatus.Information <span style="color:#719e07">=</span> ioinfo;
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">IoCompleteRequest</span>(pIrp, IO_NO_INCREMENT);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">return</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å®Œæ•´ä»£ç åœ¨
<a href="https://github.com/Military-axe/HideProcessR0" target="_blank" rel="noopener">HideProcessR0</a>ä¸­ã€‚</p>
<p><strong>ç”¨æˆ·å±‚éƒ¨åˆ†ä»£ç </strong></p>
<p>ç”¨æˆ·å±‚éƒ¨åˆ†æˆ‘ç›´æ¥æ˜¯ç”¨Rustæ¥ç¼–å†™</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#719e07">#[derive(Debug)]</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">pub</span> <span style="color:#719e07">struct</span> <span style="color:#268bd2">BreakChain</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">impl</span> BreakChain {
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">pub</span> <span style="color:#719e07">fn</span> <span style="color:#268bd2">hide_by_pid</span>(pid: <span style="color:#dc322f">u32</span>) -&gt; <span style="color:#b58900">Result</span><span style="color:#719e07">&lt;</span>()<span style="color:#719e07">&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2">let</span> hdevice <span style="color:#719e07">=</span> <span style="color:#719e07">unsafe</span> {
</span></span><span style="display:flex;"><span>            CreateFileA(
</span></span><span style="display:flex;"><span>                <span style="color:#268bd2">s!</span>(<span style="color:#2aa198">&#34;</span><span style="color:#cb4b16">\\\\</span><span style="color:#2aa198">.</span><span style="color:#cb4b16">\\</span><span style="color:#2aa198">HideProcessR0&#34;</span>),
</span></span><span style="display:flex;"><span>                (<span style="color:#cb4b16">GENERIC_READ</span> <span style="color:#719e07">|</span> <span style="color:#cb4b16">GENERIC_WRITE</span>).<span style="color:#2aa198">0</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#cb4b16">FILE_SHARE_NONE</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#b58900">None</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#cb4b16">OPEN_EXISTING</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#cb4b16">FILE_ATTRIBUTE_NORMAL</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#b58900">None</span>,
</span></span><span style="display:flex;"><span>            )<span style="color:#719e07">?</span>
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2">debug!</span>(<span style="color:#2aa198">&#34;Open Device success&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">if</span> hdevice.is_invalid() {
</span></span><span style="display:flex;"><span>            <span style="color:#268bd2">warn!</span>(<span style="color:#2aa198">&#34;Open Device failed {:?}.&#34;</span>, <span style="color:#719e07">unsafe</span> { GetLastError() });
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">return</span> <span style="color:#b58900">Err</span>(Error::msg(<span style="color:#2aa198">&#34;Open Device failed.&#34;</span>));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2">let</span> input_buffer <span style="color:#719e07">=</span> <span style="color:#719e07">&amp;</span>pid <span style="color:#719e07">as</span> <span style="color:#719e07">*</span><span style="color:#719e07">const</span> <span style="color:#dc322f">u32</span> <span style="color:#719e07">as</span> <span style="color:#719e07">*</span><span style="color:#719e07">const</span> c_void;
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">unsafe</span> {
</span></span><span style="display:flex;"><span>            DeviceIoControl(
</span></span><span style="display:flex;"><span>                hdevice,
</span></span><span style="display:flex;"><span>                ctl_code(
</span></span><span style="display:flex;"><span>                    <span style="color:#cb4b16">FILE_DEVICE_UNKNOWN</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#2aa198">0x6666</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#cb4b16">METHOD_BUFFERED</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#cb4b16">FILE_ANY_ACCESS</span>,
</span></span><span style="display:flex;"><span>                ),
</span></span><span style="display:flex;"><span>                <span style="color:#b58900">Some</span>(input_buffer),
</span></span><span style="display:flex;"><span>                size_of::<span style="color:#719e07">&lt;</span><span style="color:#dc322f">u32</span><span style="color:#719e07">&gt;</span>() <span style="color:#719e07">as</span> <span style="color:#dc322f">u32</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#b58900">None</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#2aa198">0</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#b58900">None</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#b58900">None</span>,
</span></span><span style="display:flex;"><span>            )<span style="color:#719e07">?</span>
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2">debug!</span>(<span style="color:#2aa198">&#34;Send pid to driver success&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#b58900">Ok</span>(())
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">fn</span> <span style="color:#268bd2">ctl_code</span>(device_type: <span style="color:#dc322f">u32</span>, function: <span style="color:#dc322f">u32</span>, method: <span style="color:#dc322f">u32</span>, access: <span style="color:#dc322f">u32</span>) -&gt; <span style="color:#dc322f">u32</span> {
</span></span><span style="display:flex;"><span>    ((device_type) <span style="color:#719e07">&lt;&lt;</span> <span style="color:#2aa198">16</span>) <span style="color:#719e07">|</span> ((access) <span style="color:#719e07">&lt;&lt;</span> <span style="color:#2aa198">14</span>) <span style="color:#719e07">|</span> ((function) <span style="color:#719e07">&lt;&lt;</span> <span style="color:#2aa198">2</span>) <span style="color:#719e07">|</span> (method)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>è¿è¡Œä¹‹åï¼Œæœç´¢ä¸åˆ°è®°äº‹æœ¬è¿›ç¨‹äº†</p>
<p><img src="https://s2.loli.net/2024/05/27/nEihpY3gI2ukyom.png" alt=""></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘æ‰‹åŠ¨å…³é—­è¿™ä¸ªæ–­å¼€é“¾è¡¨çš„è¿›ç¨‹ä¼šé€ æˆè“å±ï¼Œæ‰€ä»¥ç›®å‰è¿™ä¸ªåªèƒ½ç”¨äºç®€å•çš„demoæ¼”ç¤ºï¼Œæˆ–è€…æŸç§éœ€è¦éšè”½ä¸”ä¸å…³é—­çš„ç¨‹åºã€‚å…·ä½“çš„è“å±æŠ¥é”™ä¿¡æ¯å¦‚ä¸‹ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>EXCEPTION_RECORD:  ffffc2857eb137a8 <span style="color:#719e07">--</span> (.exr <span style="color:#2aa198">0xffffc2857eb137a8</span>)
</span></span><span style="display:flex;"><span>ExceptionAddress: <span style="color:#268bd2">fffff8066aa4dc11</span> (nt<span style="color:#719e07">!</span>PspProcessDelete<span style="color:#719e07">+</span><span style="color:#2aa198">0x000000000012e731</span>)
</span></span><span style="display:flex;"><span>   ExceptionCode: <span style="color:#268bd2">c0000409</span> (Security check failure or stack buffer overrun)
</span></span><span style="display:flex;"><span>  ExceptionFlags: <span style="color:#2aa198">00000001</span>
</span></span><span style="display:flex;"><span>NumberParameters: <span style="color:#2aa198">1</span>
</span></span><span style="display:flex;"><span>   Parameter[<span style="color:#2aa198">0</span>]<span style="color:#719e07">:</span> <span style="color:#2aa198">0000000000000003</span>
</span></span><span style="display:flex;"><span>Subcode: <span style="color:#2aa198">0x3</span> FAST_FAIL_CORRUPT_LIST_ENTRY 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PROCESS_NAME:  System
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ERROR_CODE: (NTSTATUS) <span style="color:#2aa198">0xc0000409</span> <span style="color:#719e07">-</span> The system detected an overrun of a stack<span style="color:#719e07">-</span>based buffer in this application. This overrun could potentially allow a malicious user to gain control of this application.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>EXCEPTION_CODE_STR:  c0000409
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>EXCEPTION_PARAMETER1:  <span style="color:#2aa198">0000000000000003</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>EXCEPTION_STR:  <span style="color:#2aa198">0xc0000409</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>STACK_TEXT:  
</span></span><span style="display:flex;"><span>ffffc285`<span style="color:#2aa198">7</span>eb12d78 fffff806`<span style="color:#2aa198">6</span>a718e82     : ffffc285`<span style="color:#2aa198">7</span>eb12ee0 fffff806`<span style="color:#2aa198">6</span>a57f580 <span style="color:#2aa198">00000000</span>`<span style="color:#2aa198">00000100</span> <span style="color:#2aa198">00000000</span>`<span style="color:#2aa198">00000000</span> <span style="color:#719e07">:</span> nt<span style="color:#719e07">!</span>DbgBreakPointWithStatus
</span></span><span style="display:flex;"><span>ffffc285`<span style="color:#2aa198">7</span>eb12d80 fffff806`<span style="color:#2aa198">6</span>a718466     : <span style="color:#2aa198">00000000</span>`<span style="color:#2aa198">00000003</span> ffffc285`<span style="color:#2aa198">7</span>eb12ee0 fffff806`<span style="color:#2aa198">6</span>a6159e0 <span style="color:#2aa198">00000000</span>`<span style="color:#2aa198">0000013</span><span style="color:#2aa198">9</span> <span style="color:#719e07">:</span> nt<span style="color:#719e07">!</span>KiBugCheckDebugBreak<span style="color:#719e07">+</span><span style="color:#2aa198">0x12</span>
</span></span><span style="display:flex;"><span>ffffc285`<span style="color:#2aa198">7</span>eb12de0 fffff806`<span style="color:#2aa198">6</span>a5fdb47     : <span style="color:#2aa198">00000000</span>`<span style="color:#2aa198">0000004</span><span style="color:#2aa198">8</span> <span style="color:#2aa198">00000000</span>`<span style="color:#2aa198">00000004</span> ffffc40d`<span style="color:#2aa198">26</span>a08080 <span style="color:#2aa198">33333333</span>`<span style="color:#2aa198">33333333</span> <span style="color:#719e07">:</span> nt<span style="color:#719e07">!</span>KeBugCheck2<span style="color:#719e07">+</span><span style="color:#2aa198">0x946</span>
</span></span><span style="display:flex;"><span>ffffc285`<span style="color:#2aa198">7</span>eb134f0 fffff806`<span style="color:#2aa198">6</span>a612269     : <span style="color:#2aa198">00000000</span>`<span style="color:#2aa198">0000013</span><span style="color:#2aa198">9</span> <span style="color:#2aa198">00000000</span>`<span style="color:#2aa198">00000003</span> ffffc285`<span style="color:#2aa198">7</span>eb13850 ffffc285`<span style="color:#2aa198">7</span>eb137a8 : nt<span style="color:#719e07">!</span>KeBugCheckEx<span style="color:#719e07">+</span><span style="color:#2aa198">0x107</span>
</span></span><span style="display:flex;"><span>ffffc285`<span style="color:#2aa198">7</span>eb13530 fffff806`<span style="color:#2aa198">6</span>a612810     : ffffc40d`<span style="color:#2aa198">23602100</span> fffff806`<span style="color:#2aa198">6</span>a433ff2 ffffc40d`<span style="color:#2aa198">26</span>a08080 ffffc40d`<span style="color:#2aa198">26</span>a084c8 : nt<span style="color:#719e07">!</span>KiBugCheckDispatch<span style="color:#719e07">+</span><span style="color:#2aa198">0x69</span>
</span></span><span style="display:flex;"><span>ffffc285`<span style="color:#2aa198">7</span>eb13670 fffff806`<span style="color:#2aa198">6</span>a6106ae     : <span style="color:#2aa198">00000000</span>`<span style="color:#2aa198">00000000</span> fffff806`<span style="color:#2aa198">6</span>a606036 ffffffff`ffffffff <span style="color:#2aa198">00000000</span>`<span style="color:#2aa198">00000006</span> <span style="color:#719e07">:</span> nt<span style="color:#719e07">!</span>KiFastFailDispatch<span style="color:#719e07">+</span><span style="color:#2aa198">0xd0</span>
</span></span><span style="display:flex;"><span>ffffc285`<span style="color:#2aa198">7</span>eb13850 fffff806`<span style="color:#2aa198">6</span>aa4dc11     : <span style="color:#2aa198">00000000</span>`<span style="color:#2aa198">00000000</span> <span style="color:#2aa198">00000000</span>`<span style="color:#2aa198">00000000</span> <span style="color:#2aa198">00000000</span>`<span style="color:#2aa198">00000000</span> <span style="color:#2aa198">00000000</span>`<span style="color:#2aa198">00000000</span> <span style="color:#719e07">:</span> nt<span style="color:#719e07">!</span>KiRaiseSecurityCheckFailure<span style="color:#719e07">+</span><span style="color:#2aa198">0x32e</span>
</span></span><span style="display:flex;"><span>ffffc285`<span style="color:#2aa198">7</span>eb139e0 fffff806`<span style="color:#2aa198">6</span>a82e9b0     : ffffc40d`<span style="color:#2aa198">26</span>a08050 ffffc40d`<span style="color:#2aa198">26</span>a08050 <span style="color:#2aa198">00000000</span>`<span style="color:#2aa198">00000001</span> ffffc40d`<span style="color:#2aa198">23</span>ce0980 : nt<span style="color:#719e07">!</span>PspProcessDelete<span style="color:#719e07">+</span><span style="color:#2aa198">0x12e731</span>
</span></span><span style="display:flex;"><span>ffffc285`<span style="color:#2aa198">7</span>eb13a70 fffff806`<span style="color:#2aa198">6</span>a8d4844     : <span style="color:#2aa198">00000000</span>`<span style="color:#2aa198">00000000</span> ffffc40d`<span style="color:#2aa198">26</span>a08050 fffff806`<span style="color:#2aa198">6</span>a8d4640 ffffc40d`<span style="color:#2aa198">23</span>d13af0 : nt<span style="color:#719e07">!</span>ObpRemoveObjectRoutine<span style="color:#719e07">+</span><span style="color:#2aa198">0x80</span>
</span></span><span style="display:flex;"><span>ffffc285`<span style="color:#2aa198">7</span>eb13ad0 fffff806`<span style="color:#2aa198">6</span>a4c3ea5     : ffffc40d`<span style="color:#2aa198">292</span>c3040 fffff806`<span style="color:#2aa198">6</span>a8d4640 ffffc40d`<span style="color:#2aa198">23</span>d13af0 ffffc40d`<span style="color:#2aa198">00000000</span> <span style="color:#719e07">:</span> nt<span style="color:#719e07">!</span>ObpProcessRemoveObjectQueue<span style="color:#719e07">+</span><span style="color:#2aa198">0x204</span>
</span></span><span style="display:flex;"><span>ffffc285`<span style="color:#2aa198">7</span>eb13b70 fffff806`<span style="color:#2aa198">6</span>a54ef55     : ffffc40d`<span style="color:#2aa198">292</span>c3040 <span style="color:#2aa198">00000000</span>`<span style="color:#2aa198">000000</span><span style="color:#2aa198">80</span> ffffc40d`<span style="color:#2aa198">23</span>c95040 <span style="color:#2aa198">00000000</span>`<span style="color:#2aa198">00000000</span> <span style="color:#719e07">:</span> nt<span style="color:#719e07">!</span>ExpWorkerThread<span style="color:#719e07">+</span><span style="color:#2aa198">0x105</span>
</span></span><span style="display:flex;"><span>ffffc285`<span style="color:#2aa198">7</span>eb13c10 fffff806`<span style="color:#2aa198">6</span>a606a48     : ffffae01`<span style="color:#2aa198">1f</span><span style="color:#2aa198">940180</span> ffffc40d`<span style="color:#2aa198">292</span>c3040 fffff806`<span style="color:#2aa198">6</span>a54ef00 ffffffff`ffffffff : nt<span style="color:#719e07">!</span>PspSystemThreadStartup<span style="color:#719e07">+</span><span style="color:#2aa198">0x55</span>
</span></span><span style="display:flex;"><span>ffffc285`<span style="color:#2aa198">7</span>eb13c60 <span style="color:#2aa198">00000000</span>`<span style="color:#2aa198">00000000</span>     <span style="color:#719e07">:</span> ffffc285`<span style="color:#2aa198">7</span>eb14000 ffffc285`<span style="color:#2aa198">7</span>eb0e000 <span style="color:#2aa198">00000000</span>`<span style="color:#2aa198">00000000</span> <span style="color:#2aa198">00000000</span>`<span style="color:#2aa198">00000000</span> <span style="color:#719e07">:</span> nt<span style="color:#719e07">!</span>KiStartSystemThread<span style="color:#719e07">+</span><span style="color:#2aa198">0x28</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SYMBOL_NAME:  nt<span style="color:#719e07">!</span>KiFastFailDispatch<span style="color:#719e07">+</span>d0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>MODULE_NAME: nt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>IMAGE_NAME:  ntkrnlmp.exe
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>STACK_COMMAND:  .cxr; .ecxr ; kb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BUCKET_ID_FUNC_OFFSET:  d0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>FAILURE_BUCKET_ID:  <span style="color:#2aa198">0x139</span>_3_CORRUPT_LIST_ENTRY_nt<span style="color:#719e07">!</span>KiFastFailDispatch
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OS_VERSION:  <span style="color:#2aa198">10.0.19041.1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BUILDLAB_STR:  vb_release
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OSPLATFORM_TYPE:  x64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OSNAME:  Windows <span style="color:#2aa198">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>FAILURE_ID_HASH:  {<span style="color:#2aa198">3</span>aede96a<span style="color:#719e07">-</span><span style="color:#2aa198">54</span>dd<span style="color:#719e07">-</span><span style="color:#2aa198">40</span>d6<span style="color:#719e07">-</span>d4cb<span style="color:#719e07">-</span><span style="color:#2aa198">2</span>a161a843851}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Followup:     MachineOwner
</span></span></code></pre></div><h1 id="æ€»ç»“æ€è€ƒ">æ€»ç»“æ€è€ƒ</h1>
<p>R3å±‚é¢çš„ä¸»è¦æ˜¯hookç¨‹åºçš„<code>ZwQuerySystemInformation</code>å‡½æ•°ï¼Œè¿™ç§éœ€è¦æ³¨å…¥dllï¼Œå¯¹å‘½ä»¤è¡Œè·å–è¿›ç¨‹ä¿¡æ¯çš„ç¨‹åºæ²¡åŠæ³•ï¼Œæ¯”å¦‚<code>Tasklist</code>ç¨‹åºå°±æ²¡æœ‰åŠæ³•ã€‚å“ªæ€•æ˜¯SetWindowsHookä¹Ÿä¸è¡Œï¼Œå› ä¸ºå‘½ä»¤ç¨‹åºæ²¡æœ‰Windowsï¼Œæ²¡æœ‰çª—å£äº‹ä»¶ã€‚</p>
<p>Hook explorerçš„åªèƒ½ç›‘æ§åŸºäºexplorerçš„å­è¿›ç¨‹ï¼Œå¯¹äºå¤§éƒ¨åˆ†æƒ…å†µåº”è¯¥å¯ä»¥ï¼Œä½†æ˜¯æˆ‘è¿™é‡Œè¿˜æ²¡æ‰¾åˆ°å¤ªå¤šèµ„æ–™ï¼Œæ²¡æœ‰å®ç°å‡ºæ¥</p>
<p>R0å±‚é¢ï¼Œå¦‚æœæ–­å¼€é“¾è¡¨ï¼Œå°±éœ€è¦åœ¨è¿›ç¨‹é€€å‡ºçš„æ—¶å€™è¿˜åŸé“¾è¡¨ï¼Œå¦åˆ™å°±ä¼šå¯¼è‡´è“å±ã€‚</p>
<h1 id="å‚è€ƒ">å‚è€ƒ</h1>
<p>
<a href="https://github.com/Oxygen1a1/HideProcess?tab=readme-ov-file" target="_blank" rel="noopener">HideProcess | Oxygen1a1 Â· github.com</a></p>
<p>
<a href="https://bbs.kanxue.com/thread-269919.htm" target="_blank" rel="noopener">è¿›ç¨‹éšè—æŠ€æœ¯ | 1900 Â· çœ‹é›ª</a></p>
<p>
<a href="https://bbs.kanxue.com/thread-278717.htm" target="_blank" rel="noopener">è¶…è¯¦ç»†çš„3ç¯å’Œ0ç¯æ–­é“¾éšè—åˆ†æ | ATrueMan Â· çœ‹é›ª</a></p>
<p>
<a href="https://military-axe.github.io/posts/rustbian-xie-ji-chong-hookde-fang-shi/" target="_blank" rel="noopener">Rustç¼–å†™å‡ ç§hookçš„æ–¹å¼ | mi1itray.axe Â· github.io</a></p>
<p>
<a href="https://xz.aliyun.com/t/10256?time__1311=mq%2BxBDyDRAn4lxGggYG8i2A1DjhnPoD&amp;alichlgref=https%3A%2F%2Fwww.google.com.hk%2F" target="_blank" rel="noopener">Windowå‘ä¹‹å…¨å±€Hookå®ç°è¿›ç¨‹éšè— | xq17 Â· å…ˆçŸ¥</a></p>
<p>
<a href="https://learn.microsoft.com/zh-cn/windows/win32/api/winuser/nf-winuser-setwindowshookexa" target="_blank" rel="noopener">SetWindowsHookExA å‡½æ•° (winuser.h)</a></p>
<p>
<a href="https://blog.csdn.net/kingkee/article/details/97390029" target="_blank" rel="noopener">ã€C++ã€‘ä»£ç å®ç°ï¼šå…¨å±€é’©å­æ³¨å…¥æŠ€æœ¯ | kingkee Â· csdn.net</a></p>
        </div>
        <footer>
  <p class="meta">
    <span class="byline author vcard">Posted by <span class="fn">Mi1itray.axe</span></span><time>May 30, 2024</time>
    
      <span class="categories">
        Tags:<a class="category" href="http://localhost:1313/tags/windows">windows</a>  <a class="category" href="http://localhost:1313/tags/hide">hide</a>  <a class="category" href="http://localhost:1313/tags/driver">driver</a>  <a class="category" href="http://localhost:1313/tags/hook">hook</a>  
    
    </span>
  </p><p class="meta">
    
        <a class="basic-alignment left" href="http://localhost:1313/blog/2024-05-06-%E9%80%9A%E8%BF%87%E4%BF%AE%E6%94%B9%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98%E5%AE%9E%E7%8E%B0%E8%B7%A8%E8%BF%9B%E7%A8%8B%E5%86%85%E5%AD%98%E8%AF%BB%E5%86%99/" title="é€šè¿‡ä¿®æ”¹ç‰©ç†å†…å­˜å®ç°è·¨è¿›ç¨‹å†…å­˜è¯»å†™">é€šè¿‡ä¿®æ”¹ç‰©ç†å†…å­˜å®ç°è·¨è¿›ç¨‹å†…å­˜è¯»å†™</a>
    

    
      <a class="basic-alignment right" href="http://localhost:1313/blog/2025-01-10-c-static-polymorphism-curiously-recurring-template-pattern/" title="C&#43;&#43; static polymorphism &amp;&amp; Curiously recurring template pattern">C&#43;&#43; static polymorphism &amp;&amp; Curiously recurring template pattern</a>
    
  </p>
  
  
</footer>


      </article>
    </div>
    <aside class="sidebar thirds">
  <section class="first odd">

    
      <h1>About</h1>
    

    <p>
      
        <p>mi1itray.axe&rsquo;s blog</p>
<p>This blog is mainly used to record my learning in the field of CTF. The main direction is Reverse.</p>
<p>You can use gpg to contact me, My public key in 
<a href="./gpg_publickey.asc">here</a></p>

      
    </p>
  </section><ul class="sidebar-nav">
  <li class="sidebar-nav-item">
    <a target="_blank" rel="noopener noreferrer" href="https://github.com/Military-axe" title="https://github.com/Military-axe"><i class="fa fa-github fa-3x"></i></a>
    
    
    
    
    
    
    
    
    
    
    </li>
</ul>
    
      <section class="odd">
        
          <h1>Friend Link</h1>
        
        
          <li>
            <a href="https://h0pe-ay.github.io/" title="h0pe" >h0pe</a>
          </li>
        
          <li>
            <a href="https://lindll.github.io/" title="l0ck" >l0ck</a>
          </li>
        
          <li>
            <a href="https://www.cnblogs.com/Ar3sh1" title="Ar3sh1" >Ar3sh1</a>
          </li>
        
          <li>
            <a href="https://github.com/WyHlj" title="Char0n" >Char0n</a>
          </li>
        
          <li>
            <a href="https://southsea.st/" title="southsea" >southsea</a>
          </li>
        
      </section>
    
  
    
      <section class="even">
        <h1>Recent Posts</h1>
        <ul id="recent_posts">
          
          
            
              <li class="post">
                <a href="/blog/2025-01-25-llvm-base-development-environment-configuration/">llvm base development environment configuration</a>
              </li>
            
          
            
          
            
              <li class="post">
                <a href="/blog/2025-01-10-c-static-polymorphism-curiously-recurring-template-pattern/">C&#43;&#43; static polymorphism &amp;&amp; Curiously recurring template pattern</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2024-05-30-windows%E8%BF%9B%E7%A8%8B%E9%9A%90%E8%97%8F%E5%88%9D%E6%8E%A2/">Windowsè¿›ç¨‹éšè—åˆæ¢</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2024-05-06-%E9%80%9A%E8%BF%87%E4%BF%AE%E6%94%B9%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98%E5%AE%9E%E7%8E%B0%E8%B7%A8%E8%BF%9B%E7%A8%8B%E5%86%85%E5%AD%98%E8%AF%BB%E5%86%99/">é€šè¿‡ä¿®æ”¹ç‰©ç†å†…å­˜å®ç°è·¨è¿›ç¨‹å†…å­˜è¯»å†™</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2024-04-29-%E5%8F%A5%E6%9F%84%E9%99%8D%E6%9D%83%E7%BB%95%E8%BF%87callbacks%E6%A3%80%E6%9F%A5/">å¥æŸ„é™æƒç»•è¿‡CallBacksæ£€æŸ¥</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2024-03-22-rust%E7%BC%96%E5%86%99%E5%87%A0%E7%A7%8Dhook%E7%9A%84%E6%96%B9%E5%BC%8F/">Rustç¼–å†™å‡ ç§hookçš„æ–¹å¼</a>
              </li>
            
          
            
              <li class="post">
                <a href="/blog/2024-03-19-%E5%88%A9%E7%94%A8peb%E9%81%8D%E5%8E%86%E6%A8%A1%E5%9D%97%E9%93%BE%E8%A1%A8/">åˆ©ç”¨PEBéå†æ¨¡å—é“¾è¡¨</a>
              </li>
            
          
        </ul>
      </section>
    
  
</aside>

  </div>
</div>

    <footer role="contentinfo">
      <p>Copyright &copy; 2025 Mi1itray.axe - <a href="http://localhost:1313/license/">License</a> -
        <span class="credit">Powered by <a target="_blank" href="https://gohugo.io" rel="noopener noreferrer">Hugo</a> and <a target="_blank" href="https://github.com/parsiya/hugo-octopress/" rel="noopener noreferrer">Hugo-Octopress</a> theme.
      </p>
    </footer>
  </body>
</html>

